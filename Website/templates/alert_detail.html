{% extends 'base.html' %}
{% load humanize %}
{% load static %}

{% block title %}Alert Details - GE Tools{% endblock %}

{% block extra_css %}
<!-- Group selector styles (shared with alerts.html) -->
<link rel="stylesheet" href="{% static 'css/group-selector.css' %}">

<style>

    #view-weights-toggle-btn, #edit-weights-toggle-group .btn-weights-toggle {
        width: auto; /* prevents fullâ€‘width stretching */
        max-width: 190px; padding: 4px 10px;/* reduce horizontal padding */
        display: inline-block; white-space: nowrap;
    }

#alert-delete-btn {
    vertical-align: inherit;
}
    .alert-detail-container {
        max-width: 900px;
        margin: 0 auto;
    }
    
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: #667eea;
        text-decoration: none;
        font-weight: 500;
        margin-bottom: 20px;
        transition: all 0.2s ease;
    }
    
    .back-link:hover {
        color: #764ba2;
        transform: translateX(-3px);
    }
    
    .back-link svg {
        width: 20px;
        height: 20px;
    }
    
    .alert-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 30px;
        color: white;
        box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
    }
    
    .alert-header-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
    }
    
    .alert-type-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.2);
        padding: 8px 16px;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .alert-type-badge svg {
        width: 18px;
        height: 18px;
    }
    
    .alert-status {
        display: flex;
        gap: 10px;
    }
    
    .status-pill {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .status-active {
        background: #28a745;
        color: white;
    }
    
    .status-inactive {
        background: #6c757d;
        color: white;
    }
    
    .status-triggered {
        background: #28a745;
        color: white;
    }
    
    .status-not-triggered {
        background: #6c757d;
        color: white;
    }
    
    /* Status notification */
    .status-notification {
        background-color: #28a745;
        color: white;
        padding: 15px 40px 15px 20px;
        border-radius: 8px;
        margin-bottom: 15px;
        position: relative;
        font-weight: 500;
        transition: opacity 0.3s ease, transform 0.3s ease, max-height 0.3s ease, margin 0.3s ease, padding 0.3s ease;
        max-height: 100px;
        overflow: hidden;
    }
    
    .status-notification.dismissing {
        opacity: 0;
        transform: translateX(20px);
        max-height: 0;
        margin-bottom: 0;
        padding-top: 0;
        padding-bottom: 0;
    }
    
    .status-notification .dismiss-btn {
        position: absolute;
        top: 50%;
        right: 15px;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        font-weight: bold;
        line-height: 1;
        opacity: 0.8;
    }
    
    .status-notification .dismiss-btn:hover {
        opacity: 1;
    }
    
    .alert-title {
        font-size: 1.8rem;
        font-weight: 700;
        margin: 0 0 10px 0;
        line-height: 1.3;
    }
    
    .alert-subtitle {
        opacity: 0.9;
        font-size: 1rem;
    }
    
    .detail-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        margin-bottom: 20px;
        overflow: hidden;
    }
    
    .detail-card-header {
        background: #f8f9fa;
        padding: 16px 24px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .detail-card-header h3 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .detail-card-header h3 svg {
        width: 20px;
        height: 20px;
        color: #667eea;
    }
    
    .detail-card-body {
        padding: 24px;
    }
    
    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px !important;
    }
    
    .detail-item {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    /* Default (compact) label styling â€” pill-shaped inline badge */
    .detail-label {
        width: auto;
        padding: 2px 6px;
        border-radius: 4px;
    }

    /* =============================================================================
       COMPACT / EXPANDED VIEW TOGGLE
       =============================================================================
       What: The page defaults to "compact" (inline flex rows, pill labels, tight gap).
             When .detail-grid has the .expanded-view class, items stack vertically
             with more spacing and full-width labels.
       Why: Lets users switch between a dense compact view and a spacious expanded view
       How: .expanded-view increases grid gap to 20px, removes display:flex from
            .detail-item so they stack, and resets .detail-label to full-width block
    ============================================================================= */
    .detail-grid {
        gap: 10px;
    }
    .expanded-view {
        gap: 5px !important;
    }
    .expanded-view .detail-item {
        display: block;
    }
    .expanded-view .detail-label {
        width: 100%;
        padding: 0;
    }
    
    /* Full-width detail item for reference prices display */
    /* What: Makes the detail item span full width of the grid */
    /* Why: Reference prices list needs more horizontal space */
    /* How: grid-column: 1 / -1 spans all columns */
    .detail-item.detail-item-full {
        grid-column: 1 / -1;
    }
    
    /* Reference prices display in view mode (non-editing) */
    /* What: Styles for the baseline reference prices list */
    /* Why: Match the edit mode display styling for consistency */
    .reference-prices-display-view {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 8px;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .reference-prices-display-view .reference-price-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 12px;
        border-radius: 4px;
    }
    
    /* Zebra striping for view mode reference prices */
    /* What: Alternating row colors for better readability */
    /* Why: Makes it easier to scan long lists of items and prices */
    /* How: nth-child selectors with subtle color alternation */
    .reference-prices-display-view .reference-price-item:nth-child(odd) {
        background: #ffffff;
    }
    
    .reference-prices-display-view .reference-price-item:nth-child(even) {
        background: #eef2ff;  /* Light purple/blue tint to match site theme */
    }
    
    .reference-prices-display-view .item-name {
        font-weight: 500;
        color: #333;
    }
    
    .reference-prices-display-view .item-price {
        font-weight: 600;
        color: #1cb537;
    }
    
    .reference-prices-display-view .no-data {
        color: #6c757d;
        font-style: italic;
    }
    
    .detail-label {
        font-size: 0.7rem;
        font-weight: 600;
        color: #2a7fca;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        background-color: #e8eef5;
        border-radius: 4px;
        padding: 2px 6px !important;
    }
    
    .detail-value {
        font-size: 0.8rem;
        font-weight: 500;
        color: #333;
    }
    
    .detail-value.highlight {
        color: #18b43f;
        font-weight: 700;
    }
    
    .detail-value.price {
        font-family: 'Segoe UI', system-ui, sans-serif;
    }
    
    .detail-value.positive {
        color: #28a745;
    }
    
    .detail-value.negative {
        color: #dc3545;
    }
    .btn-weights-toggle svg {
        vertical-align: baseline;
    }
    
    .detail-value.muted {
        color: #6c757d;
        font-style: italic;
    }
    
    /* Edit Controls - in header */
    .edit-controls {
        display: flex;
        gap: 8px;
        margin-left: auto;
    }
    
    .header-buttons {
        display: flex;
        gap: 8px;
    }
    
    .btn-edit {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 6px 14px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    
    .btn-edit:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
    }
    
    .btn-edit svg {
        width: 14px;
        height: 14px;
    }
    
    /* btn-compact-toggle: Button to switch between compact and expanded detail views
       What: Styled like the "Manage Groups" outline button on the favorites page
       Why: White/outline style visually communicates a secondary, non-destructive action
       How: White background, grey text, light border; hover darkens background and
            highlights border with the page's primary accent color */
    .btn-compact-toggle {
        background: #FFFFFF;
        color: #374151;
        border: 1px solid #E5E7EB;
        padding: 6px 14px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    .btn-compact-toggle:hover {
        background: #F5F6F8;
        border-color: #667eea;
    }
    .btn-compact-toggle svg {
        width: 14px;
        height: 14px;
    }
    
    .btn-save {
        background: #28a745;
        color: white;
        border: none;
        padding: 6px 14px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: none;
    }
    
    .btn-save:hover {
        background: #218838;
    }
    
    .btn-save svg {
        width: 14px;
        height: 14px;
    }
    
    .btn-cancel {
        background: #6c757d;
        color: white;
        border: none;
        padding: 6px 14px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: none;
    }
    
    .btn-cancel:hover {
        background: #5a6268;
    }
    
    .btn-cancel svg {
        width: 14px;
        height: 14px;
    }
    
    .btn-delete {
        background: #dc3545;
        color: white;
        border: none;
        padding: 6px 14px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .btn-delete:hover {
        background: #c82333;
    }
    
    .btn-delete svg {
        width: 14px;
        height: 14px;
    }
    
    .edit-mode .btn-edit,
    .edit-mode .btn-delete {
        display: none;
    }
    
    /* Form Styles */
    .edit-form {
        display: none;
    }
    
    .edit-mode .edit-form {
        display: block;
    }
    
    .edit-mode .edit-form .form-grid {
        display: grid;
    }
    
    .edit-mode .display-content {
        display: none;
    }
    
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid #e9ecef;
    }
    
    .form-actions .btn-save,
    .form-actions .btn-cancel {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        font-size: 0.85rem;
    }
    
    .form-actions .btn-save svg,
    .form-actions .btn-cancel svg {
        width: 14px;
        height: 14px;
    }
    
    .form-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
    }
    
    @media (max-width: 900px) {
        .form-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 600px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .form-group {
        margin-bottom: 0;
        min-width: 0;  /* Prevent content from expanding grid cell */
    }
    
    /* Full-width form group - spans all grid columns */
    /* What: Makes certain form groups span the entire form width */
    /* Why: Reference prices display needs more space and should be at the bottom */
    /* How: grid-column: 1 / -1 spans from first to last column */
    .form-group.form-group-full-width {
        grid-column: 1 / -1;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
        font-size: 0.9rem;
    }
    
    .form-group input,
    .form-group select {
        width: 100%;
        padding: 12px 14px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.2s ease;
        background: white;
    }
    
    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
    }
    
    .form-group input:disabled {
        background: #f8f9fa;
        cursor: not-allowed;
    }
    
    /* Suggestions Dropdown */
    .suggestions-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: none;
    }
    
    .suggestion-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }
    
    .suggestion-item:last-child {
        border-bottom: none;
    }
    
    .suggestion-item:hover,
    .suggestion-item.selected {
        background-color: #007bff;
        color: white;
    }
    
    #item-name-group {
        position: relative;
    }
    
    .form-group.toggle-group {
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
    }
    
    .form-group.toggle-group .toggle-container {
        height: 46px;
        display: flex;
        align-items: center;
    }
    
    /* Toggle Switch */
    .toggle-container {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .toggle-switch {
        position: relative;
        width: 50px;
        height: 26px;
        flex-shrink: 0;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.3s;
        border-radius: 26px;
    }
    
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    input:checked + .toggle-slider:before {
        transform: translateX(24px);
    }
    
    .toggle-label {
        font-weight: 500;
        color: #333;
    }
    
    /* Groups */
    .groups-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .group-pill {
        display: inline-flex;
        align-items: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .no-groups {
        color: #6c757d;
        font-style: italic;
    }
    
    /* Group Controls in header */
    .group-controls {
        display: flex;
        gap: 8px;
        margin-left: auto;
    }
    
    .group-edit-mode .group-controls .btn-edit {
        display: none;
    }
    
    .group-edit-mode .groups-display {
        display: none;
    }
    
    .group-edit-mode .groups-edit-mode {
        display: block !important;
    }
    
    /* Group pills list for editing */
    .group-pills-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        min-height: 40px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 2px solid #e9ecef;
    }
    
    .group-pills-list .group-pill {
        background: #212529;
        color: white;
        border: 2px solid #fff;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
    }
    
    .group-pills-list .group-pill:hover {
        background: #343a40;
        border-color: #adb5bd;
    }
    
    .group-pills-list .group-pill.selected {
        background: #fd7e14;
        border-color: #fd7e14;
        color: white;
    }
    
    .group-pills-list .group-pill.selected:hover {
        background: #e96b02;
        border-color: #e96b02;
    }
    
    .group-pills-list .no-groups-msg {
        color: #6c757d;
        font-style: italic;
        padding: 4px;
    }
    
    /* =============================================================================
       FORM HINT STYLES
       What: Small help text displayed below form inputs
       Why: Provides guidance to users about what each field does
       How: Subtle gray text with small font size
    ============================================================================= */
    .form-hint {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 4px;
    }
    }

    /* =============================================================================
       THRESHOLD ALERT SPECIFIC STYLES
       What: Styles for threshold alert editing UI elements
       Why: Threshold alerts have unique UI components (type selector, reference prices display)
       How: Custom styles for the threshold-specific form fields
    ============================================================================= */
    
    /* Threshold type dropdown wrapper for tooltip positioning */
    .threshold-type-wrapper {
        position: relative;
        display: inline-block;
        width: 100%;
    }
    
    .threshold-type-wrapper select {
        width: 100%;
    }
    
    /* =========================================================================
       LOCKED FIELD INDICATOR STYLES
       What: Styles for the locked indicator icon and tooltip
       Why: Provides visual feedback when a dropdown is locked and explains why
       How: Icon appears inline with label; tooltip appears on click
       ========================================================================= */
    
    /* Locked indicator icon - appears next to label when field is locked */
    /* What: A no-entry symbol (ðŸš«) that indicates the field cannot be changed */
    /* Why: Users need visual feedback that the field is intentionally locked */
    /* How: Displayed inline with the label, with hover effect to indicate clickability */
    .locked-indicator {
        margin-left: 8px;
        cursor: pointer;
        font-size: 14px;
        opacity: 0.8;
        transition: opacity 0.15s, transform 0.15s;
        display: inline-block;
        vertical-align: middle;
    }
    
    /* Hover state for locked indicator - makes it clear it's clickable */
    .locked-indicator:hover {
        opacity: 1;
        transform: scale(1.15);
    }
    
    /* Tooltip container - explains why the field is locked */
    /* What: A popup box with explanation text */
    /* Why: Users need to understand why they can't change the threshold type */
    /* How: Positioned 15px below the locked indicator icon, styled as an info box */
    .locked-tooltip {
        position: absolute;
        top: 30px;  /* Position 15px below the label line (label ~15px + 15px gap) */
        left: 0;
        right: 0;
        padding: 12px 16px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 100;
        font-size: 13px;
        line-height: 1.5;
        color: var(--text);
    }
    
    /* Tooltip paragraph spacing */
    .locked-tooltip p {
        margin: 0 0 8px 0;
    }
    
    /* Remove bottom margin from last paragraph */
    .locked-tooltip p:last-of-type {
        margin-bottom: 0;
    }
    
    /* Close button for the tooltip */
    /* What: X button in top-right corner to dismiss the tooltip */
    /* Why: Users need a way to close the tooltip after reading */
    /* How: Positioned absolutely, styled as a subtle close button */
    .locked-tooltip-close {
        position: absolute;
        top: 8px;
        right: 12px;
        cursor: pointer;
        font-size: 18px;
        color: var(--muted);
        line-height: 1;
        transition: color 0.15s;
    }
    
    .locked-tooltip-close:hover {
        color: var(--text);
    }
    
    /* Disabled/locked select styling */
    /* What: Red background for disabled dropdown to indicate it's locked */
    /* Why: Provides strong visual feedback that the field cannot be changed */
    /* How: Targets disabled select elements with a light red background */
    select:disabled {
        background-color: rgba(239, 68, 68, 0.15);  /* Light red background */
        border-color: rgba(239, 68, 68, 0.4);       /* Red-tinted border */
        cursor: not-allowed;
    }
    
    /* Reference prices display (non-editable) */
    /* What: Container for displaying baseline reference prices */
    /* Why: Users need to see what prices their threshold is compared against */
    /* How: Styled as a read-only info box with item list */
    .reference-prices-display {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 8px;
        max-height: 200px;
        overflow-y: auto;
        font-size: 0.9rem;
    }
    
    .reference-prices-display .no-data {
        color: #6c757d;
        font-style: italic;
    }
    
    .reference-prices-display .reference-price-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 12px;
        border-radius: 4px;
    }
    
    /* Zebra striping for edit mode reference prices */
    /* What: Alternating row colors for better readability */
    /* Why: Makes it easier to scan long lists of items and prices */
    /* How: nth-child selectors with subtle color alternation */
    .reference-prices-display .reference-price-item:nth-child(odd) {
        background: #ffffff;
    }
    
    .reference-prices-display .reference-price-item:nth-child(even) {
        background: #eef2ff;  /* Light purple/blue tint to match site theme */
    }
    
    .reference-prices-display .item-name {
        color: #495057;
        font-weight: 500;
    }
    
    .reference-prices-display .item-price {
        color: #28a745;
        font-weight: 600;
    }
    
    /* Unlink button */
    .btn-unlink {
        background: #ffc107;
        color: #212529;
        border: none;
        padding: 6px 14px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .btn-unlink:hover {
        background: #e0a800;
    }
    
    .btn-unlink svg {
        width: 14px;
        height: 14px;
    }
    
    .group-subsection {
        margin-top: 20px;
    }
    
    .groups-edit-mode .form-actions {
        justify-content: flex-end;
    }
    
    .groups-edit-mode .form-actions .btn-unlink {
        margin-right: auto;
    }
    
    .groups-edit-mode .form-actions .btn-delete {
        margin-right: 0;
    }
    
    .groups-edit-mode .form-actions .btn-save,
    .groups-edit-mode .form-actions .btn-cancel,
    .groups-edit-mode .form-actions .btn-delete,
    .groups-edit-mode .form-actions .btn-unlink {
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    
    /* Note: Group selector and new group modal styles are in static/css/group-selector.css */
    
    /* Price Card */
    .price-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: none;
    }
    
    .price-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        text-align: center;
    }
    
    .price-item {
        padding: 15px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .price-item .detail-label {
        margin-bottom: 8px;
    }
    
    .price-item .detail-value {
        font-size: 1.4rem;
    }
    
    /* Triggered Data Section */
    .triggered-card {
        /* No special border */
    }
    
    .triggered-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .triggered-info-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
    }
    
    .triggered-items-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        background: #f8f9fa;
        padding: 4px;
    }
    
    .triggered-items-list ul {
        list-style: none;
        margin: 0;
        padding: 0;
    }
    
    .triggered-items-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        border-radius: 4px;
    }
    
    /* Zebra striping for triggered items list */
    /* What: Alternating row colors for better readability */
    /* Why: Makes it easier to scan long lists of triggered items */
    /* How: nth-child selectors with subtle color alternation */
    .triggered-items-list li:nth-child(odd) {
        background: #ffffff;
    }
    
    .triggered-items-list li:nth-child(even) {
        background: #eef2ff;  /* Light purple/blue tint to match site theme */
    }
    
    .triggered-items-list li:hover {
        background: #e2e8f0;  /* Slightly darker on hover */
    }
    
    .triggered-item-name {
        font-weight: 600;
        color: #333;
    }
    
    .triggered-item-details {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 4px;
    }
    
    .triggered-item-percentage {
        font-weight: 700;
        color: #28a745;
        font-size: 1.1rem;
    }
    
    .triggered-item-percentage.negative-change {
        color: #dc3545;
    }
    
    .no-triggered-data {
        padding: 20px;
        text-align: center;
        color: #6c757d;
        font-style: italic;
    }
    
    /* =========================================================================
       COLLECTIVE MOVE TRIGGERED DATA STYLES
       What: Styles for collective move alert triggered data display
       Why: Users need to see average change prominently, then detailed item table
       How: Large average change at top, then full-width sortable table below
    ========================================================================= */
    
    /* Highlight the average change value - make it prominent */
    .collective-average-highlight {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 8px;
        padding: 15px !important;
    }
    
    .collective-average-highlight .detail-value.large {
        font-size: 1.5rem;
        font-weight: 700;
    }
    
    /* Table section container - spans full width */
    .collective-items-table-section {
        grid-column: 1 / -1;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e9ecef;
    }
    
    /* Table header */
    .collective-table-header {
        font-size: 1rem;
        font-weight: 600;
        color: #343a40;
        margin: 0 0 12px 0;
    }
    
    /* Table wrapper for horizontal scrolling on mobile */
    .collective-items-table-wrapper {
        overflow-x: auto;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background: #fff;
    }
    
    /* The actual table */
    .collective-items-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }
    
    .collective-items-table thead {
        background: #f8f9fa;
        position: sticky;
        top: 0;
    }
    
    .collective-items-table th {
        padding: 12px 15px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
    }
    
    .collective-items-table th.num-col {
        text-align: right;
    }
    
    .collective-items-table td {
        padding: 10px 15px;
        border-bottom: 1px solid #f0f0f0;
        color: #495057;
    }
    
    .collective-items-table td.num-col {
        text-align: right;
        font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    }
    
    .collective-items-table td.item-name-cell {
        font-weight: 500;
    }
    
    .collective-items-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    .collective-items-table tbody tr:hover {
        background: #f8f9fa;
    }
    
    /* Positive/negative coloring for change column */
    .collective-items-table td.positive {
        color: #28a745;
        font-weight: 600;
    }
    
    .collective-items-table td.negative {
        color: #dc3545;
        font-weight: 600;
    }
    
    /* Note below table */
    .collective-items-note {
        margin-top: 10px;
        font-size: 0.85rem;
        color: #6c757d;
        font-style: italic;
        text-align: center;
    }
    
    /* Max height with scroll for large tables */
    .collective-items-table-wrapper {
        max-height: 400px;
        overflow-y: auto;
    }
    
    /* Timestamps */
    .timestamp-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
    }
    
    .timestamp-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .alert-header {
            padding: 20px;
        }
        
        .alert-title {
            font-size: 1.4rem;
        }
        
        .alert-header-top {
            flex-direction: column;
            gap: 15px;
        }
        
        .price-grid {
            grid-template-columns: 1fr;
        }
        
        .detail-card-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }
        
        .edit-controls {
            margin-left: 0;
            justify-content: flex-start;
        }
        
        .group-controls {
            margin-left: 0;
            justify-content: flex-start;
        }
        
        .form-actions {
            justify-content: flex-start !important;
        }
        
        .groups-edit-mode .form-actions {
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .groups-edit-mode .form-actions .btn-unlink {
            margin-right: 0;
            order: 1;
        }
        
        .groups-edit-mode .form-actions .btn-delete {
            order: 2;
        }
        
        .groups-edit-mode .form-actions::after {
            content: "";
            flex-basis: 100%;
            order: 2;
        }
        
        .groups-edit-mode .form-actions .btn-save {
            order: 3;
            flex-basis: auto;
        }
        
        .groups-edit-mode .form-actions .btn-cancel {
            order: 4;
        }
    }
    
    /* =========================================================================
       MULTI-ITEM SELECTOR STYLES
       What: Styles for the multi-item selector with dropdown arrow design
       Why: Clean UI for selecting/removing multiple items in spread alerts
       ========================================================================= */
    
    /* Main container box - input + dropdown arrow button */
    .multi-item-selector-box {
        position: relative;
        display: flex;
        align-items: stretch;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        background: white;
        overflow: visible;
        width: 100%;  /* Fill available space in form-group */
        min-width: 0;  /* Allow shrinking within grid */
    }
    
    .multi-item-selector-box:focus-within {
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    
    /* Search input inside the box */
    .multi-item-selector-box input[type="text"] {
        flex: 1;
        border: none;
        outline: none;
        padding: 10px 12px;
        font-size: 0.95rem;
        border-radius: 6px 0 0 6px;
        min-width: 0;
    }
    
    .multi-item-selector-box input[type="text"]::placeholder {
        color: #9ca3af;
    }
    
    /* Dropdown toggle button with arrow */
    .multi-item-dropdown-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        border: none;
        border-left: 1px solid #d1d5db;
        background: #f9fafb;
        cursor: pointer;
        transition: background-color 0.15s ease;
        border-radius: 0 6px 6px 0;
    }
    
    .multi-item-dropdown-toggle:hover {
        background: #f3f4f6;
    }
    
    .multi-item-dropdown-toggle.active {
        background: #a7f3d0;
    }
    
    .multi-item-dropdown-toggle svg {
        width: 20px;
        height: 20px;
        color: #6b7280;
        transition: transform 0.2s ease;
    }
    
    .multi-item-dropdown-toggle.active svg {
        transform: rotate(180deg);
        color: #047857;
    }
    
    /* Autocomplete suggestions dropdown (shown when typing) */
    .multi-item-suggestions-dropdown {
        display: none;
        position: absolute;
        top: calc(100% + 5px);  /* 5px margin between dropdown and input box */
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 6px;  /* Full border radius since there's a gap now */
        max-height: 200px;
        overflow-y: auto;
        z-index: 1001;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .multi-item-suggestions-dropdown .suggestion-item {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
    }
    
    /* What: Highlight styling for autocomplete suggestion items */
    /* Why: User needs visual feedback when hovering/selecting items */
    /* How: Light green background with explicit black text for readability */
    .multi-item-suggestions-dropdown .suggestion-item:hover,
    .multi-item-suggestions-dropdown .suggestion-item.selected {
        background: #f0fdf4;
        color: #000000;  /* Ensure text stays black and readable on green background */
    }
    
    .multi-item-suggestions-dropdown .suggestion-item:last-child {
        border-bottom: none;
    }
    
    /* Selected items dropdown (shown when clicking arrow) */
    .multi-item-selected-dropdown {
        display: none;
        position: absolute;
        top: calc(100% + 5px);  /* 5px margin between dropdown and search box */
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 6px;  /* Full border radius since there's a gap now */
        max-height: 150px;  /* Restricted height to prevent overflow beyond card */
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .multi-item-selected-dropdown.show {
        display: block;
    }
    
    /* Individual selected item row */
    .selected-item-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .selected-item-row:last-child {
        border-bottom: none;
    }
    
    .selected-item-row .item-name {
        flex: 1;
        font-size: 0.95rem;
        color: #374151;
    }
    
    /* Red X remove button */
    .selected-item-row .remove-item-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        cursor: pointer;
        color: #ef4444;
        font-size: 1.4rem;
        font-weight: bold;
        line-height: 1;
        padding: 0;
        transition: color 0.15s ease, transform 0.15s ease;
    }
    
    .selected-item-row .remove-item-btn:hover {
        color: #dc2626;
        transform: scale(1.1);
    }
    
    /* No items message */
    .no-items-message {
        display: none;
        padding: 16px 12px;
        text-align: center;
        color: #9ca3af;
        font-style: italic;
    }
    
    .no-items-message.show {
        display: block;
    }
    
    /* =========================================================================
       ITEM NOTIFICATION STYLES
       What: Small inline notifications for item add/remove feedback
       Why: Provides immediate visual feedback without disruptive popups
       ========================================================================= */
    
    /* Container for label + notification */
    /* =============================================================================
       LABEL WITH NOTIFICATION
       What: Container for label and inline notification
       Why: Notification should not affect layout width
       How: Position notification absolutely so it overlays without shifting elements
    ============================================================================= */
    .label-with-notification {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 5px;  /* 5px margin between notification row and input box */
        position: relative;  /* Needed for absolute positioning of notification */
    }
    
    /* Small inline notification shown next to "Items" label */
    /* What: Notification badge for item add/remove feedback */
    /* Why: Should not cause layout shift when appearing/disappearing */
    /* How: Absolutely positioned, truncated with ellipsis if too long */
    .item-notification {
        font-size: 0.8rem;
        padding: 3px 8px;
        border-radius: 4px;
        opacity: 0;
        transition: opacity 0.3s ease;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: calc(100% - 60px);  /* Leave room for label */
        position: absolute;
        left: 50px;  /* Position after "Items" label */
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;  /* Don't interfere with clicks */
    }
    
    .item-notification.show {
        opacity: 1;
    }
    
    /* Success notification (green) - item added successfully */
    .item-notification.success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
    }
    
    /* Error notification (red) - item not found */
    .item-notification.error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }
    
    /* =============================================================================
       ERROR MODAL STYLES
       What: Styles for the error modal dialog
       Why: Provides a nicer alternative to browser alert() dialogs
       How: Fixed overlay with centered content box, animation on show
    ============================================================================= */
    .error-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
    }
    
    .error-modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    
    .error-modal-content {
        background: white;
        border-radius: 12px;
        width: 100%;
        max-width: 420px;
        margin: 20px;
        transform: scale(0.95);
        transition: transform 0.2s ease;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .error-modal-overlay.active .error-modal-content {
        transform: scale(1);
    }
    
    .error-modal-header {
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .error-modal-header .error-icon {
        width: 28px;
        height: 28px;
        color: #dc3545;
    }
    
    .error-modal-header h3 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin: 0;
    }
    
    .error-modal-body {
        padding: 20px;
        color: #555;
        line-height: 1.6;
    }
    
    .error-modal-footer {
        padding: 16px 20px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
    }
    
    .error-modal-btn {
        padding: 10px 24px;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .error-modal-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    /* =============================================================================
       CONFIRM MODAL STYLES
       What: Styles for the reusable confirmation modal dialog
       Why: Provides a nicely styled alternative to browser confirm() dialogs,
            matching the look and feel of the existing error and new-group modals.
            Designed to be reusable for any action that requires user confirmation
            (e.g., unlinking groups, deleting alerts, deleting groups).
       How: Fixed overlay with centered content box, show/hide via the 'active' class,
            scale animation on open, Cancel and Confirm buttons in the footer.
    ============================================================================= */

    /* confirm-modal-overlay: Full-screen semi-transparent backdrop that covers the
       entire page when the confirmation modal is visible. Centers the modal content
       using flexbox. Hidden by default via opacity/visibility, toggled via .active. */
    .confirm-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
    }

    /* confirm-modal-overlay.active: Makes the overlay visible with a smooth fade-in.
       Paired with the scale transition on .confirm-modal-content to create a 
       polished open animation. */
    .confirm-modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    /* confirm-modal-content: The white card that holds the modal header, body, and
       footer. Starts slightly scaled down (0.95) and scales to 1 when .active is
       added to the overlay, creating a subtle "pop in" effect. */
    .confirm-modal-content {
        background: white;
        border-radius: 12px;
        width: 100%;
        max-width: 420px;
        margin: 20px;
        transform: scale(0.95);
        transition: transform 0.2s ease;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .confirm-modal-overlay.active .confirm-modal-content {
        transform: scale(1);
    }

    /* confirm-modal-header: Top section of the modal containing the warning icon
       and title text. Bottom border separates it from the body. */
    .confirm-modal-header {
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    /* confirm-modal-header .confirm-icon: Warning/caution SVG icon displayed next
       to the title. Uses an amber/orange color to indicate a cautionary action. */
    .confirm-modal-header .confirm-icon {
        width: 28px;
        height: 28px;
        color: #f59e0b;
    }

    /* confirm-modal-header h3: Title text for the confirmation modal (e.g.,
       "Unlink Groups"). Styled consistently with the error modal title. */
    .confirm-modal-header h3 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin: 0;
    }

    /* confirm-modal-body: Middle section containing the descriptive message that
       explains what the user is about to confirm. */
    .confirm-modal-body {
        padding: 20px;
        color: #555;
        line-height: 1.6;
    }

    /* confirm-modal-footer: Bottom section containing the Cancel and Confirm action
       buttons. Uses flexbox to right-align the buttons with a gap between them. */
    .confirm-modal-footer {
        padding: 16px 20px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    /* confirm-modal-btn: Base styles shared by both Cancel and Confirm buttons.
       Provides consistent padding, border-radius, font, and cursor. */
    .confirm-modal-btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        font-size: 0.9rem;
    }

    /* confirm-modal-btn.cancel: The Cancel button uses a light gray background
       with dark text, allowing the user to back out without taking action. */
    .confirm-modal-btn.cancel {
        background: #f8f9fa;
        color: #495057;
        border: 1px solid #dee2e6;
    }

    /* confirm-modal-btn.cancel:hover: Slightly darker background on hover to
       indicate interactivity. */
    .confirm-modal-btn.cancel:hover {
        background: #e9ecef;
    }

    /* confirm-modal-btn.confirm: The primary action button uses a gradient matching
       the site's accent colors, drawing the user's attention to the confirm action. */
    .confirm-modal-btn.confirm {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    /* confirm-modal-btn.confirm:hover: Elevates the button slightly and adds a
       colored shadow on hover for a polished interactive feel. */
    .confirm-modal-btn.confirm:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    /* =============================================================================
       DELETE ALERT MODAL STYLES
       What: Styles for the delete alert confirmation modal dialog
       Why: Replaces the browser confirm() dialog for deleting an alert with a styled
            modal that matches the deletion modals used across the application (e.g.,
            item_detail.html, favorites.html). Uses a centered layout with a red
            trash can icon to clearly communicate the destructive nature of the action.
       How: Uses display:none / display:flex toggled via the .show class. The modal
            content is centered on screen with a semi-transparent backdrop. The red
            color scheme (icon background, delete button) follows the established
            deletion modal pattern from other pages.
    ============================================================================= */

    /* delete-alert-modal-overlay: Full-screen backdrop that covers the entire page.
       Hidden by default (display:none), shown via the .show class. Uses flexbox
       to center the modal content vertically and horizontally. */
    .delete-alert-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        align-items: center;
        justify-content: center;
    }

    /* delete-alert-modal-overlay.show: Makes the overlay visible by switching
       from display:none to display:flex, instantly centering the content. */
    .delete-alert-modal-overlay.show {
        display: flex;
    }

    /* delete-alert-modal-content: The white card containing the icon, title,
       message, and action buttons. Centered text layout with rounded corners
       and a prominent shadow to elevate it above the backdrop. */
    .delete-alert-modal-content {
        background: white;
        border-radius: 12px;
        padding: 24px;
        width: 90%;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    /* delete-alert-modal-icon: Circular container for the trash can SVG icon.
       Uses a light red background to visually reinforce the destructive nature
       of the delete action, matching the pattern in item_detail.html. */
    .delete-alert-modal-icon {
        width: 48px;
        height: 48px;
        background: rgba(220, 38, 38, 0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
    }

    /* delete-alert-modal-icon svg: The trash can icon itself, sized and colored
       in red to match the danger/delete visual language. */
    .delete-alert-modal-icon svg {
        width: 24px;
        height: 24px;
        color: #DC2626;
    }

    /* delete-alert-modal-title: Bold heading that states the action being
       confirmed (e.g., "Delete this alert?"). */
    .delete-alert-modal-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #374151;
        margin: 0 0 8px 0;
    }

    /* delete-alert-modal-message: Descriptive text beneath the title that warns
       the user about the consequences of deleting (e.g., "This action cannot
       be undone."). Uses a muted color to differentiate from the title. */
    .delete-alert-modal-message {
        color: #6B7280;
        font-size: 0.9rem;
        margin: 0 0 20px 0;
    }

    /* delete-alert-modal-buttons: Flex container for the Cancel and Delete
       buttons, arranged side by side with a gap between them. */
    .delete-alert-modal-buttons {
        display: flex;
        gap: 12px;
    }

    /* delete-alert-modal-btn: Base button styles shared by both Cancel and
       Delete buttons. Each button takes equal width (flex:1) for a balanced
       layout. Uses a subtle border and smooth hover transition. */
    .delete-alert-modal-btn {
        flex: 1;
        padding: 10px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s;
        border: 1px solid #E5E7EB;
    }

    /* delete-alert-modal-btn.cancel: The Cancel button uses a white background
       with dark text, allowing the user to dismiss without taking action. */
    .delete-alert-modal-btn.cancel {
        background: white;
        color: #374151;
    }

    /* delete-alert-modal-btn.cancel:hover: Slightly darker background on
       hover to indicate interactivity. */
    .delete-alert-modal-btn.cancel:hover {
        background: #F5F6F8;
    }

    /* delete-alert-modal-btn.delete: The Delete button uses a solid red
       background to clearly communicate the destructive action. The border
       color matches the background for a clean look. */
    .delete-alert-modal-btn.delete {
        background: #DC2626;
        color: white;
        border-color: #DC2626;
    }

    /* delete-alert-modal-btn.delete:hover: Darker red on hover to indicate
       interactivity, consistent with the deletion modals on other pages. */
    .delete-alert-modal-btn.delete:hover {
        background: #B91C1C;
        border-color: #B91C1C;
    }

    /* =============================================================================
       ERROR NOTIFICATION STYLES
       ============================================================================= */
    /* What: Styles for inline error notification banners shown at the top of the page
       Why: Provides visual feedback when form validation fails (e.g., missing min/max price)
       How: Fixed-position red notification with dismiss button and fade-out animation */
    
    /* error-notification-container: Container for error notification banners
       positioned at the top of the content area */
    .error-notification-container {
        margin-bottom: 20px;
    }
    
    /* error-notification: The red notification banner itself
       Styled to match the triggered-notification pattern from alerts.html */
    .error-notification {
        background: linear-gradient(135deg, #ff4757 0%, #ff6b81 100%);
        border-radius: 12px;
        padding: 15px 45px 15px 20px;
        color: white;
        font-weight: 500;
        box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3);
        position: relative;
        margin-bottom: 10px;
        animation: slideInDown 0.3s ease-out;
    }
    
    /* dismiss-btn: X button to manually close the notification */
    .error-notification .dismiss-btn {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 26px;
        height: 26px;
        border-radius: 50%;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s ease;
        line-height: 1;
    }
    
    .error-notification .dismiss-btn:hover {
        background: rgba(255, 255, 255, 0.35);
    }
    
    /* dismissing: Class added when notification is being dismissed
       Triggers the fade-out animation */
    .error-notification.dismissing {
        animation: slideOutUp 0.3s ease-out forwards;
    }
    
    /* slideInDown: Animation for notification appearing */
    @keyframes slideInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* slideOutUp: Animation for notification being dismissed */
    @keyframes slideOutUp {
        from {
            opacity: 1;
            transform: translateY(0);
        }
        to {
            opacity: 0;
            transform: translateY(-20px);
        }
    }

    /* ==========================================================================
       CONFIDENCE WEIGHTS TOGGLE BUTTON & PANELS
       ==========================================================================
       What: Styles for the "Scoring Weights" toggle button and the collapsible
             panels used in both VIEW and EDIT modes on the alert detail page
       Why: Keeps the weights section compact and hidden by default, since most
            users don't need to see/edit them
       How: A styled button triggers JS toggle; panels use flex grid for layout
    ========================================================================== */

    /* btn-weights-toggle: The toggle button that shows/hides the weights panel
       What: Compact button with a gear icon and "Scoring Weights" label
       Why: Consistent with the "Advanced Scoring Weights" button on the create form
       How: Styled as a subtle outlined button with hover state */
    /* btn-weights-toggle: Button to show/hide scoring weight fields
       What: Styled identically to the "Create Alert" button on the alerts page
       Why: Consistent visual language across the app for action buttons
       How: Uses the same gradient (tealâ†’green), border-radius, font styling,
            and hover effects as .btn-create-alert in alerts-form.css.
            Horizontal padding reduced to keep the button compact. */
    .btn-weights-toggle {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        border: none;
        padding: 12px 14px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 15px;
        font-weight: 600;
        transition: all 0.15s;
    }
    .btn-weights-toggle:hover {
        background: linear-gradient(135deg, #0e8377 0%, #2dd36f 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(17, 153, 142, 0.3);
    }



    /* weights-panel: View-mode container for weight values
       What: A padded box showing the 5 weights in a row
       How: Uses the weights-grid child for flex layout */
    .weights-panel {
        padding: 8px 0;
    }

    /* weights-grid / edit-weights-grid: Flex row of weight items
       What: Lays out 5 weight items side-by-side with wrapping
       Why: Compact display that fits all 5 on one line on desktop
       How: display:flex with wrap and gap */
    .weights-grid,
    .edit-weights-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 8px 16px;
    }

    /* weight-item: A single weight label+value pair in view mode
       What: Shows "Trend: 0.35" in a compact cell
       How: Fixed width so they line up in a row */
    .weight-item {
        display: flex;
        flex-direction: column;
        min-width: 80px;
    }
    .weight-item .detail-label {
        font-size: 11px;
        margin-bottom: 2px;
        color: #1cb154;
        background-color: #eef2ef;

    }
    .weight-item .detail-value {
        font-size: 14px;
        font-weight: 600;
    }

    /* edit-weight-field: A single weight input in edit mode
       What: Narrow form-group for number inputs (0.00-1.00)
       Why: Keeps all 5 on one row like the create form (140px each)
       How: Fixed width with no bottom margin (parent gap handles spacing) */
    .edit-weight-field {
        width: 110px;
        flex-shrink: 0;
        margin-bottom: 0 !important;
    }
    .edit-weight-field label {
        font-size: 12px !important;
        margin-bottom: 3px !important;
        color: #166534;
    }
    .edit-weight-field input {
        padding: 6px 8px !important;
        font-size: 13px !important;
    }

    /* Reuse the same weight-sum color classes from alerts-form.css */
    .weight-sum-valid { color: #22c55e; }
    .weight-sum-invalid { color: #ef4444; }
    .weight-sum-empty { color: var(--muted); }

    /* ==========================================================================
       edit-dump-advanced-grid / edit-dump-advanced-field
       ==========================================================================
       What: Flex grid layout for the dump advanced detection settings panel.
       Why:  Mirrors the edit-weights-grid pattern â€” compact, left-aligned,
             contained to the left side of the form. 2 inputs per row (each
             ~160px) keeps it small and unobtrusive, matching the scoring
             weights look for confidence alerts.
       How:  display:flex with wrap. Each child has fixed width of 160px.
             Labels and inputs are sized down to match edit-weight-field styling.
       ========================================================================== */
    .edit-dump-advanced-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 8px 16px;
    }

    /* edit-dump-advanced-field: A single advanced dump input in edit mode
       What: Narrow form-group for dump advanced number inputs
       Why:  Keeps fields compact â€” two per row at 160px each, left-aligned
       How:  Fixed width with no bottom margin (parent gap handles spacing) */
    .edit-dump-advanced-field {
        width: 160px;
        flex-shrink: 0;
        margin-bottom: 0 !important;
    }
    .edit-dump-advanced-field label {
        font-size: 12px !important;
        margin-bottom: 3px !important;
        color: #166534;
    }
    .edit-dump-advanced-field input {
        padding: 6px 8px !important;
        font-size: 13px !important;
    }
    .edit-dump-advanced-field .form-hint {
        font-size: 10px !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="alert-detail-container">
    <a href="{% url 'alerts' %}" class="back-link">
        <svg fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
        </svg>
        Back to Alerts
    </a>
    
    <!-- =============================================================================
         ERROR NOTIFICATION CONTAINER
         ============================================================================= -->
    <!-- What: Container for displaying validation error notifications at the top of the page
         Why: When form validation fails (e.g., missing min/max price for All Items),
              we need a visible area to show the red error notification
         How: Empty div that gets populated by showValidationError() JavaScript function -->
    <div id="error-notification-container" class="error-notification-container"></div>
    
    <!-- Header Card -->
    <div class="alert-header" id="alertHeader">
        <div class="alert-header-top">
            <div class="alert-type-badge" id="typeBadge">
                {# NOTE: Above/Below Threshold alerts were removed; this badge only handles supported types. #}
                {% if alert.type == 'spread' %}
                    <svg fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"/><path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd"/></svg>
                    Spread Alert
                {% elif alert.type == 'spike' %}
                    <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"/></svg>
                    Spike Alert
                {% elif alert.type == 'sustained' %}
                    <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 3a1 1 0 011 1v11.586l3.293-3.293a1 1 0 011.414 1.414l-5 5A1 1 0 014 19H3a1 1 0 110-2h1V4a1 1 0 011-1zm7.293 2.293a1 1 0 011.414 0L16 8.586V6a1 1 0 112 0v5a1 1 0 01-1 1h-5a1 1 0 110-2h2.586l-3.293-3.293a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                    Sustained Move
                {% elif alert.type == 'threshold' %}
                    <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zM8.5 5.5a1 1 0 112 0v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3h-3a1 1 0 110-2h3v-3z" clip-rule="evenodd"/></svg>
                    Threshold
                {% elif alert.type == 'flip_confidence' %}
                    {# What: Badge icon and label for flip confidence alerts #}
                    {# Why: Users need a visual indicator of the alert type at a glance #}
                    {# How: Uses a chart/analytics-style SVG icon to represent confidence scoring #}
                    <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 0l-2 2a1 1 0 101.414 1.414L8 10.414l1.293 1.293a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                    Flip Confidence
                {% else %}
                    {{ alert.type|title }}
                {% endif %}
            </div>
            <div class="alert-status">
                {% if alert.is_active %}
                    <span class="status-pill status-active">Active</span>
                {% else %}
                    <span class="status-pill status-inactive">Inactive</span>
                {% endif %}
                {% if alert.is_triggered %}
                    <span class="status-pill status-triggered">Triggered</span>
                {% else %}
                    <span class="status-pill status-not-triggered">Not Triggered</span>
                {% endif %}
            </div>
        </div>
        <h1 class="alert-title" id="alertTitle">{% if alert.alert_name and alert.alert_name != 'Default' %}{{ alert.alert_name }}{% else %}{{ alert }}{% endif %}</h1>
    </div>
    
    <!-- Status Notification Container -->
    <div id="status-notifications">
        {% if edit_saved %}
        <div class="status-notification">
            Changes saved
            <button class="dismiss-btn" onclick="dismissStatusNotification(this)">&times;</button>
        </div>
        {% endif %}
    </div>
    
    <!-- Alert Configuration -->
    <div class="detail-card" id="configCard">
        <div class="detail-card-header">
            <h3>
                <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/></svg>
                Alert Configuration
            </h3>
            <div class="edit-controls" id="editControls">
                <!-- What: Toggle between compact (inline) and expanded (stacked) detail views
                     Why: Compact shows label+value on one line for density; expanded stacks them
                     How: Toggles .compact-view class on .detail-grid which controls display:flex
                          on .detail-item and pill-style padding on .detail-label -->
                <button class="btn-compact-toggle" onclick="toggleCompactView()" id="compact-toggle-btn">
                    <!-- SVG: horizontal bars icon representing a list/layout toggle -->
                    <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/></svg>
                    <span id="compact-toggle-label">Expanded</span>
                </button>
                <button class="btn-edit" onclick="enterEditMode()">
                    <svg fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/></svg>
                    Edit
                </button>
                <button class="btn-delete" onclick="deleteAlert()">
                    <svg fill="currentColor" id="alert-delete-btn" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
                    Delete
                </button>
            </div>
        </div>
        <div class="detail-card-body">
            <!-- Display Content (shown when not editing) -->
            <div class="display-content">
                <div class="detail-grid">
                    <div class="detail-item">
                        <span class="detail-label">Active</span>
                        <span class="detail-value {% if alert.is_active %}positive{% else %}muted{% endif %}">{% if alert.is_active %}Yes{% else %}No{% endif %}</span>
                    </div>
                    
                    <div class="detail-item">
                        <span class="detail-label">Alert Type</span>
                        <span class="detail-value">
                            {# NOTE: Above/Below Threshold alerts were removed. #}
                            {% if alert.type == 'spread' %}Spread
                            {% elif alert.type == 'spike' %}Spike
                            {% elif alert.type == 'threshold' %}Threshold
                            {% elif alert.type == 'sustained' %}Sustained Move
                            {% elif alert.type == 'flip_confidence' %}Flip Confidence
                            {% else %}{{ alert.type|title }}{% endif %}
                        </span>
                    </div>
                    
                    {% if alert.type == 'spread' or alert.type == 'spike' or alert.type == 'threshold' or alert.type == 'sustained' or alert.type == 'flip_confidence' or alert.type == 'dump' %}
                    <div class="detail-item">
                        <span class="detail-label">All Items</span>
                        <span class="detail-value">{% if alert.is_all_items %}Yes{% else %}No{% endif %}</span>
                    </div>
                    {% endif %}
                    
                    <!-- Item display - handles single item, multi-item, and all-items modes -->
                    <!-- What: Shows which item(s) the alert monitors -->
                    <!-- Why: User needs to see what the alert is tracking -->
                    <!-- How: Check is_all_items first, then item_ids for multi-item, then single item_name -->
                    {% if not alert.is_all_items %}
                        {% if alert.item_ids %}
                        <!-- Multi-item alert - display count and list -->
                        <div class="detail-item">
                            <span class="detail-label">Items</span>
                            <span class="detail-value">{{ item_ids_data|length }} item{{ item_ids_data|length|pluralize }}</span>
                        </div>
                        {% else %}
                        <!-- Single item alert -->
                        <div class="detail-item">
                            <span class="detail-label">Item</span>
                            <span class="detail-value">{{ alert.item_name|default:"Not Set" }}</span>
                        </div>
                        {% endif %}
                    {% endif %}
                    
                    
                    {% if alert.type == 'spread' or alert.type == 'spike' %}
                    <div class="detail-item">
                        <span class="detail-label">Percentage</span>
                        <span class="detail-value highlight">{% if alert.percentage %}{{ alert.percentage }}%{% else %}Not Set{% endif %}</span>
                    </div>
                    {% endif %}
                    
                    <!-- =============================================================================
                         SPREAD/SPIKE ALERT VOLUME DISPLAY
                         What: Shows the minimum hourly volume (GP) filter when set on a spread or spike alert
                         Why: Users need to see their required (spike) or optional (spread) volume filter
                         How: Conditional display based on alert type being 'spread' or 'spike' AND min_volume
                              being set. Uses intcomma filter for readable formatting.
                    ============================================================================= -->
                    {% if alert.type == 'spread' and alert.min_volume or alert.type == 'spike' and alert.min_volume %}
                    <div class="detail-item">
                        <span class="detail-label">Min Hourly Volume (GP)</span>
                        <span class="detail-value">{{ alert.min_volume|intcomma }}</span>
                    </div>
                    {% endif %}
                    
                    {% if alert.type == 'spike' %}
                    <div class="detail-item">
                        <span class="detail-label">Time Frame</span>
                        <span class="detail-value">{% if alert.price %}{{ alert.time_frame_display }}{% else %}Not Set{% endif %}</span>
                    </div>
                    <div class="detail-item">
                        <!-- What: Displays the direction setting for spike/sustained alerts
                             Why: Users need to see whether the alert triggers on price increases, decreases, or both
                             How: Maps database values (up/down/both) to user-friendly labels (Above/Below/Both) -->
                        <span class="detail-label">Above / Below</span>
                        <span class="detail-value">
                            {% if alert.direction == 'up' %}Above
                            {% elif alert.direction == 'down' %}Below
                            {% else %}Both{% endif %}
                        </span>
                    </div>
                    <div class="detail-item">
                        <!-- What: Displays the reference price type for spike alerts
                             Why: Users need to see which price point is being monitored
                             How: Maps database values (high/low/average) to user-friendly labels -->
                        <span class="detail-label">Reference Price</span>
                        <span class="detail-value">
                            {% if alert.reference == 'high' %}High (Instant Buy)
                            {% elif alert.reference == 'low' %}Low (Instant Sell)
                            {% elif alert.reference == 'average' %}Average
                            {% else %}Average{% endif %}
                        </span>
                    </div>
                    {% endif %}
                    
                    <!-- =============================================================================
                         SUSTAINED ALERT DISPLAY FIELDS
                         What: Shows sustained-specific configuration when viewing (not editing)
                         Why: Users need to see direction, time frame, reference, and sustained-specific settings
                         How: Conditional display based on alert.type == 'sustained'
                    ============================================================================= -->
                    {% if alert.type == 'sustained' %}
                    <div class="detail-item">
                        <!-- What: Displays the time frame setting for sustained alerts
                             Why: Users need to see the monitoring window duration
                             How: Shows time_frame field value -->
                        <span class="detail-label">Time Frame</span>
                        <span class="detail-value">{% if alert.time_frame %}{{ alert.time_frame }} minutes{% else %}Not Set{% endif %}</span>
                    </div>
                    <div class="detail-item">
                        <!-- What: Displays the direction setting for sustained alerts
                             Why: Users need to see whether the alert triggers on price increases, decreases, or both
                             How: Maps database values (up/down/both) to user-friendly labels -->
                        <span class="detail-label">Direction</span>
                        <span class="detail-value">
                            {% if alert.direction == 'up' %}Up
                            {% elif alert.direction == 'down' %}Down
                            {% else %}Both{% endif %}
                        </span>
                    </div>
                    <div class="detail-item">
                        <!-- What: Displays the reference price type for sustained alerts
                             Why: Users need to see which price point is being monitored
                             How: Maps database values (high/low/average) to user-friendly labels -->
                        <span class="detail-label">Reference Price</span>
                        <span class="detail-value">
                            {% if alert.reference == 'high' %}High (Instant Buy)
                            {% elif alert.reference == 'low' %}Low (Instant Sell)
                            {% elif alert.reference == 'average' %}Average
                            {% else %}Average{% endif %}
                        </span>
                    </div>
                    {% if alert.min_consecutive_moves %}
                    <div class="detail-item">
                        <span class="detail-label">Min Consecutive Moves</span>
                        <span class="detail-value">{{ alert.min_consecutive_moves }}</span>
                    </div>
                    {% endif %}
                    {% if alert.min_move_percentage %}
                    <div class="detail-item">
                        <span class="detail-label">Min Move %</span>
                        <span class="detail-value">{{ alert.min_move_percentage }}%</span>
                    </div>
                    {% endif %}
                    {% if alert.min_volume %}
                    <div class="detail-item">
                        <span class="detail-label">Min Hourly Volume (GP)</span>
                        <span class="detail-value">{{ alert.min_volume|intcomma }}</span>
                    </div>
                    {% endif %}
                    {% if alert.volatility_buffer_size %}
                    <div class="detail-item">
                        <span class="detail-label">Volatility Buffer Size</span>
                        <span class="detail-value">{{ alert.volatility_buffer_size }}</span>
                    </div>
                    {% endif %}
                    {% if alert.volatility_multiplier %}
                    <div class="detail-item">
                        <span class="detail-label">Volatility Multiplier</span>
                        <span class="detail-value">{{ alert.volatility_multiplier }}x</span>
                    </div>
                    {% endif %}
                    {% endif %}
                    
                    <!-- =============================================================================
                         COLLECTIVE MOVE ALERT DISPLAY FIELDS
                         What: Shows collective move time frame when viewing (not editing)
                         Why: Users need to see the rolling window used for comparisons
                         How: Displays alert.time_frame value in minutes
                    ============================================================================= -->
                    {% if alert.type == 'collective_move' %}
                    <div class="detail-item">
                        <!-- What: Displays the time frame setting for collective move alerts
                             Why: Users need to see the monitoring window duration
                             How: Shows time_frame field value -->
                        <span class="detail-label">Time Frame</span>
                        <span class="detail-value">{% if alert.time_frame %}{{ alert.time_frame }} minutes{% else %}Not Set{% endif %}</span>
                    </div>
                    {% endif %}
                    
                    <!-- =============================================================================
                         FLIP CONFIDENCE ALERT DISPLAY FIELDS
                         What: Shows flip confidence-specific configuration when viewing (not editing)
                         Why: Users need to see timestep, lookback, threshold, trigger rule, and
                              optional filters (min spread, min volume, cooldown, eval interval,
                              sustained count) to understand how their confidence alert is configured
                         How: Conditional display based on alert.type == 'flip_confidence'
                              Reads from alert model fields: confidence_timestep, confidence_lookback,
                              confidence_threshold, confidence_trigger_rule, confidence_min_spread_pct,
                              confidence_min_volume, confidence_cooldown, confidence_eval_interval,
                              confidence_sustained_count
                    ============================================================================= -->
                    {% if alert.type == 'flip_confidence' %}
                    <div class="detail-item">
                        <!-- What: The time bucket granularity for timeseries data (5m, 1h, 6h, 24h) -->
                        <span class="detail-label">Timestep</span>
                        <span class="detail-value">{{ alert.confidence_timestep|default:"1h" }}</span>
                    </div>
                    <div class="detail-item">
                        <!-- What: Number of time buckets analyzed to compute the confidence score -->
                        <span class="detail-label">Lookback</span>
                        <span class="detail-value">{{ alert.confidence_lookback|default:"24" }} periods</span>
                    </div>
                    <div class="detail-item">
                        <!-- What: The confidence score threshold that must be met for triggering -->
                        <span class="detail-label">Threshold</span>
                        <span class="detail-value highlight">{% if alert.confidence_threshold is not None %}{{ alert.confidence_threshold }}{% else %}Not Set{% endif %}</span>
                    </div>
                    <div class="detail-item">
                        <!-- What: How the score is compared to the threshold -->
                        <!-- crosses_above = score >= threshold, delta_increase = score increased by >= threshold -->
                        <span class="detail-label">Trigger Rule</span>
                        <span class="detail-value">{% if alert.confidence_trigger_rule == 'delta_increase' %}Delta Increase{% else %}Crosses Above{% endif %}</span>
                    </div>
                    {% if alert.confidence_min_spread_pct %}
                    <div class="detail-item">
                        <!-- What: Minimum current spread % to consider an item worth evaluating -->
                        <span class="detail-label">Min Spread</span>
                        <span class="detail-value">{{ alert.confidence_min_spread_pct }}%</span>
                    </div>
                    {% endif %}
                    {% if alert.confidence_min_volume %}
                    <div class="detail-item">
                        <!-- What: Minimum total GP volume (sum of qty * price for all buys + sells)
                             Why: GP-based volume normalises across price tiers, unlike raw trade counts
                             How: Displayed with intcomma formatting and " GP" suffix for clarity -->
                        <span class="detail-label">Min Volume (GP)</span>
                        <span class="detail-value">{{ alert.confidence_min_volume|intcomma }} GP</span>
                    </div>
                    {% endif %}
                    {% if alert.confidence_cooldown %}
                    <div class="detail-item">
                        <!-- What: Minutes to wait before re-alerting on the same item after it triggers -->
                        <span class="detail-label">Cooldown</span>
                        <span class="detail-value">{{ alert.confidence_cooldown }} minutes</span>
                    </div>
                    {% endif %}
                    {% if alert.confidence_eval_interval %}
                    <div class="detail-item">
                        <!-- What: Minutes between evaluations of each item -->
                        <span class="detail-label">Eval Interval</span>
                        <span class="detail-value">{{ alert.confidence_eval_interval }} minutes</span>
                    </div>
                    {% endif %}
                    {% if alert.confidence_sustained_count and alert.confidence_sustained_count > 1 %}
                    <div class="detail-item">
                        <!-- What: How many consecutive evaluations must pass before triggering -->
                        <span class="detail-label">Sustained Count</span>
                        <span class="detail-value">{{ alert.confidence_sustained_count }} consecutive</span>
                    </div>
                    {% endif %}
                    {% if alert.is_all_items %}
                    {% if alert.minimum_price %}
                    <div class="detail-item">
                        <span class="detail-label">Min Price Filter</span>
                        <span class="detail-value price">{{ alert.minimum_price|intcomma }}</span>
                    </div>
                    {% endif %}
                    {% if alert.maximum_price %}
                    <div class="detail-item">
                        <span class="detail-label">Max Price Filter</span>
                        <span class="detail-value price">{{ alert.maximum_price|intcomma }}</span>
                    </div>
                    {% endif %}
                    {% endif %}

                    {% endif %}
                    
                    <!-- =============================================================================
                         DUMP ALERT DISPLAY FIELDS
                         =============================================================================
                         What: Shows dump-specific configuration when viewing (not editing).
                         Why:  Users need to see discount threshold, shock sigma, liquidity floor,
                               and cooldown at a glance. Advanced EWMA/detection parameters are
                               hidden behind a toggle (matching the scoring weights pattern).
                         How:  Conditional display based on alert.type == 'dump'. Basic fields are
                               always shown; advanced fields are inside a collapsible panel toggled
                               by toggleViewDumpAdvanced().
                    ============================================================================= -->
                    {% if alert.type == 'dump' %}
                    <div class="detail-item">
                        <!-- What: The minimum discount % below EWMA fair value to trigger -->
                        <span class="detail-label">Min Discount</span>
                        <span class="detail-value highlight">{% if alert.dump_discount_min is not None %}{{ alert.dump_discount_min }}%{% else %}Not Set{% endif %}</span>
                    </div>
                    <div class="detail-item">
                        <!-- What: The shock sigma threshold (how many std devs the idiosyncratic return must drop) -->
                        <span class="detail-label">Shock Sigma</span>
                        <span class="detail-value">{% if alert.dump_shock_sigma is not None %}{{ alert.dump_shock_sigma }}{% else %}Not Set{% endif %}</span>
                    </div>
                    <div class="detail-item">
                        <!-- What: Minimum GP/hr liquidity floor to filter out illiquid items -->
                        <span class="detail-label">Liquidity Floor (GP)</span>
                        <span class="detail-value">{% if alert.dump_liquidity_floor is not None %}{{ alert.dump_liquidity_floor|intcomma }}{% else %}Not Set{% endif %}</span>
                    </div>
                    <div class="detail-item">
                        <!-- What: Minutes before re-alerting on the same item -->
                        <span class="detail-label">Cooldown</span>
                        <span class="detail-value">{% if alert.dump_cooldown_minutes is not None %}{{ alert.dump_cooldown_minutes }} minutes{% else %}Not Set{% endif %}</span>
                    </div>
                    {% if alert.is_all_items %}
                    {% if alert.minimum_price %}
                    <div class="detail-item">
                        <span class="detail-label">Min Price Filter</span>
                        <span class="detail-value price">{{ alert.minimum_price|intcomma }}</span>
                    </div>
                    {% endif %}
                    {% if alert.maximum_price %}
                    <div class="detail-item">
                        <span class="detail-label">Max Price Filter</span>
                        <span class="detail-value price">{{ alert.maximum_price|intcomma }}</span>
                    </div>
                    {% endif %}
                    {% endif %}

                    {% endif %}
                    
                    <!-- =============================================================================
                         SHARED FIELDS: Direction, Threshold Type, Percentage, Reference
                         What: These fields are common to spread/spike/sustained/threshold/collective_move
                              but NOT applicable to flip_confidence or dump alerts
                         Why: flip_confidence uses its own dedicated fields (timestep, lookback,
                              trigger_rule, etc.) and dump uses its own (discount, shock sigma, etc.)
                              â€” showing "Threshold Type = Percentage" is misleading for both
                         How: Wrap in a type check that excludes flip_confidence and dump
                    ============================================================================= -->
                    {% if alert.type != 'flip_confidence' and alert.type != 'dump' %}
                    <div class="detail-item">
                        <!-- What: Displays the direction setting for threshold alerts
                             Why: Users need to see whether the alert triggers when price goes above or below threshold
                             How: Maps database values (up/down) to user-friendly labels (Above/Below) -->
                        <span class="detail-label">Above / Below</span>
                        <span class="detail-value">
                            {% if alert.direction == 'up' %}Above
                            {% elif alert.direction == 'down' %}Below
                            {% else %}Both{% endif %}
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Threshold Type</span>
                        <span class="detail-value">{% if alert.threshold_type == 'value' %}Value{% else %}Percentage{% endif %}</span>
                    </div>
                    {% if alert.threshold_type == 'value' %}
                    <div class="detail-item">
                        <span class="detail-label">Target Price</span>
                        <span class="detail-value price">{% if alert.target_price %}{{ alert.target_price|intcomma }}{% else %}Not Set{% endif %}</span>
                    </div>
                    {% else %}
                    <div class="detail-item">
                        <span class="detail-label">Percentage Threshold</span>
                        <span class="detail-value highlight">{% if alert.percentage %}{{ alert.percentage }}%{% else %}Not Set{% endif %}</span>
                    </div>
                    {% endif %}
                    <div class="detail-item">
                        <span class="detail-label">Reference Price Type</span>
                        <span class="detail-value">
                            {% if alert.reference == 'high' %}High (Instant Buy)
                            {% elif alert.reference == 'low' %}Low (Instant Sell)
                            {% elif alert.reference == 'average' %}Average
                            {% else %}Average{% endif %}
                        </span>
                    </div>
                    {% endif %}
                    
                    <!-- What: Min/Max Price Filters for non-confidence, non-dump alert types
                         Why: flip_confidence already shows these in its own config section above;
                              dump alerts use liquidity floor instead of min/max price filters
                         How: Exclude flip_confidence and dump from this shared block -->
                    {% if alert.type != 'flip_confidence' and alert.type != 'dump' %}
                    {% if alert.is_all_items %}
                    <div class="detail-item">
                        <span class="detail-label">Minimum Price Filter</span>
                        <span class="detail-value price">{% if alert.minimum_price %}{{ alert.minimum_price|intcomma }}{% else %}None{% endif %}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Maximum Price Filter</span>
                        <span class="detail-value price">{% if alert.maximum_price %}{{ alert.maximum_price|intcomma }}{% else %}None{% endif %}</span>
                    </div>
                    {% endif %}
                    {% endif %}
                    
                    {% if alert.type == 'threshold' and alert.min_volume %}
                    <!-- What: Displays the minimum hourly volume filter for threshold alerts -->
                    <!-- Why: Users need to confirm the liquidity filter applied to their threshold alert -->
                    <!-- How: Shows alert.min_volume formatted with intcomma for readability -->
                    <div class="detail-item">
                        <span class="detail-label">Min Hourly Volume (GP)</span>
                        <span class="detail-value">{{ alert.min_volume|intcomma }}</span>
                    </div>
                    {% endif %}
                    
                    <div class="detail-item">
                        <span class="detail-label">Alert Notification</span>
                        <span class="detail-value">{% if alert.show_notification %}Enabled{% else %}Disabled{% endif %}</span>
                    </div>
                    
                    <div class="detail-item">
                        <span class="detail-label">SMS Notifications</span>
                        <span class="detail-value">{% if alert.email_notification %}Enabled{% else %}Disabled{% endif %}</span>
                    </div>
                    
                    <!-- Group Display -->
                    <!-- What: Shows which group(s) this alert belongs to in the config card -->
                    <!-- Why: Users need to see alert grouping at a glance before editing -->
                    <!-- How: Display group names or "No group" if none assigned -->
                    <div class="detail-item">
                        <span class="detail-label">Group</span>
                        <span class="detail-value">{% if groups %}{{ groups|join:", " }}{% else %}No group{% endif %}</span>
                    </div>
                    
                    {% if alert.type == 'threshold' %}
                    <!-- Reference Prices Display (baseline prices at creation) -->
                    <!-- What: Shows the stored reference prices for each monitored item -->
                    <!-- Why: Users need to see what baseline their threshold is compared against -->
                    <!-- How: Render from reference_prices_display_data passed from view context -->
                    <!-- Note: Positioned at end of display grid to keep other fields grouped -->
                    <div class="detail-item detail-item-full">
                        <span class="detail-label">Reference Prices (Baseline)</span>
                        <div class="reference-prices-display-view" id="reference-prices-display-view">
                            <!-- Will be populated by JavaScript on page load -->
                            <span class="no-data">Loading...</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- =============================================================
                         SCORING WEIGHTS TOGGLE (View Mode) â€” positioned at very end
                         =============================================================
                         What: Collapsible section showing the 5 scoring weights
                         Why: Users want to verify what weights are active without
                              cluttering the main configuration view
                         How: A button toggles a hidden div containing weight values.
                              Only rendered for flip_confidence alerts.
                    ============================================================= -->
                    {% if alert.type == 'flip_confidence' %}
                    <div class="detail-item" style="flex-basis: 100%;">
                        <button type="button"
                                class="btn-weights-toggle"
                                onclick="toggleViewWeights()"
                                id="view-weights-toggle-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                 fill="currentColor" width="14" height="14">
                                <path fill-rule="evenodd"
                                      d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"
                                      clip-rule="evenodd"/>
                            </svg>
                            Show Scoring Weights
                        </button>
                        <!-- What: Weights panel lives inside the same detail-item as the button
                             Why: Ensures the panel appears directly below the button in the same
                                  grid position, rather than flowing into the next grid cell
                             How: The parent detail-item is flex-direction:column, so children stack -->
                        <div id="view-weights-panel" class="weights-panel" style="display: none;">
                            {% if alert.confidence_weight_trend is not None or alert.confidence_weight_pressure is not None or alert.confidence_weight_spread is not None or alert.confidence_weight_volume is not None or alert.confidence_weight_stability is not None %}
                            <div class="weights-grid">
                                <div class="weight-item">
                                    <span class="detail-label">Trend</span>
                                    <span class="detail-value">{{ alert.confidence_weight_trend|default:"0.35" }}</span>
                                </div>
                                <div class="weight-item">
                                    <span class="detail-label">Pressure</span>
                                    <span class="detail-value">{{ alert.confidence_weight_pressure|default:"0.25" }}</span>
                                </div>
                                <div class="weight-item">
                                    <span class="detail-label">Spread</span>
                                    <span class="detail-value">{{ alert.confidence_weight_spread|default:"0.20" }}</span>
                                </div>
                                <div class="weight-item">
                                    <span class="detail-label">Volume</span>
                                    <span class="detail-value">{{ alert.confidence_weight_volume|default:"0.10" }}</span>
                                </div>
                                <div class="weight-item">
                                    <span class="detail-label">Stability</span>
                                    <span class="detail-value">{{ alert.confidence_weight_stability|default:"0.10" }}</span>
                                </div>
                            </div>
                            {% else %}
                            <span class="form-hint">Using default weights (Trend: 0.35, Pressure: 0.25, Spread: 0.20, Volume: 0.10, Stability: 0.10)</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- =============================================================
                         DUMP ADVANCED DETECTION SETTINGS TOGGLE (View Mode)
                         =============================================================
                         What: Collapsible section showing advanced EWMA & detection params
                         Why:  Positioned at the very end of the detail grid (after Group,
                               after scoring weights) so it flows naturally as the last
                               item. On wide screens it sits to the right of Group; on
                               narrow screens it wraps to the bottom.
                         How:  A button toggles a hidden div containing read-only values.
                               Only rendered for dump alerts.
                    ============================================================= -->
                    {% if alert.type == 'dump' %}
                    <div class="detail-item" style="flex-basis: 100%;">
                        <button type="button"
                                class="btn-weights-toggle"
                                onclick="toggleViewDumpAdvanced()"
                                id="view-dump-advanced-toggle-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                 fill="currentColor" width="14" height="14">
                                <path fill-rule="evenodd"
                                      d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"
                                      clip-rule="evenodd"/>
                            </svg>
                            Advanced Detection Settings
                        </button>
                        <!-- What: Panel containing all advanced dump detection values (read-only)
                             Why:  Keeps advanced settings out of the way until the user wants them
                             How:  Uses the same weights-grid flex layout for compact, left-aligned display -->
                        <div id="view-dump-advanced-panel" class="weights-panel" style="display: none;">
                            <div class="weights-grid">
                                <div class="weight-item">
                                    <span class="detail-label">Sell Ratio</span>
                                    <span class="detail-value">{{ alert.dump_sell_ratio_min|default:"0.70" }}</span>
                                </div>
                                <div class="weight-item">
                                    <span class="detail-label">Rel Volume</span>
                                    <span class="detail-value">{{ alert.dump_rel_vol_min|default:"2.5" }}</span>
                                </div>
                                <div class="weight-item">
                                    <span class="detail-label">Fair HL</span>
                                    <span class="detail-value">{{ alert.dump_fair_halflife|default:"120" }}m</span>
                                </div>
                                <div class="weight-item">
                                    <span class="detail-label">Vol HL</span>
                                    <span class="detail-value">{{ alert.dump_vol_halflife|default:"60" }}m</span>
                                </div>
                                <div class="weight-item">
                                    <span class="detail-label">Var HL</span>
                                    <span class="detail-value">{{ alert.dump_var_halflife|default:"60" }}m</span>
                                </div>
                                <div class="weight-item">
                                    <span class="detail-label">Confirm</span>
                                    <span class="detail-value">{{ alert.dump_confirmation_buckets|default:"1" }} bucket{{ alert.dump_confirmation_buckets|default:"1"|pluralize }}</span>
                                </div>
                                <div class="weight-item">
                                    <span class="detail-label">Consistency</span>
                                    <span class="detail-value">{% if alert.dump_consistency_required %}Required{% else %}Off{% endif %}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            <!-- =============================================================================
                 FORM ELEMENT ORDER:
                 1. All regular inputs in alphabetical order by label
                 2. Toggle buttons at the end: Active, All Items, Show Alert Notification, SMS Notification
                 3. Reference Prices (Baseline) at the very end
                 This ordering applies to all alert types - visibility is controlled by JS
            ============================================================================= -->
            <div class="edit-form">
                <div class="form-grid">
                    <!-- ======================= ALPHABETICAL INPUTS SECTION ======================= -->
                    
                    <!-- Alert Name -->
                    <div class="form-group" id="alert-name-group">
                        <label for="edit-alert-name">Alert Name</label>
                        <input type="text" id="edit-alert-name" value="{{ alert.alert_name|default:'' }}" placeholder="Enter alert name...">
                        <small class="form-hint">A friendly name to identify this alert</small>
                    </div>
                    
                    <!-- Alert Type -->
                    <div class="form-group" id="type-group">
                        <label for="edit-type">Alert Type</label>
                        <select id="edit-type" onchange="handleTypeChange()">
                            <!-- NOTE: Above/Below Threshold alert types were removed; do not re-add without backend support. -->
                            <option value="spread" {% if alert.type == 'spread' %}selected{% endif %}>Spread</option>
                            <option value="spike" {% if alert.type == 'spike' %}selected{% endif %}>Spike</option>
                            <option value="sustained" {% if alert.type == 'sustained' %}selected{% endif %}>Sustained Move</option>
                            <option value="threshold" {% if alert.type == 'threshold' %}selected{% endif %}>Threshold</option>
                            <option value="collective_move" {% if alert.type == 'collective_move' %}selected{% endif %}>Collective Move</option>
                            <option value="flip_confidence" {% if alert.type == 'flip_confidence' %}selected{% endif %}>Flip Confidence</option>
                            <option value="dump" {% if alert.type == 'dump' %}selected{% endif %}>Dump Alert</option>
                        </select>
                        <small class="form-hint">The condition that triggers this alert</small>
                    </div>
                    
                    <!-- Above / Below (spike/sustained) -->
                    <!-- What: Dropdown to select price movement direction for spike/sustained alerts
                         Why: Users can choose to trigger on price increases (Above), decreases (Below), or both
                         How: Displays "Above/Below" labels but saves as "up/down" values to the database -->
                    <div class="form-group" id="direction-group" style="display: none;">
                        <label for="edit-direction">Above / Below</label>
                        <select id="edit-direction">
                            <option value="both" {% if alert.direction == 'both' or not alert.direction %}selected{% endif %}>Both</option>
                            <option value="up" {% if alert.direction == 'up' %}selected{% endif %}>Above</option>
                            <option value="down" {% if alert.direction == 'down' %}selected{% endif %}>Below</option>
                        </select>
                        <small class="form-hint">Price movement direction to trigger alert</small>
                    </div>
                    
                    <!-- Above / Below (threshold - up/down only, no 'both') -->
                    <!-- What: Dropdown to select price movement direction for threshold alerts
                         Why: Threshold alerts trigger when price goes above or below a target
                         How: Displays "Above/Below" labels but saves as "up/down" values to the database -->
                    <div class="form-group" id="threshold-direction-group" style="display: none;">
                        <label for="edit-threshold-direction">Above / Below</label>
                        <select id="edit-threshold-direction">
                            <option value="up" {% if alert.direction == 'up' or not alert.direction %}selected{% endif %}>Above</option>
                            <option value="down" {% if alert.direction == 'down' %}selected{% endif %}>Below</option>
                        </select>
                        <small class="form-hint">Price movement direction to trigger alert</small>
                    </div>
                    
                    <!-- Group -->
                    <!-- What: Dropdown to select which group this alert belongs to -->
                    <!-- Why: Users can organize alerts into groups for easier management -->
                    <!-- How: Dropdown populated from user's groups with "+" button to create new -->
                    <div class="form-group" id="group-edit-group">
                        <label for="edit-group">Group</label>
                        <div class="group-selector-wrapper">
                            <select id="edit-group">
                                <option value="">No Group</option>
                                <!-- Options populated by JavaScript from all_groups -->
                            </select>
                            <button type="button" class="btn-add-group" onclick="openNewGroupModal()" title="Create new group">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"/>
                                </svg>
                            </button>
                        </div>
                        <small class="form-hint">Organize alerts into groups for easier management</small>
                    </div>
                    
                    <!-- Item Name (single item) -->
                    <div class="form-group" id="item-name-group">
                        <label for="edit-item-name">Item Name</label>
                        <input type="text" id="edit-item-name" value="{{ alert.item_name|default:'' }}" placeholder="Enter item name..." autocomplete="off">
                        <input type="hidden" id="edit-item-id" value="{{ alert.item_id|default:'' }}">
                        <div id="edit-item-suggestions" class="suggestions-dropdown"></div>
                        <small class="form-hint">The item to monitor for this alert</small>
                    </div>
                    
                    <!-- Items (multi-item selector) -->
                    <div class="form-group" id="multi-item-group" style="display: none;">
                        <div class="label-with-notification">
                            <label for="edit-multi-item-input">Items</label>
                            <span id="item-add-notification" class="item-notification"></span>
                        </div>
                        <div class="multi-item-selector-box">
                            <input type="text" id="edit-multi-item-input" placeholder="Search for item to add..." autocomplete="off">
                            <button type="button" class="multi-item-dropdown-toggle" id="edit-multi-item-toggle" title="Show selected items">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <input type="hidden" id="edit-item-ids" value="">
                            <div id="edit-multi-item-suggestions" class="multi-item-suggestions-dropdown"></div>
                            <div id="edit-selected-items-dropdown" class="multi-item-selected-dropdown">
                                <div class="selected-items-list" id="edit-selected-items-list"></div>
                                <div class="no-items-message" id="edit-no-items-message">No items selected</div>
                            </div>
                        </div>
                        <small class="form-hint">Add or remove items to monitor</small>
                    </div>
                    
                    <!-- Market Pressure (sustained only) -->
                    <div class="form-group" id="pressure-strength-group" style="display: none;">
                        <label for="edit-pressure-strength">Market Pressure</label>
                        <select id="edit-pressure-strength">
                            <option value="">No Pressure Filter</option>
                            <option value="weak" {% if alert.min_pressure_strength == 'weak' %}selected{% endif %}>Weak+ (any time delta)</option>
                            <option value="moderate" {% if alert.min_pressure_strength == 'moderate' %}selected{% endif %}>Moderate+ (&lt;5min)</option>
                            <option value="strong" {% if alert.min_pressure_strength == 'strong' %}selected{% endif %}>Strong (&lt;1min)</option>
                        </select>
                        <small class="form-hint">BUY=up, SELL=down direction match</small>
                    </div>
                    
                    <!-- Maximum Price (all items only) -->
                    <div class="form-group" id="max-price-group" style="display: none;">
                        <label for="edit-maximum-price">Maximum Price</label>
                        <input type="number" id="edit-maximum-price" value="{{ alert.maximum_price|default:'' }}" min="0" placeholder="Enter maximum price...">
                        <small class="form-hint">Only monitor items below this price</small>
                    </div>
                    
                    <!-- Min Consecutive Moves (sustained) -->
                    <div class="form-group" id="min-consecutive-moves-group" style="display: none;">
                        <label for="edit-min-consecutive-moves">Min Consecutive Moves</label>
                        <input type="number" id="edit-min-consecutive-moves" value="{{ alert.min_consecutive_moves|default:'' }}" min="2" step="1" placeholder="e.g. 5">
                        <small class="form-hint">Number of price changes in same direction</small>
                    </div>
                    
                    <!-- Min Move % (sustained) -->
                    <div class="form-group" id="min-move-percentage-group" style="display: none;">
                        <label for="edit-min-move-percentage">Min Move %</label>
                        <input type="number" id="edit-min-move-percentage" value="{{ alert.min_move_percentage|default:'' }}" min="0.01" step="0.01" placeholder="e.g. 0.5">
                        <small class="form-hint">Min % change to count as move</small>
                    </div>
                    
                    <!-- Min Spread % for Pressure (sustained) -->
                    <div class="form-group" id="pressure-spread-group" style="display: none;">
                        <label for="edit-pressure-spread">Min Spread % for Pressure</label>
                        <input type="number" id="edit-pressure-spread" value="{{ alert.min_pressure_spread_pct|default:'' }}" min="0.01" step="0.01" placeholder="e.g. 0.2">
                        <small class="form-hint">Spread % threshold for pressure</small>
                    </div>
                    
                    <!-- Min Hourly Volume (sustained, spread, threshold) -->
                    <!-- What: Input field for minimum hourly trading volume in GP -->
                    <!-- Why: Sustained, spread, and threshold alerts use this to filter out low-volume items -->
                    <!-- How: Shared form field reused across alert types; visibility controlled by JS -->
                    <div class="form-group" id="min-volume-group" style="display: none;">
                        <label for="edit-min-volume">Min Hourly Volume (GP)</label>
                        <input type="number" id="edit-min-volume" value="{{ alert.min_volume|default:'' }}" min="0" step="1" placeholder="e.g. 75000000">
                        <!-- What: Helper text for editing the min hourly volume -->
                        <!-- Why: Spike alerts now require this value, while spread alerts keep it optional -->
                        <!-- How: Provide a concise hint explaining which alert types require the field -->
                        <small class="form-hint">Minimum hourly trading volume in GP (required for spike alerts)</small>
                    </div>
                    
                    <!-- Minimum Price (all items only) -->
                    <div class="form-group" id="min-price-group" style="display: none;">
                        <label for="edit-minimum-price">Minimum Price</label>
                        <input type="number" id="edit-minimum-price" value="{{ alert.minimum_price|default:'' }}" min="0" placeholder="Enter minimum price...">
                        <small class="form-hint">Only monitor items above this price</small>
                    </div>
                    
                    <!-- Percentage (spread/spike/threshold) -->
                    <div class="form-group" id="percentage-group" style="display: none;">
                        <label for="edit-percentage">Percentage (%)</label>
                        <input type="number" id="edit-percentage" value="{{ alert.percentage|default:'' }}" step="0.001" min="0.001" placeholder="Enter percentage...">
                        <small class="form-hint">Percent change threshold to trigger alert</small>
                    </div>
                    
                    <!-- Price Threshold (legacy above/below removed; field retained for other alert types that reuse it) -->
                    <div class="form-group" id="price-group">
                        <label for="edit-price">Price Threshold</label>
                        <input type="number" id="edit-price" value="{{ alert.price|default:'' }}" placeholder="Enter price...">
                        <small class="form-hint">Price value that triggers the alert</small>
                    </div>
                    
                    <!-- Reference Price (spike/sustained/threshold) -->
                    <!-- What: Dropdown to select which price type to monitor
                         Why: Users can choose high (instant buy), low (instant sell), or average price
                         How: Default to average if not set; show appropriate labels with context -->
                    <div class="form-group" id="reference-group">
                        <label for="edit-reference">Reference Price</label>
                        <select id="edit-reference">
                            <option value="high" {% if alert.reference == 'high' %}selected{% endif %}>High (Instant Buy)</option>
                            <option value="low" {% if alert.reference == 'low' %}selected{% endif %}>Low (Instant Sell)</option>
                            <option value="average" {% if alert.reference == 'average' or not alert.reference %}selected{% endif %}>Average</option>
                        </select>
                        <small class="form-hint">Which price to monitor for alert calculations</small>
                    </div>
                    
                    <!-- Target Price (value-based threshold only) -->
                    <div class="form-group" id="target-price-group" style="display: none;">
                        <label for="edit-target-price">Target Price (GP)</label>
                        <input type="number" id="edit-target-price" value="{{ alert.target_price|default:'' }}" min="1" step="1" placeholder="Enter target price...">
                        <small class="form-hint">Alert triggers when price crosses this value</small>
                    </div>
                    
                    <!-- Threshold Type (percentage/value) -->
                    <div class="form-group" id="threshold-type-group" style="display: none;">
                        <label for="edit-threshold-type">
                            Threshold Type
                            <!-- Locked indicator: Shows when threshold type is forced to percentage -->
                            <!-- What: Visual indicator (ðŸš«) that the dropdown is locked -->
                            <!-- Why: Users need to understand why they can't change the threshold type -->
                            <!-- How: Icon appears when dropdown is disabled; clicking shows explanatory tooltip -->
                            <span id="threshold-type-locked-indicator" class="locked-indicator" style="display: none;" title="Click for more info">ðŸš«</span>
                        </label>
                        <div class="threshold-type-wrapper">
                            <select id="edit-threshold-type" onchange="handleThresholdTypeChange()">
                                <option value="percentage" {% if alert.threshold_type == 'percentage' or not alert.threshold_type %}selected{% endif %}>Percentage</option>
                                <option value="value" {% if alert.threshold_type == 'value' %}selected{% endif %}>Value (GP)</option>
                            </select>
                        </div>
                        <!-- Tooltip that appears when user clicks the locked indicator -->
                        <!-- What: Explanation popup for why threshold type is locked -->
                        <!-- Why: Provides context so users understand the restriction -->
                        <!-- How: Shown/hidden via JavaScript when indicator is clicked -->
                        <div id="threshold-type-locked-tooltip" class="locked-tooltip" style="display: none;">
                            <span class="locked-tooltip-close">&times;</span>
                            <p>Value-based thresholds can only be used when monitoring a <strong>single item</strong>.</p>
                            <p>When monitoring multiple items or all items, percentage-based thresholds must be used because each item has a different price.</p>
                        </div>
                        <small class="form-hint">How to measure the threshold</small>
                    </div>
                    
                    <!-- Time Frame (spike/sustained/collective move) -->
                    <div class="form-group" id="time-frame-group" style="display: none;">
                        <label for="edit-time-frame">Time Frame (minutes)</label>
                        <input type="number" id="edit-time-frame" value="{% if alert.type == 'spike' %}{{ alert.price|default:'' }}{% elif alert.type == 'sustained' or alert.type == 'collective_move' %}{{ alert.time_frame|default:'' }}{% endif %}" min="1" step="1" placeholder="e.g. 10">
                        <small class="form-hint">Time window the alert must trigger within</small>
                    </div>
                    
                    <!-- Volatility Buffer (sustained) -->
                    <div class="form-group" id="volatility-buffer-group" style="display: none;">
                        <label for="edit-volatility-buffer-size">Volatility Buffer (N)</label>
                        <input type="number" id="edit-volatility-buffer-size" value="{{ alert.volatility_buffer_size|default:'' }}" min="5" step="1" placeholder="e.g. 20">
                        <small class="form-hint">Rolling buffer size for avg volatility</small>
                    </div>
                    
                    <!-- Volatility Multiplier (sustained) -->
                    <div class="form-group" id="volatility-multiplier-group" style="display: none;">
                        <label for="edit-volatility-multiplier">Volatility Multiplier (K)</label>
                        <input type="number" id="edit-volatility-multiplier" value="{{ alert.volatility_multiplier|default:'' }}" min="0.1" step="0.1" placeholder="e.g. 1.5">
                        <small class="form-hint">Streak must move â‰¥ K Ã— avg volatility</small>
                    </div>
                    
                    <!-- =============================================================================
                         FLIP CONFIDENCE EDIT FIELDS
                         =============================================================================
                         What: All editable configuration fields specific to flip_confidence alerts
                         Why: Users need to adjust confidence scoring parameters (timestep, lookback,
                              threshold, trigger rule, filters, cooldown, etc.) from the detail page
                         How: Hidden by default (display:none), shown by handleTypeChange() when
                              the selected type is 'flip_confidence'
                    ============================================================================= -->
                    
                    <!-- Confidence: Timestep -->
                    <div class="form-group" id="confidence-timestep-group" style="display: none;">
                        <label for="edit-confidence-timestep">Timestep</label>
                        <select id="edit-confidence-timestep">
                            <option value="5m" {% if alert.confidence_timestep == '5m' %}selected{% endif %}>5 minutes</option>
                            <option value="1h" {% if alert.confidence_timestep == '1h' or not alert.confidence_timestep %}selected{% endif %}>1 hour</option>
                            <option value="6h" {% if alert.confidence_timestep == '6h' %}selected{% endif %}>6 hours</option>
                            <option value="24h" {% if alert.confidence_timestep == '24h' %}selected{% endif %}>24 hours</option>
                        </select>
                        <small class="form-hint">Time bucket granularity for timeseries data</small>
                    </div>
                    
                    <!-- Confidence: Lookback Periods -->
                    <div class="form-group" id="confidence-lookback-group" style="display: none;">
                        <label for="edit-confidence-lookback">Lookback Periods</label>
                        <input type="number" id="edit-confidence-lookback"
                               value="{{ alert.confidence_lookback|default:'24' }}"
                               min="3" step="1" placeholder="e.g. 24">
                        <small class="form-hint">Number of time buckets to analyze</small>
                    </div>
                    
                    <!-- Confidence: Score Threshold -->
                    <div class="form-group" id="confidence-threshold-group" style="display: none;">
                        <label for="edit-confidence-threshold">Score Threshold</label>
                        <input type="number" id="edit-confidence-threshold"
                               value="{% if alert.confidence_threshold is not None %}{{ alert.confidence_threshold }}{% endif %}"
                               min="0" max="1" step="0.01" placeholder="e.g. 0.65">
                        <small class="form-hint">Minimum confidence score to trigger (0.0 - 1.0)</small>
                    </div>
                    
                    <!-- Confidence: Trigger Rule -->
                    <div class="form-group" id="confidence-trigger-rule-group" style="display: none;">
                        <label for="edit-confidence-trigger-rule">Trigger Rule</label>
                        <select id="edit-confidence-trigger-rule">
                            <option value="crosses_above" {% if alert.confidence_trigger_rule == 'crosses_above' or not alert.confidence_trigger_rule %}selected{% endif %}>Crosses Above</option>
                            <option value="delta_increase" {% if alert.confidence_trigger_rule == 'delta_increase' %}selected{% endif %}>Delta Increase</option>
                        </select>
                        <small class="form-hint">How to compare score against threshold</small>
                    </div>
                    
                    <!-- Confidence: Min Spread % -->
                    <div class="form-group" id="confidence-min-spread-group" style="display: none;">
                        <label for="edit-confidence-min-spread">Min Spread %</label>
                        <input type="number" id="edit-confidence-min-spread"
                               value="{% if alert.confidence_min_spread_pct is not None %}{{ alert.confidence_min_spread_pct }}{% endif %}"
                               min="0" step="0.1" placeholder="e.g. 1.5">
                        <small class="form-hint">Minimum buy/sell spread percentage (optional)</small>
                    </div>
                    
                    <!-- Confidence: Min Total Volume (GP) -->
                    <div class="form-group" id="confidence-min-volume-group" style="display: none;">
                        <label for="edit-confidence-min-volume">Min Total Volume (GP)</label>
                        <input type="number" id="edit-confidence-min-volume"
                               value="{% if alert.confidence_min_volume is not None %}{{ alert.confidence_min_volume }}{% endif %}"
                               min="0" step="1" placeholder="">
                        <small class="form-hint">Minimum total GP traded across lookback window (optional)</small>
                    </div>
                    
                    <!-- Confidence: Cooldown -->
                    <div class="form-group" id="confidence-cooldown-group" style="display: none;">
                        <label for="edit-confidence-cooldown">Cooldown (minutes)</label>
                        <input type="number" id="edit-confidence-cooldown"
                               value="{% if alert.confidence_cooldown is not None %}{{ alert.confidence_cooldown }}{% endif %}"
                               min="0" step="1" placeholder="e.g. 60">
                        <small class="form-hint">Minutes to wait before re-alerting same item (optional)</small>
                    </div>
                    
                    <!-- Confidence: Eval Interval -->
                    <div class="form-group" id="confidence-eval-interval-group" style="display: none;">
                        <label for="edit-confidence-eval-interval">Eval Interval (minutes)</label>
                        <input type="number" id="edit-confidence-eval-interval"
                               value="{% if alert.confidence_eval_interval is not None %}{{ alert.confidence_eval_interval }}{% endif %}"
                               min="0" step="1" placeholder="e.g. 15">
                        <small class="form-hint">How often to re-evaluate (optional, default: every cycle)</small>
                    </div>
                    
                    <!-- Confidence: Sustained Count -->
                    <div class="form-group" id="confidence-sustained-count-group" style="display: none;">
                        <label for="edit-confidence-sustained-count">Sustained Count</label>
                        <input type="number" id="edit-confidence-sustained-count"
                               value="{% if alert.confidence_sustained_count is not None %}{{ alert.confidence_sustained_count }}{% endif %}"
                               min="1" step="1" placeholder="e.g. 1">
                        <small class="form-hint">Consecutive evaluations required before triggering</small>
                    </div>
                    
                    <!-- =============================================================================
                         DUMP ALERT EDIT FIELDS
                         =============================================================================
                         What: All editable configuration fields specific to dump alerts
                         Why: Users need to adjust dump detection parameters (discount, shock sigma,
                              liquidity floor, cooldown, and advanced EWMA settings) from the detail page
                         How: Hidden by default (display:none), shown by handleTypeChange() when
                              the selected type is 'dump'
                    ============================================================================= -->
                    
                    <!-- Dump: Min Discount % -->
                    <div class="form-group" id="dump-discount-min-group" style="display: none;">
                        <label for="edit-dump-discount-min">Min Discount (%)</label>
                        <input type="number" id="edit-dump-discount-min"
                               value="{% if alert.dump_discount_min is not None %}{{ alert.dump_discount_min }}{% endif %}"
                               step="0.5" min="0.5" max="50" placeholder="e.g. 3">
                        <small class="form-hint">Minimum % the price must drop below EWMA fair value</small>
                    </div>
                    
                    <!-- Dump: Shock Sigma -->
                    <div class="form-group" id="dump-shock-sigma-group" style="display: none;">
                        <label for="edit-dump-shock-sigma">Shock Sigma (Ïƒ)</label>
                        <input type="number" id="edit-dump-shock-sigma"
                               value="{% if alert.dump_shock_sigma is not None %}{{ alert.dump_shock_sigma }}{% endif %}"
                               step="0.5" min="-20" max="-1" placeholder="e.g. -4">
                        <small class="form-hint">Standard deviations for idiosyncratic drop (more negative = more extreme)</small>
                    </div>
                    
                    <!-- Dump: Liquidity Floor -->
                    <div class="form-group" id="dump-liquidity-floor-group" style="display: none;">
                        <label for="edit-dump-liquidity-floor">Liquidity Floor (GP/hr)</label>
                        <input type="number" id="edit-dump-liquidity-floor"
                               value="{% if alert.dump_liquidity_floor is not None %}{{ alert.dump_liquidity_floor }}{% endif %}"
                               min="0" step="1000000" placeholder="e.g. 50000000">
                        <small class="form-hint">Minimum hourly GP volume for an item to qualify</small>
                    </div>
                    
                    <!-- Dump: Cooldown -->
                    <div class="form-group" id="dump-cooldown-group" style="display: none;">
                        <label for="edit-dump-cooldown">Cooldown (minutes)</label>
                        <input type="number" id="edit-dump-cooldown"
                               value="{% if alert.dump_cooldown is not None %}{{ alert.dump_cooldown }}{% endif %}"
                               min="0" step="5" placeholder="e.g. 60">
                        <small class="form-hint">Minutes before re-alerting on the same item</small>
                    </div>
                    
                    <!-- ======================= TOGGLE BUTTONS SECTION ======================= -->
                    <!-- Toggles appear at end, in order: Active, All Items, Show Alert Notification, SMS Notification -->
                    
                    <!-- 1. Active Toggle -->
                    <div class="form-group toggle-group" id="active-group">
                        <label>Active</label>
                        <div class="toggle-container">
                            <label class="toggle-switch">
                                <input type="checkbox" id="edit-is-active" {% if alert.is_active %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">{% if alert.is_active %}Enabled{% else %}Disabled{% endif %}</span>
                        </div>
                        <small class="form-hint">Enable or disable alert checking</small>
                    </div>
                    
                    <!-- 2. All Items Toggle (spike/spread only) -->
                    <div class="form-group toggle-group" id="all-items-group" style="display: none;">
                        <label>All Items</label>
                        <div class="toggle-container">
                            <label class="toggle-switch">
                                <input type="checkbox" id="edit-all-items" {% if alert.is_all_items %}checked{% endif %} onchange="handleScopeChange()">
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">{% if alert.is_all_items %}Yes{% else %}No{% endif %}</span>
                        </div>
                        <input type="hidden" id="edit-is-all-items" value="{% if alert.is_all_items %}true{% else %}false{% endif %}">
                        <small class="form-hint">Monitor all items in the database</small>
                    </div>
                    
                    <!-- 3. Show Alert Notification -->
                    <div class="form-group toggle-group" id="show-notification-group">
                        <label>Show Alert Notification</label>
                        <div class="toggle-container">
                            <label class="toggle-switch">
                                <input type="checkbox" id="edit-show-notification" {% if alert.show_notification %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">{% if alert.show_notification %}Enabled{% else %}Disabled{% endif %}</span>
                        </div>
                        <small class="form-hint">Show popup notification when triggered</small>
                    </div>
                    
                    <!-- 4. SMS Notification -->
                    <div class="form-group toggle-group" id="sms-group">
                        <label>SMS Notification</label>
                        <div class="toggle-container">
                            <label class="toggle-switch">
                                <input type="checkbox" id="edit-email-notification" {% if alert.email_notification %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">{% if alert.email_notification %}Enabled{% else %}Disabled{% endif %}</span>
                        </div>
                        <small class="form-hint">Send SMS when alert is triggered</small>
                    </div>

                    <!-- =================================================================================
                         Dump Alert: Advanced Detection Settings Toggle Button
                         =================================================================================
                         What: Toggle button to show/hide advanced EWMA and detection parameters.
                         Why:  Placed after SMS notifications (the last common field) so it appears at
                               the bottom of the basic fields section. Matches the scoring weights
                               pattern â€” advanced fields are hidden behind a toggle to reduce clutter.
                         How:  Clicking calls toggleEditDumpAdvanced() which toggles the panel div
                               (#edit-dump-advanced-panel) containing all advanced fields. The panel
                               uses its own .edit-dump-advanced-grid flex layout (2 inputs per row).
                         ================================================================================= -->
                    <div class="form-group" id="edit-dump-advanced-toggle-group" style="display: none;">
                        <button type="button" class="btn-weights-toggle" id="edit-dump-advanced-toggle" onclick="toggleEditDumpAdvanced()">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="14" height="14">
                                <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                            </svg>
                            Advanced Detection Settings
                        </button>
                    </div>
                    <!-- =================================================================================
                         Dump Alert: Advanced Detection Settings Panel
                         =================================================================================
                         What: Collapsible panel containing all advanced dump detection parameters.
                         Why:  Mirrors the scoring weights panel pattern â€” a self-contained panel
                               that sits outside the main .form-grid. Uses its own internal 2-column
                               grid layout (.edit-dump-advanced-grid) so advanced fields appear compact,
                               left-aligned, with two inputs per row â€” matching how scoring weights
                               display for confidence alerts.
                         How:  Panel is toggled by toggleEditDumpAdvanced(). Contains 7 fields
                               (sell ratio, relative volume, 3 half-lives, confirmation buckets,
                               consistency checkbox) in a 2-column flex grid.
                         ================================================================================= -->
                    <div id="edit-dump-advanced-panel" style="display: none; grid-column: 1 / -1;">
                        <div class="edit-dump-advanced-grid">
                            <!-- Dump: Sell Ratio Min -->
                            <div class="form-group edit-dump-advanced-field" id="dump-sell-ratio-min-group">
                                <label for="edit-dump-sell-ratio-min">Min Sell Ratio</label>
                                <input type="number" id="edit-dump-sell-ratio-min"
                                       value="{% if alert.dump_sell_ratio_min is not None %}{{ alert.dump_sell_ratio_min }}{% endif %}"
                                       step="0.05" min="0.5" max="1.0" placeholder="e.g. 0.70">
                                <small class="form-hint">Fraction of 5min volume at low price</small>
                            </div>
                            <!-- Dump: Relative Volume Min -->
                            <div class="form-group edit-dump-advanced-field" id="dump-rel-vol-min-group">
                                <label for="edit-dump-rel-vol-min">Min Relative Volume</label>
                                <input type="number" id="edit-dump-rel-vol-min"
                                       value="{% if alert.dump_rel_vol_min is not None %}{{ alert.dump_rel_vol_min }}{% endif %}"
                                       step="0.5" min="1.0" max="20" placeholder="e.g. 2.5">
                                <small class="form-hint">Volume spike vs EWMA expected</small>
                            </div>
                            <!-- Dump: Fair Value Half-Life -->
                            <div class="form-group edit-dump-advanced-field" id="dump-fair-halflife-group">
                                <label for="edit-dump-fair-halflife">Fair Half-Life (min)</label>
                                <input type="number" id="edit-dump-fair-halflife"
                                       value="{% if alert.dump_fair_halflife is not None %}{{ alert.dump_fair_halflife }}{% endif %}"
                                       step="5" min="10" max="1440" placeholder="e.g. 120">
                                <small class="form-hint">EWMA half-life for fair value</small>
                            </div>
                            <!-- Dump: Volume Half-Life -->
                            <div class="form-group edit-dump-advanced-field" id="dump-vol-halflife-group">
                                <label for="edit-dump-vol-halflife">Vol Half-Life (min)</label>
                                <input type="number" id="edit-dump-vol-halflife"
                                       value="{% if alert.dump_vol_halflife is not None %}{{ alert.dump_vol_halflife }}{% endif %}"
                                       step="5" min="10" max="1440" placeholder="e.g. 60">
                                <small class="form-hint">EWMA half-life for expected volume</small>
                            </div>
                            <!-- Dump: Variance Half-Life -->
                            <div class="form-group edit-dump-advanced-field" id="dump-var-halflife-group">
                                <label for="edit-dump-var-halflife">Var Half-Life (min)</label>
                                <input type="number" id="edit-dump-var-halflife"
                                       value="{% if alert.dump_var_halflife is not None %}{{ alert.dump_var_halflife }}{% endif %}"
                                       step="5" min="10" max="1440" placeholder="e.g. 60">
                                <small class="form-hint">EWMA half-life for return variance</small>
                            </div>
                            <!-- Dump: Confirmation Buckets -->
                            <div class="form-group edit-dump-advanced-field" id="dump-confirmation-buckets-group">
                                <label for="edit-dump-confirmation-buckets">Confirmation Buckets</label>
                                <input type="number" id="edit-dump-confirmation-buckets"
                                       value="{% if alert.dump_confirmation_buckets is not None %}{{ alert.dump_confirmation_buckets }}{% endif %}"
                                       step="1" min="1" max="10" placeholder="e.g. 1">
                                <small class="form-hint">Consecutive 5min buckets required</small>
                            </div>
                        </div>
                        <!-- Dump: Consistency Required Checkbox
                             What: Checkbox for requiring consistency check, placed below the grid
                             Why:  Checkboxes need different layout than number inputs â€” full width row -->
                        <div class="form-check d-flex align-items-center" id="dump-consistency-required-group" style="margin-top: 8px;">
                            <input style="transform: scale(1.35); margin-top: 0;" type="checkbox" class="form-check-input me-2" id="edit-dump-consistency-required"
                                   {% if alert.dump_consistency_required %}checked{% endif %}>
                            <label class="form-check-label" for="edit-dump-consistency-required">
                                Require Consistency Check
                            </label>
                        </div>
                        <small class="form-hint" style="margin-top: 4px;">Leave empty to use defaults.</small>
                    </div>
                    
                    <!-- ======================= REFERENCE PRICES (LAST) ======================= -->
                    
                    <!-- Reference Prices (Baseline) - Non-editable display for threshold alerts -->
                    <div class="form-group form-group-full-width" id="reference-prices-group" style="display: none;">
                        <label>Reference Prices (Baseline)</label>
                        <div id="reference-prices-display" class="reference-prices-display">
                            <span class="no-data">N/A</span>
                        </div>
                        <small class="form-hint">Baseline prices captured when alert was created (not editable)</small>
                    </div>
                    
                    <!-- ===================================================================
                         SCORING WEIGHTS TOGGLE + EDIT INPUTS (Edit Mode) â€” at very end
                         ===================================================================
                         What: Toggle button + collapsible panel for the 5 scoring weights
                         Why: Positioned last in the form so it doesn't interrupt the main
                              config fields; power users can expand it when needed
                         How: Button calls toggleEditWeights() which shows/hides the panel.
                              Each weight input has an 'input' event listener for the live sum.
                    =================================================================== -->
                    <div class="form-group" id="edit-weights-toggle-group" style="display: none; flex-basis: 100%;">
                        <button type="button"
                                class="btn-weights-toggle"
                                onclick="toggleEditWeights()">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                 fill="currentColor" width="14" height="14">
                                <path fill-rule="evenodd"
                                      d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"
                                      clip-rule="evenodd"/>
                            </svg>
                            Scoring Weights
                        </button>
                    </div>
                    <div id="edit-weights-panel" style="display: none; flex-basis: 100%;">
                        <div class="edit-weights-grid">
                            <div class="form-group edit-weight-field">
                                <label for="edit-weight-trend">Trend</label>
                                <input type="number" id="edit-weight-trend"
                                       value="{% if alert.confidence_weight_trend is not None %}{{ alert.confidence_weight_trend }}{% endif %}"
                                       step="0.01" min="0" max="1" placeholder="0.35">
                            </div>
                            <div class="form-group edit-weight-field">
                                <label for="edit-weight-pressure">Pressure</label>
                                <input type="number" id="edit-weight-pressure"
                                       value="{% if alert.confidence_weight_pressure is not None %}{{ alert.confidence_weight_pressure }}{% endif %}"
                                       step="0.01" min="0" max="1" placeholder="0.25">
                            </div>
                            <div class="form-group edit-weight-field">
                                <label for="edit-weight-spread">Spread</label>
                                <input type="number" id="edit-weight-spread"
                                       value="{% if alert.confidence_weight_spread is not None %}{{ alert.confidence_weight_spread }}{% endif %}"
                                       step="0.01" min="0" max="1" placeholder="0.20">
                            </div>
                            <div class="form-group edit-weight-field">
                                <label for="edit-weight-volume">Volume</label>
                                <input type="number" id="edit-weight-volume"
                                       value="{% if alert.confidence_weight_volume is not None %}{{ alert.confidence_weight_volume }}{% endif %}"
                                       step="0.01" min="0" max="1" placeholder="0.10">
                            </div>
                            <div class="form-group edit-weight-field">
                                <label for="edit-weight-stability">Stability</label>
                                <input type="number" id="edit-weight-stability"
                                       value="{% if alert.confidence_weight_stability is not None %}{{ alert.confidence_weight_stability }}{% endif %}"
                                       step="0.01" min="0" max="1" placeholder="0.10">
                            </div>
                        </div>
                        <small class="form-hint">Leave all empty to use defaults. Weights must sum to 1.0.</small>
                        <div id="edit-weight-sum-indicator" class="weight-sum-empty"
                             style="font-size: 13px; font-weight: 600; padding: 6px 0 0 0;">
                            Total: &mdash; / 1.00 (using defaults)
                        </div>
                    </div>
                </div>
                
                <!-- Save/Cancel buttons at bottom of form -->
                <div class="form-actions">
                    <button class="btn-save" onclick="saveChanges()">
                        <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                        Save Changes
                    </button>
                    <button class="btn-cancel" onclick="cancelEdit()">
                        <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Current Market Data (if item has current price) -->
    {# Hide this section for multi-item alerts (All Items or Specific Item(s)) since #}
    {# displaying single item market data doesn't make sense when monitoring multiple items #}
    <!-- 
    {% if current_price.high or current_price.low %}
    {% if not triggered_info.is_all_items and not triggered_info.has_multiple_items %}
    <div class="detail-card price-card">
        <div class="detail-card-header">
            <h3>
                <svg fill="currentColor" viewBox="0 0 20 20"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/></svg>
                Current Market Data
            </h3>
        </div>
        <div class="detail-card-body">
            <div class="price-grid">
                <div class="price-item">
                    <span class="detail-label">High Price</span>
                    <span class="detail-value price positive">{% if current_price.high %}{{ current_price.high|intcomma }}{% else %}N/A{% endif %}</span>
                </div>
                <div class="price-item">
                    <span class="detail-label">Low Price</span>
                    <span class="detail-value price negative">{% if current_price.low %}{{ current_price.low|intcomma }}{% else %}N/A{% endif %}</span>
                </div>
                <div class="price-item">
                    <span class="detail-label">Current Spread</span>
                    <span class="detail-value price highlight">{% if current_price.spread %}{{ current_price.spread }}%{% else %}N/A{% endif %}</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}
    -->
    
    <!-- Alert Triggered Data -->
    {% if triggered_info %}
    <div class="detail-card triggered-card">
        <div class="detail-card-header">
            <h3>
                <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                Alert Triggered Data
            </h3>
        </div>
        <div class="detail-card-body">
            {# Show multi-item list view for both "All Items" alerts AND "Specific Item(s)" alerts with item_ids #}
            {# is_all_items: True when alert monitors all items in the market #}
            {# has_multiple_items: True when alert monitors specific multiple items (item_ids JSON array) #}
            {# We check if items exist AND (is_all_items OR has_multiple_items) to show the multi-item list #}
            {% if triggered_info.items and triggered_info.is_all_items or triggered_info.items and triggered_info.has_multiple_items %}

                <!-- Multi-item alert (All Items or Specific Item(s)) - show scrollable list -->
                <div class="triggered-info-grid">
                    <div class="triggered-info-item">
                        <span class="detail-label">Triggered At</span>
                        <span class="detail-value">{% if triggered_info.triggered_at %}{{ triggered_info.triggered_at|date:"M d, Y H:i" }}{% else %}N/A{% endif %}</span>
                    </div>
                    <div class="triggered-info-item">
                        <span class="detail-label">Items Triggered</span>
                        <span class="detail-value highlight">{{ triggered_info.items|length }}</span>
                    </div>
                </div>
                
                <label style="font-weight: 600; color: #333; margin-bottom: 10px; display: block;">Triggered Items</label>
                <div class="triggered-items-list">
                    <ul>
                    {% for item in triggered_info.items %}
                        <li data-item-id="{{ item.item_id }}">
                            <div>
                                <span class="triggered-item-name">{{ item.item_name }}</span>
                                {% if triggered_info.alert_type == 'spread' %}
                                <div class="triggered-item-details">
                                    Low: {{ item.low|intcomma }} | High: {{ item.high|intcomma }}
                                </div>
                                {% elif triggered_info.alert_type == 'spike' %}
                                <div class="triggered-item-details">
                                    Baseline: {{ item.baseline|intcomma }} | Current: {{ item.current|intcomma }}
                                </div>
                                {% elif triggered_info.alert_type == 'sustained' %}
                                <div class="triggered-item-details">
                                    {{ item.streak_direction|default:""|title }} {{ item.streak_count }} moves | {{ item.start_price|floatformat:0|intcomma }} â†’ {{ item.current_price|floatformat:0|intcomma }} | Pressure Strength : {{ item.pressure_strength }}
                                </div>
                                {% elif triggered_info.alert_type == 'threshold' %}
                                <!-- Threshold alert triggered item details -->
                                <!-- What: Shows reference/target price and current price for threshold alerts -->
                                <!-- Why: Users need to see how the price has changed from baseline (%) or target (value) -->
                                <!-- How: Display appropriate info based on threshold_type (percentage vs value) -->
                                <div class="triggered-item-details">
                                    {% if triggered_info.threshold_type == 'value' %}
                                        Target: {{ item.target_price|intcomma }} | Current: {{ item.current_price|intcomma }} | Direction: {{ item.direction|default:"up"|title }}
                                    {% else %}
                                        Ref: {{ item.reference_price|intcomma }} â†’ Current: {{ item.current_price|intcomma }} | Threshold: {{ item.threshold }}%
                                    {% endif %}
                                </div>
                                {% elif triggered_info.alert_type == 'flip_confidence' %}
                                <!-- =============================================================================
                                     FLIP CONFIDENCE TRIGGERED ITEM DETAILS (Multi-item list view)
                                     What: Shows confidence score details for each triggered item in the list
                                     Why: Users need to see the score, threshold, and trigger rule at a glance
                                     How: Displays threshold and previous score (if available) on the detail line.
                                          The confidence score itself is shown on the right side of the row.
                                ============================================================================= -->
                                <div class="triggered-item-details">
                                    Threshold: {{ item.threshold }} | {% if item.previous_score is not None %}Prev: {{ item.previous_score }}{% else %}Prev: N/A{% endif %} | {% if item.trigger_rule == 'delta_increase' %}Delta Increase{% else %}Crosses Above{% endif %}
                                </div>
                                {% elif triggered_info.alert_type == 'dump' %}
                                <!-- =============================================================================
                                     DUMP ALERT TRIGGERED ITEM DETAILS (Multi-item list view)
                                     What: Shows dump detection details for each triggered item in the list
                                     Why: Users need to see fair value, sell ratio, and spike volume at a glance
                                     How: Displays fair value, sell ratio, and volume on the detail line.
                                          The discount % is shown on the right side of the row.
                                ============================================================================= -->
                                <div class="triggered-item-details">
                                    Fair: {{ item.fair_value|intcomma }} | Sell Ratio: {{ item.sell_ratio }} | Vol: {{ item.spike_volume|intcomma }}
                                </div>
                                {% endif %}
                            </div>
                            {% if triggered_info.alert_type == 'spread' %}
                            <span class="triggered-item-percentage">{{ item.spread }}%</span>
                            {% elif triggered_info.alert_type == 'spike' %}
                            <span class="triggered-item-percentage {% if item.percent_change < 0 %}negative-change{% endif %}">{{ item.percent_change }}%</span>
                            {% elif triggered_info.alert_type == 'sustained' %}
                            <span class="triggered-item-percentage {% if item.streak_direction == 'down' %}negative-change{% endif %}">{{ item.total_move_percent }}%</span>
                            {% elif triggered_info.alert_type == 'threshold' %}
                            <!-- Threshold alert percentage change or status display -->
                            <!-- What: Shows the percentage change (for % type) or crossed status (for value type) -->
                            <!-- Why: Indicates how much the price has moved from baseline or if it crossed target -->
                            <!-- How: For percentage: show change%. For value: show checkmark/crossed indicator -->
                            {% if triggered_info.threshold_type == 'value' %}
                            <span class="triggered-item-percentage">&#10003;</span>
                            {% else %}
                            <span class="triggered-item-percentage {% if item.change_percent < 0 %}negative-change{% endif %}">{{ item.change_percent }}%</span>
                            {% endif %}
                            {% elif triggered_info.alert_type == 'flip_confidence' %}
                            <!-- What: Shows the confidence score as the right-side value for each item row -->
                            <!-- Why: The score is the primary metric users care about for flip confidence -->
                            <!-- How: Displays the score rounded to 1 decimal, always positive so no negative class -->
                            <span class="triggered-item-percentage">{{ item.confidence_score }}</span>
                            {% elif triggered_info.alert_type == 'dump' %}
                            <!-- What: Shows the discount percentage as the right-side value for each dump item -->
                            <!-- Why: The discount % is the primary metric users care about for dump alerts -->
                            <!-- How: Always negative (price below fair), so apply negative-change class for red color -->
                            <span class="triggered-item-percentage negative-change">-{{ item.discount_pct }}%</span>
                            {% endif %}
                        </li>
                    {% endfor %}
                    </ul>
                </div>
            {% else %}
                <!-- Single item alert -->
                <div class="triggered-info-grid">

                    <div class="triggered-info-item">
                        <span class="detail-label">Triggered At</span>
                        <span class="detail-value">{% if triggered_info.triggered_at %}{{ triggered_info.triggered_at|date:"M d, Y H:i" }}{% else %}N/A{% endif %}</span>
                    </div>
                    
                    {% if triggered_info.alert_type == 'spread' %}
                        <div class="triggered-info-item">
                            <span class="detail-label">Low Price</span>
                            <span class="detail-value price negative">{% if triggered_info.spread_low %}{{ triggered_info.spread_low|intcomma }}{% else %}N/A{% endif %}</span>
                        </div>
                        <div class="triggered-info-item">
                            <span class="detail-label">High Price</span>
                            <span class="detail-value price positive">{% if triggered_info.spread_high %}{{ triggered_info.spread_high|intcomma }}{% else %}N/A{% endif %}</span>
                        </div>
                        <div class="triggered-info-item">
                            <span class="detail-label">Spread Percentage</span>
                            <span class="detail-value highlight">{% if triggered_info.spread_percentage %}{{ triggered_info.spread_percentage }}%{% else %}N/A{% endif %}</span>
                        </div>
                    {% elif triggered_info.alert_type == 'spike' and triggered_info.spike_data %}
                        <div class="triggered-info-item">
                            <span class="detail-label">Baseline Price</span>
                            <span class="detail-value price">{% if triggered_info.spike_data.baseline %}{{ triggered_info.spike_data.baseline|intcomma }}{% else %}N/A{% endif %}</span>
                        </div>
                        <div class="triggered-info-item">
                            <span class="detail-label">Current Price</span>
                            <span class="detail-value price">{% if triggered_info.spike_data.current %}{{ triggered_info.spike_data.current|intcomma }}{% else %}N/A{% endif %}</span>
                        </div>
                        <div class="triggered-info-item">
                            <span class="detail-label">Percentage Change</span>
                            <span class="detail-value {% if triggered_info.spike_data.percent_change >= 0 %}positive{% else %}negative{% endif %}">{% if triggered_info.spike_data.percent_change %}{{ triggered_info.spike_data.percent_change }}%{% else %}N/A{% endif %}</span>
                        </div>
                    {% elif triggered_info.alert_type == 'sustained' and triggered_info.sustained_data %}

                        <div class="triggered-info-item">
                            <span class="detail-label">Item</span>
                            <span class="detail-value">{{ triggered_info.sustained_item_name|default:"N/A" }}</span>
                        </div>
                        <div class="triggered-info-item">
                            <span class="detail-label">Direction</span>
                            <span class="detail-value {% if triggered_info.sustained_direction == 'up' %}positive{% else %}negative{% endif %}">{{ triggered_info.sustained_direction|default:"N/A"|title }}</span>
                        </div>
                        <div class="triggered-info-item">
                            <span class="detail-label">Consecutive Moves</span>
                            <span class="detail-value">{{ triggered_info.sustained_streak_count|default:"N/A" }}</span>
                        </div>
                        <div class="triggered-info-item">
                            <span class="detail-label">Total Move</span>
                            <span class="detail-value {% if triggered_info.sustained_direction == 'up' %}positive{% else %}negative{% endif %}">{% if triggered_info.sustained_total_move %}{{ triggered_info.sustained_total_move }}%{% else %}N/A{% endif %}</span>
                        </div>
                        <div class="triggered-info-item">
                            <span class="detail-label">Start Price</span>
                            <span class="detail-value price">{% if triggered_info.sustained_start_price %}{{ triggered_info.sustained_start_price|floatformat:0|intcomma }}{% else %}N/A{% endif %}</span>
                        </div>
                        <div class="triggered-info-item">
                            <span class="detail-label">Current Price</span>
                            <span class="detail-value price">{% if triggered_info.sustained_current_price %}{{ triggered_info.sustained_current_price|floatformat:0|intcomma }}{% else %}N/A{% endif %}</span>
                        </div>
                        {% if triggered_info.sustained_volume %}
                        <div class="triggered-info-item">
                            <span class="detail-label">Hourly Volume (GP)</span>
                            <span class="detail-value">{{ triggered_info.sustained_volume|intcomma }}</span>
                        </div>
                        {% endif %}
                    
                    {% elif triggered_info.alert_type == 'threshold' %}
                        <!-- =============================================================================
                             THRESHOLD ALERT SINGLE ITEM TRIGGERED DATA DISPLAY
                             What: Displays triggered data for single-item threshold alerts
                             Why: Users need to see reference/target price, threshold, and current price
                             How: Grid layout showing all relevant threshold trigger information
                             Note: Value-based thresholds show Target Price instead of Reference Price
                                   and don't show Change % (price just crossed the target)
                        ============================================================================= -->
                        
                        {% if triggered_info.threshold_type == 'value' %}
                            <!-- VALUE-BASED THRESHOLD: Show Target Price, Baseline, and Current Price -->
                            <!-- What: Displays triggered data for value-based threshold alerts -->
                            <!-- Why: Users need to see target price, where the price started (baseline), -->
                            <!--      direction, and current price to understand the full picture -->
                            <!-- How: Baseline price comes from reference_prices captured at alert creation -->
                            <!--      and may be absent for alerts created before this feature was added -->
                            <div class="triggered-info-item">
                                <span class="detail-label">Target Price</span>
                                <span class="detail-value price">{% if triggered_info.threshold_target_price %}{{ triggered_info.threshold_target_price|intcomma }}{% elif alert.target_price %}{{ alert.target_price|intcomma }}{% else %}N/A{% endif %}</span>
                            </div>
                            {% if triggered_info.threshold_baseline_price %}
                            <!-- Baseline Price: The item's price at the time the alert was created. -->
                            <!-- Why: Gives context â€” users can see where the price started relative to -->
                            <!--      the target and current prices. E.g., "started at 12M, target 15M, now 15.2M" -->
                            <div class="triggered-info-item">
                                <span class="detail-label">Baseline Price (At Creation)</span>
                                <span class="detail-value price">{{ triggered_info.threshold_baseline_price|intcomma }}</span>
                            </div>
                            {% endif %}
                            <div class="triggered-info-item">
                                <span class="detail-label">Direction</span>
                                <span class="detail-value">{% if triggered_info.threshold_direction %}{{ triggered_info.threshold_direction|title }}{% elif alert.direction %}{{ alert.direction|title }}{% else %}N/A{% endif %}</span>
                            </div>
                            <div class="triggered-info-item">
                                <span class="detail-label">Current {{ triggered_info.reference|default:"High"|title }} Price</span>
                                <span class="detail-value price highlight">{% if triggered_info.threshold_current_price %}{{ triggered_info.threshold_current_price|intcomma }}{% else %}N/A{% endif %}</span>
                            </div>
                        {% else %}
                            <!-- PERCENTAGE-BASED THRESHOLD: Show Reference Price and Change % -->
                            <div class="triggered-info-item">
                                <span class="detail-label">Reference Price (Baseline)</span>
                                <span class="detail-value price">{% if triggered_info.threshold_reference_price %}{{ triggered_info.threshold_reference_price|intcomma }}{% else %}N/A{% endif %}</span>
                            </div>
                            <div class="triggered-info-item">
                                <span class="detail-label">Threshold</span>
                                <span class="detail-value">{% if triggered_info.threshold_value %}{{ triggered_info.threshold_value }}%{% else %}N/A{% endif %}</span>
                            </div>
                            <div class="triggered-info-item">
                                <span class="detail-label">Current {{ triggered_info.reference|default:"High"|title }} Price</span>
                                <span class="detail-value price {% if triggered_info.threshold_change_percent >= 0 %}positive{% else %}negative{% endif %}">{% if triggered_info.threshold_current_price %}{{ triggered_info.threshold_current_price|intcomma }}{% else %}N/A{% endif %}</span>
                            </div>
                            <div class="triggered-info-item">
                                <span class="detail-label">Change</span>
                                <span class="detail-value {% if triggered_info.threshold_change_percent >= 0 %}positive{% else %}negative{% endif %}">{% if triggered_info.threshold_change_percent %}{{ triggered_info.threshold_change_percent }}%{% else %}N/A{% endif %}</span>
                            </div>
                        {% endif %}
                    
                    {% elif triggered_info.alert_type == 'flip_confidence' %}
                        <!-- =============================================================================
                             FLIP CONFIDENCE ALERT SINGLE ITEM TRIGGERED DATA DISPLAY
                             What: Displays triggered data for single-item flip confidence alerts
                             Why: Users need to see the confidence score, previous score, trigger rule,
                                  threshold, and how many consecutive passes occurred before triggering
                             How: Grid layout showing all confidence-specific trigger information.
                                  Also used as a summary for multi-item alerts when they display
                                  in single-item mode (e.g., when only 1 item is configured).
                        ============================================================================= -->
                        
                        {% if triggered_info.confidence_data %}
                            <div class="triggered-info-item">
                                <!-- What: The computed flip confidence score at the time of triggering -->
                                <span class="detail-label">Confidence Score</span>
                                <span class="detail-value highlight">{% if triggered_info.confidence_score is not None %}{{ triggered_info.confidence_score }}{% else %}N/A{% endif %}</span>
                            </div>
                            <div class="triggered-info-item">
                                <!-- What: The confidence score from the previous evaluation cycle -->
                                <!-- Why: Shows the user how the score changed between evaluations -->
                                <span class="detail-label">Previous Score</span>
                                <span class="detail-value">{% if triggered_info.confidence_previous_score is not None %}{{ triggered_info.confidence_previous_score }}{% else %}N/A{% endif %}</span>
                            </div>
                            <div class="triggered-info-item">
                                <!-- What: How the score was compared against the threshold -->
                                <!-- 'crosses_above' means score >= threshold; 'delta_increase' means -->
                                <!-- the score INCREASED by at least threshold since the last check -->
                                <span class="detail-label">Trigger Rule</span>
                                <span class="detail-value">{% if triggered_info.confidence_trigger_rule == 'delta_increase' %}Delta Increase{% else %}Crosses Above{% endif %}</span>
                            </div>
                            <div class="triggered-info-item">
                                <!-- What: The threshold value the user configured for triggering -->
                                <span class="detail-label">Threshold</span>
                                <span class="detail-value">{% if triggered_info.confidence_threshold is not None %}{{ triggered_info.confidence_threshold }}{% else %}N/A{% endif %}</span>
                            </div>
                            {% if triggered_info.confidence_consecutive %}
                            <div class="triggered-info-item">
                                <!-- What: Number of consecutive evaluations that passed before triggering -->
                                <!-- Why: If the alert has a sustained_count > 1, this shows how many -->
                                <!--      consecutive passes occurred before the alert actually fired -->
                                <span class="detail-label">Consecutive Passes</span>
                                <span class="detail-value">{{ triggered_info.confidence_consecutive }}</span>
                            </div>
                            {% endif %}
                        {% else %}
                            <div class="triggered-info-item">
                                <span class="detail-label">Status</span>
                                <span class="detail-value">Triggered data not available</span>
                            </div>
                        {% endif %}

                    {% elif triggered_info.alert_type == 'collective_move' %}
                        <!-- =============================================================================
                             COLLECTIVE MOVE ALERT TRIGGERED DATA DISPLAY
                             What: Displays triggered data for collective move alerts
                             Why: Users need to see the average change at top, then a table of all items
                             How: Summary stats at top, then full table with baseline/current/change columns
                             Note: Items are sorted by absolute change percent (highest impact first)
                        ============================================================================= -->
                        
                        {% if triggered_info.collective_data %}
                            <!-- Summary Statistics -->
                            <div class="triggered-info-item collective-average-highlight">
                                <span class="detail-label">Average Change</span>
                                <span class="detail-value large {% if triggered_info.collective_data.average_change >= 0 %}positive{% else %}negative{% endif %}">
                                    {% if triggered_info.collective_data.average_change is not None %}{{ triggered_info.collective_data.average_change }}%{% else %}N/A{% endif %}
                                </span>
                            </div>
                            <div class="triggered-info-item">
                                <span class="detail-label">Threshold</span>
                                <span class="detail-value">{% if triggered_info.collective_data.threshold %}{{ triggered_info.collective_data.threshold }}%{% else %}N/A{% endif %}</span>
                            </div>
                            <div class="triggered-info-item">
                                <span class="detail-label">Direction</span>
                                <span class="detail-value">{% if triggered_info.collective_data.effective_direction %}{{ triggered_info.collective_data.effective_direction|title }}{% else %}N/A{% endif %}</span>
                            </div>
                            <div class="triggered-info-item">
                                <span class="detail-label">Calculation</span>
                                <span class="detail-value">{% if triggered_info.collective_data.calculation_method == 'weighted' %}Weighted{% else %}Simple{% endif %}</span>
                            </div>
                            <div class="triggered-info-item">
                                <span class="detail-label">Items Checked</span>
                                <span class="detail-value">{{ triggered_info.collective_data.total_items_checked|default:"N/A" }}</span>
                            </div>
                            <div class="triggered-info-item">
                                <span class="detail-label">Reference</span>
                                <span class="detail-value">{{ triggered_info.collective_data.reference_type|default:"Average"|title }}</span>
                            </div>
                            <div class="triggered-info-item">
                                <span class="detail-label">Time Frame</span>
                                <span class="detail-value">{% if triggered_info.collective_data.time_frame_minutes %}{{ triggered_info.collective_data.time_frame_minutes }} minutes{% else %}N/A{% endif %}</span>
                            </div>
                            
                            <!-- Items Table - Full width below the summary -->
                            {% if triggered_info.collective_data.items %}
                            <div class="collective-items-table-section">
                                <h4 class="collective-table-header">Item Breakdown (sorted by change)</h4>
                                <div class="collective-items-table-wrapper">
                                    <table class="collective-items-table">
                                        <thead>
                                            <tr>
                                                <th>Item</th>
                                                <th class="num-col">Baseline</th>
                                                <th class="num-col">Current</th>
                                                <th class="num-col">Change</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in triggered_info.collective_data.items %}
                                            <tr>
                                                <td class="item-name-cell">{{ item.item_name }}</td>
                                                <td class="num-col">{{ item.reference_price|floatformat:0|intcomma }}</td>
                                                <td class="num-col">{{ item.current_price|floatformat:0|intcomma }}</td>
                                                <td class="num-col {% if item.change_percent >= 0 %}positive{% else %}negative{% endif %}">
                                                    {{ item.change_percent }}%
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% if triggered_info.collective_data.total_items_checked > triggered_info.collective_data.items_in_response %}
                                <p class="collective-items-note">
                                    Showing top {{ triggered_info.collective_data.items_in_response }} items by change magnitude ({{ triggered_info.collective_data.total_items_checked }} total)
                                </p>
                                {% endif %}
                            </div>
                            {% endif %}
                        {% else %}
                            <div class="triggered-info-item">
                                <span class="detail-label">Status</span>
                                <span class="detail-value">Triggered data not available</span>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    <!-- Groups -->
    <div class="detail-card" id="groupsCard">
        <div class="detail-card-header">
            <h3>
                <svg fill="currentColor" viewBox="0 0 20 20"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"/></svg>
                Alert Groups
            </h3>
            <div class="group-controls" id="groupControls">
                <button class="btn-edit" onclick="enterGroupEditMode()">
                    <svg fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/></svg>
                    Edit
                </button>
            </div>
        </div>
        <div class="detail-card-body">
            <!-- Display mode -->
            <div class="groups-display">
                {% if groups %}
                <div class="groups-container">
                    {% for group in groups %}
                    <span class="group-pill">{{ group }}</span>
                    {% endfor %}
                </div>
                {% else %}
                <span class="no-groups">No groups assigned</span>
                {% endif %}
            </div>
            
            <!-- Edit mode -->
            <div class="groups-edit-mode" style="display: none;">
                <div class="form-group">
                    <label>This Alert's Group(s)</label>
                    <p class="form-hint">Groups this alert currently belongs to. Select to unlink.</p>
                    <div id="current-groups-list" class="group-pills-list"></div>
                </div>
                <div class="form-group group-subsection">
                    <label>All Groups</label>
                    <p class="form-hint">Click to select groups to add to this alert</p>
                    <div id="group-pills-list" class="group-pills-list"></div>
                </div>
                <div class="form-group group-subsection">
                    <label for="new-group-input">Add New Group</label>
                    <input type="text" id="new-group-input" placeholder="Enter new group name...">
                </div>
                <div class="form-actions">
                    <button class="btn-unlink" onclick="unlinkSelectedGroups()">
                        <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/></svg>
                        Unlink Selected.
                    </button>
                    <button class="btn-delete" onclick="deleteSelectedGroups()">
                        <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
                        Delete Selected
                    </button>
                    <button class="btn-save" onclick="saveGroups()">
                        <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                        Save
                    </button>
                    <button class="btn-cancel" onclick="cancelGroupEdit()">
                        <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Timestamps -->
    <div class="detail-card">
        <div class="detail-card-header">
            <h3>
                <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/></svg>
                Timestamps
            </h3>
        </div>
        <div class="detail-card-body">
            <div class="timestamp-grid">
                <div class="timestamp-item">
                    <span class="detail-label">Created</span>
                    <span class="detail-value">{{ alert.created_at|date:"M d, Y H:i" }}</span>
                </div>
                {% if alert.triggered_at %}
                <div class="timestamp-item">
                    <span class="detail-label">Last Triggered</span>
                    <span class="detail-value">{{ alert.triggered_at|date:"M d, Y H:i" }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- =============================================================================
     ERROR MODAL
     What: Modal dialog for displaying validation errors
     Why: Provides a nicer user experience than browser alert() dialogs
     How: Hidden by default, shown by JavaScript when validation fails
============================================================================= -->
<div id="error-modal" class="error-modal-overlay">
    <div class="error-modal-content">
        <div class="error-modal-header">
            <svg class="error-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <h3 id="error-modal-title">Error</h3>
        </div>
        <div class="error-modal-body">
            <p id="error-modal-message">An error occurred.</p>
        </div>
        <div class="error-modal-footer">
            <button class="error-modal-btn" onclick="closeErrorModal()">OK</button>
        </div>
    </div>
</div>

<!-- =============================================================================
     NEW GROUP MODAL
     What: Modal dialog for creating a new alert group while editing
     Why: Users need a way to create groups inline without leaving the edit form
     How: Overlay with input field, Create/Cancel buttons, calls createNewGroup()
============================================================================= -->
<div id="new-group-modal" class="new-group-modal-overlay">
    <div class="new-group-modal-content">
        <div class="new-group-modal-header">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
            </svg>
            <h3>Create New Group</h3>
        </div>
        <div class="new-group-modal-body">
            <label for="new-group-name-input">Group Name</label>
            <input type="text" id="new-group-name-input" placeholder="Enter group name..." maxlength="100" autocomplete="off">
            <p class="form-hint">Choose a descriptive name for your alert group</p>
        </div>
        <div class="new-group-modal-footer">
            <button type="button" class="new-group-modal-btn cancel" onclick="closeNewGroupModal()">Cancel</button>
            <button type="button" class="new-group-modal-btn create" id="create-group-btn" onclick="createNewGroup()">Create Group</button>
        </div>
    </div>
</div>

<!-- =============================================================================
     CONFIRM MODAL
     What: Reusable confirmation modal dialog for actions that require user consent
     Why: Replaces browser confirm() dialogs with a styled, consistent modal that
          matches the look and feel of the rest of the application. Designed to be
          reusable â€” any action needing confirmation can call showConfirmModal() with
          a title, message, and callback function.
     How: Hidden by default. JavaScript sets the title, message, and onConfirm
          callback, then adds the 'active' class to show. Cancel dismisses, Confirm
          runs the callback and then dismisses.
============================================================================= -->
<div id="confirm-modal" class="confirm-modal-overlay">
    <div class="confirm-modal-content">
        <div class="confirm-modal-header">
            <!-- Warning/caution triangle icon to visually indicate a cautionary action -->
            <svg class="confirm-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.999L13.732 4.001c-.77-1.333-2.694-1.333-3.464 0L3.34 16.001C2.57 17.334 3.532 19 5.072 19z"/>
            </svg>
            <h3 id="confirm-modal-title">Are you sure?</h3>
        </div>
        <div class="confirm-modal-body">
            <p id="confirm-modal-message">This action cannot be undone.</p>
        </div>
        <div class="confirm-modal-footer">
            <!-- Cancel button: dismisses the modal without taking action -->
            <button class="confirm-modal-btn cancel" onclick="closeConfirmModal()">Cancel</button>
            <!-- Confirm button: executes the stored onConfirm callback, then dismisses -->
            <button class="confirm-modal-btn confirm" id="confirm-modal-action-btn" onclick="executeConfirmAction()">Confirm</button>
        </div>
    </div>
</div>

<!-- =============================================================================
     DELETE ALERT MODAL
     What: Confirmation modal shown when the user attempts to delete the current alert
     Why: Replaces the browser's native confirm() dialog with a styled modal matching
          the deletion modal pattern used across the application (item_detail.html,
          favorites.html, alerts.html). The red trash icon and "Delete" button clearly
          communicate the destructive and irreversible nature of the action.
     How: Hidden by default (display:none). JavaScript adds the 'show' class when the
          user clicks the delete button. Cancel or clicking outside removes 'show'.
          The Delete button triggers the actual API call to delete the alert.
============================================================================= -->
<div class="delete-alert-modal-overlay" id="deleteAlertModal">
    <div class="delete-alert-modal-content">
        <!-- Red circular icon with trash can SVG to visually indicate deletion -->
        <div class="delete-alert-modal-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
        </div>
        <h4 class="delete-alert-modal-title">Delete this alert?</h4>
        <p class="delete-alert-modal-message">This action cannot be undone. The alert and all its settings will be permanently removed.</p>
        <div class="delete-alert-modal-buttons">
            <!-- Cancel button: closes the modal without deleting -->
            <button type="button" class="delete-alert-modal-btn cancel" onclick="closeDeleteAlertModal()">Cancel</button>
            <!-- Delete button: triggers the actual delete API call -->
            <button type="button" class="delete-alert-modal-btn delete" onclick="confirmDeleteAlert()">Delete</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const alertId = {{ alert.id }};
const csrfToken = '{{ csrf_token }}';
let isEditMode = false;
let originalValues = {};

// item_ids_data: Pre-populated list of {id, name} objects for multi-item spread alerts
// Used to initialize the multi-item selector when editing an alert with item_ids
const itemIdsData = {{ item_ids_data_json|safe }};

// =============================================================================
// THRESHOLD ALERT DATA FROM DJANGO
// What: Data passed from Django for threshold alert initialization
// Why: Threshold alerts need reference_prices and other threshold-specific data
// How: Django template variables rendered as JavaScript constants
// =============================================================================
const referencePricesJson = {{ reference_prices_json|safe }};
const itemIdToNameMapping = {{ item_id_to_name_mapping_json|safe }};
const alertThresholdType = '{{ alert.threshold_type|default:"percentage" }}';
const alertTargetPrice = {{ alert.target_price|default:"null" }};

// =============================================================================
// ALERT GROUPS DATA FROM DJANGO
// What: Data about the alert's current groups and all available groups
// Why: Need to populate the group dropdown in the edit form
// How: Django template variables rendered as JavaScript arrays
// Note: allGroups is declared with 'let' later in the code for the groups card,
//       so we use a different variable name here for the edit form
// =============================================================================
// alertGroups: Array of group names this alert currently belongs to
const alertGroups = {{ groups_json|safe }};
// allGroupsForEdit: Array of all group names available for this user (for edit form dropdown)
// Note: Named differently from 'allGroups' which is used by the groups card section
let allGroupsForEdit = {{ all_groups_json|safe }};

// =============================================================================
// COLLECTIVE MOVE TRIGGERED DATA TOGGLE FUNCTION
// What: Toggles visibility of individual items list in collective move triggered data
// Why: Users can expand to see which items contributed to the collective average
// How: Toggles display of items list and updates button aria-expanded state
// =============================================================================
function toggleCollectiveItems() {
    // Get the toggle button and items list elements
    const button = document.querySelector('.btn-toggle-collective-items');
    const itemsList = document.querySelector('.collective-items-list');
    
    // If elements don't exist, exit early
    if (!button || !itemsList) return;
    
    // Check current expanded state
    const isExpanded = button.getAttribute('aria-expanded') === 'true';
    
    if (isExpanded) {
        // Collapse: hide items list and update button state
        itemsList.style.display = 'none';
        button.setAttribute('aria-expanded', 'false');
        // Update button text to show "Show" instead of "Hide"
        button.innerHTML = button.innerHTML.replace('Hide', 'Show');
    } else {
        // Expand: show items list and update button state
        itemsList.style.display = 'block';
        button.setAttribute('aria-expanded', 'true');
        // Update button text to show "Hide" instead of "Show"
        button.innerHTML = button.innerHTML.replace('Show', 'Hide');
    }
}

/**
 * EditMultiItemSelector: Module for managing the multi-item selector in the edit form.
 * 
 * What: Provides item search with dropdown arrow for viewing/removing selected items
 * Why: Spread alerts can monitor multiple specific items, need UI to add/remove items
 * How: Search input with autocomplete, dropdown arrow reveals selected items with remove buttons
 */
const EditMultiItemSelector = {
    // selectedItems: Array of {id, name} objects representing currently selected items
    selectedItems: [],
    // selectedIndex: Index of currently highlighted suggestion in dropdown (-1 = none)
    selectedIndex: -1,
    // isDropdownOpen: Tracks whether the selected items dropdown is currently open
    isDropdownOpen: false,
    // notificationTimeout: Stores timeout ID for auto-hiding notifications
    notificationTimeout: null,

    /**
     * Initializes the edit multi-item selector.
     * Sets up event listeners and pre-populates with existing items if editing.
     */
    init() {
        // DEBUG: Log initialization data
        console.log('DEBUG EditMultiItemSelector.init: itemIdsData =', itemIdsData);
        
        // input: Text input where user types to search for items
        const input = document.getElementById('edit-multi-item-input');
        // suggestionsDropdown: Container showing autocomplete suggestions when typing
        const suggestionsDropdown = document.getElementById('edit-multi-item-suggestions');
        // selectedDropdown: Container showing selected items when arrow is clicked
        const selectedDropdown = document.getElementById('edit-selected-items-dropdown');
        // toggleBtn: The dropdown arrow button
        const toggleBtn = document.getElementById('edit-multi-item-toggle');
        // selectedList: Container for the selected items list
        const selectedList = document.getElementById('edit-selected-items-list');
        // noItemsMsg: Message shown when no items are selected
        const noItemsMsg = document.getElementById('edit-no-items-message');
        // hiddenInput: Hidden field that stores comma-separated item IDs for form submission
        const hiddenInput = document.getElementById('edit-item-ids');

        if (!input || !suggestionsDropdown || !toggleBtn || !hiddenInput) {
            console.log('DEBUG EditMultiItemSelector.init: Missing elements, input=', input, 'suggestionsDropdown=', suggestionsDropdown, 'toggleBtn=', toggleBtn, 'hiddenInput=', hiddenInput);
            return;
        }

        // Pre-populate with existing items from the alert
        this.selectedItems = [...itemIdsData];
        this.selectedIndex = -1;
        this.isDropdownOpen = false;
        this.updateHiddenInput();
        this.renderSelectedItems();
        
        console.log('DEBUG EditMultiItemSelector.init: After init, selectedItems =', this.selectedItems, 'hidden input value =', hiddenInput.value);

        const self = this;

        // Toggle button click - show/hide selected items dropdown
        toggleBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            self.toggleSelectedDropdown();
        });

        // Handle input changes - fetch suggestions from API
        input.addEventListener('input', async () => {
            const query = input.value;

            // Close selected items dropdown when typing
            self.closeSelectedDropdown();

            // minSearchLength: Minimum characters before searching (prevents API spam)
            if (query.length < 2) {
                suggestionsDropdown.style.display = 'none';
                self.selectedIndex = -1;
                return;
            }

            // Fetch matching items from API
            // The item_search_api endpoint at /api/items/ accepts a 'q' query parameter
            try {
                const response = await fetch(`/api/items/?q=${encodeURIComponent(query)}`);
                const items = await response.json();

                // Filter out already selected items from suggestions
                const filteredItems = items.filter(item =>
                    !self.selectedItems.some(selected => String(selected.id) === String(item.id))
                );

                if (filteredItems.length > 0) {
                    suggestionsDropdown.innerHTML = filteredItems.map(item =>
                        `<div class="suggestion-item" data-id="${item.id}" data-name="${item.name}">${item.name}</div>`
                    ).join('');
                    suggestionsDropdown.style.display = 'block';
                    self.selectedIndex = -1;
                } else {
                    suggestionsDropdown.style.display = 'none';
                    self.selectedIndex = -1;
                }
            } catch (error) {
                console.error('Error searching items:', error);
                suggestionsDropdown.style.display = 'none';
            }
        });

        // Handle input focus - close selected dropdown, ready for search
        input.addEventListener('focus', () => {
            self.closeSelectedDropdown();
        });

        // Handle keyboard navigation in suggestions dropdown
        // Tab: Move selection down in the suggestions list
        // Shift+Tab: Move selection up in the suggestions list
        // Enter: Select highlighted suggestion OR submit typed text directly
        // Escape: Close the suggestions dropdown
        // Arrow keys also supported as alternative navigation
        input.addEventListener('keydown', async (e) => {
            // Handle Enter key - can work whether dropdown is open or not
            if (e.key === 'Enter') {
                e.preventDefault();
                
                const dropdownVisible = suggestionsDropdown.style.display !== 'none' && suggestionsDropdown.style.display !== '';
                const items = suggestionsDropdown.querySelectorAll('.suggestion-item');
                
                // If dropdown is visible and an item is selected, add that item
                if (dropdownVisible && self.selectedIndex >= 0 && items.length > 0) {
                    const selectedItem = items[self.selectedIndex];
                    self.addItem(selectedItem.dataset.id, selectedItem.dataset.name);
                    self.showNotification(`Added: ${selectedItem.dataset.name}`, 'success');
                    input.value = '';
                    suggestionsDropdown.style.display = 'none';
                    self.selectedIndex = -1;
                } 
                // No selection or no dropdown - try to find exact match via API
                else if (input.value.trim().length >= 2) {
                    suggestionsDropdown.style.display = 'none';
                    await self.tryAddItemByName(input.value.trim(), input, suggestionsDropdown);
                }
                return;
            }
            
            // Other keys only matter if dropdown is visible with items
            if (suggestionsDropdown.style.display === 'none' || suggestionsDropdown.style.display === '') {
                return;
            }

            const items = suggestionsDropdown.querySelectorAll('.suggestion-item');
            if (items.length === 0) return;

            switch (e.key) {
                case 'Tab':
                    // Tab (no shift) = move down through suggestions
                    // Shift+Tab = move up through suggestions
                    e.preventDefault();  // Prevent focus from leaving the input
                    if (e.shiftKey) {
                        // Shift+Tab: Move up (wrap to bottom if at top)
                        self.selectedIndex = self.selectedIndex <= 0
                            ? items.length - 1
                            : self.selectedIndex - 1;
                    } else {
                        // Tab: Move down (wrap to top if at bottom)
                        self.selectedIndex = (self.selectedIndex + 1) % items.length;
                    }
                    self.updateSuggestionSelection(suggestionsDropdown);
                    break;

                case 'ArrowDown':
                    // Alternative navigation: Arrow down moves selection down
                    e.preventDefault();
                    self.selectedIndex = (self.selectedIndex + 1) % items.length;
                    self.updateSuggestionSelection(suggestionsDropdown);
                    break;

                case 'ArrowUp':
                    // Alternative navigation: Arrow up moves selection up
                    e.preventDefault();
                    self.selectedIndex = self.selectedIndex <= 0
                        ? items.length - 1
                        : self.selectedIndex - 1;
                    self.updateSuggestionSelection(suggestionsDropdown);
                    break;

                case 'Escape':
                    // Escape: Close suggestions without selecting
                    e.preventDefault();
                    suggestionsDropdown.style.display = 'none';
                    self.selectedIndex = -1;
                    break;
            }
        });

        // Handle mouse click on suggestion
        suggestionsDropdown.addEventListener('click', (e) => {
            if (e.target.classList.contains('suggestion-item')) {
                self.addItem(e.target.dataset.id, e.target.dataset.name);
                self.showNotification(`Added: ${e.target.dataset.name}`, 'success');
                input.value = '';
                suggestionsDropdown.style.display = 'none';
            }
        });

        // Handle mouse hover on suggestion
        suggestionsDropdown.addEventListener('mouseover', (e) => {
            if (e.target.classList.contains('suggestion-item')) {
                const items = suggestionsDropdown.querySelectorAll('.suggestion-item');
                items.forEach((item, index) => {
                    if (item === e.target) {
                        self.selectedIndex = index;
                    }
                });
                self.updateSuggestionSelection(suggestionsDropdown);
            }
        });

        // Handle remove button clicks in selected items dropdown (event delegation)
        if (selectedDropdown) {
            selectedDropdown.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-item-btn')) {
                    e.stopPropagation();  // Prevent dropdown from closing
                    const itemId = e.target.dataset.id;
                    if (itemId) {
                        // Get item name before removing for notification
                        const itemToRemove = self.selectedItems.find(item => String(item.id) === String(itemId));
                        const itemName = itemToRemove ? itemToRemove.name : 'Item';
                        self.removeItem(itemId);
                        self.showNotification(`${itemName} deleted`, 'error');
                    }
                }
            });
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            const selectorBox = document.querySelector('.multi-item-selector-box');
            if (selectorBox && !selectorBox.contains(e.target)) {
                suggestionsDropdown.style.display = 'none';
                self.closeSelectedDropdown();
            }
        });
    },

    /**
     * Toggles the selected items dropdown visibility.
     */
    toggleSelectedDropdown() {
        const selectedDropdown = document.getElementById('edit-selected-items-dropdown');
        const toggleBtn = document.getElementById('edit-multi-item-toggle');
        const suggestionsDropdown = document.getElementById('edit-multi-item-suggestions');
        
        if (!selectedDropdown || !toggleBtn) return;

        // Close suggestions dropdown first
        if (suggestionsDropdown) {
            suggestionsDropdown.style.display = 'none';
        }

        this.isDropdownOpen = !this.isDropdownOpen;
        
        if (this.isDropdownOpen) {
            selectedDropdown.classList.add('show');
            toggleBtn.classList.add('active');
            this.renderSelectedItems();
        } else {
            selectedDropdown.classList.remove('show');
            toggleBtn.classList.remove('active');
        }
    },

    /**
     * Closes the selected items dropdown.
     */
    closeSelectedDropdown() {
        const selectedDropdown = document.getElementById('edit-selected-items-dropdown');
        const toggleBtn = document.getElementById('edit-multi-item-toggle');
        
        this.isDropdownOpen = false;
        if (selectedDropdown) selectedDropdown.classList.remove('show');
        if (toggleBtn) toggleBtn.classList.remove('active');
    },

    /**
     * Updates visual selection state in suggestions dropdown.
     */
    updateSuggestionSelection(dropdown) {
        const items = dropdown.querySelectorAll('.suggestion-item');
        items.forEach((item, index) => {
            if (index === this.selectedIndex) {
                item.classList.add('selected');
                item.scrollIntoView({block: 'nearest'});
            } else {
                item.classList.remove('selected');
            }
        });
    },

    /**
     * Adds an item to the selected list.
     * 
     * @param {string} id - Item ID
     * @param {string} name - Item name for display
     */
    addItem(id, name) {
        // Check if already selected to prevent duplicates
        if (this.selectedItems.some(item => String(item.id) === String(id))) {
            return;
        }

        this.selectedItems.push({id: String(id), name});
        this.updateHiddenInput();
        this.renderSelectedItems();
        
        // What: Update threshold type dropdown state after adding an item
        // Why: If user now has multiple items, threshold type must be locked to percentage
        // How: Call updateThresholdTypeState which checks selectedItems.length
        if (typeof updateThresholdTypeState === 'function') {
            updateThresholdTypeState();
        }
    },

    /**
     * Removes an item from the selected list.
     * Also removes the corresponding triggered data entry from the UI display.
     * 
     * What: Removes an item from both the selected items list and triggered data display
     * Why: When user removes an item, it should be removed from all relevant UI sections
     * How: Filters selectedItems array, updates hidden input, re-renders list, and removes triggered data li element
     * 
     * @param {string} id - Item ID to remove
     */
    removeItem(id) {
        this.selectedItems = this.selectedItems.filter(item => String(item.id) !== String(id));
        this.updateHiddenInput();
        this.renderSelectedItems();
        
        // Also remove from triggered data display if present
        // The triggered items list has li elements with data-item-id attribute
        this.removeTriggeredDataItem(id);
        
        // What: Update threshold type dropdown state after removing an item
        // Why: If user now has only one or zero items, threshold type should be unlocked
        // How: Call updateThresholdTypeState which checks selectedItems.length
        if (typeof updateThresholdTypeState === 'function') {
            updateThresholdTypeState();
        }
    },

    /**
     * Removes an item from the triggered data display in the UI.
     * Also updates the "Items Triggered" count displayed on the page.
     * 
     * What: Removes a specific item's triggered data entry from the visible list
     * Why: Keep triggered data display in sync when user removes an item from the alert
     * How: Finds the li element with matching data-item-id and removes it, updates count
     * 
     * @param {string} id - Item ID to remove from triggered data display
     */
    removeTriggeredDataItem(id) {
        // Find the triggered items list
        const triggeredList = document.querySelector('.triggered-items-list ul');
        if (!triggeredList) return;
        
        // Find and remove the li element with matching item id
        const itemToRemove = triggeredList.querySelector(`li[data-item-id="${id}"]`);
        if (itemToRemove) {
            itemToRemove.remove();
            
            // Update the "Items Triggered" count display
            const remainingItems = triggeredList.querySelectorAll('li').length;
            const countDisplay = document.querySelector('.triggered-info-item .detail-value.highlight');
            if (countDisplay) {
                countDisplay.textContent = remainingItems;
            }
            
            // If no items left, hide the entire triggered data section or show a message
            if (remainingItems === 0) {
                const triggeredSection = document.querySelector('.triggered-items-list');
                if (triggeredSection) {
                    triggeredSection.innerHTML = '<p class="no-triggered-data">No triggered data - all items have been removed</p>';
                }
            }
        }
    },

    /**
     * Updates the hidden input with current selected item IDs.
     */
    updateHiddenInput() {
        const hiddenInput = document.getElementById('edit-item-ids');
        if (hiddenInput) {
            const newValue = this.selectedItems.map(item => item.id).join(',');
            // DEBUG: Log when hidden input is updated
            console.log('DEBUG updateHiddenInput: setting edit-item-ids to:', newValue);
            console.log('DEBUG updateHiddenInput: selectedItems =', this.selectedItems);
            hiddenInput.value = newValue;
        }
    },

    /**
     * Renders the selected items in the dropdown list.
     * Shows each item with its name and a red X remove button.
     */
    renderSelectedItems() {
        const selectedList = document.getElementById('edit-selected-items-list');
        const noItemsMsg = document.getElementById('edit-no-items-message');
        
        if (!selectedList) return;
        
        if (this.selectedItems.length === 0) {
            selectedList.innerHTML = '';
            if (noItemsMsg) noItemsMsg.classList.add('show');
        } else {
            if (noItemsMsg) noItemsMsg.classList.remove('show');
            
            // Sort items alphabetically by name before rendering
            // What: Sorts selected items by name for consistent display
            // Why: Easier for users to find and manage items in the list
            // How: Create sorted copy of array, sort by name using localeCompare
            const sortedItems = [...this.selectedItems].sort((a, b) => 
                a.name.localeCompare(b.name)
            );
            
            selectedList.innerHTML = sortedItems.map(item =>
                `<div class="selected-item-row">
                    <span class="item-name">${item.name}</span>
                    <button type="button" class="remove-item-btn" data-id="${item.id}" title="Remove ${item.name}">Ã—</button>
                </div>`
            ).join('');
        }
    },

    /**
     * Shows a small notification next to the "Items" label.
     * 
     * What: Displays success/error feedback for item add operations
     * Why: Provides immediate visual feedback without disruptive popups
     * How: Updates the notification span with text and appropriate class, auto-hides after delay
     * 
     * @param {string} message - The notification message to display
     * @param {string} type - 'success' for green (item added) or 'error' for red (item not found)
     */
    showNotification(message, type) {
        const notification = document.getElementById('item-add-notification');
        if (!notification) return;
        
        // Clear any existing timeout to prevent overlapping notifications
        if (this.notificationTimeout) {
            clearTimeout(this.notificationTimeout);
        }
        
        // Set notification text and style
        notification.textContent = message;
        notification.className = `item-notification ${type} show`;
        
        // Auto-hide after 3 seconds
        this.notificationTimeout = setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    },

    /**
     * Attempts to add an item by searching for an exact name match via API.
     * 
     * What: Looks up item by name when user presses Enter without selecting from dropdown
     * Why: Allows quick entry for users who know exact item names
     * How: Calls API, finds exact match (case-insensitive), adds item or shows error
     * 
     * @param {string} name - The item name to search for
     * @param {HTMLInputElement} input - The input element to clear on success
     * @param {HTMLElement} suggestionsDropdown - The dropdown to hide on success
     */
    async tryAddItemByName(name, input, suggestionsDropdown) {
        try {
            const response = await fetch(`/api/items/?q=${encodeURIComponent(name)}`);
            const items = await response.json();
            
            // Find exact match (case-insensitive)
            const exactMatch = items.find(item => 
                item.name.toLowerCase() === name.toLowerCase()
            );
            
            if (exactMatch) {
                // Check if already selected
                if (this.selectedItems.some(item => String(item.id) === String(exactMatch.id))) {
                    this.showNotification(`Already added: ${exactMatch.name}`, 'error');
                } else {
                    this.addItem(exactMatch.id, exactMatch.name);
                    this.showNotification(`Added: ${exactMatch.name}`, 'success');
                    input.value = '';
                    suggestionsDropdown.style.display = 'none';
                }
            } else {
                // No exact match found
                this.showNotification(`Item not found: "${name}"`, 'error');
            }
        } catch (error) {
            console.error('Error looking up item:', error);
            this.showNotification('Error looking up item', 'error');
        }
    },

    /**
     * Clears all selected items.
     */
    clear() {
        this.selectedItems = [];
        const hiddenInput = document.getElementById('edit-item-ids');
        if (hiddenInput) hiddenInput.value = '';
        this.renderSelectedItems();
    },

    /**
     * Gets the selected item IDs.
     * @returns {Array} Array of item ID strings
     */
    getSelectedIds() {
        return this.selectedItems.map(item => item.id);
    },

    /**
     * Checks if there are any items selected (multi-item mode).
     * @returns {boolean} True if at least one item is selected
     */
    hasMultipleItems() {
        return this.selectedItems.length > 0;
    }
};

// Initialize the multi-item selector when page loads
document.addEventListener('DOMContentLoaded', function() {
    EditMultiItemSelector.init();
    
    // =============================================================================
    // LOCKED INDICATOR EVENT LISTENERS
    // =============================================================================
    // What: Set up click handlers for the threshold type locked indicator and tooltip
    // Why: Users need to click the ðŸš« icon to see why the field is locked
    // How: Add event listeners to toggle tooltip visibility on click
    
    const lockedIndicator = document.getElementById('threshold-type-locked-indicator');
    const lockedTooltip = document.getElementById('threshold-type-locked-tooltip');
    
    if (lockedIndicator && lockedTooltip) {
        // Show tooltip when indicator is clicked
        // What: Toggle tooltip visibility on indicator click
        // Why: Users clicking the ðŸš« want to know why the field is locked
        // How: Toggle display between 'none' and 'block'
        lockedIndicator.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const isVisible = lockedTooltip.style.display === 'block';
            lockedTooltip.style.display = isVisible ? 'none' : 'block';
        });
        
        // Close button click handler - hides the tooltip
        // What: Close the tooltip when X button is clicked
        // Why: Users need a way to dismiss the tooltip after reading
        // How: Set tooltip display to 'none'
        const closeBtn = lockedTooltip.querySelector('.locked-tooltip-close');
        if (closeBtn) {
            closeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                lockedTooltip.style.display = 'none';
            });
        }
        
        // Click outside to close tooltip
        // What: Close tooltip when user clicks anywhere else on the page
        // Why: Standard UX pattern - clicking outside dismisses popups
        // How: Listen for document clicks, close if click is outside tooltip and indicator
        document.addEventListener('click', function(e) {
            if (lockedTooltip.style.display === 'block' &&
                !lockedTooltip.contains(e.target) &&
                !lockedIndicator.contains(e.target)) {
                lockedTooltip.style.display = 'none';
            }
        });
    }
    
    // =============================================================================
    // THRESHOLD ALERT INITIALIZATION
    // What: Initialize threshold-specific fields when page loads
    // Why: Threshold alerts need reference prices display populated and type state updated
    // How: Call initialization functions if this is a threshold alert
    // =============================================================================
    const alertType = '{{ alert.type }}';
    if (alertType === 'threshold') {
        // Populate reference prices display for EDIT mode
        populateReferencePricesDisplay(referencePricesJson, itemIdToNameMapping);
        
        // Populate reference prices display for VIEW mode (non-editing display)
        // What: Shows reference prices in the Alert Configuration card before clicking Edit
        // Why: Users need to see baseline prices without entering edit mode
        // How: Same logic as edit mode but targets the view-mode container
        populateReferencePricesDisplayView(referencePricesJson, itemIdToNameMapping);
        
        // Set threshold type dropdown value
        const thresholdTypeSelect = document.getElementById('edit-threshold-type');
        if (thresholdTypeSelect && alertThresholdType) {
            thresholdTypeSelect.value = alertThresholdType;
        }
        
        // Set target price if value mode
        const targetPriceInput = document.getElementById('edit-target-price');
        if (targetPriceInput && alertTargetPrice) {
            targetPriceInput.value = alertTargetPrice;
        }
    }
});

// Clean up URL parameter after page loads
if (window.location.search.includes('edit_saved=1')) {
    window.history.replaceState({}, document.title, window.location.pathname);
}

// =============================================================================
// GROUP DROPDOWN MANAGEMENT
// What: Functions for managing the group dropdown in the edit form
// Why: Users need to select or create groups for their alerts
// How: Populate dropdown from allGroups, handle selection, create new groups via modal
// =============================================================================

/**
 * Populates the group dropdown with all available groups.
 * What: Fills the group select element with options from allGroups array
 * Why: User needs to see all available groups when editing an alert
 * How: Clear existing options (except "No Group"), add option for each group,
 *      select the current group if one exists
 */
function populateGroupDropdown() {
    const select = document.getElementById('edit-group');
    if (!select) return;
    
    // Clear existing options except the first "No Group" option
    while (select.options.length > 1) {
        select.remove(1);
    }
    
    // Sort groups alphabetically for consistent display
    // What: Creates a sorted copy of allGroupsForEdit array
    // Why: Users expect groups to appear in alphabetical order
    // How: Use localeCompare for proper string sorting
    const sortedGroups = [...allGroupsForEdit].sort((a, b) => a.localeCompare(b));
    
    // Add an option for each group
    // What: Creates <option> elements for each group name
    // Why: Populates the dropdown with available choices
    // How: Loop through sortedGroups, create option, append to select
    sortedGroups.forEach(groupName => {
        const option = document.createElement('option');
        option.value = groupName;
        option.textContent = groupName;
        select.appendChild(option);
    });
    
    // Select the current group if one exists
    // What: Sets the dropdown to show the alert's current group
    // Why: User should see which group the alert currently belongs to
    // How: Check if alertGroups has entries, select the first one (alerts typically have one group)
    if (alertGroups && alertGroups.length > 0) {
        select.value = alertGroups[0];
    }
}

/**
 * Opens the modal for creating a new group.
 * What: Shows the new group modal dialog
 * Why: Users need a way to create groups without leaving the edit form
 * How: Add 'show' class to modal overlay, focus the input field
 */
function openNewGroupModal() {
    const modal = document.getElementById('new-group-modal');
    const input = document.getElementById('new-group-name-input');
    
    // Show the modal
    modal.classList.add('show');
    
    // Clear any previous input and focus
    input.value = '';
    input.focus();
    
    // Add event listener for Enter key
    // What: Allows user to press Enter to create the group
    // Why: Faster workflow than clicking the button
    // How: Listen for keydown, check for Enter, call createNewGroup
    input.onkeydown = function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            createNewGroup();
        } else if (e.key === 'Escape') {
            closeNewGroupModal();
        }
    };
}

/**
 * Closes the new group modal.
 * What: Hides the new group modal dialog
 * Why: User cancelled or finished creating a group
 * How: Remove 'show' class from modal overlay
 */
function closeNewGroupModal() {
    const modal = document.getElementById('new-group-modal');
    modal.classList.remove('show');
}

/**
 * Creates a new group and adds it to the dropdown.
 * What: Validates input, adds new group to dropdown, selects it
 * Why: User wants to create a new group for this alert
 * How: Get input value, validate, add to allGroups array, repopulate dropdown, select new group
 */
function createNewGroup() {
    const input = document.getElementById('new-group-name-input');
    const groupName = input.value.trim();
    
    // Validate input
    // What: Ensure the group name is not empty
    // Why: Empty group names are not allowed
    // How: Check trimmed value length
    if (!groupName) {
        input.focus();
        return;
    }
    
    // Check for duplicates (case-insensitive)
    // What: Prevent creating duplicate groups
    // Why: Group names should be unique per user
    // How: Check if any existing group matches (ignoring case)
    const isDuplicate = allGroupsForEdit.some(g => g.toLowerCase() === groupName.toLowerCase());
    if (isDuplicate) {
        // Show error - group already exists
        input.style.borderColor = '#dc3545';
        setTimeout(() => {
            input.style.borderColor = '';
        }, 2000);
        return;
    }
    
    // Add new group to allGroupsForEdit array
    // What: Adds the new group name to the available groups
    // Why: Makes it available in the dropdown
    // How: Push to array (will be properly sorted when dropdown repopulates)
    allGroupsForEdit.push(groupName);
    
    // Also add to the allGroups array used by the groups card section
    // What: Keeps both group arrays in sync
    // Why: The groups card has its own copy of all groups
    // How: Check if allGroups exists and push to it if so
    if (typeof allGroups !== 'undefined') {
        allGroups.push(groupName);
    }
    
    // Repopulate dropdown with new group included
    populateGroupDropdown();
    
    // Select the newly created group
    // What: Automatically selects the new group in the dropdown
    // Why: User likely wants to use the group they just created
    // How: Set the select value to the new group name
    const select = document.getElementById('edit-group');
    select.value = groupName;
    
    // Close the modal
    closeNewGroupModal();
    
    // Return keyboard focus to the group dropdown after modal closes
    // What: Calls .focus() on the #edit-group select element after successful group creation
    // Why: Accessibility best practice - when a modal closes, focus should return to the 
    //      triggering element or a logical next element. The group dropdown is the logical
    //      location since the user just created a group and that group is now selected.
    // How: Query for #edit-group element, verify it exists (defensive null check to avoid
    //      runtime errors if DOM structure changes), then call .focus() to move keyboard
    //      focus to the dropdown
    // Note: This ensures keyboard-only users can continue their workflow without having to
    //       manually navigate back to the form controls. The check prevents errors if the
    //       element doesn't exist in the DOM.
    const editGroupDropdown = document.getElementById('edit-group');
    if (editGroupDropdown) {
        editGroupDropdown.focus();
    }
}

/**
 * Closes the new group modal when clicking outside of it.
 * What: Click handler for modal overlay backdrop
 * Why: Standard UX pattern - clicking outside modal closes it
 * How: Check if click target is the overlay itself (not the content)
 */
document.addEventListener('click', function(e) {
    const modal = document.getElementById('new-group-modal');
    if (e.target === modal) {
        closeNewGroupModal();
    }
});

function enterEditMode() {
    isEditMode = true;
    document.getElementById('configCard').classList.add('edit-mode');
    document.getElementById('groupsCard').classList.add('edit-mode');
    
    // Store original values for cancel
    storeOriginalValues();
    
    // Populate the group dropdown
    // What: Fills the group dropdown with all available groups and selects current one
    // Why: User needs to see and change which group the alert belongs to
    // How: Clear dropdown, add options for each group, select current group
    populateGroupDropdown();
    
    // Set up form based on current alert type
    handleTypeChange();
}

function storeOriginalValues() {
    originalValues = {
        // alertName: Store the original alert name for cancel restoration
        alertName: document.getElementById('edit-alert-name').value,
        type: document.getElementById('edit-type').value,
        allItems: document.getElementById('edit-all-items').checked,
        itemName: document.getElementById('edit-item-name').value,
        itemId: document.getElementById('edit-item-id').value,
        isAllItems: document.getElementById('edit-is-all-items').value,
        // itemIds: Store the comma-separated item IDs for multi-item alerts
        itemIds: document.getElementById('edit-item-ids').value,
        // multiItems: Store a copy of the selected items array for restoration
        multiItems: [...EditMultiItemSelector.selectedItems],
        price: document.getElementById('edit-price').value,
        reference: document.getElementById('edit-reference').value,
        percentage: document.getElementById('edit-percentage').value,
        timeFrame: document.getElementById('edit-time-frame').value,
        direction: document.getElementById('edit-direction').value,
        minimumPrice: document.getElementById('edit-minimum-price').value,
        maximumPrice: document.getElementById('edit-maximum-price').value,
        // minVolume: Store the min hourly volume input value for cancel restoration
        // What: Captures the current min_volume value from the edit form
        // Why: Cancel should revert any edits to the volume filter for threshold/sustained/spread alerts
        // How: Read directly from the edit-min-volume input field
        minVolume: document.getElementById('edit-min-volume').value,
        emailNotification: document.getElementById('edit-email-notification').checked,
        isActive: document.getElementById('edit-is-active').checked,
        // group: Store the current group selection for cancel restoration
        group: document.getElementById('edit-group').value,
        groups: Array.from(document.querySelectorAll('input[name="groups"]:checked')).map(cb => cb.value)
    };
}

function cancelEdit() {
    isEditMode = false;
    document.getElementById('configCard').classList.remove('edit-mode');
    document.getElementById('groupsCard').classList.remove('edit-mode');
    
    // Restore original values
    document.getElementById('edit-alert-name').value = originalValues.alertName;
    document.getElementById('edit-type').value = originalValues.type;
    document.getElementById('edit-all-items').checked = originalValues.allItems;
    document.getElementById('edit-item-name').value = originalValues.itemName;
    document.getElementById('edit-item-id').value = originalValues.itemId;
    document.getElementById('edit-is-all-items').value = originalValues.isAllItems;
    
    // Restore multi-item selector state
    document.getElementById('edit-item-ids').value = originalValues.itemIds;
    EditMultiItemSelector.selectedItems = [...originalValues.multiItems];
    EditMultiItemSelector.renderSelectedItems();
    EditMultiItemSelector.closeSelectedDropdown();
    
    document.getElementById('edit-price').value = originalValues.price;
    document.getElementById('edit-reference').value = originalValues.reference;
    document.getElementById('edit-percentage').value = originalValues.percentage;
    document.getElementById('edit-time-frame').value = originalValues.timeFrame;
    document.getElementById('edit-direction').value = originalValues.direction;
    document.getElementById('edit-minimum-price').value = originalValues.minimumPrice;
    document.getElementById('edit-maximum-price').value = originalValues.maximumPrice;
    // What: Restore the min hourly volume field to its original value on cancel
    // Why: Users expect the volume filter to revert if they cancel their edits
    // How: Set the edit-min-volume input back to originalValues.minVolume
    document.getElementById('edit-min-volume').value = originalValues.minVolume;
    document.getElementById('edit-email-notification').checked = originalValues.emailNotification;
    document.getElementById('edit-is-active').checked = originalValues.isActive;
    
    // Restore group selection
    // What: Restores the group dropdown to its original value when cancel is clicked
    // Why: User may have changed the group selection but then decided to cancel
    // How: Set the dropdown value back to what was stored in originalValues.group
    document.getElementById('edit-group').value = originalValues.group;
    
    // Restore groups
    document.querySelectorAll('input[name="groups"]').forEach(cb => {
        cb.checked = originalValues.groups.includes(cb.value);
    });
}

function handleTypeChange() {
    const alertType = document.getElementById('edit-type').value;
    
    // Get all form groups
    const groups = {
        allItems: document.getElementById('all-items-group'),
        itemName: document.getElementById('item-name-group'),
        price: document.getElementById('price-group'),
        reference: document.getElementById('reference-group'),
        percentage: document.getElementById('percentage-group'),
        timeFrame: document.getElementById('time-frame-group'),
        direction: document.getElementById('direction-group'),
        minPrice: document.getElementById('min-price-group'),
        maxPrice: document.getElementById('max-price-group'),
        minConsecutiveMoves: document.getElementById('min-consecutive-moves-group'),
        minMovePercentage: document.getElementById('min-move-percentage-group'),
        minVolume: document.getElementById('min-volume-group'),
        volatilityBuffer: document.getElementById('volatility-buffer-group'),
        volatilityMultiplier: document.getElementById('volatility-multiplier-group'),
        pressureStrength: document.getElementById('pressure-strength-group'),
        pressureSpread: document.getElementById('pressure-spread-group'),
        // Threshold-specific groups
        thresholdDirection: document.getElementById('threshold-direction-group'),
        thresholdType: document.getElementById('threshold-type-group'),
        targetPrice: document.getElementById('target-price-group'),
        referencePrices: document.getElementById('reference-prices-group'),
        // Flip confidence-specific groups
        // What: References to all confidence edit form containers
        // Why: handleTypeChange() needs to show/hide these when switching to/from flip_confidence
        confidenceTimestep: document.getElementById('confidence-timestep-group'),
        confidenceLookback: document.getElementById('confidence-lookback-group'),
        confidenceThreshold: document.getElementById('confidence-threshold-group'),
        confidenceTriggerRule: document.getElementById('confidence-trigger-rule-group'),
        confidenceMinSpread: document.getElementById('confidence-min-spread-group'),
        confidenceMinVolume: document.getElementById('confidence-min-volume-group'),
        confidenceCooldown: document.getElementById('confidence-cooldown-group'),
        confidenceEvalInterval: document.getElementById('confidence-eval-interval-group'),
        confidenceSustainedCount: document.getElementById('confidence-sustained-count-group'),
        confidenceWeightsToggle: document.getElementById('edit-weights-toggle-group'),
        confidenceWeightsPanel: document.getElementById('edit-weights-panel'),
        // Dump alert-specific groups
        // What: References to dump basic fields, toggle button, and advanced panel
        // Why: handleTypeChange() needs to show/hide these when switching to/from dump.
        //      Advanced fields are inside the panel (like scoring weights), not individual grid children.
        // How: Basic fields are direct .form-grid children. The toggle button and panel
        //      sit after SMS notifications and contain all advanced fields internally.
        dumpDiscountMin: document.getElementById('dump-discount-min-group'),
        dumpShockSigma: document.getElementById('dump-shock-sigma-group'),
        dumpLiquidityFloor: document.getElementById('dump-liquidity-floor-group'),
        dumpCooldown: document.getElementById('dump-cooldown-group'),
        dumpAdvancedToggle: document.getElementById('edit-dump-advanced-toggle-group'),
        dumpAdvancedPanel: document.getElementById('edit-dump-advanced-panel')
    };
    
    // minVolumeInput: The input element for the minimum hourly volume value
    // What: Direct reference to the numeric input inside the min-volume-group container
    // Why: We need to toggle the required attribute when switching between alert types
    // How: Use document.getElementById to grab the input by its fixed ID
    const minVolumeInput = document.getElementById('edit-min-volume');
    
    // Helper to hide all sustained-specific fields
    const hideSustainedFields = () => {
        if (groups.minConsecutiveMoves) groups.minConsecutiveMoves.style.display = 'none';
        if (groups.minMovePercentage) groups.minMovePercentage.style.display = 'none';
        if (groups.minVolume) groups.minVolume.style.display = 'none';
        // What: Clear the required flag when the min volume field is hidden
        // Why: Only spike/sustained alerts require this field; other alert types must not
        //      be blocked by an invisible required input
        // How: Explicitly set required=false on the input whenever we hide the field
        if (minVolumeInput) minVolumeInput.required = false;
        if (groups.volatilityBuffer) groups.volatilityBuffer.style.display = 'none';
        if (groups.volatilityMultiplier) groups.volatilityMultiplier.style.display = 'none';
        if (groups.pressureStrength) groups.pressureStrength.style.display = 'none';
        if (groups.pressureSpread) groups.pressureSpread.style.display = 'none';
    };
    
    // Helper to hide all threshold-specific fields
    // What: Hides all form fields specific to threshold alerts
    // Why: When switching away from threshold type, these fields should be hidden
    // How: Sets display to 'none' for each threshold-specific field group
    const hideThresholdFields = () => {
        if (groups.thresholdDirection) groups.thresholdDirection.style.display = 'none';
        if (groups.thresholdType) groups.thresholdType.style.display = 'none';
        if (groups.targetPrice) groups.targetPrice.style.display = 'none';
        if (groups.referencePrices) groups.referencePrices.style.display = 'none';
    };
    
    // Helper to hide all flip_confidence-specific fields
    // What: Hides all form fields specific to flip_confidence alerts
    // Why: When switching away from flip_confidence type, these fields should be hidden
    // How: Sets display to 'none' for each confidence-specific field group and the
    //      weights toggle/panel
    const hideConfidenceFields = () => {
        if (groups.confidenceTimestep) groups.confidenceTimestep.style.display = 'none';
        if (groups.confidenceLookback) groups.confidenceLookback.style.display = 'none';
        if (groups.confidenceThreshold) groups.confidenceThreshold.style.display = 'none';
        if (groups.confidenceTriggerRule) groups.confidenceTriggerRule.style.display = 'none';
        if (groups.confidenceMinSpread) groups.confidenceMinSpread.style.display = 'none';
        if (groups.confidenceMinVolume) groups.confidenceMinVolume.style.display = 'none';
        if (groups.confidenceCooldown) groups.confidenceCooldown.style.display = 'none';
        if (groups.confidenceEvalInterval) groups.confidenceEvalInterval.style.display = 'none';
        if (groups.confidenceSustainedCount) groups.confidenceSustainedCount.style.display = 'none';
        if (groups.confidenceWeightsToggle) groups.confidenceWeightsToggle.style.display = 'none';
        if (groups.confidenceWeightsPanel) groups.confidenceWeightsPanel.style.display = 'none';
    };
    
    // Helper to hide all dump-specific fields
    // What: Hides all form fields specific to dump alerts (basic fields + toggle + panel)
    // Why: When switching away from dump type, these fields should be hidden
    // How: Hides the 4 basic fields, the toggle button, and the advanced panel.
    //      The panel contains all 7 advanced fields internally, so hiding the panel
    //      hides them all at once (same pattern as scoring weights).
    const hideDumpFields = () => {
        if (groups.dumpDiscountMin) groups.dumpDiscountMin.style.display = 'none';
        if (groups.dumpShockSigma) groups.dumpShockSigma.style.display = 'none';
        if (groups.dumpLiquidityFloor) groups.dumpLiquidityFloor.style.display = 'none';
        if (groups.dumpCooldown) groups.dumpCooldown.style.display = 'none';
        if (groups.dumpAdvancedToggle) groups.dumpAdvancedToggle.style.display = 'none';
        if (groups.dumpAdvancedPanel) groups.dumpAdvancedPanel.style.display = 'none';
    };
    
    if (alertType === 'spread') {
        // Spread: show all items toggle, percentage, and min volume filter
        // What: Configure edit form fields for spread alert editing
        // Why: Spread alerts support percentage threshold and optional volume filtering
        // How: Show spread-relevant fields plus minVolume for optional volume filtering
        groups.allItems.style.display = 'block';
        groups.price.style.display = 'none';
        groups.reference.style.display = 'none';
        groups.percentage.style.display = 'block';
        groups.timeFrame.style.display = 'none';
        groups.direction.style.display = 'none';
        hideSustainedFields();
        hideThresholdFields();
        hideConfidenceFields();
        hideDumpFields();
        // What: Show min volume field for spread alerts in edit mode
        // Why: Users can filter spread alerts by minimum hourly trading volume (GP)
        //      to exclude low-volume items with artificially inflated spreads
        // How: Override hideSustainedFields() which hides minVolume, and show it explicitly
        if (groups.minVolume) groups.minVolume.style.display = 'block';
        // What: Ensure min volume stays OPTIONAL for spread alerts
        // Why: Spread alerts allow volume filtering but do not require it
        // How: Explicitly set required=false so HTML validation doesn't block saving
        if (minVolumeInput) minVolumeInput.required = false;
        
        // Let scope change handler determine item/min/max visibility
        handleScopeChange();
    } else if (alertType === 'spike') {
        // Spike: show all items toggle, percentage, time frame, direction, reference
        groups.allItems.style.display = 'block';
        groups.price.style.display = 'none';
        groups.reference.style.display = 'block';
        groups.percentage.style.display = 'block';
        groups.timeFrame.style.display = 'block';
        groups.direction.style.display = 'block';
        hideSustainedFields();
        hideThresholdFields();
        hideConfidenceFields();
        hideDumpFields();
        // What: Show and require min volume for spike alerts in edit mode
        // Why: Spike alerts must enforce a minimum hourly volume threshold
        // How: Display the min-volume group and mark the input as required
        if (groups.minVolume) groups.minVolume.style.display = 'block';
        if (minVolumeInput) minVolumeInput.required = true;
        
        // Let scope change handler determine item/min/max visibility
        handleScopeChange();
    } else if (alertType === 'sustained') {
        // Sustained Move: show all items toggle, time frame, direction, reference, sustained-specific fields
        // What: Configure edit form fields for sustained move alert editing
        // Why: Sustained alerts now support reference price selection (High/Low/Average)
        // How: Show all sustained-specific fields plus the reference dropdown
        groups.allItems.style.display = 'block';
        groups.price.style.display = 'none';
        groups.reference.style.display = 'block';  // Show reference selector for sustained alerts
        groups.percentage.style.display = 'none';
        groups.timeFrame.style.display = 'block';
        groups.direction.style.display = 'block';
        hideThresholdFields();
        hideConfidenceFields();
        hideDumpFields();
        
        // Show sustained-specific fields
        if (groups.minConsecutiveMoves) groups.minConsecutiveMoves.style.display = 'block';
        if (groups.minMovePercentage) groups.minMovePercentage.style.display = 'block';
        if (groups.minVolume) groups.minVolume.style.display = 'block';
        // What: Keep min volume required for sustained alerts
        // Why: Sustained move logic depends on volume filtering to avoid low-activity noise
        // How: Mark the min volume input as required when sustained fields are visible
        if (minVolumeInput) minVolumeInput.required = true;
        if (groups.volatilityBuffer) groups.volatilityBuffer.style.display = 'block';
        if (groups.volatilityMultiplier) groups.volatilityMultiplier.style.display = 'block';
        if (groups.pressureStrength) groups.pressureStrength.style.display = 'block';
        if (groups.pressureSpread) groups.pressureSpread.style.display = 'block';
        
        // Let scope change handler determine item/min/max visibility
        handleScopeChange();
    } else if (alertType === 'threshold') {
        // =============================================================================
        // THRESHOLD ALERT TYPE HANDLING
        // What: Shows threshold-specific fields and hides other alert type fields
        // Why: Threshold alerts have unique configuration (threshold_type, target_price, etc.)
        // How: Show direction (up/down), threshold_type, percentage/target_price, reference, min/max
        // =============================================================================
        
        // Show all items toggle for threshold
        groups.allItems.style.display = 'block';
        
        // Hide standard fields used by other types
        groups.price.style.display = 'none';  // Using target_price instead
        groups.direction.style.display = 'none';  // Using threshold-specific direction
        groups.timeFrame.style.display = 'none';
        hideSustainedFields();
        hideConfidenceFields();
        hideDumpFields();
        
        // Show threshold-specific fields
        if (groups.thresholdDirection) groups.thresholdDirection.style.display = 'block';
        if (groups.thresholdType) groups.thresholdType.style.display = 'block';
        if (groups.reference) groups.reference.style.display = 'block';
        if (groups.referencePrices) groups.referencePrices.style.display = 'block';
        // What: Show the min hourly volume field for threshold alerts in edit mode
        // Why: Threshold alerts now support a minimum hourly GP volume filter
        // How: Explicitly display the shared minVolume group that hideSustainedFields() hides
        if (groups.minVolume) groups.minVolume.style.display = 'block';
        
        // Show percentage or target_price based on threshold_type
        handleThresholdTypeChange();
        
        // Update threshold type dropdown state based on item count
        updateThresholdTypeState();
        
        // Let scope change handler determine item/min/max visibility
        handleThresholdScopeChange();
        } else if (alertType === 'collective_move') {
        // =============================================================================
        // COLLECTIVE MOVE ALERT TYPE HANDLING
        // What: Shows collective_move-specific fields and hides other alert type fields
        // Why: Collective move alerts cannot use "All Items" - must specify items
        // How: Hide all items toggle, show item selector, reference, direction, percentage
        // =============================================================================
        
        // Hide all items toggle - collective move must use specific items
        groups.allItems.style.display = 'none';
        
            // Show fields needed for collective move alerts
            groups.itemName.style.display = 'none';  // Using multi-item selector instead
            groups.price.style.display = 'none';
            groups.reference.style.display = 'block';  // Reference price (high/low/average)
            groups.percentage.style.display = 'block';  // Threshold percentage
            groups.timeFrame.style.display = 'block';
            groups.direction.style.display = 'block';  // Direction (up/down/both)
            groups.minPrice.style.display = 'none';
            groups.maxPrice.style.display = 'none';
        
        hideSustainedFields();
        hideThresholdFields();
        hideConfidenceFields();
        hideDumpFields();
        
        // Ensure is_all_items is always false for collective move
        document.getElementById('edit-is-all-items').value = 'false';
        document.getElementById('edit-all-items').checked = false;
        
        // Show the multi-item selector for collective move
        const multiItemGroup = document.getElementById('multi-item-group');
        if (multiItemGroup) multiItemGroup.style.display = 'block';
    } else if (alertType === 'flip_confidence') {
        // =============================================================================
        // FLIP CONFIDENCE ALERT TYPE HANDLING
        // =============================================================================
        // What: Shows all flip_confidence-specific fields and hides fields from other types
        // Why: Flip confidence alerts have their own unique configuration (timestep, lookback,
        //      threshold, trigger rule, min spread, min GP volume, cooldown, eval interval,
        //      sustained count, and scoring weights)
        // How: Hide all shared fields, show confidence-specific fields, and handle scope
        //      (all items vs specific items) for item/price filter visibility
        // =============================================================================
        
        // Show all-items toggle (confidence supports all items mode)
        groups.allItems.style.display = 'block';
        
        // Hide all shared fields that don't apply to flip_confidence
        groups.price.style.display = 'none';
        groups.reference.style.display = 'none';
        groups.percentage.style.display = 'none';
        groups.timeFrame.style.display = 'none';
        groups.direction.style.display = 'none';
        hideSustainedFields();
        hideThresholdFields();
        hideDumpFields();
        
        // Show all confidence-specific fields
        if (groups.confidenceTimestep) groups.confidenceTimestep.style.display = 'block';
        if (groups.confidenceLookback) groups.confidenceLookback.style.display = 'block';
        if (groups.confidenceThreshold) groups.confidenceThreshold.style.display = 'block';
        if (groups.confidenceTriggerRule) groups.confidenceTriggerRule.style.display = 'block';
        if (groups.confidenceMinSpread) groups.confidenceMinSpread.style.display = 'block';
        if (groups.confidenceMinVolume) groups.confidenceMinVolume.style.display = 'block';
        if (groups.confidenceCooldown) groups.confidenceCooldown.style.display = 'block';
        if (groups.confidenceEvalInterval) groups.confidenceEvalInterval.style.display = 'block';
        if (groups.confidenceSustainedCount) groups.confidenceSustainedCount.style.display = 'block';
        if (groups.confidenceWeightsToggle) groups.confidenceWeightsToggle.style.display = 'block';
        // Note: weights panel stays hidden until user clicks the toggle button
        
        // Let scope change handler determine item/min-max price visibility
        handleScopeChange();
    } else if (alertType === 'dump') {
        // =============================================================================
        // DUMP ALERT TYPE HANDLING
        // =============================================================================
        // What: Shows all dump-specific fields and hides fields from other types
        // Why: Dump alerts have their own unique configuration (discount, shock sigma,
        //      liquidity floor, cooldown, and advanced EWMA parameters)
        // How: Hide all shared fields, show dump-specific fields (basic + advanced),
        //      and handle scope (all items vs specific items) for item visibility
        // =============================================================================
        
        // Show all-items toggle (dump supports all items mode)
        groups.allItems.style.display = 'block';
        
        // Hide all shared fields that don't apply to dump
        groups.price.style.display = 'none';
        groups.reference.style.display = 'none';
        groups.percentage.style.display = 'none';
        groups.timeFrame.style.display = 'none';
        groups.direction.style.display = 'none';
        hideSustainedFields();
        hideThresholdFields();
        hideConfidenceFields();
        
        // Show dump-specific fields (basic)
        if (groups.dumpDiscountMin) groups.dumpDiscountMin.style.display = 'block';
        if (groups.dumpShockSigma) groups.dumpShockSigma.style.display = 'block';
        if (groups.dumpLiquidityFloor) groups.dumpLiquidityFloor.style.display = 'block';
        if (groups.dumpCooldown) groups.dumpCooldown.style.display = 'block';
        // Show the advanced toggle button (advanced fields hidden behind it, same as create page)
        // What: Shows the "Advanced Detection Settings" button but keeps the panel collapsed
        // Why: Matches the create-page UX â€” advanced fields are opt-in, reducing clutter
        // How: Only the toggle button is made visible; clicking it calls toggleEditDumpAdvanced()
        if (groups.dumpAdvancedToggle) groups.dumpAdvancedToggle.style.display = 'block';
        
        // Let scope change handler determine item/min-max price visibility
        handleScopeChange();
    } else {
        // NOTE: Above/Below Threshold alerts were removed.
        //
        // What: This branch used to show item/price/reference fields for legacy above/below alert types.
        // Why: If we hit this branch now, it indicates an unsupported/unknown alert type.
        // How: Hide everything to prevent editing/saving malformed alert payloads.
        groups.allItems.style.display = 'none';
        groups.itemName.style.display = 'none';
        groups.price.style.display = 'none';
        groups.reference.style.display = 'none';
        groups.percentage.style.display = 'none';
        groups.timeFrame.style.display = 'none';
        groups.direction.style.display = 'none';
        groups.minPrice.style.display = 'none';
        groups.maxPrice.style.display = 'none';
        hideSustainedFields();
        hideThresholdFields();
        hideConfidenceFields();
        hideDumpFields();
        document.getElementById('edit-is-all-items').value = 'false';
        document.getElementById('edit-all-items').checked = false;
    }
}

// =============================================================================
// CONFIDENCE WEIGHTS TOGGLE FUNCTIONS (View + Edit modes)
// =============================================================================
// What: Toggle visibility of the scoring weights panel in view and edit modes
// Why: Weights are an advanced detail that most users don't need to see;
//      keeping them behind a toggle keeps the UI clean
// How: Each function finds its panel element and toggles display between
//      'none' and 'block'
// =============================================================================

/**
 * toggleViewWeights()
 * What: Toggles the view-mode weights panel visibility
 * Why: Users on the detail view page want to check/hide weights without editing
 * How: Finds #view-weights-panel and toggles between display:none and display:block
 */
function toggleViewWeights() {
    const panel = document.getElementById('view-weights-panel');
    if (!panel) return;
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

/**
 * toggleViewDumpAdvanced()
 *
 * What: Toggles the dump advanced detection settings panel in VIEW mode (read-only).
 * Why:  Mirrors toggleViewWeights() â€” lets users inspect advanced EWMA parameters
 *       without cluttering the main config view. Panel shows read-only values.
 * How:  Finds #view-dump-advanced-panel and toggles display between 'none' and 'block'.
 */
function toggleViewDumpAdvanced() {
    // panel: The read-only panel containing all 7 advanced dump parameter values
    const panel = document.getElementById('view-dump-advanced-panel');
    if (!panel) return;
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

/**
 * toggleCompactView()
 * What: Toggles the .compact-view class on all .detail-grid containers
 * Why: Switches between compact (label + value inline) and expanded (stacked) layouts
 * How: Toggles the class and updates the button text to reflect current state.
 *      The .compact-view class triggers CSS rules that add display:flex to .detail-item
 *      and pill-style padding/width to .detail-label
 */
function toggleCompactView() {
    // grids: All detail-grid containers on the page (config card, triggered data, etc.)
    const grids = document.querySelectorAll('.detail-grid');
    // label: The toggle button's label span, used to update its text
    const label = document.getElementById('compact-toggle-label');

    grids.forEach(grid => grid.classList.toggle('expanded-view'));

    // isExpanded: Whether expanded mode is now active (after the toggle)
    const isExpanded = grids.length > 0 && grids[0].classList.contains('expanded-view');

    // Persist the user's preference in localStorage
    // What: Saves 'compact' or 'expanded' so the choice survives page reloads
    // Why: Users shouldn't have to re-select their preferred layout every visit
    // How: localStorage.setItem stores a simple string value keyed by 'alertDetailViewMode'
    localStorage.setItem('alertDetailViewMode', isExpanded ? 'expanded' : 'compact');

    if (label) {
        // Update label to show what clicking will switch TO
        label.textContent = isExpanded ? 'Compact' : 'Expanded';
    }
}

/**
 * applyCompactViewPreference()
 * What: Reads the saved view mode from localStorage and applies it on page load
 * Why: Persists the user's compact/expanded choice across page reloads and navigation
 * How: Checks localStorage for 'alertDetailViewMode'; if 'expanded', adds .expanded-view
 *      to all grids and updates the button label. Default is compact (no class added).
 */
function applyCompactViewPreference() {
    // savedMode: The persisted view mode string ('compact' or 'expanded'), or null if never set
    const savedMode = localStorage.getItem('alertDetailViewMode');

    if (savedMode === 'expanded') {
        const grids = document.querySelectorAll('.detail-grid');
        grids.forEach(grid => grid.classList.add('expanded-view'));

        const label = document.getElementById('compact-toggle-label');
        if (label) label.textContent = 'Compact';
    }
    // Default is compact â€” no class needed, button already says "Expanded"
}

// Apply saved preference as soon as the DOM is ready
document.addEventListener('DOMContentLoaded', applyCompactViewPreference);

/**
 * toggleEditWeights()
 * What: Toggles the edit-mode weights panel visibility and triggers sum recalc
 * Why: Users editing a confidence alert want to show/hide the weight inputs
 * How: Finds #edit-weights-panel, toggles display, and recalculates the live sum
 *      indicator if the panel is being shown
 */
function toggleEditWeights() {
    const panel = document.getElementById('edit-weights-panel');
    if (!panel) return;
    const isVisible = panel.style.display !== 'none';
    panel.style.display = isVisible ? 'none' : 'block';
    // Recalculate sum indicator when panel is shown
    if (!isVisible) updateEditWeightSum();
}

/**
 * toggleEditDumpAdvanced()
 *
 * What: Toggles the dump advanced detection settings panel on the edit page.
 * Why:  Mirrors the scoring weights toggle pattern â€” a single panel div containing
 *       all advanced fields is shown/hidden as a unit. This keeps them compact,
 *       left-aligned, and visually contained (not scattered across the main grid).
 * How:  Finds the #edit-dump-advanced-panel div and toggles its display between
 *       'none' and 'block'. The panel uses grid-column: 1 / -1 to span the full
 *       width of .form-grid, and contains its own .edit-dump-advanced-grid flex
 *       layout with 2 inputs per row.
 */
function toggleEditDumpAdvanced() {
    // panel: The container holding all 7 advanced dump fields
    const panel = document.getElementById('edit-dump-advanced-panel');
    if (!panel) return;

    // isVisible: Current visibility state of the panel
    const isVisible = panel.style.display !== 'none';
    panel.style.display = isVisible ? 'none' : 'block';
}

/**
 * updateEditWeightSum()
 * What: Recalculates and displays the current sum of all 5 edit-mode weight inputs
 * Why: Provides real-time validation feedback identical to the create form's indicator
 * How: Reads the 5 edit weight inputs, sums them, and updates the indicator div
 *      with the total and a color-coded class (valid/invalid/empty)
 */
function updateEditWeightSum() {
    const indicator = document.getElementById('edit-weight-sum-indicator');
    if (!indicator) return;

    // editWeightIds: Array of the 5 edit-mode weight input element IDs
    const editWeightIds = [
        'edit-weight-trend',
        'edit-weight-pressure',
        'edit-weight-spread',
        'edit-weight-volume',
        'edit-weight-stability',
    ];

    let hasAnyValue = false;
    let sum = 0;

    editWeightIds.forEach(id => {
        const input = document.getElementById(id);
        if (!input) return;
        const val = input.value.trim();
        if (val !== '') {
            hasAnyValue = true;
            sum += parseFloat(val) || 0;
        }
    });

    indicator.classList.remove('weight-sum-valid', 'weight-sum-invalid', 'weight-sum-empty');

    if (!hasAnyValue) {
        indicator.textContent = 'Total: \u2014 / 1.00 (using defaults)';
        indicator.classList.add('weight-sum-empty');
    } else {
        // WEIGHT_SUM_TOLERANCE: Â±0.001 for floating-point rounding tolerance
        const isValid = Math.abs(sum - 1.0) <= 0.001;
        indicator.textContent = 'Total: ' + sum.toFixed(2) + ' / 1.00';
        indicator.classList.add(isValid ? 'weight-sum-valid' : 'weight-sum-invalid');
    }
}

// Attach live-update listeners to all 5 edit-mode weight inputs
// What: Adds 'input' event listeners so the sum indicator updates on every keystroke
// Why: Immediate feedback is better than discovering errors at save time
// How: 'input' event fires on every character change including paste/delete
document.addEventListener('DOMContentLoaded', function () {
    ['edit-weight-trend', 'edit-weight-pressure', 'edit-weight-spread',
     'edit-weight-volume', 'edit-weight-stability'].forEach(id => {
        const input = document.getElementById(id);
        if (input) input.addEventListener('input', updateEditWeightSum);
    });
});

function handleScopeChange() {
    const isAllItems = document.getElementById('edit-all-items').checked;
    const alertType = document.getElementById('edit-type').value;
    const itemNameGroup = document.getElementById('item-name-group');
    const multiItemGroup = document.getElementById('multi-item-group');
    const minPriceGroup = document.getElementById('min-price-group');
    const maxPriceGroup = document.getElementById('max-price-group');
    const isAllItemsInput = document.getElementById('edit-is-all-items');
    const toggleLabel = document.querySelector('#all-items-group .toggle-label');
    
    // hasMultipleItems: Check if this is a multi-item spread alert (has items in the selector)
    const hasMultipleItems = EditMultiItemSelector.hasMultipleItems();
    
    if (isAllItems) {
        // All Items mode: hide item selectors, show price filters
        itemNameGroup.style.display = 'none';
        multiItemGroup.style.display = 'none';
        minPriceGroup.style.display = 'block';
        maxPriceGroup.style.display = 'block';
        isAllItemsInput.value = 'true';
        if (toggleLabel) toggleLabel.textContent = 'Yes';
    } else {
        // Specific item(s) mode
        // What: Show appropriate item selector based on alert type and item count
        // Why: Spread, spike, and sustained alerts with multiple items should use multi-item selector
        //      Single item alerts or other types should use single item input
        // How: Check alert type and hasMultipleItems flag to determine which UI to show
        
        // multiItemAlertTypes: Alert types that support multi-item selection
        // What: List of alert types that can monitor multiple specific items
        // Why: Spread, spike, and sustained alerts can monitor multiple items
        const multiItemAlertTypes = ['spread', 'spike', 'sustained'];
        
        if (multiItemAlertTypes.includes(alertType) && hasMultipleItems) {
            // Multi-item mode for spread/spike alerts with existing items
            // What: Show multi-item selector and hide single item input
            // Why: User is editing a multi-item alert, show the appropriate UI
            itemNameGroup.style.display = 'none';
            multiItemGroup.style.display = 'block';
        } else {
            // Single item mode or no items yet
            // What: Show single item input and hide multi-item selector
            // Why: Either a single-item alert or user hasn't added items yet
            itemNameGroup.style.display = 'block';
            multiItemGroup.style.display = 'none';
        }
        minPriceGroup.style.display = 'none';
        maxPriceGroup.style.display = 'none';
        isAllItemsInput.value = 'false';
        if (toggleLabel) toggleLabel.textContent = 'No';
    }
}

// =============================================================================
// THRESHOLD ALERT HELPER FUNCTIONS
// What: Helper functions for threshold alert editing UI
// Why: Threshold alerts have complex UI logic for type switching and item count restrictions
// How: Separate functions for handling threshold type changes, scope changes, and state updates
// =============================================================================

/**
 * Handles changes to the threshold type dropdown (percentage vs value).
 * What: Shows/hides percentage or target_price input based on selection
 * Why: Percentage mode uses percentage field, value mode uses target_price field
 * How: Toggle display of the relevant input fields
 */
function handleThresholdTypeChange() {
    const thresholdType = document.getElementById('edit-threshold-type');
    const percentageGroup = document.getElementById('percentage-group');
    const targetPriceGroup = document.getElementById('target-price-group');
    const percentageInput = document.getElementById('edit-percentage');
    const targetPriceInput = document.getElementById('edit-target-price');
    
    if (!thresholdType) return;
    
    if (thresholdType.value === 'value') {
        // Value mode: show target price, hide percentage
        if (percentageGroup) percentageGroup.style.display = 'none';
        if (targetPriceGroup) targetPriceGroup.style.display = 'block';
        
        // Clear the percentage input when switching to value mode
        // What: Clears the percentage field when user switches to value threshold
        // Why: Prevents old percentage value from being submitted with value-type alert
        // How: Set the input value to empty string
        if (percentageInput) percentageInput.value = '';
    } else {
        // Percentage mode: show percentage, hide target price
        if (percentageGroup) percentageGroup.style.display = 'block';
        if (targetPriceGroup) targetPriceGroup.style.display = 'none';
        
        // Clear the target price input when switching to percentage mode
        // What: Clears the target price field when user switches to percentage threshold
        // Why: Prevents old target price value from being submitted with percentage-type alert
        // How: Set the input value to empty string
        if (targetPriceInput) targetPriceInput.value = '';
    }
}

/**
 * Updates the threshold type dropdown state based on selected item count.
 * What: Enables/disables threshold type dropdown and shows tooltip when restricted
 * Why: Value-based threshold only allowed for single item; percentage required for multiple
 * How: If more than 1 item selected (or all items mode), force percentage and disable dropdown
 */
function updateThresholdTypeState() {
    const thresholdTypeSelect = document.getElementById('edit-threshold-type');
    // lockedIndicator: The ðŸš« icon that appears when dropdown is locked
    const lockedIndicator = document.getElementById('threshold-type-locked-indicator');
    // lockedTooltip: The explanation popup that appears when indicator is clicked
    const lockedTooltip = document.getElementById('threshold-type-locked-tooltip');
    const isAllItems = document.getElementById('edit-all-items').checked;
    
    if (!thresholdTypeSelect) return;
    
    // Determine if multiple items are selected
    const hasMultipleItems = isAllItems || EditMultiItemSelector.selectedItems.length > 1;
    
    if (hasMultipleItems) {
        // Multiple items: force percentage type, disable dropdown, show locked indicator
        // What: Lock the dropdown and display the locked indicator
        // Why: Value-based thresholds don't work with multiple items (each has different price)
        // How: Disable select, show ðŸš« icon
        thresholdTypeSelect.value = 'percentage';
        thresholdTypeSelect.disabled = true;
        handleThresholdTypeChange();  // Update display
        
        // Show locked indicator
        if (lockedIndicator) lockedIndicator.style.display = 'inline-block';
    } else {
        // Single or no items: allow choice, hide locked indicator
        // What: Unlock the dropdown and hide the locked indicator
        // Why: Value-based thresholds are valid for single item monitoring
        // How: Enable select, hide ðŸš« icon and tooltip
        thresholdTypeSelect.disabled = false;
        
        // Hide locked indicator and tooltip
        if (lockedIndicator) lockedIndicator.style.display = 'none';
        if (lockedTooltip) lockedTooltip.style.display = 'none';
    }
}

/**
 * Handles scope changes specifically for threshold alerts.
 * What: Shows/hides item selector and min/max price fields for threshold alerts
 * Why: Threshold alerts support all-items, multi-item, and single-item modes
 * How: Similar to handleScopeChange but also updates threshold type state
 */
function handleThresholdScopeChange() {
    const isAllItems = document.getElementById('edit-all-items').checked;
    const itemNameGroup = document.getElementById('item-name-group');
    const multiItemGroup = document.getElementById('multi-item-group');
    const minPriceGroup = document.getElementById('min-price-group');
    const maxPriceGroup = document.getElementById('max-price-group');
    const isAllItemsInput = document.getElementById('edit-is-all-items');
    const toggleLabel = document.querySelector('#all-items-group .toggle-label');
    
    const hasMultipleItems = EditMultiItemSelector.hasMultipleItems();
    
    if (isAllItems) {
        // All Items mode: hide item selectors, show price filters
        if (itemNameGroup) itemNameGroup.style.display = 'none';
        if (multiItemGroup) multiItemGroup.style.display = 'none';
        if (minPriceGroup) minPriceGroup.style.display = 'block';
        if (maxPriceGroup) maxPriceGroup.style.display = 'block';
        isAllItemsInput.value = 'true';
        if (toggleLabel) toggleLabel.textContent = 'Yes';
    } else {
        // Specific item(s) mode
        if (hasMultipleItems) {
            if (itemNameGroup) itemNameGroup.style.display = 'none';
            if (multiItemGroup) multiItemGroup.style.display = 'block';
        } else {
            if (itemNameGroup) itemNameGroup.style.display = 'block';
            if (multiItemGroup) multiItemGroup.style.display = 'none';
        }
        if (minPriceGroup) minPriceGroup.style.display = 'none';
        if (maxPriceGroup) maxPriceGroup.style.display = 'none';
        isAllItemsInput.value = 'false';
        if (toggleLabel) toggleLabel.textContent = 'No';
    }
    
    // Always update threshold type state when scope changes
    updateThresholdTypeState();
}

/**
 * Populates the reference prices display with baseline prices.
 * What: Renders the reference_prices data in the non-editable display field
 * Why: Users need to see what baseline prices their threshold is compared against
 * How: Parse JSON data (if string), get item names, format as list of items with prices
 * Note: referencePricesData can be either a string (if from storage) or an object (from Django template)
 */
function populateReferencePricesDisplay(referencePricesData, itemMapping) {
    const display = document.getElementById('reference-prices-display');
    if (!display) return;
    
    if (!referencePricesData) {
        display.innerHTML = '<span class="no-data">N/A</span>';
        return;
    }
    
    try {
        // Handle both string (needs parsing) and object (already parsed from template)
        // What: Normalize input to always be an object
        // Why: Django template outputs JSON directly as JS object literal when using |safe
        // How: Check if string, parse it; if already object, use as-is
        let referencePrices;
        if (typeof referencePricesData === 'string') {
            referencePrices = JSON.parse(referencePricesData);
        } else {
            referencePrices = referencePricesData;
        }
        
        const entries = Object.entries(referencePrices);
        
        if (entries.length === 0) {
            display.innerHTML = '<span class="no-data">N/A</span>';
            return;
        }
        
        // Sort entries alphabetically by item name
        // What: Sorts reference prices by item name for consistent display
        // Why: Easier for users to find specific items in the list
        // How: Map entries to include resolved names, sort by name, then render
        const sortedEntries = entries
            .map(([itemId, price]) => ({
                itemId,
                price,
                itemName: (itemMapping && itemMapping[itemId]) || `Item ${itemId}`
            }))
            .sort((a, b) => a.itemName.localeCompare(b.itemName));
        
        // Build HTML for each item
        let html = '';
        sortedEntries.forEach(({ itemId, price, itemName }) => {
            const formattedPrice = Number(price).toLocaleString();
            html += `
                <div class="reference-price-item">
                    <span class="item-name">${itemName}</span>
                    <span class="item-price">${formattedPrice} gp</span>
                </div>
            `;
        });
        
        display.innerHTML = html;
    } catch (e) {
        display.innerHTML = '<span class="no-data">Error parsing reference prices</span>';
        console.error('Error parsing reference_prices:', e);
    }
}

/**
 * Populates the reference prices display in VIEW mode (non-editing).
 * What: Renders reference_prices data in the Alert Configuration card's display view
 * Why: Users need to see baseline prices before entering edit mode
 * How: Same logic as edit mode display, but targets the view-mode container
 */
function populateReferencePricesDisplayView(referencePricesData, itemMapping) {
    const display = document.getElementById('reference-prices-display-view');
    if (!display) return;
    
    if (!referencePricesData) {
        display.innerHTML = '<span class="no-data">N/A</span>';
        return;
    }
    
    try {
        // Handle both string (needs parsing) and object (already parsed from template)
        let referencePrices;
        if (typeof referencePricesData === 'string') {
            referencePrices = JSON.parse(referencePricesData);
        } else {
            referencePrices = referencePricesData;
        }
        
        const entries = Object.entries(referencePrices);
        
        if (entries.length === 0) {
            display.innerHTML = '<span class="no-data">N/A</span>';
            return;
        }
        
        // Sort entries alphabetically by item name
        // What: Sorts reference prices by item name for consistent display
        // Why: Easier for users to find specific items in the list
        // How: Map entries to include resolved names, sort by name, then render
        const sortedEntries = entries
            .map(([itemId, price]) => ({
                itemId,
                price,
                itemName: (itemMapping && itemMapping[itemId]) || `Item ${itemId}`
            }))
            .sort((a, b) => a.itemName.localeCompare(b.itemName));
        
        // Build HTML for each item
        let html = '';
        sortedEntries.forEach(({ itemId, price, itemName }) => {
            const formattedPrice = Number(price).toLocaleString();
            html += `
                <div class="reference-price-item">
                    <span class="item-name">${itemName}</span>
                    <span class="item-price">${formattedPrice} gp</span>
                </div>
            `;
        });
        
        display.innerHTML = html;
    } catch (e) {
        display.innerHTML = '<span class="no-data">Error parsing reference prices</span>';
        console.error('Error parsing reference_prices:', e);
    }
}

// Update toggle labels when changed
document.getElementById('edit-is-active').addEventListener('change', function() {
    const label = document.querySelector('#active-group .toggle-label');
    if (label) label.textContent = this.checked ? 'Enabled' : 'Disabled';
});

document.getElementById('edit-show-notification').addEventListener('change', function() {
    const label = document.querySelector('#show-notification-group .toggle-label');
    if (label) label.textContent = this.checked ? 'Enabled' : 'Disabled';
});

document.getElementById('edit-email-notification').addEventListener('change', function() {
    const label = document.querySelector('#sms-group .toggle-label');
    if (label) label.textContent = this.checked ? 'Enabled' : 'Disabled';
});

// =============================================================================
// VALIDATION ERROR NOTIFICATION DISPLAY
// =============================================================================
/**
 * Shows a validation error notification at the top of the page.
 * 
 * What: Displays a red notification banner with the error message and a dismiss button
 * Why: Provides immediate visual feedback when form validation fails (e.g., missing
 *      required fields like min/max price when All Items is selected)
 * How: Creates a notification element, appends it to the error-notification-container,
 *      adds click handler for dismiss button, and auto-dismisses after 5 seconds
 * 
 * @param {string} message - The error message to display to the user
 */
function showValidationError(message) {
    // container: The div element where error notifications are displayed
    // Located at the top of the page, after the back-link
    const container = document.getElementById('error-notification-container');
    if (!container) return;
    
    // Remove any existing error notifications before showing new one
    // This prevents multiple error notifications from stacking up
    container.querySelectorAll('.error-notification').forEach(n => n.remove());
    
    // Create the notification element with the error message and dismiss button
    // notification: The red banner element that displays the error
    const notification = document.createElement('div');
    notification.className = 'error-notification';
    notification.innerHTML = `${message}<button class="dismiss-btn" type="button">&times;</button>`;
    
    // Add click handler for the dismiss button
    // Clicking the X triggers the fade-out animation then removes the element
    const dismissBtn = notification.querySelector('.dismiss-btn');
    if (dismissBtn) {
        dismissBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            // Add dismissing class to trigger the slideOutUp animation
            notification.classList.add('dismissing');
            // Remove the element after the animation completes (300ms)
            setTimeout(() => notification.remove(), 300);
        });
    }
    
    // Append the notification to the container
    container.appendChild(notification);
    
    // Scroll to top so user can see the error notification
    // This ensures visibility even if user has scrolled down the page
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // Auto-dismiss after 5 seconds if not manually dismissed
    // This matches the behavior of error notifications in alerts.html
    setTimeout(() => {
        if (notification.parentNode) {
            notification.classList.add('dismissing');
            setTimeout(() => notification.remove(), 300);
        }
    }, 5000);
}

async function saveChanges() {
    const alertType = document.getElementById('edit-type').value;
    const isAllItems = document.getElementById('edit-is-all-items').value === 'true';
    
    // minVolumeVal: Normalized min-volume value for spike alerts (trimmed string)
    // What: Holds the validated min hourly volume input after trimming whitespace
    // Why: Allows reuse later when building the spike alert payload
    // How: Initialized to null and populated during spike validation
    let minVolumeVal = null;
    
    // =============================================================================
    // CLIENT-SIDE VALIDATION: ALL ITEMS REQUIRES MIN/MAX PRICE
    // =============================================================================
    // What: Validates that both minimum and maximum price fields have values when
    //       "All Items" is selected for any alert type during an UPDATE operation
    // Why: When monitoring all items, price range filters are REQUIRED to narrow
    //       down the items being tracked - without them, the alert would monitor
    //       every single item in the database which is impractical and noisy
    // How: Check if isAllItems is true, and if so, verify both edit-minimum-price
    //       and edit-maximum-price inputs have non-empty values. If validation fails,
    //       show an error notification and abort the save operation
    // Note: This validation applies to ALL alert types (spread, spike, sustained, threshold)
    if (isAllItems) {
        // minPriceValue: The value from the minimum price input field
        // maxPriceValue: The value from the maximum price input field
        const minPriceValue = document.getElementById('edit-minimum-price').value;
        const maxPriceValue = document.getElementById('edit-maximum-price').value;
        
        // Both fields must have values when All Items is selected
        // We trim to catch whitespace-only inputs as invalid
        const minMissing = !minPriceValue || minPriceValue.trim() === '';
        const maxMissing = !maxPriceValue || maxPriceValue.trim() === '';
        
        if (minMissing || maxMissing) {
            // Show validation error notification and abort save
            showValidationError('Minimum Price and Maximum Price are required when tracking All Items');
            return;  // Stop save operation - don't send request to server
        }
    }
    
    // =============================================================================
    // CLIENT-SIDE VALIDATION: SPIKE ALERTS REQUIRE MIN HOURLY VOLUME
    // =============================================================================
    // What: Validates that the min hourly volume field is set when editing spike alerts
    // Why: Spike alerts now require this value to prevent low-activity items from triggering
    // How: Check the min-volume input, show validation error, and abort save if missing
    if (alertType === 'spike') {
        // minVolumeVal: Current value from the min hourly volume input field
        // What: Captures the numeric value typed by the user
        // Why: Needed to verify the required spike alert field is not empty
        // How: Read the input value from edit-min-volume for trimming
        minVolumeVal = document.getElementById('edit-min-volume').value;
        
        // trimmedMinVolumeVal: Whitespace-trimmed min volume input
        // What: Normalized string value for validation and payload use
        // Why: Ensures we treat whitespace-only inputs as empty
        // How: Apply .trim() to the raw input value
        const trimmedMinVolumeVal = minVolumeVal.trim();
        
        // What: Prevent save when min volume is missing for spike alerts
        // Why: The new requirement makes this field mandatory for spike alerts
        // How: Treat empty or whitespace-only values as invalid
        if (!trimmedMinVolumeVal) {
            showValidationError('Min Hourly Volume (GP) is required for spike alerts');
            return;  // Stop save operation - don't send request to server
        }
        
        // What: Store the trimmed value for reuse when building the spike payload
        // Why: Avoids re-reading from the DOM and keeps validation consistent
        // How: Assign the trimmed value back to minVolumeVal for later use
        minVolumeVal = trimmedMinVolumeVal;
    }
    
    // Get item_ids from multi-item selector
    // item_ids: Comma-separated string of item IDs for multi-item spread alerts
    // We always send the current value (even if empty string) so the backend knows
    // the user explicitly cleared items vs not touching the field
    const itemIds = document.getElementById('edit-item-ids').value;
    
    // DEBUG: Log item_ids value being sent
    console.log('DEBUG saveChanges: edit-item-ids value =', itemIds);
    console.log('DEBUG saveChanges: EditMultiItemSelector.selectedItems =', EditMultiItemSelector.selectedItems);
    
    const data = {
        type: alertType,
        // name: User-editable alert name
        name: document.getElementById('edit-alert-name').value || null,
        item_name: document.getElementById('edit-item-name').value || null,
        item_id: document.getElementById('edit-item-id').value || null,
        is_all_items: isAllItems,
        // item_ids: For multi-item spread alerts, send the value (can be empty string)
        // Empty string means user cleared all items, backend will handle appropriately
        item_ids: itemIds,
        email_notification: document.getElementById('edit-email-notification').checked,
        // show_notification: Controls whether notification banner appears when alert triggers
        show_notification: document.getElementById('edit-show-notification').checked,
        is_active: document.getElementById('edit-is-active').checked,
        // groups: Array of group names this alert belongs to
        // What: Collects the selected group from the dropdown
        // Why: Backend expects an array of group names to set for this alert
        // How: Get dropdown value, wrap in array if not empty, otherwise empty array
        groups: (function() {
            const selectedGroup = document.getElementById('edit-group').value;
            // If a group is selected, return it as an array
            // If "No Group" (empty string) is selected, return empty array to clear groups
            return selectedGroup ? [selectedGroup] : [];
        })()
    };
    
    // Type-specific fields
    // NOTE: Above/Below Threshold alert types were removed.
    // What: Previously sent "price" + "reference" for legacy above/below alert types.
    // Why: Keeping that branch would imply those types are still supported.
    // How: We now only send type-specific fields for supported types.
    if (alertType === 'spread') {
        data.percentage = document.getElementById('edit-percentage').value || null;
        // What: Include min_volume in spread alert save data
        // Why: Spread alerts now support optional minimum hourly volume (GP) filtering
        //      to ensure only actively-traded items trigger spread alerts
        // How: Read the value from the min-volume input field; null if not set
        data.min_volume = document.getElementById('edit-min-volume').value || null;
        if (isAllItems) {
            data.minimum_price = document.getElementById('edit-minimum-price').value || null;
            data.maximum_price = document.getElementById('edit-maximum-price').value || null;
        }
    } else if (alertType === 'spike') {
        data.percentage = document.getElementById('edit-percentage').value || null;
        data.time_frame = document.getElementById('edit-time-frame').value || null;
        data.direction = document.getElementById('edit-direction').value || 'both';
        // Reference defaults to 'average' for spike alerts
        data.reference = document.getElementById('edit-reference').value || 'average';
        // What: Include min_volume in spike alert save data
        // Why: Spike alerts now require a minimum hourly volume threshold
        // How: Use the validated, trimmed minVolumeVal from the spike validation block
        data.min_volume = minVolumeVal;
        if (isAllItems) {
            data.minimum_price = document.getElementById('edit-minimum-price').value || null;
            data.maximum_price = document.getElementById('edit-maximum-price').value || null;
        }
    } else if (alertType === 'sustained') {
        data.time_frame = document.getElementById('edit-time-frame').value || null;
        data.direction = document.getElementById('edit-direction').value || 'both';
        // Reference defaults to 'average' for sustained alerts
        // What: Include reference price type when saving sustained alerts
        // Why: Sustained alerts now support reference selection (High/Low/Average)
        // How: Get value from edit-reference dropdown, default to 'average'
        data.reference = document.getElementById('edit-reference').value || 'average';
        data.min_consecutive_moves = document.getElementById('edit-min-consecutive-moves').value || null;
        data.min_move_percentage = document.getElementById('edit-min-move-percentage').value || null;
        data.min_volume = document.getElementById('edit-min-volume').value || null;
        data.volatility_buffer_size = document.getElementById('edit-volatility-buffer-size').value || null;
        data.volatility_multiplier = document.getElementById('edit-volatility-multiplier').value || null;
        data.min_pressure_strength = document.getElementById('edit-pressure-strength').value || null;
        data.min_pressure_spread_pct = document.getElementById('edit-pressure-spread').value || null;
        if (isAllItems) {
            data.minimum_price = document.getElementById('edit-minimum-price').value || null;
            data.maximum_price = document.getElementById('edit-maximum-price').value || null;
        }
    } else if (alertType === 'threshold') {
        // =============================================================================
        // THRESHOLD ALERT SAVE DATA
        // What: Collect threshold-specific field values for saving
        // Why: Threshold alerts have unique fields (threshold_type, target_price, direction)
        // How: Get values from threshold-specific form inputs
        // =============================================================================
        
        // Get threshold type (percentage or value)
        const thresholdType = document.getElementById('edit-threshold-type').value || 'percentage';
        
        // =============================================================================
        // VALIDATE: Value type not allowed with multiple items
        // What: Prevent saving a value-based threshold alert with multiple items
        // Why: Value thresholds only make sense for a single item (specific price target)
        // How: Check if value type AND (all items OR multiple items selected), show error modal
        // =============================================================================
        const hasMultipleItems = isAllItems || EditMultiItemSelector.selectedItems.length > 1;
        if (thresholdType === 'value' && hasMultipleItems) {
            showErrorModal(
                'Invalid Configuration',
                'Value-based thresholds can only be used when tracking a single item. Please switch to percentage mode, or select only one item to track.'
            );
            return;  // Stop save operation
        }
        
        data.threshold_type = thresholdType;
        
        // Get direction from threshold-specific direction dropdown (up/down only)
        const thresholdDirection = document.getElementById('edit-threshold-direction');
        data.direction = thresholdDirection ? thresholdDirection.value : 'up';
        
        // Get reference price type
        // What: Include reference price type when saving threshold alerts
        // Why: Reference determines which price (high/low/average) to compare against
        // How: Get value from dropdown, default to 'average' for consistency
        data.reference = document.getElementById('edit-reference').value || 'average';
        
        // Get percentage or target_price based on threshold_type
        if (thresholdType === 'value') {
            data.target_price = document.getElementById('edit-target-price').value || null;
            data.percentage = null;  // Clear percentage for value mode
        } else {
            data.percentage = document.getElementById('edit-percentage').value || null;
            data.target_price = null;  // Clear target_price for percentage mode
        }
        
        // Min/max price for all-items mode
        if (isAllItems) {
            data.minimum_price = document.getElementById('edit-minimum-price').value || null;
            data.maximum_price = document.getElementById('edit-maximum-price').value || null;
        }
        
        // What: Include minimum hourly volume for threshold alerts
        // Why: Threshold alerts can filter out low-liquidity items using min_volume
        // How: Read from the shared edit-min-volume input; send null if blank
        data.min_volume = document.getElementById('edit-min-volume').value || null;
    } else if (alertType === 'collective_move') {
        // =============================================================================
        // COLLECTIVE MOVE ALERT SAVE DATA
        // What: Collect collective_move-specific field values for saving
        // Why: Collective move alerts have unique fields (percentage threshold, direction,
        //      reference type, calculation_method) that need to be sent to the server
        // How: Get values from the shared form inputs used by collective_move alerts
        // =============================================================================
        
        // percentage: The threshold percentage for average price change
        // What: How much the average price change must exceed to trigger the alert
        // Why: Core setting for collective move - triggers when avg change >= this value
        data.percentage = document.getElementById('edit-percentage').value || null;
        
        // direction: Which direction of price movement to monitor (up/down/both)
        // What: Filter to only trigger on upward, downward, or any price movement
        // Why: Users may only care about prices going up (or down)
        data.direction = document.getElementById('edit-direction').value || 'both';
        
        // reference: Which price to use as baseline (high/low/average)
        // What: Determines which OSRS price value to compare against
        // Why: Different trading strategies may prefer different reference points
        data.reference = document.getElementById('edit-reference').value || 'average';
        
        // calculation_method: How to calculate the average (simple/weighted)
        // What: Simple = arithmetic mean, Weighted = value-weighted mean
        // Why: Weighted gives more influence to expensive items
        // Note: This field may not exist in the edit form yet - check if element exists
        const calcMethodEl = document.getElementById('edit-calculation-method');
        if (calcMethodEl) {
            data.calculation_method = calcMethodEl.value || 'simple';
        }
        
        // time_frame: Rolling window (minutes) for collective move comparisons
        // What: The number of minutes back to compare against current prices
        // Why: Collective move alerts require a time window to compute baseline changes
        // How: Read from the shared edit-time-frame input used for time-frame alert types
        data.time_frame = document.getElementById('edit-time-frame').value || null;
    } else if (alertType === 'flip_confidence') {
        // =============================================================================
        // FLIP CONFIDENCE ALERT SAVE DATA
        // =============================================================================
        // What: Collect all flip_confidence-specific field values for saving
        // Why: Flip confidence alerts have 9 config fields + 5 optional weight fields
        //      that need to be sent to the backend
        // How: Read each confidence-specific input by its 'edit-confidence-*' ID,
        //      collect weights separately (only if user has set any), then validate
        //      that weights sum to 1.0 if any are provided
        // =============================================================================
        
        // confidence_timestep: The timeseries resolution (e.g. '5m', '1h')
        data.confidence_timestep = document.getElementById('edit-confidence-timestep').value || '5m';
        
        // confidence_lookback: Number of data points to analyze
        data.confidence_lookback = document.getElementById('edit-confidence-lookback').value || null;
        
        // confidence_threshold: Minimum confidence score (0-100) to trigger
        data.confidence_threshold = document.getElementById('edit-confidence-threshold').value || null;
        
        // confidence_trigger_rule: 'any' = any single check, 'sustained' = N consecutive checks
        data.confidence_trigger_rule = document.getElementById('edit-confidence-trigger-rule').value || 'any';
        
        // confidence_min_spread_pct: Minimum buy/sell spread percentage to qualify
        data.confidence_min_spread_pct = document.getElementById('edit-confidence-min-spread').value || null;
        
        // confidence_min_volume: Minimum total GP volume across the lookback window
        data.confidence_min_volume = document.getElementById('edit-confidence-min-volume').value || null;
        
        // confidence_cooldown: Minutes to wait after triggering before re-triggering
        data.confidence_cooldown = document.getElementById('edit-confidence-cooldown').value || null;
        
        // confidence_eval_interval: Minutes between evaluation cycles
        data.confidence_eval_interval = document.getElementById('edit-confidence-eval-interval').value || null;
        
        // confidence_sustained_count: Number of consecutive above-threshold checks for 'sustained' rule
        data.confidence_sustained_count = document.getElementById('edit-confidence-sustained-count').value || null;
        
        // =========================================================================
        // WEIGHT COLLECTION AND VALIDATION
        // =========================================================================
        // What: Collect the 5 scoring weight values (trend, pressure, spread, volume, stability)
        // Why: Weights are optional â€” if any are set, ALL 5 must be set and must sum to 1.0
        // How: Read each weight input, apply all-or-nothing validation,
        //      then validate sum Â±0.001 tolerance
        // =========================================================================
        
        // weightInputIds: Maps each weight field name to its edit input element ID
        const weightInputIds = {
            confidence_weight_trend: 'edit-weight-trend',
            confidence_weight_pressure: 'edit-weight-pressure',
            confidence_weight_spread: 'edit-weight-spread',
            confidence_weight_volume: 'edit-weight-volume',
            confidence_weight_stability: 'edit-weight-stability',
        };
        
        // weightValues: Object collecting each weight's parsed value (null if input is empty)
        const weightValues = {};
        // filledCount: Number of weight inputs that have a non-empty value
        let filledCount = 0;
        // weightSum: Running sum of all filled weight values for validation
        let weightSum = 0;
        
        for (const [fieldName, inputId] of Object.entries(weightInputIds)) {
            const el = document.getElementById(inputId);
            const val = el ? el.value.trim() : '';
            if (val !== '') {
                weightValues[fieldName] = parseFloat(val);
                weightSum += weightValues[fieldName];
                filledCount++;
            } else {
                weightValues[fieldName] = null;
            }
        }
        
        // All-or-nothing validation: partial weights (some filled, some empty) are invalid
        if (filledCount > 0 && filledCount < 5) {
            showValidationError(
                'All 5 scoring weights must be filled in, or leave all blank for defaults.'
            );
            return;
        }
        
        // Sum validation: if all 5 are filled, they must sum to 1.0 within tolerance
        if (filledCount === 5) {
            // WEIGHT_SUM_TOLERANCE: Â±0.001 floating-point rounding tolerance
            if (Math.abs(weightSum - 1.0) > 0.001) {
                showValidationError(
                    'Scoring weights must sum to 1.0. Current total: ' + weightSum.toFixed(3)
                );
                return;
            }
            // Include weights in the save payload
            Object.assign(data, weightValues);
        }
        // If filledCount === 0, we don't send weight fields â†’ backend keeps existing values
        
        // Min/max price for all-items mode
        if (isAllItems) {
            data.minimum_price = document.getElementById('edit-minimum-price').value || null;
            data.maximum_price = document.getElementById('edit-maximum-price').value || null;
        }
    } else if (alertType === 'dump') {
        // =============================================================================
        // DUMP ALERT SAVE DATA
        // =============================================================================
        // What: Collect all dump-specific field values for saving
        // Why: Dump alerts have 11 config fields (4 basic + 7 advanced) that need to be
        //      sent to the backend when editing
        // How: Read each dump-specific input by its 'edit-dump-*' ID and add to data object
        // =============================================================================
        
        // Basic fields
        // dump_discount_min: Minimum % discount below fair value to trigger
        data.dump_discount_min = document.getElementById('edit-dump-discount-min').value || null;
        // dump_shock_sigma: Standard deviations of idiosyncratic shock required
        data.dump_shock_sigma = document.getElementById('edit-dump-shock-sigma').value || null;
        // dump_liquidity_floor: Minimum hourly GP volume for an item to qualify
        data.dump_liquidity_floor = document.getElementById('edit-dump-liquidity-floor').value || null;
        // dump_cooldown: Minutes after triggering before re-triggering
        data.dump_cooldown = document.getElementById('edit-dump-cooldown').value || null;
        
        // Advanced fields
        // dump_sell_ratio_min: Fraction of volume at low price
        data.dump_sell_ratio_min = document.getElementById('edit-dump-sell-ratio-min').value || null;
        // dump_rel_vol_min: Minimum relative volume vs expected
        data.dump_rel_vol_min = document.getElementById('edit-dump-rel-vol-min').value || null;
        // dump_fair_halflife: EWMA half-life for fair value in minutes
        data.dump_fair_halflife = document.getElementById('edit-dump-fair-halflife').value || null;
        // dump_vol_halflife: EWMA half-life for expected volume in minutes
        data.dump_vol_halflife = document.getElementById('edit-dump-vol-halflife').value || null;
        // dump_var_halflife: EWMA half-life for return variance in minutes
        data.dump_var_halflife = document.getElementById('edit-dump-var-halflife').value || null;
        // dump_confirmation_buckets: Consecutive 5m buckets required before trigger
        data.dump_confirmation_buckets = document.getElementById('edit-dump-confirmation-buckets').value || null;
        // dump_consistency_required: Whether majority of rows must show sell pressure
        const dumpConsistencyEl = document.getElementById('edit-dump-consistency-required');
        data.dump_consistency_required = dumpConsistencyEl ? dumpConsistencyEl.checked : true;
        
        // Min/max price for all-items mode
        if (isAllItems) {
            data.minimum_price = document.getElementById('edit-minimum-price').value || null;
            data.maximum_price = document.getElementById('edit-maximum-price').value || null;
        }
    }
    
    try {
        const response = await fetch(`/api/alerts/${alertId}/update/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Clear notification caches for this alert so it can trigger fresh
            try {
                // Remove from dismissed notifications
                const dismissed = JSON.parse(localStorage.getItem('dismissedAlertNotifications') || '[]');
                const filteredDismissed = dismissed.filter(id => String(id) !== String(alertId));
                localStorage.setItem('dismissedAlertNotifications', JSON.stringify(filteredDismissed));
                
                // Remove from active notifications
                const active = JSON.parse(localStorage.getItem('activeAlertNotifications') || '{}');
                delete active[String(alertId)];
                localStorage.setItem('activeAlertNotifications', JSON.stringify(active));
                
                // Remove tracked triggered items for this alert
                localStorage.removeItem('alertTriggeredItems_' + alertId);
            } catch (e) {
                console.error('Error clearing notification caches:', e);
            }
            
            // Check if the alert was deleted (all items removed)
            // What: Handles the case where removing all items from an alert causes it to be deleted
            // Why: An alert with no items to track is invalid, so the backend deletes it
            // How: If the response contains 'deleted: true', redirect to alerts page with notification
            //      Otherwise, reload the current page to show saved changes
            if (result.deleted) {
                // Alert was deleted because all items were removed
                // Redirect to alerts page with a notification message
                window.location.href = result.redirect + '?deleted=1';
            } else {
                // Normal save - redirect with edit_saved parameter to show notification
                window.location.href = window.location.pathname + '?edit_saved=1';
            }
        } else {
            // =============================================================================
            // HANDLE SERVER-SIDE VALIDATION ERRORS WITH REDIRECT
            // =============================================================================
            // What: Checks if the server response includes a redirect URL (e.g., for validation errors)
            // Why: When server-side validation fails (e.g., missing min/max price for All Items),
            //       the server returns an error with a redirect URL to send the user back to /alerts/
            // How: If result.redirect exists, redirect to that URL. Otherwise, show the error modal.
            if (result.redirect) {
                // Server requested a redirect (e.g., validation failed)
                // Store error message in sessionStorage so it can be displayed on the alerts page
                // The alerts page will check for this and show the notification
                sessionStorage.setItem('alertValidationError', result.error || 'An error occurred');
                window.location.href = result.redirect;
            } else {
                showErrorModal('Error Saving', result.error || 'An unknown error occurred while saving changes.');
            }
        }
    } catch (error) {
        console.error('Error:', error);
        showErrorModal('Connection Error', 'Unable to save changes. Please check your connection and try again.');
    }
}

/**
 * Opens the delete alert confirmation modal.
 * What: Shows the styled delete confirmation modal instead of a browser confirm() dialog
 * Why: Provides a consistent, styled UI for destructive actions that matches the
 *      deletion modal pattern used across the rest of the application
 * How: Adds the 'show' class to the modal overlay, which switches it from
 *      display:none to display:flex, making it visible with the centered layout
 */
function deleteAlert() {
    const modal = document.getElementById('deleteAlertModal');
    if (modal) modal.classList.add('show');
}

/**
 * Closes the delete alert confirmation modal without deleting.
 * What: Hides the delete alert modal, allowing the user to cancel the action
 * Why: Users need a way to back out of a destructive action without consequences
 * How: Removes the 'show' class from the modal overlay, returning it to display:none
 */
function closeDeleteAlertModal() {
    const modal = document.getElementById('deleteAlertModal');
    if (modal) modal.classList.remove('show');
}

/**
 * Executes the actual alert deletion after the user confirms via the modal.
 * What: Sends a POST request to the delete API endpoint and redirects on success
 * Why: Separated from deleteAlert() so the modal's Delete button can trigger the
 *      actual deletion only after the user has explicitly confirmed
 * How: Closes the modal first, then sends the API request with the alert ID. On
 *      success, redirects to the alerts list page. On failure, shows an error modal.
 */
async function confirmDeleteAlert() {
    /* Close the confirmation modal immediately so the user sees the page
       responding to their action while the API request is in flight */
    closeDeleteAlertModal();
    
    try {
        const response = await fetch('/api/alerts/delete/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ alert_ids: [alertId] })
        });
        
        const result = await response.json();
        
        if (result.success) {
            window.location.href = '{% url "alerts" %}?deleted=1';
        } else {
            showErrorModal('Error Deleting', result.error || 'An unknown error occurred while deleting the alert.');
        }
    } catch (error) {
        console.error('Error:', error);
        showErrorModal('Connection Error', 'Unable to delete alert. Please check your connection and try again.');
    }
}

// =============================================================================
// GROUP MANAGEMENT
// =============================================================================

// Store all groups and current alert's groups
const allGroups = {{ all_groups_json|safe }};
const currentGroups = {{ groups_json|safe }};
let originalGroups = [...currentGroups];

function enterGroupEditMode() {
    document.getElementById('groupsCard').classList.add('group-edit-mode');
    renderCurrentGroupPills();
    renderAllGroupPills();
    document.getElementById('new-group-input').value = '';
}

function cancelGroupEdit() {
    document.getElementById('groupsCard').classList.remove('group-edit-mode');
}

function renderCurrentGroupPills() {
    const container = document.getElementById('current-groups-list');
    container.innerHTML = '';
    
    if (currentGroups.length === 0) {
        container.innerHTML = '<span class="no-groups-msg">This alert is not in any groups.</span>';
        return;
    }
    
    currentGroups.forEach(group => {
        const pill = document.createElement('span');
        pill.className = 'group-pill';
        pill.dataset.group = group;
        pill.textContent = group;
        
        pill.onclick = function() {
            this.classList.toggle('selected');
        };
        
        container.appendChild(pill);
    });
}

function renderAllGroupPills() {
    const container = document.getElementById('group-pills-list');
    container.innerHTML = '';
    
    // Filter out groups that this alert already belongs to
    const availableGroups = allGroups.filter(g => !currentGroups.includes(g));
    
    if (availableGroups.length === 0) {
        container.innerHTML = '<span class="no-groups-msg">No additional groups available. Add a new one below.</span>';
        return;
    }
    
    availableGroups.forEach(group => {
        const pill = document.createElement('span');
        pill.className = 'group-pill';
        pill.dataset.group = group;
        pill.textContent = group;
        
        pill.onclick = function() {
            this.classList.toggle('selected');
        };
        
        container.appendChild(pill);
    });
}

function getSelectedGroupPills() {
    const selected = [];
    document.querySelectorAll('#group-pills-list .group-pill.selected').forEach(pill => {
        selected.push(pill.dataset.group);
    });
    return selected;
}

function getSelectedCurrentGroupPills() {
    const selected = [];
    document.querySelectorAll('#current-groups-list .group-pill.selected').forEach(pill => {
        selected.push(pill.dataset.group);
    });
    return selected;
}

async function saveGroups() {
    const selectedGroups = getSelectedGroupPills();
    const newGroupInput = document.getElementById('new-group-input').value.trim();
    
    // Parse new groups (comma-separated)
    const newGroups = newGroupInput ? newGroupInput.split(',').map(g => g.trim()).filter(g => g.length > 0) : [];
    
    if (selectedGroups.length === 0 && newGroups.length === 0) {
        alert('Please select existing groups or enter a new group name.');
        return;
    }
    
    try {
        const response = await fetch('/api/alerts/group/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                alert_ids: [alertId],
                groups: selectedGroups,
                new_groups: newGroups
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            window.location.reload();
        } else {
            alert('Error saving groups: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error saving groups. Please try again.');
    }
}

async function unlinkSelectedGroups() {
    /* Get all group pills the user has selected in the "This Alert's Group(s)" list.
       These are the groups the user wants to unlink from the current alert. */
    const selectedGroups = getSelectedCurrentGroupPills();
    
    /* Validate that the user has actually selected at least one group before
       proceeding. Without this check, we'd send an empty request to the API. */
    if (selectedGroups.length === 0) {
        alert('Please select at least one group from "This Alert\'s Group(s)" to unlink.');
        return;
    }
    
    /* Show the styled confirmation modal instead of the browser's native confirm()
       dialog. The third argument is the callback function that will be executed
       only if the user clicks the "Unlink" button. The fourth argument customizes
       the confirm button label to "Unlink" for clarity. */
    showConfirmModal(
        'Unlink Groups',
        'Unlink this alert from the selected group(s)?',
        async function() {
            try {
                /* Send POST request to the unlink-groups API endpoint with the
                   current alert ID and the list of selected group names */
                const response = await fetch('/api/alerts/unlink-groups/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        alert_id: alertId,
                        groups: selectedGroups
                    })
                });
                
                const result = await response.json();
                
                /* On success, reload the page to reflect the updated group
                   assignments. On failure, show the error to the user. */
                if (result.success) {
                    window.location.reload();
                } else {
                    alert('Error unlinking groups: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error unlinking groups. Please try again.');
            }
        },
        'Unlink'
    );
}

async function deleteSelectedGroups() {
    const selectedGroups = getSelectedGroupPills();
    
    if (selectedGroups.length === 0) {
        alert('Please select at least one group from "All Groups" to delete.');
        return;
    }
    
    if (!confirm('Delete selected group(s)? This will remove them from all alerts.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/alerts/groups/delete/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                groups: selectedGroups
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            window.location.reload();
        } else {
            alert('Error deleting groups: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error deleting groups. Please try again.');
    }
}

// =============================================================================
// STATUS NOTIFICATIONS
// =============================================================================

function showStatusNotification(message) {
    const container = document.getElementById('status-notifications');
    if (!container) return;
    
    const notification = document.createElement('div');
    notification.className = 'status-notification';
    notification.innerHTML = message + 
        '<button class="dismiss-btn" onclick="dismissStatusNotification(this)">&times;</button>';
    
    container.insertBefore(notification, container.firstChild);
}

function dismissStatusNotification(button) {
    const notification = button.closest('.status-notification');
    if (notification) {
        notification.classList.add('dismissing');
        setTimeout(() => notification.remove(), 300);
    }
}

// =============================================================================
// ITEM AUTOCOMPLETE
// =============================================================================

const ItemAutocomplete = {
    selectedIndex: -1,
    minSearchLength: 2,
    
    init() {
        const input = document.getElementById('edit-item-name');
        const hiddenInput = document.getElementById('edit-item-id');
        const dropdown = document.getElementById('edit-item-suggestions');
        
        if (!input || !dropdown) return;
        
        // Handle input changes - fetch suggestions
        input.addEventListener('input', async () => {
            const query = input.value;
            
            if (query.length < this.minSearchLength) {
                dropdown.style.display = 'none';
                this.selectedIndex = -1;
                return;
            }
            
            try {
                const response = await fetch('/api/items/?q=' + encodeURIComponent(query));
                const items = await response.json();
                
                if (items.length > 0) {
                    dropdown.innerHTML = items.map(item => 
                        `<div class="suggestion-item" data-id="${item.id}" data-name="${item.name}">${item.name}</div>`
                    ).join('');
                    dropdown.style.display = 'block';
                    this.selectedIndex = -1;
                } else {
                    dropdown.style.display = 'none';
                    this.selectedIndex = -1;
                }
            } catch (error) {
                console.error('Error searching items:', error);
                dropdown.style.display = 'none';
            }
        });
        
        // Handle keyboard navigation
        input.addEventListener('keydown', (e) => {
            if (dropdown.style.display === 'none') return;
            
            const items = dropdown.querySelectorAll('.suggestion-item');
            if (items.length === 0) return;
            
            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    this.selectedIndex = (this.selectedIndex + 1) % items.length;
                    this.updateSelection(items);
                    break;
                    
                case 'ArrowUp':
                    e.preventDefault();
                    this.selectedIndex = this.selectedIndex <= 0 ? items.length - 1 : this.selectedIndex - 1;
                    this.updateSelection(items);
                    break;
                    
                case 'Tab':
                    e.preventDefault();
                    if (e.shiftKey) {
                        this.selectedIndex = this.selectedIndex <= 0 ? items.length - 1 : this.selectedIndex - 1;
                    } else {
                        this.selectedIndex = (this.selectedIndex + 1) % items.length;
                    }
                    this.updateSelection(items);
                    break;
                    
                case 'Enter':
                    if (this.selectedIndex >= 0) {
                        e.preventDefault();
                        this.selectItem(items[this.selectedIndex], input, hiddenInput, dropdown);
                    }
                    break;
                    
                case 'Escape':
                    e.preventDefault();
                    dropdown.style.display = 'none';
                    this.selectedIndex = -1;
                    break;
            }
        });
        
        // Handle mouse click on suggestion
        dropdown.addEventListener('click', (e) => {
            if (e.target.classList.contains('suggestion-item')) {
                this.selectItem(e.target, input, hiddenInput, dropdown);
            }
        });
        
        // Handle mouse hover to update selection
        dropdown.addEventListener('mouseover', (e) => {
            if (e.target.classList.contains('suggestion-item')) {
                const items = dropdown.querySelectorAll('.suggestion-item');
                items.forEach((item, index) => {
                    if (item === e.target) {
                        this.selectedIndex = index;
                    }
                });
                this.updateSelection(items);
            }
        });
        
        // Close dropdown on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#item-name-group')) {
                dropdown.style.display = 'none';
                this.selectedIndex = -1;
            }
        });
    },
    
    updateSelection(items) {
        items.forEach((item, index) => {
            if (index === this.selectedIndex) {
                item.classList.add('selected');
                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('selected');
            }
        });
    },
    
    selectItem(item, input, hiddenInput, dropdown) {
        input.value = item.dataset.name;
        hiddenInput.value = item.dataset.id;
        dropdown.style.display = 'none';
        this.selectedIndex = -1;
    }
};

// =============================================================================
// ERROR MODAL FUNCTIONS
// What: Functions to show and close the error modal dialog
// Why: Provides a nicer alternative to browser alert() dialogs
// How: Toggle the 'active' class on the modal overlay, set message content
// =============================================================================

/**
 * Shows the error modal with a custom title and message.
 * What: Displays a styled modal dialog with the given error information
 * Why: Better UX than browser alert() - matches site styling
 * How: Sets title and message content, adds 'active' class to show modal
 * 
 * @param {string} title - The title to display in the modal header
 * @param {string} message - The error message to display in the modal body
 */
function showErrorModal(title, message) {
    const modal = document.getElementById('error-modal');
    const titleEl = document.getElementById('error-modal-title');
    const messageEl = document.getElementById('error-modal-message');
    
    if (titleEl) titleEl.textContent = title;
    if (messageEl) messageEl.textContent = message;
    if (modal) modal.classList.add('active');
}

/**
 * Closes the error modal.
 * What: Hides the error modal dialog
 * Why: Allow user to dismiss the error and continue
 * How: Removes 'active' class from modal overlay
 */
function closeErrorModal() {
    const modal = document.getElementById('error-modal');
    if (modal) modal.classList.remove('active');
}

// Close modal when clicking outside content
document.addEventListener('click', function(e) {
    const modal = document.getElementById('error-modal');
    if (e.target === modal) {
        closeErrorModal();
    }
    /* Also close the confirm modal when clicking outside its content area.
       This gives users an intuitive way to dismiss the confirmation dialog
       without explicitly pressing Cancel. */
    const confirmModal = document.getElementById('confirm-modal');
    if (e.target === confirmModal) {
        closeConfirmModal();
    }
    /* Also close the delete alert modal when clicking outside its content area.
       Clicking the overlay backdrop (not the modal card) dismisses the modal,
       matching the standard UX pattern for all modals in this application. */
    const deleteAlertModal = document.getElementById('deleteAlertModal');
    if (e.target === deleteAlertModal) {
        closeDeleteAlertModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeErrorModal();
        /* Also close the confirm modal on Escape. This is the standard keyboard
           shortcut for dismissing dialogs and matches user expectations. */
        closeConfirmModal();
        /* Also close the delete alert modal on Escape, consistent with all
           other modal dismiss behaviors in this template. */
        closeDeleteAlertModal();
    }
});

/* =============================================================================
   CONFIRM MODAL FUNCTIONS
   What: Functions for showing and hiding the reusable confirmation modal, and
         executing the confirmed action via a stored callback.
   Why: Replaces native browser confirm() dialogs with a styled modal that is
        consistent with the rest of the application's UI. Using a callback-based
        approach (storing the onConfirm function) makes this modal fully reusable
        for any future confirmation needs (e.g., deleting alerts, deleting groups).
   How: showConfirmModal() stores the callback, sets title/message, and shows the
        modal. executeConfirmAction() runs the stored callback and closes the modal.
        closeConfirmModal() hides the modal and clears the stored callback.
============================================================================= */

/* _confirmModalCallback: Private variable that holds the function to execute
   when the user clicks the "Confirm" button. Set by showConfirmModal() and
   cleared by closeConfirmModal(). Using a module-level variable allows the
   modal HTML's onclick to call executeConfirmAction() without needing to
   know what specific action is being confirmed. */
let _confirmModalCallback = null;

/**
 * Shows the confirmation modal with a custom title, message, and action.
 * What: Displays the confirm modal overlay with the provided content
 * Why: Provides a reusable way to ask the user for confirmation before any
 *      destructive or significant action, without relying on browser dialogs
 * How: Sets the title and message text content, stores the onConfirm callback,
 *      optionally customizes the confirm button label, and adds the 'active'
 *      class to make the modal visible with its CSS transition.
 *
 * @param {string} title - The heading text shown in the modal header (e.g., "Unlink Groups")
 * @param {string} message - The descriptive text shown in the modal body
 * @param {Function} onConfirm - Callback function to execute when the user clicks Confirm
 * @param {string} [confirmLabel='Confirm'] - Optional custom label for the confirm button
 */
function showConfirmModal(title, message, onConfirm, confirmLabel = 'Confirm') {
    const modal = document.getElementById('confirm-modal');
    const titleEl = document.getElementById('confirm-modal-title');
    const messageEl = document.getElementById('confirm-modal-message');
    const actionBtn = document.getElementById('confirm-modal-action-btn');

    /* Set the modal's title and message to the caller-provided values */
    if (titleEl) titleEl.textContent = title;
    if (messageEl) messageEl.textContent = message;

    /* Allow callers to customize the confirm button text (e.g., "Unlink" instead
       of the default "Confirm") for clearer action labeling */
    if (actionBtn) actionBtn.textContent = confirmLabel;

    /* Store the callback so executeConfirmAction() can invoke it later */
    _confirmModalCallback = onConfirm;

    /* Add the 'active' class to trigger the CSS opacity/visibility transition,
       making the modal fade in with the scale animation */
    if (modal) modal.classList.add('active');
}

/**
 * Closes the confirmation modal without executing the action.
 * What: Hides the confirm modal and clears the stored callback
 * Why: Allows the user to back out of a confirmation without side effects
 * How: Removes the 'active' class (triggering the CSS fade-out transition)
 *      and nullifies the stored callback to prevent stale references
 */
function closeConfirmModal() {
    const modal = document.getElementById('confirm-modal');
    if (modal) modal.classList.remove('active');

    /* Clear the stored callback to avoid accidentally executing a stale action
       if showConfirmModal() is called again later */
    _confirmModalCallback = null;
}

/**
 * Executes the stored confirm action and closes the modal.
 * What: Runs the onConfirm callback that was passed to showConfirmModal()
 * Why: Separates the "execute" logic from the modal UI, so the HTML button's
 *      onclick can simply call this function without knowing the specific action
 * How: Checks that the callback exists and is a function, executes it, then
 *      closes the modal. The callback is cleared inside closeConfirmModal().
 */
function executeConfirmAction() {
    if (_confirmModalCallback && typeof _confirmModalCallback === 'function') {
        _confirmModalCallback();
    }
    closeConfirmModal();
}

// Initialize autocomplete when page loads
ItemAutocomplete.init();

// Set up form visibility based on current alert type on page load
handleTypeChange();
</script>
{% endblock %}
