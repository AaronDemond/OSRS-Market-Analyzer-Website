{% extends 'base.html' %}

{% block title %}Alerts - OSRS Market Tracker{% endblock %}

{% block content %}
<h1>Alerts</h1>
<hr>

<div class="alert-tabs">
    <button class="tab-btn active" data-tab="my-alerts">My Alerts</button>
    <button class="tab-btn" data-tab="create-alert">Create Alert</button>
    <button class="tab-btn" data-tab="edit-delete-alert">Edit Alert</button>
</div>

<div class="tab-content">
    <div id="my-alerts" class="tab-pane active">
        <div id="triggered-notifications">
            {% for alert in triggered_alerts %}
                <div class="triggered-notification" data-alert-id="{{ alert.id }}">
                    {{ alert.triggered_text }}
                    <button class="dismiss-btn" onclick="dismissAlert({{ alert.id }})">&times;</button>
                </div>
            {% endfor %}
        </div>
        {% if all_alerts %}
        <div class="alert-actions">
            <button class="action-btn delete-btn" onclick="toggleDeleteMode()">Delete Alert(s)</button>
            <button class="action-btn confirm-delete-btn" onclick="confirmDelete()" style="display: none;">Confirm Delete</button>
            <button class="action-btn cancel-btn" onclick="cancelDeleteMode()" style="display: none;">Cancel</button>
        </div>
            <ul class="alerts-list">
                {% for alert in all_alerts %}
                    <li class="alert-item" data-alert-id="{{ alert.id }}">
                        <input type="checkbox" class="alert-checkbox" style="display: none;">
                        <span class="alert-icon">ðŸ””</span>
                        <span class="alert-text">{{ alert }}</span>
                        {% if alert.is_triggered %}
                            <span class="alert-triggered">TRIGGERED: {{alert.triggered_text}} </span>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% elif not triggered_alerts %}
            <p class="no-alerts">No active alerts. Create one to get started!</p>
        {% endif %}
    </div>
    <div id="create-alert" class="tab-pane" style="display: none;">
        <form method="POST" action="{% url 'create_alert' %}" class="create-alert-form">
            {% csrf_token %}
            <div class="form-group">
                <label for="alert-type">Alert Type</label>
                <select name="type" id="alert-type" required onchange="handleAlertTypeChange()">
                    <option value="above" selected>Above Threshold</option>
                    <option value="below">Below Threshold</option>
                    <option value="spread">Spread</option>
                </select>
            </div>
            
            <!-- Spread-specific fields -->
            <div class="form-group" id="spread-scope-group" style="display: none;">
                <label for="spread-scope">Apply To</label>
                <select name="spread_scope" id="spread-scope" onchange="handleSpreadScopeChange()">
                    <option value="all">All Items</option>
                    <option value="specific">Specific Item</option>
                </select>
            </div>
            
            <!-- Item fields (shown for above/below, or spread with specific item) -->
            <div class="form-group" id="item-name-group">
                <label for="item-name">Item Name</label>
                <input type="text" name="item_name" id="item-name" autocomplete="off">
                <input type="hidden" name="item_id" id="item-id">
                <input type="hidden" name="is_all_items" id="is-all-items" value="false">
                <div id="item-suggestions" class="suggestions-dropdown"></div>
            </div>
            
            <!-- Price fields (shown for above/below only) -->
            <div class="form-group" id="price-group">
                <label for="price">Price Threshold</label>
                <input type="number" name="price" id="price">
            </div>
            <div class="form-group" id="reference-group">
                <label for="reference">Reference Price</label>
                <select name="reference" id="reference">
                    <option value="high">High Price</option>
                    <option value="low">Low Price</option>
                </select>
            </div>
            
            <!-- Percentage field (shown for spread only) -->
            <div class="form-group" id="percentage-group" style="display: none;">
                <label for="percentage">Spread Percentage (%)</label>
                <input type="number" name="percentage" id="percentage" step="0.1" min="0">
            </div>
            
            <!-- Min/Max price fields (shown for spread all items only) -->
            <div class="form-group" id="min-price-group" style="display: none;">
                <label for="minimum-price">Minimum Price</label>
                <input type="number" name="minimum_price" id="minimum-price" min="0">
            </div>
            <div class="form-group" id="max-price-group" style="display: none;">
                <label for="maximum-price">Maximum Price</label>
                <input type="number" name="maximum_price" id="maximum-price" min="0">
            </div>
            
            <button type="submit" class="btn-create-alert">Create Alert</button>
        </form>
    </div>
    <div id="edit-delete-alert" class="tab-pane" style="display: none;">
        {% if all_alerts %}
            <ul class="alerts-list edit-alerts-list">
                {% for alert in all_alerts %}
                    <li class="alert-item clickable-alert" onclick="openEditModal({{ alert.id }}, '{{ alert.type }}', '{{ alert.item_name|default_if_none:"" }}', {{ alert.item_id|default_if_none:"null" }}, {{ alert.price|default_if_none:"null" }}, '{{ alert.reference|default_if_none:"" }}', {{ alert.percentage|default_if_none:"null" }}, {{ alert.is_all_items|yesno:"true,false,false" }}, {{ alert.minimum_price|default_if_none:"null" }}, {{ alert.maximum_price|default_if_none:"null" }})">
                        <span class="alert-icon">ðŸ””</span>
                        <span class="alert-text">{{ alert }}</span>
                        <span class="edit-hint">Click to edit</span>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="no-alerts">No alerts to edit.</p>
        {% endif %}
    </div>
</div>

<!-- Edit Modal -->
<div id="edit-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit Alert</h2>
            <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <form id="edit-alert-form" class="edit-alert-form">
            <input type="hidden" id="edit-alert-id">
            <input type="hidden" id="edit-is-all-items">
            <div class="form-group">
                <label for="edit-alert-type">Alert Type</label>
                <select name="type" id="edit-alert-type" required onchange="handleEditAlertTypeChange()">
                    <option value="above">Above Threshold</option>
                    <option value="below">Below Threshold</option>
                    <option value="spread">Spread</option>
                </select>
            </div>
            
            <!-- Spread-specific fields -->
            <div class="form-group" id="edit-spread-scope-group" style="display: none;">
                <label for="edit-spread-scope">Apply To</label>
                <select name="spread_scope" id="edit-spread-scope" onchange="handleEditSpreadScopeChange()">
                    <option value="all">All Items</option>
                    <option value="specific">Specific Item</option>
                </select>
            </div>
            
            <div class="form-group" id="edit-item-name-group">
                <label for="edit-item-name">Item Name</label>
                <input type="text" name="item_name" id="edit-item-name" autocomplete="off">
                <input type="hidden" name="item_id" id="edit-item-id">
                <div id="edit-item-suggestions" class="suggestions-dropdown"></div>
            </div>
            <div class="form-group" id="edit-price-group">
                <label for="edit-price">Price Threshold</label>
                <input type="number" name="price" id="edit-price">
            </div>
            <div class="form-group" id="edit-reference-group">
                <label for="edit-reference">Reference Price</label>
                <select name="reference" id="edit-reference">
                    <option value="high">High Price</option>
                    <option value="low">Low Price</option>
                </select>
            </div>
            
            <!-- Percentage field (shown for spread only) -->
            <div class="form-group" id="edit-percentage-group" style="display: none;">
                <label for="edit-percentage">Spread Percentage (%)</label>
                <input type="number" name="percentage" id="edit-percentage" step="0.1" min="0">
            </div>
            
            <!-- Min/Max price fields (shown for spread all items only) -->
            <div class="form-group" id="edit-min-price-group" style="display: none;">
                <label for="edit-minimum-price">Minimum Price</label>
                <input type="number" name="minimum_price" id="edit-minimum-price" min="0">
            </div>
            <div class="form-group" id="edit-max-price-group" style="display: none;">
                <label for="edit-maximum-price">Maximum Price</label>
                <input type="number" name="maximum_price" id="edit-maximum-price" min="0">
            </div>
            
            <div class="modal-buttons">
                <button type="button" class="btn-save" onclick="saveAlert()">Save</button>
                <button type="button" class="btn-cancel" onclick="closeEditModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Spread Details Modal -->
<div id="spread-modal" class="modal" style="display: none;">
    <div class="modal-content modal-content-large">
        <div class="modal-header">
            <h2>Spread Alert Details</h2>
            <button class="modal-close" onclick="closeSpreadModal()">&times;</button>
        </div>
        <div id="spread-modal-body">
            <ul id="spread-items-list"></ul>
        </div>
        <div class="modal-buttons">
            <button type="button" class="btn-cancel" onclick="closeSpreadModal()">Close</button>
        </div>
    </div>
</div>

<style>
    .alert-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    .tab-btn {
        padding: 10px 20px;
        border: none;
        background-color: transparent;
        cursor: pointer;
        font-size: 16px;
        border-bottom: 2px solid transparent;
    }
    .tab-btn:hover {
        border-bottom: 2px solid #ccc;
    }
    .tab-btn.active {
        border-bottom: 2px solid #007bff;
        color: #007bff;
    }
    .tab-content {
        padding: 20px;
    }
    .alerts-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .alert-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 15px 20px;
        margin-bottom: 10px;
        background-color: #cce5ff;
        border-left: 4px solid #007bff;
        border-radius: 8px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .alert-item:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
    }
    .alert-text {
        flex: 1;
    }
    .alert-triggered {
        font-weight: 700;
        color: #8b5cf6;
        background-color: #ede9fe;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
    }
    .alert-icon {
        font-size: 1.4rem;
    }
    .alert-text {
        font-size: 1rem;
        color: #333;
    }
    .no-alerts {
        color: #6c757d;
        font-style: italic;
        padding: 20px;
        text-align: center;
    }
    .alert-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    .action-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.2s ease;
    }
    .edit-btn {
        background-color: #007bff;
        color: white;
    }
    .edit-btn:hover {
        background-color: #0056b3;
    }
    .delete-btn {
        background-color: #dc3545;
        color: white;
    }
    .delete-btn:hover {
        background-color: #c82333;
    }
    .confirm-delete-btn {
        background-color: #dc3545;
        color: white;
    }
    .confirm-delete-btn:hover {
        background-color: #c82333;
    }
    .cancel-btn {
        background-color: #6c757d;
        color: white;
    }
    .cancel-btn:hover {
        background-color: #5a6268;
    }
    .alert-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: #dc3545;
    }
    .alert-item.delete-mode {
        background-color: #fff3cd;
        border-left-color: #dc3545;
    }
    .triggered-notification {
        background-color: #28a745;
        color: white;
        padding: 15px 40px 15px 20px;
        border-radius: 8px;
        margin-bottom: 15px;
        position: relative;
        font-weight: 500;
        transition: opacity 0.3s ease, transform 0.3s ease, max-height 0.3s ease, margin 0.3s ease, padding 0.3s ease;
        max-height: 100px;
        overflow: hidden;
    }
    .triggered-notification.dismissing {
        opacity: 0;
        transform: translateX(20px);
        max-height: 0;
        margin-bottom: 0;
        padding-top: 0;
        padding-bottom: 0;
    }
    .triggered-notification .dismiss-btn {
        position: absolute;
        top: 50%;
        right: 15px;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        font-weight: bold;
        line-height: 1;
        opacity: 0.8;
    }
    .triggered-notification .dismiss-btn:hover {
        opacity: 1;
    }
    .create-alert-form {
        max-width: 400px;
    }
    .form-group {
        margin-bottom: 15px;
        position: relative;
    }
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
    }
    .form-group input,
    .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 14px;
    }
    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
    }
    .btn-create-alert {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
    }
    .btn-create-alert:hover {
        background-color: #0056b3;
    }
    .suggestions-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ccc;
        border-top: none;
        border-radius: 0 0 5px 5px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 100;
        display: none;
    }
    .suggestion-item {
        padding: 10px;
        cursor: pointer;
    }
    .suggestion-item:hover {
        background-color: #f0f0f0;
    }
    .clickable-alert {
        cursor: pointer;
    }
    .clickable-alert:hover {
        background-color: #b8daff;
    }
    .edit-hint {
        font-size: 0.8rem;
        color: #6c757d;
        font-style: italic;
        margin-left: auto;
    }
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .modal-content {
        background-color: white;
        padding: 30px;
        border-radius: 12px;
        width: 100%;
        max-width: 450px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .modal-header h2 {
        margin: 0;
        color: #333;
    }
    .modal-close {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: #666;
        line-height: 1;
    }
    .modal-close:hover {
        color: #333;
    }
    .modal-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }
    .btn-save {
        flex: 1;
        background-color: #28a745;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
    }
    .btn-save:hover {
        background-color: #218838;
    }
    .btn-cancel {
        flex: 1;
        background-color: #6c757d;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
    }
    .btn-cancel:hover {
        background-color: #5a6268;
    }
    .edit-alert-form {
        max-width: 100%;
    }
    .modal-content-large {
        max-width: 700px;
        max-height: 80vh;
        overflow-y: auto;
    }
    #spread-items-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    #spread-items-list li {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    #spread-items-list li:last-child {
        border-bottom: none;
    }
    .spread-item-name {
        font-weight: 600;
        color: #333;
    }
    .spread-item-details {
        color: #666;
        font-size: 0.9rem;
    }
    .spread-item-percentage {
        font-weight: 700;
        color: #28a745;
        font-size: 1.1rem;
    }
    .clickable-triggered {
        cursor: pointer;
        text-decoration: underline;
    }
    .clickable-triggered:hover {
        opacity: 0.8;
    }
</style>

<script>
    // Handle alert type dropdown change
    function handleAlertTypeChange() {
        const alertType = document.getElementById('alert-type').value;
        const spreadScopeGroup = document.getElementById('spread-scope-group');
        const itemNameGroup = document.getElementById('item-name-group');
        const priceGroup = document.getElementById('price-group');
        const referenceGroup = document.getElementById('reference-group');
        const percentageGroup = document.getElementById('percentage-group');
        const minPriceGroup = document.getElementById('min-price-group');
        const maxPriceGroup = document.getElementById('max-price-group');
        const isAllItemsInput = document.getElementById('is-all-items');
        
        if (alertType === 'spread') {
            spreadScopeGroup.style.display = 'block';
            priceGroup.style.display = 'none';
            referenceGroup.style.display = 'none';
            percentageGroup.style.display = 'block';
            // Trigger scope change to set item visibility
            handleSpreadScopeChange();
        } else {
            spreadScopeGroup.style.display = 'none';
            itemNameGroup.style.display = 'block';
            priceGroup.style.display = 'block';
            referenceGroup.style.display = 'block';
            percentageGroup.style.display = 'none';
            minPriceGroup.style.display = 'none';
            maxPriceGroup.style.display = 'none';
            isAllItemsInput.value = 'false';
        }
    }
    
    // Handle spread scope dropdown change
    function handleSpreadScopeChange() {
        const spreadScope = document.getElementById('spread-scope').value;
        const itemNameGroup = document.getElementById('item-name-group');
        const minPriceGroup = document.getElementById('min-price-group');
        const maxPriceGroup = document.getElementById('max-price-group');
        const isAllItemsInput = document.getElementById('is-all-items');
        
        if (spreadScope === 'all') {
            itemNameGroup.style.display = 'none';
            minPriceGroup.style.display = 'block';
            maxPriceGroup.style.display = 'block';
            isAllItemsInput.value = 'true';
        } else {
            itemNameGroup.style.display = 'block';
            minPriceGroup.style.display = 'none';
            maxPriceGroup.style.display = 'none';
            isAllItemsInput.value = 'false';
        }
    }

    document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', () => {
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            button.classList.add('active');
            
            // Hide all tab panes
            document.querySelectorAll('.tab-pane').forEach(pane => pane.style.display = 'none');
            // Show the selected tab pane
            const tabId = button.getAttribute('data-tab');
            document.getElementById(tabId).style.display = 'block';
        });
    });

    // Item search autocomplete
    const itemNameInput = document.getElementById('item-name');
    const itemIdInput = document.getElementById('item-id');
    const suggestionsDropdown = document.getElementById('item-suggestions');

    itemNameInput.addEventListener('input', async () => {
        const query = itemNameInput.value;
        if (query.length < 2) {
            suggestionsDropdown.style.display = 'none';
            return;
        }

        const response = await fetch(`/api/items/?q=${encodeURIComponent(query)}`);
        const items = await response.json();

        if (items.length > 0) {
            suggestionsDropdown.innerHTML = items.map(item => 
                `<div class="suggestion-item" data-id="${item.id}" data-name="${item.name}">${item.name}</div>`
            ).join('');
            suggestionsDropdown.style.display = 'block';
        } else {
            suggestionsDropdown.style.display = 'none';
        }
    });

    suggestionsDropdown.addEventListener('click', (e) => {
        if (e.target.classList.contains('suggestion-item')) {
            itemNameInput.value = e.target.dataset.name;
            itemIdInput.value = e.target.dataset.id;
            suggestionsDropdown.style.display = 'none';
        }
    });

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.form-group')) {
            suggestionsDropdown.style.display = 'none';
        }
    });

    // Auto-refresh alerts every 5 seconds
    async function refreshAlerts() {
        // Skip refresh if in delete mode
        if (deleteMode) return;
        
        try {
            const response = await fetch('/api/alerts/');
            const data = await response.json();
            
            const myAlertsPane = document.getElementById('my-alerts');
            
            // Build triggered notifications
            let notificationsHtml = '';
            if (data.triggered && data.triggered.length > 0) {
                data.triggered.forEach(alert => {
                    const isSpreadAllItems = alert.type === 'spread' && alert.is_all_items && alert.triggered_data;
                    
                    if (isSpreadAllItems) {
                        // Store the data in a global variable for this alert
                        window[`spreadData_${alert.id}`] = alert.triggered_data;
                    }
                    
                    const clickHandler = isSpreadAllItems ? `onclick="showSpreadDetails(${alert.id})"` : '';
                    const clickableClass = isSpreadAllItems ? 'clickable-triggered' : '';
                    
                    notificationsHtml += `<div class="triggered-notification" data-alert-id="${alert.id}">
                        <span class="${clickableClass}" ${clickHandler}>${alert.triggered_text}</span>
                        <button class="dismiss-btn" onclick="event.stopPropagation(); dismissAlert(${alert.id})">&times;</button>
                    </div>`;
                });
            }

            // Build action buttons (only show if there are alerts)
            let actionsHtml = '';
            if (data.alerts.length > 0) {
                actionsHtml = `<div class="alert-actions">
                    <button class="action-btn delete-btn" onclick="toggleDeleteMode()" style="${deleteMode ? 'display:none' : ''}">Delete Alert(s)</button>
                    <button class="action-btn confirm-delete-btn" onclick="confirmDelete()" style="${deleteMode ? '' : 'display:none'}">Confirm Delete</button>
                    <button class="action-btn cancel-btn" onclick="cancelDeleteMode()" style="${deleteMode ? '' : 'display:none'}">Cancel</button>
                </div>`;
            }
            
            // Build alerts list
            let alertsHtml = '';
            if (data.alerts.length > 0) {
                alertsHtml = '<ul class="alerts-list">';
                data.alerts.forEach(alert => {
                    const isSpreadAllItems = alert.type === 'spread' && alert.is_all_items && alert.triggered_data;
                    
                    if (isSpreadAllItems && alert.is_triggered) {
                        window[`spreadData_${alert.id}`] = alert.triggered_data;
                    }
                    
                    const clickHandler = isSpreadAllItems && alert.is_triggered ? `onclick="showSpreadDetails(${alert.id})"` : '';
                    const clickableClass = isSpreadAllItems && alert.is_triggered ? 'clickable-triggered' : '';
                    
                    alertsHtml += `<li class="alert-item ${deleteMode ? 'delete-mode' : ''}" data-alert-id="${alert.id}">
                        <input type="checkbox" class="alert-checkbox" style="${deleteMode ? 'display:block' : 'display:none'}">
                        <span class="alert-icon">ðŸ””</span>
                        <span class="alert-text">${alert.text}</span>`;
                    if (alert.is_triggered) {
                        alertsHtml += `<span class="alert-triggered ${clickableClass}" ${clickHandler}>Alert triggered. Click for details</span>`;
                    }
                    alertsHtml += '</li>';
                });
                alertsHtml += '</ul>';
            } else if (!data.triggered || data.triggered.length === 0) {
                alertsHtml = '<p class="no-alerts">No active alerts. Create one to get started!</p>';
            }
            
            myAlertsPane.innerHTML = '<div id="triggered-notifications">' + notificationsHtml + '</div>' + actionsHtml + alertsHtml;
        } catch (error) {
            console.error('Error refreshing alerts:', error);
        }
    }

    function showSpreadDetails(alertId) {
        const dataStr = window[`spreadData_${alertId}`];
        if (!dataStr) {
            console.error('No spread data found for alert', alertId);
            return;
        }
        
        const data = JSON.parse(dataStr);
        const list = document.getElementById('spread-items-list');
        
        list.innerHTML = data.map(item => `
            <li>
                <div>
                    <span class="spread-item-name">${item.item_name}</span>
                    <div class="spread-item-details">High: ${item.high?.toLocaleString() || 'N/A'} | Low: ${item.low?.toLocaleString() || 'N/A'}</div>
                </div>
                <span class="spread-item-percentage">${item.spread}%</span>
            </li>
        `).join('');
        
        document.getElementById('spread-modal').style.display = 'flex';
    }

    function closeSpreadModal() {
        document.getElementById('spread-modal').style.display = 'none';
    }

    async function dismissAlert(alertId) {
        // Animate out immediately
        const notification = document.querySelector(`.triggered-notification[data-alert-id="${alertId}"]`);
        if (notification) {
            notification.classList.add('dismissing');
        }
        
        // Call API in background
        try {
            await fetch('/api/alerts/dismiss/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ alert_id: alertId })
            });
        } catch (error) {
            console.error('Error dismissing alert:', error);
        }
    }

    let deleteMode = false;

    function toggleDeleteMode() {
        deleteMode = true;
        document.querySelectorAll('.alert-checkbox').forEach(cb => cb.style.display = 'block');
        document.querySelectorAll('.alert-item').forEach(item => item.classList.add('delete-mode'));
        document.querySelector('.delete-btn').style.display = 'none';
        document.querySelector('.confirm-delete-btn').style.display = 'inline-block';
        document.querySelector('.cancel-btn').style.display = 'inline-block';
    }

    function cancelDeleteMode() {
        deleteMode = false;
        document.querySelectorAll('.alert-checkbox').forEach(cb => {
            cb.style.display = 'none';
            cb.checked = false;
        });
        document.querySelectorAll('.alert-item').forEach(item => item.classList.remove('delete-mode'));
        document.querySelector('.delete-btn').style.display = 'inline-block';
        document.querySelector('.confirm-delete-btn').style.display = 'none';
        document.querySelector('.cancel-btn').style.display = 'none';
    }

    async function confirmDelete() {
        const selectedIds = [];
        document.querySelectorAll('.alert-checkbox:checked').forEach(cb => {
            const alertItem = cb.closest('.alert-item');
            if (alertItem) {
                selectedIds.push(alertItem.dataset.alertId);
            }
        });

        if (selectedIds.length === 0) {
            alert('Please select at least one alert to delete.');
            return;
        }

        try {
            await fetch('/api/alerts/delete/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ alert_ids: selectedIds })
            });
            cancelDeleteMode();
            refreshAlerts();
        } catch (error) {
            console.error('Error deleting alerts:', error);
        }
    }

    function toggleEditMode() {
        // Switch to the Edit Alert tab
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector('[data-tab="edit-delete-alert"]').classList.add('active');
        document.querySelectorAll('.tab-pane').forEach(pane => pane.style.display = 'none');
        document.getElementById('edit-delete-alert').style.display = 'block';
    }

    function openEditModal(id, type, itemName, itemId, price, reference, percentage, isAllItems, minPrice, maxPrice) {
        document.getElementById('edit-alert-id').value = id;
        document.getElementById('edit-alert-type').value = type;
        document.getElementById('edit-item-name').value = itemName || '';
        document.getElementById('edit-item-id').value = itemId || '';
        document.getElementById('edit-price').value = price || '';
        document.getElementById('edit-reference').value = reference || 'high';
        document.getElementById('edit-percentage').value = percentage || '';
        document.getElementById('edit-is-all-items').value = isAllItems ? 'true' : 'false';
        document.getElementById('edit-minimum-price').value = minPrice || '';
        document.getElementById('edit-maximum-price').value = maxPrice || '';
        
        // Set spread scope dropdown
        if (type === 'spread') {
            document.getElementById('edit-spread-scope').value = isAllItems ? 'all' : 'specific';
        }
        
        // Update field visibility based on type
        handleEditAlertTypeChange();
        
        document.getElementById('edit-modal').style.display = 'flex';
    }

    function handleEditAlertTypeChange() {
        const alertType = document.getElementById('edit-alert-type').value;
        const spreadScopeGroup = document.getElementById('edit-spread-scope-group');
        const itemNameGroup = document.getElementById('edit-item-name-group');
        const priceGroup = document.getElementById('edit-price-group');
        const referenceGroup = document.getElementById('edit-reference-group');
        const percentageGroup = document.getElementById('edit-percentage-group');
        const minPriceGroup = document.getElementById('edit-min-price-group');
        const maxPriceGroup = document.getElementById('edit-max-price-group');
        
        if (alertType === 'spread') {
            spreadScopeGroup.style.display = 'block';
            priceGroup.style.display = 'none';
            referenceGroup.style.display = 'none';
            percentageGroup.style.display = 'block';
            handleEditSpreadScopeChange();
        } else {
            spreadScopeGroup.style.display = 'none';
            itemNameGroup.style.display = 'block';
            priceGroup.style.display = 'block';
            referenceGroup.style.display = 'block';
            percentageGroup.style.display = 'none';
            minPriceGroup.style.display = 'none';
            maxPriceGroup.style.display = 'none';
        }
    }

    function handleEditSpreadScopeChange() {
        const spreadScope = document.getElementById('edit-spread-scope').value;
        const itemNameGroup = document.getElementById('edit-item-name-group');
        const minPriceGroup = document.getElementById('edit-min-price-group');
        const maxPriceGroup = document.getElementById('edit-max-price-group');
        const isAllItemsInput = document.getElementById('edit-is-all-items');
        
        if (spreadScope === 'all') {
            itemNameGroup.style.display = 'none';
            minPriceGroup.style.display = 'block';
            maxPriceGroup.style.display = 'block';
            isAllItemsInput.value = 'true';
        } else {
            itemNameGroup.style.display = 'block';
            minPriceGroup.style.display = 'none';
            maxPriceGroup.style.display = 'none';
            isAllItemsInput.value = 'false';
        }
    }

    function closeEditModal() {
        document.getElementById('edit-modal').style.display = 'none';
    }

    async function saveAlert() {
        const alertId = document.getElementById('edit-alert-id').value;
        const alertType = document.getElementById('edit-alert-type').value;
        const itemName = document.getElementById('edit-item-name').value;
        const itemId = document.getElementById('edit-item-id').value;
        const price = document.getElementById('edit-price').value;
        const reference = document.getElementById('edit-reference').value;
        const percentage = document.getElementById('edit-percentage').value;
        const isAllItems = document.getElementById('edit-is-all-items').value === 'true';
        const minimumPrice = document.getElementById('edit-minimum-price').value;
        const maximumPrice = document.getElementById('edit-maximum-price').value;

        try {
            await fetch('/api/alerts/update/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    alert_id: alertId,
                    type: alertType,
                    item_name: itemName,
                    item_id: itemId,
                    price: price,
                    reference: reference,
                    percentage: percentage,
                    is_all_items: isAllItems,
                    minimum_price: minimumPrice,
                    maximum_price: maximumPrice
                })
            });
            closeEditModal();
            location.reload();
        } catch (error) {
            console.error('Error updating alert:', error);
        }
    }

    // Edit modal item search autocomplete
    const editItemNameInput = document.getElementById('edit-item-name');
    const editItemIdInput = document.getElementById('edit-item-id');
    const editSuggestionsDropdown = document.getElementById('edit-item-suggestions');

    editItemNameInput.addEventListener('input', async () => {
        const query = editItemNameInput.value;
        if (query.length < 2) {
            editSuggestionsDropdown.style.display = 'none';
            return;
        }

        const response = await fetch(`/api/items/?q=${encodeURIComponent(query)}`);
        const items = await response.json();

        if (items.length > 0) {
            editSuggestionsDropdown.innerHTML = items.map(item => 
                `<div class="suggestion-item" data-id="${item.id}" data-name="${item.name}">${item.name}</div>`
            ).join('');
            editSuggestionsDropdown.style.display = 'block';
        } else {
            editSuggestionsDropdown.style.display = 'none';
        }
    });

    editSuggestionsDropdown.addEventListener('click', (e) => {
        if (e.target.classList.contains('suggestion-item')) {
            editItemNameInput.value = e.target.dataset.name;
            editItemIdInput.value = e.target.dataset.id;
            editSuggestionsDropdown.style.display = 'none';
        }
    });

    // Initial load and poll every 5 seconds
    refreshAlerts();
    setInterval(refreshAlerts, 5000);
</script>
{% endblock %}
