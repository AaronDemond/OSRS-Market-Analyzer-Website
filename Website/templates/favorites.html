{% extends 'base.html' %}
{% load humanize %}
{% load favorites_tags %}

{% block title %}My Favorites - GE Tools{% endblock %}

{% block extra_css %}
<style>
    :root {
        --bg: #F8F9FA;
        --surface: #FFFFFF;
        --surface-2: #F5F6F8;
        --border: #E5E7EB;
        --text: #374151;
        --muted: #6B7280;
        --primary: #6366F1;
        --primary-hover: #5558E3;
        --success: #22C55E;
        --danger: #EF4444;
        --warning: #F59E0B;
    }

    /* Loading State */
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        gap: 12px;
    }
    
    .loading-spinner {
        width: 36px;
        height: 36px;
        border: 3px solid var(--border);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    
    .loading-text {
        color: var(--muted);
        font-size: 0.9rem;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .page-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .page-header-left {
        display: flex;
        align-items: center;
        gap: 16px;
    }
    
    .page-header-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }
    
    .page-header-icon svg {
        width: 24px;
        height: 24px;
        color: white;
    }
    
    .page-header-text h1 {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text);
        margin: 0 0 2px 0;
        letter-spacing: -0.02em;
    }
    
    .page-header-text p {
        color: var(--muted);
        margin: 0;
        font-size: 0.95rem;
    }

    .header-actions {
        display: flex;
        gap: 12px;
    }

    .header-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
    }

    .header-btn-primary {
        background: var(--primary);
        color: white;
    }

    .header-btn-primary:hover {
        background: var(--primary-hover);
    }

    .header-btn-outline {
        background: var(--surface);
        color: var(--text);
        border: 1px solid var(--border);
    }

    .header-btn-outline:hover {
        background: var(--surface-2);
        border-color: var(--primary);
    }

    .header-btn svg {
        width: 18px;
        height: 18px;
    }

    /* Group Section */
    .favorites-section {
        margin-bottom: 32px;
        background: var(--surface);
        border-radius: 12px;
        padding: 20px;
    }

    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 0 12px 0;
        border-bottom: 1px solid var(--border);
        margin-bottom: 16px;
        cursor: pointer;
        user-select: none;
    }

    .section-header:hover .section-title {
        color: var(--primary);
    }

    .section-header-left {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .collapse-toggle {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        transition: transform 0.2s;
    }

    .collapse-toggle svg {
        width: 18px;
        height: 18px;
    }

    .section-header.collapsed .collapse-toggle {
        transform: rotate(-90deg);
    }

    .section-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .section-title svg {
        width: 18px;
        height: 18px;
        color: var(--muted);
    }

    .section-count {
        font-size: 0.85rem;
        color: var(--muted);
        font-weight: 400;
    }

    .section-content {
        transition: max-height 0.3s ease-out, margin 0.3s ease-out;
        overflow: hidden;
    }

    .section-content.collapsed {
        max-height: 0 !important;
        margin-top: 0;
    }

    /* Favorites Grid */
    .favorites-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 16px;
    }
    
    .favorite-item {
        background: var(--surface-2);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        position: relative;
        transition: all 0.15s;
    }
    
    .favorite-item:hover {
        border-color: var(--primary);
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
    }
    
    .favorite-item-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        min-width: 0;
    }
    
    .favorite-item-name {
        font-weight: 600;
        color: var(--primary);
        font-size: 0.95rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-decoration: underline;
        flex: 1;
        min-width: 0;
    }

    .favorite-item-name:hover {
        color: var(--primary-hover);
    }

    .favorite-item-actions {
        display: flex;
        gap: 4px;
        opacity: 0;
        transition: opacity 0.15s;
    }

    .favorite-item:hover .favorite-item-actions {
        opacity: 1;
    }

    .favorite-action-btn {
        background: none;
        border: none;
        color: var(--muted);
        cursor: pointer;
        padding: 4px;
        line-height: 1;
        border-radius: 4px;
        transition: all 0.15s;
    }

    .favorite-action-btn:hover {
        background: var(--surface);
        color: var(--text);
    }

    .favorite-action-btn.delete:hover {
        color: var(--danger);
    }

    .favorite-action-btn svg {
        width: 16px;
        height: 16px;
    }
    
    .favorite-prices {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
    }
    
    .favorite-price {
        display: flex;
        flex-direction: column;
    }
    
    .favorite-price-label {
        color: var(--muted);
        font-size: 0.7rem;
        text-transform: uppercase;
        margin-bottom: 2px;
    }
    
    .favorite-price-value {
        color: var(--text);
        font-weight: 600;
        font-size: 0.95rem;
    }
    
    .favorite-price-value.high { color: #16A34A; }
    .favorite-price-value.low { color: #DC2626; }
    
    .favorite-spread {
        font-size: 0.8rem;
        color: var(--muted);
        text-align: center;
        padding-top: 8px;
        border-top: 1px solid var(--border);
    }
    
    .favorite-spread strong {
        color: var(--primary);
    }

    .favorite-groups-badge {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 4px;
    }

    .group-badge {
        font-size: 0.7rem;
        padding: 2px 6px;
        background: rgba(99, 102, 241, 0.1);
        color: var(--primary);
        border-radius: 4px;
    }

    /* Add Item Card */
    .add-item-card {
        background: transparent;
        border: 2px dashed var(--border);
        border-radius: 10px;
        padding: 14px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.15s;
        min-height: 120px;
    }

    .add-item-card:hover {
        border-color: var(--primary);
        background: rgba(99, 102, 241, 0.03);
    }

    .add-item-card svg {
        width: 28px;
        height: 28px;
        color: var(--muted);
        margin-bottom: 6px;
    }

    .add-item-card:hover svg {
        color: var(--primary);
    }

    .add-item-card span {
        font-size: 0.85rem;
        color: var(--muted);
        font-weight: 500;
    }

    .add-item-card:hover span {
        color: var(--primary);
    }

    /* Ungrouped section (no card wrapper) */
    .ungrouped-section {
        margin-bottom: 24px;
        background: var(--surface);
        border-radius: 12px;
        padding: 20px;
    }

    .ungrouped-section .section-header {
        cursor: default;
    }

    .ungrouped-section .section-header:hover .section-title {
        color: var(--text);
    }

    /* Modal styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    
    .modal-overlay.show {
        display: flex;
    }
    
    .modal-content {
        background: var(--surface);
        border-radius: 12px;
        width: 90%;
        max-width: 440px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        position: sticky;
        top: 0;
        background: var(--surface);
        z-index: 1;
    }
    
    .modal-header h3 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: var(--muted);
        cursor: pointer;
        line-height: 1;
    }
    
    .modal-close:hover {
        color: var(--text);
    }
    
    .modal-body {
        padding: 20px;
    }

    .form-group {
        margin-bottom: 16px;
    }

    .form-group:last-child {
        margin-bottom: 0;
    }

    .form-label {
        display: block;
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--text);
        margin-bottom: 8px;
    }
    
    .search-input-wrapper {
        position: relative;
    }
    
    .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 1rem;
        color: var(--text);
        background: var(--surface);
    }
    
    .form-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .search-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-top: 4px;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: 10;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .search-suggestions.show {
        display: block;
    }
    
    .search-suggestion {
        padding: 10px 16px;
        cursor: pointer;
        font-size: 0.9rem;
    }
    
    .search-suggestion:hover,
    .search-suggestion.highlighted {
        background: var(--surface-2);
    }
    
    .search-suggestion.highlighted {
        background: rgba(99, 102, 241, 0.1);
        color: var(--primary);
    }
    
    .selected-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--surface-2);
        padding: 10px 14px;
        border-radius: 8px;
    }
    
    .selected-item-name {
        font-weight: 500;
        color: var(--text);
    }
    
    .selected-item-clear {
        background: none;
        border: none;
        color: var(--muted);
        cursor: pointer;
        font-size: 18px;
        line-height: 1;
    }
    
    .selected-item-clear:hover {
        color: var(--danger);
    }

    /* Checkbox group for multi-select */
    .checkbox-group {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--border);
        border-radius: 8px;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        padding: 10px 14px;
        cursor: pointer;
        transition: background 0.15s;
    }

    .checkbox-item:hover {
        background: var(--surface-2);
    }

    .checkbox-item:not(:last-child) {
        border-bottom: 1px solid var(--border);
    }

    .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        margin-right: 10px;
        cursor: pointer;
    }

    .checkbox-item label {
        flex: 1;
        cursor: pointer;
        font-size: 0.95rem;
    }

    .new-group-input {
        margin-top: 8px;
    }
    
    .modal-submit {
        width: 100%;
        padding: 12px 16px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        margin-top: 16px;
        transition: background 0.2s;
    }
    
    .modal-submit:hover:not(:disabled) {
        background: var(--primary-hover);
    }
    
    .modal-submit:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Delete Confirmation */
    .delete-confirm-content {
        padding: 24px;
        text-align: center;
    }
    
    .delete-confirm-icon {
        width: 48px;
        height: 48px;
        background: rgba(239, 68, 68, 0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
    }
    
    .delete-confirm-icon svg {
        width: 24px;
        height: 24px;
        color: var(--danger);
    }
    
    .delete-confirm-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0 0 8px 0;
    }
    
    .delete-confirm-message {
        color: var(--muted);
        font-size: 0.9rem;
        margin: 0 0 20px 0;
    }
    
    .delete-confirm-item-name {
        font-weight: 600;
        color: var(--text);
    }
    
    .delete-confirm-buttons {
        display: flex;
        gap: 12px;
    }
    
    .delete-confirm-btn {
        flex: 1;
        padding: 10px 16px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
    }
    
    .delete-confirm-btn.cancel {
        background: var(--surface-2);
        color: var(--text);
    }
    
    .delete-confirm-btn.cancel:hover {
        background: var(--border);
    }
    
    .delete-confirm-btn.delete {
        background: var(--danger);
        color: white;
    }
    
    .delete-confirm-btn.delete:hover {
        background: #DC2626;
    }

    /* Manage Groups Modal */
    .groups-list {
        max-height: 300px;
        overflow-y: auto;
    }

    .group-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-bottom: 8px;
    }

    .group-item:last-child {
        margin-bottom: 0;
    }

    .group-item-name {
        font-weight: 500;
        color: var(--text);
    }

    .group-item-count {
        font-size: 0.85rem;
        color: var(--muted);
        margin-left: 8px;
    }

    .group-delete-btn {
        background: none;
        border: none;
        color: var(--muted);
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        transition: all 0.2s;
    }

    .group-delete-btn:hover {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
    }

    .no-groups-message {
        text-align: center;
        color: var(--muted);
        padding: 20px;
    }

    /* Chart Modal */
    .chart-modal-content {
        max-width: 800px;
        width: 95%;
    }

    .chart-container {
        position: relative;
        height: 400px;
        margin-top: 16px;
    }

    .chart-loading {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 16px;
        z-index: 10;
        border-radius: 8px;
    }

    .loading-spinner {
        width: 48px;
        height: 48px;
        border: 4px solid var(--border);
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-text {
        font-size: 1rem;
        color: var(--muted);
    }

    .chart-range-btns {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .chart-btn {
        padding: 8px 16px;
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--text);
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .chart-btn:hover {
        background: var(--surface-2);
    }

    .chart-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    @media (max-width: 640px) {
        .page-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .favorites-grid {
            grid-template-columns: 1fr;
        }

        .favorites-section {
            padding: 12px;
        }

        .ungrouped-section {
            padding: 12px;
        }

        .favorite-item {
            padding: 12px;
            min-width: 0;
        }

        .favorite-item-name {
            font-size: 0.85rem;
        }

        .header-actions {
            width: 100%;
        }

        .header-btn {
            flex: 1;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-left">
        <div class="page-header-icon">
            <svg fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
            </svg>
        </div>
        <div class="page-header-text">
            <h1>My Favorites</h1>
            <p>Track your favorite items and their prices</p>
        </div>
    </div>
    <div class="header-actions">
        <button class="header-btn header-btn-outline" id="manageGroupsBtn" onclick="openManageGroupsModal()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
            </svg>
            Manage Groups
        </button>
        <button class="header-btn header-btn-primary" onclick="openAddFavoriteModal()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Add Item
        </button>
    </div>
</div>

<div id="favorites-content">
    <div class="loading-container">
        <div class="loading-spinner"></div>
        <span class="loading-text">Loading</span>
    </div>
</div>

<!-- Add Favorite Modal -->
<div class="modal-overlay" id="addFavoriteModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Favorite Item</h3>
            <button class="modal-close" onclick="closeAddFavoriteModal()">×</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Item</label>
                <div class="search-input-wrapper">
                    <input type="text" class="form-input" id="addFavoriteInput" placeholder="Search for an item..." autocomplete="off">
                    <div class="search-suggestions" id="addFavoriteSuggestions"></div>
                </div>
                <div class="selected-item" id="addFavoriteSelected" style="display: none;">
                    <span class="selected-item-name" id="selectedItemName"></span>
                    <button class="selected-item-clear" onclick="clearSelectedItem()">×</button>
                </div>
                <input type="hidden" id="selectedItemId" value="">
            </div>
            
            <div class="form-group" id="addGroupsSection" style="display: none;">
                <label class="form-label">Groups (Optional)</label>
                <div class="checkbox-group" id="addGroupCheckboxes">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Create New Group (Optional)</label>
                <input type="text" class="form-input" id="newGroupInput" placeholder="Enter group name...">
            </div>
            
            <button type="button" class="modal-submit" id="addFavoriteSubmit" onclick="submitFavorite()" disabled>Add to Favorites</button>
        </div>
    </div>
</div>

<!-- Edit Groups Modal -->
<div class="modal-overlay" id="editGroupsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Groups</h3>
            <button class="modal-close" onclick="closeEditGroupsModal()">×</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Item: <span id="editItemName"></span></label>
                <input type="hidden" id="editItemId">
            </div>
            
            <div class="form-group" id="editGroupsSection">
                <label class="form-label">Select Groups</label>
                <div class="checkbox-group" id="editGroupCheckboxes">
                    <!-- Populated by JavaScript -->
                </div>
                <p class="no-groups-msg" style="color: var(--muted); display: none;">No groups created yet.</p>
            </div>
            
            <div class="form-group">
                <label class="form-label">Create New Group</label>
                <input type="text" class="form-input" id="editNewGroupInput" placeholder="Enter group name...">
            </div>
            
            <button type="button" class="modal-submit" onclick="saveItemGroups()">Save Changes</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteConfirmModal">
    <div class="modal-content">
        <div class="delete-confirm-content">
            <div class="delete-confirm-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
            </div>
            <h4 class="delete-confirm-title">Remove from Favorites?</h4>
            <p class="delete-confirm-message">
                Are you sure you want to remove <span class="delete-confirm-item-name" id="deleteItemName"></span> from your favorites?
            </p>
            <div class="delete-confirm-buttons">
                <button class="delete-confirm-btn cancel" onclick="closeDeleteModal()">Cancel</button>
                <button class="delete-confirm-btn delete" id="confirmDeleteBtn">Remove</button>
            </div>
        </div>
    </div>
</div>

<!-- Manage Groups Modal -->
<div class="modal-overlay" id="manageGroupsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Manage Groups</h3>
            <button class="modal-close" onclick="closeManageGroupsModal()">×</button>
        </div>
        <div class="modal-body">
            <div class="groups-list" id="groupsList">
                {% if groups %}
                    {% for group in groups %}
                    <div class="group-item" data-group-id="{{ group.id }}">
                        <div>
                            <span class="group-item-name">{{ group.name }}</span>
                            <span class="group-item-count">
                                {% with count=grouped_favorites|get_item:group.id|length|default:0 %}
                                ({{ count }} item{{ count|pluralize }})
                                {% endwith %}
                            </span>
                        </div>
                        <button class="group-delete-btn" onclick="deleteGroup({{ group.id }}, '{{ group.name|escapejs }}')">Delete</button>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="no-groups-message">No groups created yet</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Delete Group Confirmation Modal -->
<div class="modal-overlay" id="deleteGroupModal">
    <div class="modal-content">
        <div class="delete-confirm-content">
            <div class="delete-confirm-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
            </div>
            <h4 class="delete-confirm-title">Delete Group?</h4>
            <p class="delete-confirm-message">
                Are you sure you want to delete the group <span class="delete-confirm-item-name" id="deleteGroupName"></span>? Items in this group will become ungrouped.
            </p>
            <div class="delete-confirm-buttons">
                <button class="delete-confirm-btn cancel" onclick="closeDeleteGroupModal()">Cancel</button>
                <button class="delete-confirm-btn delete" id="confirmDeleteGroupBtn">Delete Group</button>
            </div>
        </div>
    </div>
</div>

<!-- Chart Modal -->
<div class="modal-overlay" id="chartModal">
    <div class="modal-content chart-modal-content">
        <div class="modal-header">
            <h3 id="chartModalTitle">Price History</h3>
            <button class="modal-close" onclick="closeChartModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="chart-range-btns">
                <button class="chart-btn" data-range="day">1D</button>
                <button class="chart-btn" data-range="week">1W</button>
                <button class="chart-btn active" data-range="month">1M</button>
                <button class="chart-btn" data-range="6month">6M</button>
                <button class="chart-btn" data-range="year">1Y</button>
            </div>
            <div class="chart-container">
                <div class="chart-loading" id="chartLoading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Loading chart...</div>
                </div>
                <canvas id="favoriteChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Store loaded data globally for use by other functions
let favoritesData = null;

// Format number with commas
function formatNumber(num) {
    if (num === null || num === undefined) return '-';
    return Math.round(num).toLocaleString();
}

// Escape HTML for safe insertion
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Render a single favorite item card
function renderFavoriteItem(fav) {
    const highPrice = fav.high_price ? formatNumber(fav.high_price) : '-';
    const lowPrice = fav.low_price ? formatNumber(fav.low_price) : '-';
    const spread = formatNumber(fav.spread);
    const spreadPct = fav.spread_pct ? fav.spread_pct.toFixed(1) : '0.0';
    const groupIds = JSON.stringify(fav.group_ids || []);
    const itemName = escapeHtml(fav.item_name);
    
    return `
        <div class="favorite-item" data-item-id="${fav.item_id}">
            <div class="favorite-item-header">
                <a href="/item_search/?id=${fav.item_id}&name=${encodeURIComponent(fav.item_name)}" class="favorite-item-name">${itemName}</a>
                <div class="favorite-item-actions">
                    <button class="favorite-action-btn" onclick="event.stopPropagation(); openChartModal(${fav.item_id}, '${fav.item_name.replace(/'/g, "\\'")}')" title="View Chart">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                        </svg>
                    </button>
                    <button class="favorite-action-btn" onclick="event.stopPropagation(); editFavoriteGroups(${fav.item_id}, '${fav.item_name.replace(/'/g, "\\'")}', ${groupIds})" title="Edit Groups">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                    </button>
                    <button class="favorite-action-btn delete" onclick="event.stopPropagation(); removeFavorite(${fav.item_id}, '${fav.item_name.replace(/'/g, "\\'")}')" title="Remove">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="favorite-prices">
                <div class="favorite-price">
                    <span class="favorite-price-label">High</span>
                    <span class="favorite-price-value high">${highPrice}</span>
                </div>
                <div class="favorite-price">
                    <span class="favorite-price-label">Low</span>
                    <span class="favorite-price-value low">${lowPrice}</span>
                </div>
            </div>
            <div class="favorite-spread">
                Spread: <strong>${spread}</strong> (${spreadPct}%)
            </div>
        </div>`;
}

// Render the favorites content
function renderFavoritesContent(data) {
    favoritesData = data;
    const container = document.getElementById('favorites-content');
    const groups = data.groups || [];
    const groupedFavorites = data.grouped_favorites || {};
    const ungroupedFavorites = data.ungrouped_favorites || [];
    const allFavorites = data.favorites || [];
    
    let html = '';
    
    // Render grouped favorites
    groups.forEach(group => {
        const groupItems = groupedFavorites[group.id] || [];
        if (groupItems.length > 0) {
            const itemCount = groupItems.length;
            const plural = itemCount !== 1 ? 's' : '';
            html += `
                <div class="favorites-section" data-group-id="${group.id}">
                    <div class="section-header" onclick="toggleGroup(${group.id})">
                        <div class="section-header-left">
                            <div class="collapse-toggle">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </div>
                            <div class="section-title">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                                </svg>
                                ${escapeHtml(group.name)}
                                <span class="section-count">(${itemCount} item${plural})</span>
                            </div>
                        </div>
                    </div>
                    <div class="section-content" id="group-content-${group.id}">
                        <div class="favorites-grid">
                            ${groupItems.map(renderFavoriteItem).join('')}
                        </div>
                    </div>
                </div>`;
        }
    });
    
    // Render ungrouped section only if there are ungrouped items
    if (ungroupedFavorites.length > 0) {
        const showUngroupedHeader = groups.length > 0;
        html += `
            <div class="ungrouped-section">
                ${showUngroupedHeader ? `
                    <div class="section-header">
                        <div class="section-header-left">
                            <div class="section-title">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                                </svg>
                                Ungrouped
                                <span class="section-count">(${ungroupedFavorites.length} item${ungroupedFavorites.length !== 1 ? 's' : ''})</span>
                            </div>
                        </div>
                    </div>
                ` : ''}
                <div class="favorites-grid">
                    ${ungroupedFavorites.map(renderFavoriteItem).join('')}
                </div>
            </div>`;
    }
    
    container.innerHTML = html;
    
    // Initialize collapsed groups state
    initializeCollapsedGroups();
}

// Load favorites data
function loadFavoritesData() {
    fetch('/api/favorites/data/')
        .then(response => response.json())
        .then(data => {
            renderFavoritesContent(data);
        })
        .catch(error => {
            console.error('Error loading favorites:', error);
            document.getElementById('favorites-content').innerHTML = 
                '<div class="empty-state"><p>Error loading favorites. Please refresh the page.</p></div>';
        });
}

// Load data on page load
loadFavoritesData();

// Group collapse state persistence
const COLLAPSED_GROUPS_KEY = 'favorites_collapsed_groups';

function getCollapsedGroups() {
    try {
        return JSON.parse(localStorage.getItem(COLLAPSED_GROUPS_KEY) || '[]');
    } catch {
        return [];
    }
}

function setCollapsedGroups(groups) {
    localStorage.setItem(COLLAPSED_GROUPS_KEY, JSON.stringify(groups));
}

function toggleGroup(groupId) {
    const section = document.querySelector(`.favorites-section[data-group-id="${groupId}"]`);
    const header = section.querySelector('.section-header');
    const content = document.getElementById(`group-content-${groupId}`);
    
    const collapsed = getCollapsedGroups();
    const index = collapsed.indexOf(groupId);
    
    if (index > -1) {
        // Expand
        collapsed.splice(index, 1);
        header.classList.remove('collapsed');
        content.classList.remove('collapsed');
    } else {
        // Collapse
        collapsed.push(groupId);
        header.classList.add('collapsed');
        content.classList.add('collapsed');
    }
    
    setCollapsedGroups(collapsed);
}

function initializeCollapsedGroups() {
    const collapsed = getCollapsedGroups();
    collapsed.forEach(groupId => {
        const section = document.querySelector(`.favorites-section[data-group-id="${groupId}"]`);
        if (section) {
            const header = section.querySelector('.section-header');
            const content = document.getElementById(`group-content-${groupId}`);
            if (header && content) {
                header.classList.add('collapsed');
                content.classList.add('collapsed');
            }
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    
    const modal = document.getElementById('addFavoriteModal');
    const input = document.getElementById('addFavoriteInput');
    const suggestions = document.getElementById('addFavoriteSuggestions');
    let debounceTimer;
    let highlightedIndex = -1;
    
    // Input search
    input.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value.trim();
        highlightedIndex = -1;
        
        if (query.length < 2) {
            suggestions.classList.remove('show');
            return;
        }
        
        debounceTimer = setTimeout(() => {
            fetch(`/api/items/?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    if (Array.isArray(data) && data.length > 0) {
                        suggestions.innerHTML = data.slice(0, 8).map(item => 
                            `<div class="search-suggestion" data-id="${item.id}" data-name="${item.name}">${item.name}</div>`
                        ).join('');
                        suggestions.classList.add('show');
                        highlightedIndex = -1;
                    } else {
                        suggestions.classList.remove('show');
                    }
                })
                .catch(err => {
                    console.error('Search error:', err);
                    suggestions.classList.remove('show');
                });
        }, 200);
    });
    
    // Keyboard navigation
    input.addEventListener('keydown', function(e) {
        const items = suggestions.querySelectorAll('.search-suggestion');
        
        if (e.key === 'ArrowDown' || (e.key === 'Tab' && !e.shiftKey)) {
            if (suggestions.classList.contains('show') && items.length > 0) {
                e.preventDefault();
                highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);
                updateHighlight(items);
            }
        } else if (e.key === 'ArrowUp' || (e.key === 'Tab' && e.shiftKey)) {
            if (suggestions.classList.contains('show') && items.length > 0) {
                e.preventDefault();
                highlightedIndex = Math.max(highlightedIndex - 1, 0);
                updateHighlight(items);
            }
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (highlightedIndex >= 0 && items[highlightedIndex]) {
                const item = items[highlightedIndex];
                selectItem(item.dataset.id, item.dataset.name);
            }
        } else if (e.key === 'Escape') {
            closeAddFavoriteModal();
        }
    });
    
    function updateHighlight(items) {
        items.forEach((item, idx) => {
            if (idx === highlightedIndex) {
                item.classList.add('highlighted');
                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('highlighted');
            }
        });
    }
    
    // Suggestion click
    suggestions.addEventListener('click', function(e) {
        if (e.target.classList.contains('search-suggestion')) {
            selectItem(e.target.dataset.id, e.target.dataset.name);
        }
    });
    
    // Close modals on background click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('show');
            }
        });
    });
    
    // Global escape key handler
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal-overlay.show').forEach(modal => {
                modal.classList.remove('show');
            });
        }
    });
});

function selectItem(itemId, itemName) {
    const input = document.getElementById('addFavoriteInput');
    const suggestions = document.getElementById('addFavoriteSuggestions');
    const selectedDiv = document.getElementById('addFavoriteSelected');
    const selectedName = document.getElementById('selectedItemName');
    const selectedIdInput = document.getElementById('selectedItemId');
    const submitBtn = document.getElementById('addFavoriteSubmit');
    
    input.style.display = 'none';
    suggestions.classList.remove('show');
    selectedDiv.style.display = 'flex';
    selectedName.textContent = itemName;
    selectedIdInput.value = itemId;
    selectedIdInput.dataset.name = itemName;
    submitBtn.disabled = false;
}

function clearSelectedItem() {
    const input = document.getElementById('addFavoriteInput');
    const selectedDiv = document.getElementById('addFavoriteSelected');
    const selectedIdInput = document.getElementById('selectedItemId');
    const submitBtn = document.getElementById('addFavoriteSubmit');
    
    input.style.display = 'block';
    input.value = '';
    input.focus();
    selectedDiv.style.display = 'none';
    selectedIdInput.value = '';
    selectedIdInput.dataset.name = '';
    submitBtn.disabled = true;
}

function getSelectedGroupIds(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return [];
    
    const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
    return Array.from(checkboxes).map(cb => parseInt(cb.value));
}

function submitFavorite() {
    const selectedIdInput = document.getElementById('selectedItemId');
    const itemId = selectedIdInput.value;
    const itemName = selectedIdInput.dataset.name;
    const newGroupInput = document.getElementById('newGroupInput');
    
    if (!itemId || !itemName) return;
    
    const payload = {
        item_id: parseInt(itemId),
        item_name: itemName,
        group_ids: getSelectedGroupIds('addGroupCheckboxes')
    };
    
    if (newGroupInput && newGroupInput.value.trim()) {
        payload.new_group_name = newGroupInput.value.trim();
    }
    
    const csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    
    fetch('/api/favorites/add/', {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            closeAddFavoriteModal();
            location.reload();
        } else {
            alert('Failed to add favorite: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Error adding favorite:', err);
        alert('Failed to add favorite. Please try again.');
    });
}

function populateGroupCheckboxes(containerIdPrefix, selectedGroupIds = []) {
    const container = document.getElementById(containerIdPrefix + 'Checkboxes');
    const section = document.getElementById(containerIdPrefix.replace('add', 'addGroups').replace('edit', 'editGroups') + 'Section') || document.getElementById('addGroupsSection');
    
    if (!favoritesData || !favoritesData.groups || favoritesData.groups.length === 0) {
        container.innerHTML = '';
        if (containerIdPrefix === 'addGroup') {
            document.getElementById('addGroupsSection').style.display = 'none';
        } else {
            const noGroupsMsg = document.querySelector('#editGroupsSection .no-groups-msg');
            if (noGroupsMsg) noGroupsMsg.style.display = 'block';
        }
        return;
    }
    
    if (containerIdPrefix === 'addGroup') {
        document.getElementById('addGroupsSection').style.display = '';
    } else {
        const noGroupsMsg = document.querySelector('#editGroupsSection .no-groups-msg');
        if (noGroupsMsg) noGroupsMsg.style.display = 'none';
    }
    
    let html = '';
    favoritesData.groups.forEach(group => {
        const checked = selectedGroupIds.includes(group.id) ? 'checked' : '';
        html += `
            <div class="checkbox-item">
                <input type="checkbox" id="${containerIdPrefix}-${group.id}" value="${group.id}" ${checked}>
                <label for="${containerIdPrefix}-${group.id}">${escapeHtml(group.name)}</label>
            </div>`;
    });
    container.innerHTML = html;
}

function openAddFavoriteModal() {
    const modal = document.getElementById('addFavoriteModal');
    const input = document.getElementById('addFavoriteInput');
    const newGroupInput = document.getElementById('newGroupInput');
    
    // Populate checkboxes from loaded data
    populateGroupCheckboxes('addGroup');
    
    modal.classList.add('show');
    clearSelectedItem();
    if (newGroupInput) newGroupInput.value = '';
    input.focus();
}

function closeAddFavoriteModal() {
    document.getElementById('addFavoriteModal').classList.remove('show');
    document.getElementById('addFavoriteSuggestions').classList.remove('show');
    clearSelectedItem();
}

function editFavoriteGroups(itemId, itemName, currentGroupIds) {
    const modal = document.getElementById('editGroupsModal');
    document.getElementById('editItemId').value = itemId;
    document.getElementById('editItemName').textContent = itemName;
    
    // Clear new group input
    const newGroupInput = document.getElementById('editNewGroupInput');
    if (newGroupInput) newGroupInput.value = '';
    
    // Populate checkboxes from loaded data with current selections
    populateGroupCheckboxes('editGroup', currentGroupIds);
    
    modal.classList.add('show');
}

function closeEditGroupsModal() {
    document.getElementById('editGroupsModal').classList.remove('show');
}

function saveItemGroups() {
    const itemId = document.getElementById('editItemId').value;
    const newGroupInput = document.getElementById('editNewGroupInput');
    
    const payload = {
        item_id: parseInt(itemId),
        group_ids: getSelectedGroupIds('editGroupCheckboxes')
    };
    
    if (newGroupInput && newGroupInput.value.trim()) {
        payload.new_group_name = newGroupInput.value.trim();
    }
    
    const csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    
    fetch('/api/favorites/update-group/', {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            closeEditGroupsModal();
            location.reload();
        } else {
            alert('Failed to update groups: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Error updating groups:', err);
        alert('Failed to update groups. Please try again.');
    });
}

function removeFavorite(itemId, itemName) {
    const deleteModal = document.getElementById('deleteConfirmModal');
    const deleteItemName = document.getElementById('deleteItemName');
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    
    deleteItemName.textContent = itemName;
    deleteModal.classList.add('show');
    
    confirmBtn.onclick = function() {
        doRemoveFavorite(itemId);
    };
}

function closeDeleteModal() {
    document.getElementById('deleteConfirmModal').classList.remove('show');
}

function doRemoveFavorite(itemId) {
    const csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    
    fetch('/api/favorites/remove/', {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ item_id: itemId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            closeDeleteModal();
            // Remove all instances of this item from the page
            document.querySelectorAll(`.favorite-item[data-item-id="${itemId}"]`).forEach(el => el.remove());
            checkEmptySections();
        }
    })
    .catch(err => {
        console.error('Error removing favorite:', err);
        closeDeleteModal();
    });
}

function checkEmptySections() {
    // Update counts and remove empty sections
    document.querySelectorAll('.favorites-section').forEach(section => {
        const items = section.querySelectorAll('.favorite-item');
        if (items.length === 0) {
            section.remove();
        } else {
            // Update the counter
            const countSpan = section.querySelector('.section-count');
            if (countSpan) {
                countSpan.textContent = `(${items.length} item${items.length !== 1 ? 's' : ''})`;
            }
        }
    });
    
    // Also handle ungrouped section
    const ungroupedSection = document.querySelector('.ungrouped-section');
    if (ungroupedSection) {
        const items = ungroupedSection.querySelectorAll('.favorite-item');
        if (items.length === 0) {
            ungroupedSection.remove();
        } else {
            const countSpan = ungroupedSection.querySelector('.section-count');
            if (countSpan) {
                countSpan.textContent = `(${items.length} item${items.length !== 1 ? 's' : ''})`;
            }
        }
    }
}

function openManageGroupsModal() {
    document.getElementById('manageGroupsModal').classList.add('show');
}

function closeManageGroupsModal() {
    document.getElementById('manageGroupsModal').classList.remove('show');
}

function deleteGroup(groupId, groupName) {
    closeManageGroupsModal();
    
    const modal = document.getElementById('deleteGroupModal');
    const nameSpan = document.getElementById('deleteGroupName');
    const confirmBtn = document.getElementById('confirmDeleteGroupBtn');
    
    nameSpan.textContent = groupName;
    modal.classList.add('show');
    
    confirmBtn.onclick = function() {
        doDeleteGroup(groupId);
    };
}

function closeDeleteGroupModal() {
    document.getElementById('deleteGroupModal').classList.remove('show');
}

function doDeleteGroup(groupId) {
    const csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    
    fetch('/api/favorites/groups/delete/', {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ group_id: groupId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            closeDeleteGroupModal();
            location.reload();
        } else {
            alert('Failed to delete group: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Error deleting group:', err);
        closeDeleteGroupModal();
    });
}

// Chart Modal Functions
let chartInstance = null;
let chartData = null;
let currentChartItemId = null;
let currentTimestep = null;

function openChartModal(itemId, itemName) {
    const modal = document.getElementById('chartModal');
    const title = document.getElementById('chartModalTitle');
    title.textContent = `${itemName} - Price History`;
    currentChartItemId = itemId;
    modal.classList.add('show');
    
    // Reset to default range and load chart
    document.querySelectorAll('.chart-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.range === 'month') btn.classList.add('active');
    });
    
    loadChart(itemId, 'month');
}

function closeChartModal() {
    document.getElementById('chartModal').classList.remove('show');
    if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
    }
    chartData = null;
    currentChartItemId = null;
    currentTimestep = null;
}

async function loadChart(itemId, range) {
    const loading = document.getElementById('chartLoading');
    loading.style.display = 'flex';
    
    // Determine timestep based on range
    let timestep;
    if (range === 'day') {
        timestep = '5m';
    } else if (range === 'week') {
        timestep = '1h';
    } else {
        timestep = '24h';
    }
    
    try {
        const response = await fetch('/api/item/history/?id=' + itemId + '&timestep=' + timestep);
        const data = await response.json();
        
        if (data.data && data.data.length > 0) {
            chartData = data.data;
            currentTimestep = timestep;
            filterAndDisplayChart(range);
        } else {
            displayEmptyChart();
        }
    } catch (error) {
        console.error('Error loading price history:', error);
        displayEmptyChart();
    } finally {
        loading.style.display = 'none';
    }
}

async function switchChartRange(range) {
    let requiredTimestep;
    if (range === 'day') {
        requiredTimestep = '5m';
    } else if (range === 'week') {
        requiredTimestep = '1h';
    } else {
        requiredTimestep = '24h';
    }
    
    if (currentTimestep !== requiredTimestep && currentChartItemId) {
        const loading = document.getElementById('chartLoading');
        loading.style.display = 'flex';
        
        try {
            const response = await fetch('/api/item/history/?id=' + currentChartItemId + '&timestep=' + requiredTimestep);
            const data = await response.json();
            
            if (data.data && data.data.length > 0) {
                chartData = data.data;
                currentTimestep = requiredTimestep;
            }
        } catch (error) {
            console.error('Error loading price history:', error);
        } finally {
            loading.style.display = 'none';
        }
    }
    
    filterAndDisplayChart(range);
}

function filterAndDisplayChart(range) {
    if (!chartData) return;
    
    const now = Date.now() / 1000;
    let filteredData = chartData;
    let minTime, maxTime;
    
    maxTime = new Date();
    
    switch (range) {
        case 'day':
            filteredData = chartData.filter(d => d.timestamp > now - 86400);
            minTime = new Date(Date.now() - 86400 * 1000);
            break;
        case 'week':
            filteredData = chartData.filter(d => d.timestamp > now - 604800);
            minTime = new Date(Date.now() - 604800 * 1000);
            break;
        case 'month':
            filteredData = chartData.filter(d => d.timestamp > now - 2592000);
            minTime = new Date(Date.now() - 2592000 * 1000);
            break;
        case '6month':
            filteredData = chartData.filter(d => d.timestamp > now - 15552000);
            minTime = new Date(Date.now() - 15552000 * 1000);
            break;
        case 'year':
            minTime = new Date(Date.now() - 365 * 86400 * 1000);
            break;
    }
    
    displayChart(filteredData, minTime, maxTime);
}

function displayChart(data, minTime, maxTime) {
    const ctx = document.getElementById('favoriteChart').getContext('2d');
    
    if (chartInstance) {
        chartInstance.destroy();
    }
    
    const labels = data.map(d => new Date(d.timestamp * 1000));
    const highPrices = data.map(d => d.avgHighPrice);
    const lowPrices = data.map(d => d.avgLowPrice);
    
    chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Instant Buy (High)',
                    data: highPrices,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 5,
                    pointHitRadius: 10,
                    tension: 0.3,
                    fill: false,
                    spanGaps: true
                },
                {
                    label: 'Instant Sell (Low)',
                    data: lowPrices,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 5,
                    pointHitRadius: 10,
                    tension: 0.3,
                    fill: false,
                    spanGaps: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    left: 10,
                    right: 20
                }
            },
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 14 },
                    bodyFont: { size: 13 },
                    callbacks: {
                        title: function(context) {
                            return new Date(context[0].parsed.x).toLocaleString();
                        },
                        label: function(context) {
                            return context.dataset.label + ': ' + 
                                (context.parsed.y ? context.parsed.y.toLocaleString() + ' gp' : 'N/A');
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    min: minTime,
                    max: maxTime,
                    time: {
                        displayFormats: {
                            hour: 'MMM d, HH:mm',
                            day: 'MMM d',
                            week: 'MMM d',
                            month: 'MMM yyyy'
                        }
                    },
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxTicksLimit: 8
                    }
                },
                y: {
                    beginAtZero: false,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            if (value >= 1000000) {
                                return (value / 1000000).toFixed(1) + 'M';
                            } else if (value >= 1000) {
                                return (value / 1000).toFixed(0) + 'K';
                            }
                            return value;
                        }
                    }
                }
            }
        }
    });
}

function displayEmptyChart() {
    const ctx = document.getElementById('favoriteChart').getContext('2d');
    
    if (chartInstance) {
        chartInstance.destroy();
    }
    
    chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: 'No price history available',
                    font: { size: 16 }
                }
            }
        }
    });
}

// Chart range button click handlers
document.querySelectorAll('.chart-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        switchChartRange(btn.dataset.range);
    });
});

// Close modal on backdrop click
document.getElementById('chartModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeChartModal();
    }
});
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
{% endblock %}
