{% extends 'base.html' %}
{% load humanize %}
{% load favorites_tags %}

{% block title %}My Favorites - GE Tools{% endblock %}

{% block extra_css %}
<style>
    :root {
        --bg: #F8F9FA;
        --surface: #FFFFFF;
        --surface-2: #F5F6F8;
        --border: #E5E7EB;
        --text: #374151;
        --muted: #6B7280;
        --primary: #6366F1;
        --primary-hover: #5558E3;
        --success: #22C55E;
        --danger: #EF4444;
        --warning: #F59E0B;
    }

    /* Quick Stats Bar */
    .quick-stats-bar {
        display: flex;
        gap: 16px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .stat-card {
        flex: 1;
        min-width: 180px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: all 0.2s;
    }

    .stat-card:hover {
        border-color: var(--primary);
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
    }

    .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .stat-icon.primary {
        background: rgba(99, 102, 241, 0.1);
        color: var(--primary);
    }

    .stat-icon.success {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success);
    }

    .stat-icon.warning {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
    }

    .stat-icon svg {
        width: 20px;
        height: 20px;
    }

    .stat-content {
        flex: 1;
        min-width: 0;
    }

    .stat-label {
        font-size: 0.75rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.025em;
        margin-bottom: 2px;
    }

    .stat-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text);
        line-height: 1;
    }

    .stat-sub {
        font-size: 0.7rem;
        color: var(--muted);
        margin-top: 2px;
    }

    /* Toolbar Section */
    .favorites-toolbar {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 20px;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
    }

    .toolbar-search {
        flex: 1;
        min-width: 200px;
        position: relative;
    }

    .toolbar-search input {
        width: 100%;
        padding: 10px 36px 10px 40px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 0.9rem;
        transition: all 0.2s;
    }

    .toolbar-search input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .toolbar-search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--muted);
        pointer-events: none;
    }

    .toolbar-search-icon svg {
        width: 18px;
        height: 18px;
    }

    .toolbar-search-clear {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--muted);
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        display: none;
        transition: all 0.15s;
    }

    .toolbar-search-clear:hover {
        background: var(--surface-2);
        color: var(--text);
    }

    .toolbar-search-clear svg {
        width: 16px;
        height: 16px;
    }

    .toolbar-search-clear.show {
        display: block;
    }

    .toolbar-controls {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .toolbar-select {
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 0.9rem;
        color: var(--text);
        background: var(--surface);
        cursor: pointer;
        transition: all 0.2s;
    }

    .toolbar-select:hover {
        border-color: var(--primary);
    }

    .toolbar-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .view-toggle {
        display: flex;
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
    }

    .view-toggle-btn {
        padding: 10px 16px;
        background: var(--surface);
        border: none;
        color: var(--muted);
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .view-toggle-btn:not(:last-child) {
        border-right: 1px solid var(--border);
    }

    .view-toggle-btn:hover {
        background: var(--surface-2);
        color: var(--text);
    }

    .view-toggle-btn.active {
        background: var(--primary);
        color: white;
    }

    .view-toggle-btn svg {
        width: 16px;
        height: 16px;
    }

    /* Last Updated Indicator */
    .last-updated {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.8rem;
        color: var(--muted);
        padding: 8px 12px;
        background: var(--surface-2);
        border-radius: 6px;
    }

    .last-updated svg {
        width: 14px;
        height: 14px;
    }
    
    .refresh-btn {
        background: none;
        border: none;
        color: var(--muted);
        cursor: pointer;
        padding: 2px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        margin-left: 4px;
        transition: all 0.2s;
    }
    
    .refresh-btn:hover {
        color: var(--primary);
        background: var(--surface-2);
    }

    /* Compact View Adjustments */
    .view-compact .favorites-grid {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 6px;
    }

    .view-compact .favorite-item {
        padding: 6px;
        gap: 4px;
    }

    .view-compact .favorite-item-name {
        font-size: 0.75rem;
    }

    .view-compact .favorite-prices {
        font-size: 0.7rem;
    }

    .view-compact .favorite-price-value {
        font-size: 0.75rem;
    }

    .view-compact .favorite-spread {
        font-size: 0.65rem;
        padding-top: 4px;
    }

    .view-compact .favorites-section,
    .view-compact .ungrouped-section {
        padding: 10px;
        margin-bottom: 10px;
    }
    
    .view-compact .section-header {
        padding: 0;
        margin-bottom: 4px;
    }
    
    .view-compact .section-title {
        font-size: 0.8rem;
    }

    /* List View */
    .view-list .favorites-grid {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .view-list .favorite-item {
        flex-direction: row;
        align-items: center;
        padding: 12px 16px;
        gap: 16px;
    }

    .view-list .favorite-item-header {
        flex: 1;
        min-width: 150px;
    }

    .view-list .favorite-prices {
        display: flex;
        gap: 24px;
        flex-shrink: 0;
    }

    .view-list .favorite-price {
        flex-direction: row;
        align-items: center;
        gap: 8px;
    }

    .view-list .favorite-price-label {
        font-size: 0.75rem;
        margin-bottom: 0;
    }

    .view-list .favorite-spread {
        border-top: none;
        border-left: 1px solid var(--border);
        padding: 0 0 0 16px;
        margin-left: 8px;
        text-align: left;
        min-width: 120px;
        flex-shrink: 0;
    }

    /* Tooltip Styles */
    .tooltip-trigger {
        position: relative;
    }

    .tooltip-text {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        padding: 6px 10px;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        font-size: 0.75rem;
        border-radius: 6px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
        z-index: 100;
        margin-bottom: 6px;
    }

    .tooltip-text::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 4px solid transparent;
        border-top-color: rgba(0, 0, 0, 0.9);
    }

    .tooltip-trigger:hover .tooltip-text {
        opacity: 1;
    }

    /* Keyboard Shortcuts Help */
    .keyboard-shortcuts-badge {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 48px;
        height: 48px;
        background: var(--primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        transition: all 0.2s;
        z-index: 50;
    }

    .keyboard-shortcuts-badge:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(99, 102, 241, 0.5);
    }

    .keyboard-shortcuts-badge svg {
        width: 24px;
        height: 24px;
    }

    .shortcuts-modal .modal-content {
        max-width: 500px;
    }

    .shortcuts-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .shortcut-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: var(--surface-2);
        border-radius: 6px;
    }

    .shortcut-keys {
        display: flex;
        gap: 4px;
    }

    .shortcut-key {
        padding: 4px 8px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 0.75rem;
        font-family: monospace;
        font-weight: 600;
        color: var(--text);
    }

    .shortcut-desc {
        font-size: 0.9rem;
        color: var(--text);
    }

    /* Loading State */
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        gap: 12px;
    }
    
    .loading-spinner {
        width: 36px;
        height: 36px;
        border: 3px solid var(--border);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    
    .loading-text {
        color: var(--muted);
        font-size: 0.9rem;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .page-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .page-header-left {
        display: flex;
        align-items: center;
        gap: 16px;
    }
    
    .page-header-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }
    
    .page-header-icon svg {
        width: 24px;
        height: 24px;
        color: white;
    }
    
    .page-header-text h1 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text);
        margin: 0 0 2px 0;
        letter-spacing: -0.02em;
    }

    .page-header-text p {
        color: var(--muted);
        margin: 0;
        font-size: 0.85rem;
    }

    .header-actions {
        display: flex;
        gap: 12px;
    }

    .header-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
    }

    .header-btn-primary {
        background: var(--primary);
        color: white;
    }

    .header-btn-primary:hover {
        background: var(--primary-hover);
    }

    .header-btn-outline {
        background: var(--surface);
        color: var(--text);
        border: 1px solid var(--border);
    }

    .header-btn-outline:hover {
        background: var(--surface-2);
        border-color: var(--primary);
    }

    .header-btn svg {
        width: 18px;
        height: 18px;
    }

    /* Group Section */
    .favorites-section {
        margin-bottom: 32px;
        background: var(--surface);
        border-radius: 12px;
        padding: 20px;
    }

    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0;
        border-bottom: 1px solid var(--border);
        margin-bottom: 6px;
        cursor: pointer;
        user-select: none;
    }

    .section-header:hover .section-title {
        color: var(--primary);
    }

    .section-header-left {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .collapse-toggle {
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        transition: transform 0.2s;
    }

    .collapse-toggle svg {
        width: 14px;
        height: 14px;
    }

    .section-header.collapsed .collapse-toggle {
        transform: rotate(-90deg);
    }

    .section-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .section-title svg {
        width: 14px;
        height: 14px;
        color: var(--muted);
    }

    .section-count {
        font-size: 0.75rem;
        color: var(--muted);
        font-weight: 400;
    }

    .section-content {
        transition: max-height 0.3s ease-out, margin 0.3s ease-out;
        overflow: hidden;
    }

    .section-content.collapsed {
        max-height: 0 !important;
        margin-top: 0;
    }

    /* Favorites Grid */
    .favorites-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 16px;
    }
    
    .favorite-item {
        background: var(--surface-2);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        position: relative;
        transition: all 0.15s;
    }
    
    .favorite-item:hover {
        border-color: var(--primary);
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
    }
    
    .favorite-item-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        min-width: 0;
    }
    
    .favorite-item-name {
        font-weight: 600;
        color: var(--primary);
        font-size: 0.95rem;
        white-space: normal;
        overflow: visible;
        text-overflow: unset;
        text-decoration: underline;
        flex: 1;
        min-width: 0;
        word-break: break-word;
    }

    .favorite-item-name:hover {
        color: var(--primary-hover);
    }

    .favorite-item-actions {
        display: flex;
        gap: 4px;
        opacity: 1;
        transition: opacity 0.15s;
    }

    .favorite-action-btn {
        background: none;
        border: none;
        color: var(--muted);
        cursor: pointer;
        padding: 4px;
        line-height: 1;
        border-radius: 4px;
        transition: all 0.15s;
    }

    .favorite-action-btn:hover {
        background: var(--surface);
        color: var(--text);
    }

    .favorite-action-btn.delete:hover {
        color: var(--danger);
    }

    .favorite-action-btn svg {
        width: 16px;
        height: 16px;
    }
    
    .favorite-prices {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
    }
    
    .favorite-price {
        display: flex;
        flex-direction: column;
    }
    
    .favorite-price-label {
        color: var(--muted);
        font-size: 0.7rem;
        text-transform: uppercase;
        margin-bottom: 2px;
    }
    
    .favorite-price-value {
        color: var(--text);
        font-weight: 600;
        font-size: 0.95rem;
    }
    
    .favorite-price-value.high { color: #16A34A; }
    .favorite-price-value.low { color: #DC2626; }
    
    .favorite-spread {
        font-size: 0.8rem;
        color: var(--muted);
        text-align: center;
        padding-top: 8px;
        border-top: 1px solid var(--border);
    }
    
    .favorite-spread strong {
        color: var(--primary);
    }

    .favorite-groups-badge {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 4px;
    }

    .group-badge {
        font-size: 0.7rem;
        padding: 2px 6px;
        background: rgba(99, 102, 241, 0.1);
        color: var(--primary);
        border-radius: 4px;
    }

    /* Add Item Card */
    .add-item-card {
        background: transparent;
        border: 2px dashed var(--border);
        border-radius: 10px;
        padding: 14px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.15s;
        min-height: 120px;
    }

    .add-item-card:hover {
        border-color: var(--primary);
        background: rgba(99, 102, 241, 0.03);
    }

    .add-item-card svg {
        width: 28px;
        height: 28px;
        color: var(--muted);
        margin-bottom: 6px;
    }

    .add-item-card:hover svg {
        color: var(--primary);
    }

    .add-item-card span {
        font-size: 0.85rem;
        color: var(--muted);
        font-weight: 500;
    }

    .add-item-card:hover span {
        color: var(--primary);
    }

    /* Ungrouped section (no card wrapper) */
    .ungrouped-section {
        margin-bottom: 24px;
        background: var(--surface);
        border-radius: 12px;
        padding: 20px;
    }

    .ungrouped-section .section-header {
        cursor: default;
    }

    .ungrouped-section .section-header:hover .section-title {
        color: var(--text);
    }

    /* Modal styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    
    .modal-overlay.show {
        display: flex;
    }
    
    .modal-content {
        background: var(--surface);
        border-radius: 12px;
        width: 90%;
        max-width: 440px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        position: sticky;
        top: 0;
        background: var(--surface);
        z-index: 1;
    }
    
    .modal-header h3 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: var(--muted);
        cursor: pointer;
        line-height: 1;
    }
    
    .modal-close:hover {
        color: var(--text);
    }
    
    .modal-body {
        padding: 20px;
    }

    .form-group {
        margin-bottom: 16px;
    }

    .form-group:last-child {
        margin-bottom: 0;
    }

    .form-label {
        display: block;
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--text);
        margin-bottom: 8px;
    }
    
    .search-input-wrapper {
        position: relative;
    }
    
    .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 1rem;
        color: var(--text);
        background: var(--surface);
    }
    
    .form-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .search-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-top: 4px;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: 10;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .search-suggestions.show {
        display: block;
    }
    
    .search-suggestion {
        padding: 10px 16px;
        cursor: pointer;
        font-size: 0.9rem;
    }
    
    .search-suggestion:hover,
    .search-suggestion.highlighted {
        background: var(--surface-2);
    }
    
    .search-suggestion.highlighted {
        background: rgba(99, 102, 241, 0.1);
        color: var(--primary);
    }
    
    .selected-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--surface-2);
        padding: 10px 14px;
        border-radius: 8px;
    }
    
    .selected-item-name {
        font-weight: 500;
        color: var(--text);
    }
    
    .selected-item-clear {
        background: none;
        border: none;
        color: var(--muted);
        cursor: pointer;
        font-size: 18px;
        line-height: 1;
    }
    
    .selected-item-clear:hover {
        color: var(--danger);
    }

    /* Checkbox group for multi-select */
    .checkbox-group {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--border);
        border-radius: 8px;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        padding: 10px 14px;
        cursor: pointer;
        transition: background 0.15s;
    }

    .checkbox-item:hover {
        background: var(--surface-2);
    }

    .checkbox-item:not(:last-child) {
        border-bottom: 1px solid var(--border);
    }

    .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        margin-right: 10px;
        cursor: pointer;
    }

    .checkbox-item label {
        flex: 1;
        cursor: pointer;
        font-size: 0.95rem;
    }

    .new-group-input {
        margin-top: 8px;
    }
    
    .modal-submit {
        width: 100%;
        padding: 12px 16px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        margin-top: 16px;
        transition: background 0.2s;
    }
    
    .modal-submit:hover:not(:disabled) {
        background: var(--primary-hover);
    }
    
    .modal-submit:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Delete Confirmation */
    .delete-confirm-content {
        padding: 24px;
        text-align: center;
    }
    
    .delete-confirm-icon {
        width: 48px;
        height: 48px;
        background: rgba(239, 68, 68, 0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
    }
    
    .delete-confirm-icon svg {
        width: 24px;
        height: 24px;
        color: var(--danger);
    }
    
    .delete-confirm-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0 0 8px 0;
    }
    
    .delete-confirm-message {
        color: var(--muted);
        font-size: 0.9rem;
        margin: 0 0 20px 0;
    }
    
    .delete-confirm-item-name {
        font-weight: 600;
        color: var(--text);
    }
    
    .delete-confirm-buttons {
        display: flex;
        gap: 12px;
    }
    
    .delete-confirm-btn {
        flex: 1;
        padding: 10px 16px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
    }
    
    .delete-confirm-btn.cancel {
        background: var(--surface-2);
        color: var(--text);
    }
    
    .delete-confirm-btn.cancel:hover {
        background: var(--border);
    }
    
    .delete-confirm-btn.delete {
        background: var(--danger);
        color: white;
    }
    
    .delete-confirm-btn.delete:hover {
        background: #DC2626;
    }

    /* Manage Groups Modal */
    .groups-list {
        max-height: 300px;
        overflow-y: auto;
    }

    .group-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-bottom: 8px;
    }

    .group-item:last-child {
        margin-bottom: 0;
    }

    .group-item-name {
        font-weight: 500;
        color: var(--text);
    }

    .group-item-count {
        font-size: 0.85rem;
        color: var(--muted);
        margin-left: 8px;
    }

    .group-delete-btn {
        background: none;
        border: none;
        color: var(--muted);
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        transition: all 0.2s;
    }

    .group-delete-btn:hover {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
    }
    
    .group-item-content {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
    }
    
    .group-name-input {
        padding: 4px 8px;
        border: 1px solid var(--primary);
        border-radius: 4px;
        font-size: 0.9rem;
        width: 150px;
        background: var(--surface);
        color: var(--text);
    }
    
    .group-item-actions {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .group-edit-btn {
        background: none;
        border: none;
        color: var(--muted);
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        transition: all 0.2s;
    }
    
    .group-edit-btn:hover {
        color: var(--primary);
        background: var(--surface-2);
    }

    .no-groups-message {
        text-align: center;
        color: var(--muted);
        padding: 20px;
    }

    /* Chart Modal */
    .chart-modal-content {
        max-width: 800px;
        width: 95%;
    }

    .chart-container {
        position: relative;
        height: 400px;
        margin-top: 16px;
    }

    .chart-loading {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 16px;
        z-index: 10;
        border-radius: 8px;
    }

    .loading-spinner {
        width: 48px;
        height: 48px;
        border: 4px solid var(--border);
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-text {
        font-size: 1rem;
        color: var(--muted);
    }

    .chart-range-btns {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .chart-btn {
        padding: 8px 16px;
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--text);
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .chart-btn:hover {
        background: var(--surface-2);
    }

    .chart-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    @media (max-width: 640px) {
        .page-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .quick-stats-bar {
            flex-direction: column;
        }

        .stat-card {
            min-width: 100%;
        }

        .favorites-toolbar {
            flex-direction: column;
        }

        .toolbar-search {
            width: 100%;
            min-width: 100%;
        }

        .toolbar-controls {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            flex-wrap: nowrap;
            padding-bottom: 4px;
        }

        .toolbar-row {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            flex-wrap: nowrap;
            padding-bottom: 4px;
        }

        .sort-controls-row {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            flex-wrap: nowrap;
            padding-bottom: 4px;
            position: relative;
        }
        
        .sort-controls-row::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 30px;
            background: linear-gradient(to right, transparent, var(--bg));
            pointer-events: none;
        }

        .sort-control {
            flex-shrink: 0;
        }

        .toolbar-select,
        .view-toggle {
            flex-shrink: 0;
        }

        .last-updated {
            width: 100%;
            justify-content: center;
        }

        .favorites-grid {
            grid-template-columns: 1fr;
        }

        .favorites-section {
            padding: 12px;
        }

        .ungrouped-section {
            padding: 12px;
        }

        .favorite-item {
            padding: 12px;
            min-width: 0;
        }

        .favorite-item-name {
            font-size: 0.85rem;
        }

        .header-actions {
            width: 100%;
        }

        .header-btn {
            flex: 1;
            justify-content: center;
        }

        .view-list .favorite-item {
            flex-direction: column;
            align-items: flex-start;
        }

        .view-list .favorite-prices {
            width: 100%;
            justify-content: space-between;
        }

        .view-list .favorite-spread {
            border-left: none;
            border-top: 1px solid var(--border);
            padding: 8px 0 0 0;
            margin: 8px 0 0 0;
            width: 100%;
        }

        .keyboard-shortcuts-badge {
            display: none;
        }
    }

    /* ========================================
       COMPACT SIZE REDUCTIONS
       ======================================== */
    
    /* Reduce header button sizes */
    .header-btn {
        padding: 8px 14px !important;
        font-size: 0.85rem !important;
    }
    
    .header-btn svg {
        width: 16px !important;
        height: 16px !important;
    }
    
    /* Reduce toolbar padding */
    .favorites-toolbar {
        padding: 10px !important;
        margin-bottom: 14px !important;
        gap: 10px !important;
        flex-direction: column;
        align-items: stretch;
    }
    
    .toolbar-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .toolbar-search {
        flex: 1;
        min-width: 180px;
    }
    
    .toolbar-search input {
        padding: 7px 32px 7px 34px !important;
        font-size: 0.85rem !important;
    }
    
    .toolbar-controls {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        align-items: center;
    }
    
    /* Item count summary */
    .item-count-summary {
        font-size: 0.8rem;
        color: var(--muted);
        font-weight: 500;
        padding-bottom: 6px;
        border-bottom: 1px solid var(--border);
    }
    
    .item-count-summary span {
        color: var(--primary);
        font-weight: 600;
    }
    
    /* Sort controls */
    .sort-control {
        display: flex;
        align-items: center;
        gap: 6px;
        background: var(--surface-2);
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid var(--border);
    }
    
    .sort-controls-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .sort-label {
        font-size: 0.75rem;
        color: var(--muted);
        font-weight: 600;
        white-space: nowrap;
    }
    
    .toolbar-select-compact {
        padding: 5px 8px;
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 0.8rem;
        color: var(--text);
        background: var(--surface);
        cursor: pointer;
        transition: all 0.2s;
        min-width: 100px;
    }
    
    .toolbar-select-compact:hover {
        border-color: var(--primary);
    }
    
    .toolbar-select-compact:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
    }
    
    .sort-direction-btn {
        padding: 4px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
    }
    
    .sort-direction-btn:hover {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }
    
    .sort-direction-btn svg {
        width: 14px;
        height: 14px;
        transition: transform 0.2s;
    }
    
    .sort-direction-btn[data-direction="desc"] svg {
        transform: rotate(180deg);
    }
    
    .sort-direction-btn.active {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }
    
    /* Compact toolbar buttons */
    .toolbar-btn-compact {
        padding: 6px 10px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 0.8rem;
        color: var(--text);
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 4px;
        font-weight: 500;
    }
    
    .toolbar-btn-compact:hover {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }
    
    .toolbar-btn-compact svg {
        width: 14px;
        height: 14px;
    }
    
    .toolbar-btn-compact.active {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }
    
    /* Reduce view toggle button sizes */
    .view-toggle-btn {
        padding: 6px 10px !important;
        font-size: 0;
    }
    
    .view-toggle-btn svg {
        width: 14px !important;
        height: 14px !important;
    }
    
    /* Reduce card padding and gaps */
    .favorites-grid {
        gap: 12px !important;
    }
    
    .favorites-section {
        padding: 14px !important;
        margin-bottom: 14px !important;
    }
    
    .section-header {
        padding: 0 !important;
        margin-bottom: 6px !important;
    }
    
    .section-title {
        font-size: 0.85rem !important;
    }
    
    .section-count {
        font-size: 0.7rem !important;
    }
    
    .favorite-item {
        padding: 10px !important;
    }
    
    .favorite-item-name {
        font-size: 0.85rem !important;
    }
    
    .favorite-prices {
        font-size: 0.8rem !important;
    }
    
    .favorite-spread {
        padding: 8px 0 0 12px !important;
    }
    
    .last-updated {
        font-size: 0.75rem !important;
        padding: 4px 8px !important;
    }
    
    .last-updated svg {
        width: 12px !important;
        height: 12px !important;
    }
    
    /* ========================================
       NEW FEATURE STYLES
       ======================================== */
    
    /* Group visibility toggle */
    .group-visibility-toggle {
        padding: 4px;
        background: transparent;
        border: 1px solid transparent;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        margin-left: auto;
    }
    
    .group-visibility-toggle:hover {
        background: var(--surface-2);
        border-color: var(--border);
        color: var(--text);
    }
    
    .group-visibility-toggle svg {
        width: 16px;
        height: 16px;
    }
    
    .group-visibility-toggle.hidden {
        color: var(--danger);
    }
    
    /* Hidden groups section */
    .hidden-groups-section {
        background: var(--surface-2);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 14px;
        margin-bottom: 14px;
    }
    
    .hidden-groups-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
        color: var(--muted);
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .hidden-groups-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }
    
    .hidden-group-badge {
        padding: 4px 8px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .hidden-group-badge:hover {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }
    
    .hidden-group-badge svg {
        width: 12px;
        height: 12px;
    }
    
    /* Multi-group badges on items */
    .item-group-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 6px;
    }
    
    .item-group-badge {
        padding: 2px 6px;
        background: rgba(99, 102, 241, 0.1);
        color: var(--primary);
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 500;
    }
    
    /* Show All view styles */
    .show-all-view .favorites-section {
        border: none;
        padding: 0 !important;
        margin: 0 !important;
    }
    
    .show-all-view .section-header {
        display: none;
    }
    
    .show-all-view .favorites-grid {
        margin-top: 0 !important;
    }
    
    /* Help modal styles */
    .help-modal .modal-content {
        max-width: 700px;
    }
    
    .help-section {
        margin-bottom: 20px;
    }
    
    .help-section:last-child {
        margin-bottom: 0;
    }
    
    .help-section-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1rem;
        font-weight: 600;
        color: #0d9488;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 2px solid #0d9488;
    }
    
    .help-section-title svg {
        color: var(--warning);
    }
    
    .help-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .help-list li {
        padding: 6px 0 6px 20px;
        position: relative;
        font-size: 0.9rem;
        line-height: 1.5;
        color: var(--text);
    }
    
    .help-list li:before {
        content: "→";
        position: absolute;
        left: 0;
        color: #0d9488;
        font-weight: bold;
    }
    
    .help-list strong {
        color: #0d9488;
    }
    
    .help-list kbd {
        display: inline-block;
        padding: 2px 6px;
        font-size: 0.75rem;
        font-family: monospace;
        color: var(--text);
        background: var(--surface-2);
        border: 1px solid var(--border);
        border-radius: 3px;
        box-shadow: 0 1px 0 var(--border);
    }
    
    /* Collapsed group styles */
    .favorites-section.collapsed .favorites-grid {
        display: none;
    }
    
    .section-toggle-icon {
        transition: transform 0.2s;
    }
    
    .favorites-section.collapsed .section-toggle-icon {
        transform: rotate(-90deg);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-left">
        <div class="page-header-icon">
            <svg fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
            </svg>
        </div>
        <div class="page-header-text">
            <h1>My Favorites</h1>
            <p>Track your favorite items and their prices</p>
        </div>
    </div>
    <div class="header-actions">
        <button class="header-btn header-btn-outline" id="manageGroupsBtn" onclick="openManageGroupsModal()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
            </svg>
            Manage Groups
        </button>
        <button class="header-btn header-btn-primary" onclick="openAddFavoriteModal()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Add Item
        </button>
    </div>
</div>

<!-- Toolbar -->
<div class="favorites-toolbar" id="favoritesToolbar" style="display: none;">
    <!-- Item Count Summary -->
    <div class="item-count-summary" id="itemCountSummary">
        Showing <span id="visibleItemCount">0</span> of <span id="totalItemCount">0</span> items
    </div>
    
    <div class="toolbar-row">
        <div class="toolbar-search">
            <div class="toolbar-search-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
            </div>
            <input type="text" id="searchFavorites" placeholder="Search favorites..." autocomplete="off">
            <button class="toolbar-search-clear" id="searchClear">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <!-- Sort Controls Row -->
        <div class="sort-controls-row">
            <!-- Item Sort Control -->
            <div class="sort-control">
                <label class="sort-label">Item Sort:</label>
                <select id="sortItems" class="toolbar-select-compact">
                    <option value="default">Default</option>
                    <option value="name">Name</option>
                    <option value="spread">Spread %</option>
                    <option value="high-price">High Price</option>
                    <option value="low-price">Low Price</option>
                </select>
                <button class="sort-direction-btn" id="itemSortDirection" data-direction="asc" title="Toggle sort direction">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                    </svg>
                </button>
            </div>
            
            <!-- Group Sort Control -->
            <div class="sort-control">
                <label class="sort-label">Group Sort:</label>
                <select id="sortGroups" class="toolbar-select-compact">
                    <option value="default">Default</option>
                    <option value="name">Name</option>
                    <option value="count">Item Count</option>
                    <option value="spread">Total Spread</option>
                </select>
                <button class="sort-direction-btn" id="groupSortDirection" data-direction="asc" title="Toggle sort direction">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    
    <div class="toolbar-controls">
        <!-- Show All Toggle -->
        <button class="toolbar-btn-compact" id="showAllToggle" title="Toggle grouped/ungrouped view">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
            </svg>
            <span id="showAllToggleText">Un-Group</span>
        </button>
        
        <!-- Help Button -->
        <button class="toolbar-btn-compact" id="helpBtn" title="Show help">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Help
        </button>
        
        <div class="view-toggle">
            <button class="view-toggle-btn active" data-view="comfortable" title="Comfortable view">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                </svg>
            </button>
            <button class="view-toggle-btn" data-view="compact" title="Compact view">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                </svg>
            </button>
            <button class="view-toggle-btn" data-view="list" title="List view">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
            </button>
        </div>
        <div class="last-updated" id="lastUpdated">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span>Updated <span id="lastUpdatedTime">just now</span></span>
            <button class="refresh-btn" onclick="location.reload()" title="Refresh page">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 14px; height: 14px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
            </button>
        </div>
    </div>
</div>

<div id="favorites-content">
    <div class="loading-container">
        <div class="spinner-border" role="status" style="width: 36px; height: 36px; color: var(--primary);"></div>
        <span class="loading-text">Loading</span>
    </div>
</div>

<!-- Keyboard Shortcuts Badge -->
<div class="keyboard-shortcuts-badge" id="shortcutsBadge" title="Keyboard Shortcuts (Press ?)">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
    </svg>
</div>

<!-- Add Favorite Modal -->
<div class="modal-overlay" id="addFavoriteModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Favorite Item</h3>
            <button class="modal-close" onclick="closeAddFavoriteModal()">×</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Item</label>
                <div class="search-input-wrapper">
                    <input type="text" class="form-input" id="addFavoriteInput" placeholder="Search for an item..." autocomplete="off">
                    <div class="search-suggestions" id="addFavoriteSuggestions"></div>
                </div>
                <div class="selected-item" id="addFavoriteSelected" style="display: none;">
                    <span class="selected-item-name" id="selectedItemName"></span>
                    <button class="selected-item-clear" onclick="clearSelectedItem()">×</button>
                </div>
                <input type="hidden" id="selectedItemId" value="">
            </div>
            
            <div class="form-group" id="addGroupsSection" style="display: none;">
                <label class="form-label">Groups (Optional)</label>
                <div class="checkbox-group" id="addGroupCheckboxes">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Create New Group (Optional)</label>
                <input type="text" class="form-input" id="newGroupInput" placeholder="Enter group name...">
            </div>
            
            <button type="button" class="modal-submit" id="addFavoriteSubmit" onclick="submitFavorite()" disabled>Add to Favorites</button>
        </div>
    </div>
</div>

<!-- Edit Groups Modal -->
<div class="modal-overlay" id="editGroupsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Groups</h3>
            <button class="modal-close" onclick="closeEditGroupsModal()">×</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Item: <span id="editItemName"></span></label>
                <input type="hidden" id="editItemId">
            </div>
            
            <div class="form-group" id="editGroupsSection">
                <label class="form-label">Select Groups</label>
                <div class="checkbox-group" id="editGroupCheckboxes">
                    <!-- Populated by JavaScript -->
                </div>
                <p class="no-groups-msg" style="color: var(--muted); display: none;">No groups created yet.</p>
            </div>
            
            <div class="form-group">
                <label class="form-label">Create New Group</label>
                <input type="text" class="form-input" id="editNewGroupInput" placeholder="Enter group name...">
            </div>
            
            <button type="button" class="modal-submit" onclick="saveItemGroups()">Save Changes</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteConfirmModal">
    <div class="modal-content">
        <div class="delete-confirm-content">
            <div class="delete-confirm-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
            </div>
            <h4 class="delete-confirm-title">Remove from Favorites?</h4>
            <p class="delete-confirm-message">
                Are you sure you want to remove <span class="delete-confirm-item-name" id="deleteItemName"></span> from your favorites?
            </p>
            <div class="delete-confirm-buttons">
                <button class="delete-confirm-btn cancel" onclick="closeDeleteModal()">Cancel</button>
                <button class="delete-confirm-btn delete" id="confirmDeleteBtn">Remove</button>
            </div>
        </div>
    </div>
</div>

<!-- Manage Groups Modal -->
<div class="modal-overlay" id="manageGroupsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Manage Groups</h3>
            <button class="modal-close" onclick="closeManageGroupsModal()">×</button>
        </div>
        <div class="modal-body">
            <div class="groups-list" id="groupsList">
                <!-- Populated dynamically by JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Delete Group Confirmation Modal -->
<div class="modal-overlay" id="deleteGroupModal">
    <div class="modal-content">
        <div class="delete-confirm-content">
            <div class="delete-confirm-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
            </div>
            <h4 class="delete-confirm-title">Delete Group?</h4>
            <p class="delete-confirm-message">
                Are you sure you want to delete the group <span class="delete-confirm-item-name" id="deleteGroupName"></span>? Items in this group will become ungrouped.
            </p>
            <div class="delete-confirm-buttons">
                <button class="delete-confirm-btn cancel" onclick="closeDeleteGroupModal()">Cancel</button>
                <button class="delete-confirm-btn delete" id="confirmDeleteGroupBtn">Delete Group</button>
            </div>
        </div>
    </div>
</div>

<!-- Chart Modal -->
<div class="modal-overlay" id="chartModal">
    <div class="modal-content chart-modal-content">
        <div class="modal-header">
            <h3 id="chartModalTitle">Price History</h3>
            <button class="modal-close" onclick="closeChartModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="chart-range-btns">
                <button class="chart-btn" data-range="day">1D</button>
                <button class="chart-btn" data-range="week">1W</button>
                <button class="chart-btn active" data-range="month">1M</button>
                <button class="chart-btn" data-range="6month">6M</button>
                <button class="chart-btn" data-range="year">1Y</button>
            </div>
            <div class="chart-container">
                <div class="chart-loading" id="chartLoading">
                    <div class="spinner-border" role="status" style="width: 32px; height: 32px; color: var(--primary);"></div>
                    <div class="loading-text">Loading chart...</div>
                </div>
                <canvas id="favoriteChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Keyboard Shortcuts Modal -->
<div class="modal-overlay shortcuts-modal" id="shortcutsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Keyboard Shortcuts</h3>
            <button class="modal-close" onclick="closeShortcutsModal()">×</button>
        </div>
        <div class="modal-body">
            <div class="shortcuts-list">
                <div class="shortcut-item">
                    <div class="shortcut-desc">Show this help</div>
                    <div class="shortcut-keys">
                        <span class="shortcut-key">?</span>
                    </div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-desc">Add new favorite</div>
                    <div class="shortcut-keys">
                        <span class="shortcut-key">N</span>
                    </div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-desc">Focus search</div>
                    <div class="shortcut-keys">
                        <span class="shortcut-key">/</span>
                    </div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-desc">Clear search</div>
                    <div class="shortcut-keys">
                        <span class="shortcut-key">Esc</span>
                    </div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-desc">Manage groups</div>
                    <div class="shortcut-keys">
                        <span class="shortcut-key">G</span>
                    </div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-desc">Toggle compact view</div>
                    <div class="shortcut-keys">
                        <span class="shortcut-key">C</span>
                    </div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-desc">Toggle list view</div>
                    <div class="shortcut-keys">
                        <span class="shortcut-key">L</span>
                    </div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-desc">Collapse all groups</div>
                    <div class="shortcut-keys">
                        <span class="shortcut-key">[</span>
                    </div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-desc">Expand all groups</div>
                    <div class="shortcut-keys">
                        <span class="shortcut-key">]</span>
                    </div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-desc">Refresh page</div>
                    <div class="shortcut-keys">
                        <span class="shortcut-key">R</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Help Modal -->
<div class="modal-overlay help-modal" id="helpModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Help & Guide</h3>
            <button class="modal-close" onclick="closeHelpModal()">×</button>
        </div>
        <div class="modal-body">
            <div class="help-section">
                <h4 class="help-section-title">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Adding & Removing Favorites
                </h4>
                <ul class="help-list">
                    <li><strong>Add Item:</strong> Click "Add Item" button or press <kbd>N</kbd></li>
                    <li><strong>Remove Item:</strong> Click the trash icon on any item card</li>
                    <li><strong>Quick Search:</strong> Use the search bar or press <kbd>/</kbd> to focus</li>
                </ul>
            </div>
            
            <div class="help-section">
                <h4 class="help-section-title">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                    </svg>
                    Using Groups
                </h4>
                <ul class="help-list">
                    <li><strong>Create Group:</strong> Add a new group when adding/editing an item</li>
                    <li><strong>Edit Groups:</strong> Click "Edit Groups" on any item to manage its groups</li>
                    <li><strong>Manage Groups:</strong> Use "Manage Groups" button to view and delete groups</li>
                    <li><strong>Hide Groups:</strong> Click the eye icon on a group header to temporarily hide it</li>
                    <li><strong>Multiple Groups:</strong> Items can belong to multiple groups (shown as badges)</li>
                </ul>
            </div>
            
            <div class="help-section">
                <h4 class="help-section-title">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h9m5-4v12m0 0l-4-4m4 4l4-4"/>
                    </svg>
                    Sorting & Filtering
                </h4>
                <ul class="help-list">
                    <li><strong>Item Sort:</strong> Sort items by name, spread %, high price, or low price</li>
                    <li><strong>Group Sort:</strong> Sort groups by name, item count, or total spread value</li>
                    <li><strong>Sort Direction:</strong> Click the arrow button to toggle ascending/descending</li>
                    <li><strong>Show All:</strong> Toggle to see all favorites in a flat list without groups</li>
                    <li><strong>Search:</strong> Filter items by name using the search box</li>
                </ul>
            </div>
            
            <div class="help-section">
                <h4 class="help-section-title">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                    </svg>
                    Keyboard Shortcuts
                </h4>
                <ul class="help-list">
                    <li><kbd>?</kbd> - Show keyboard shortcuts</li>
                    <li><kbd>N</kbd> - Add new favorite</li>
                    <li><kbd>/</kbd> - Focus search box</li>
                    <li><kbd>Esc</kbd> - Clear search</li>
                    <li><kbd>[</kbd> - Collapse all groups</li>
                    <li><kbd>]</kbd> - Expand all groups</li>
                    <li><kbd>C</kbd> - Toggle comfortable view</li>
                    <li><kbd>L</kbd> - Toggle list view</li>
                    <li><kbd>R</kbd> - Refresh page</li>
                </ul>
            </div>
            
            <div class="help-section">
                <h4 class="help-section-title">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    Power User Tips
                </h4>
                <ul class="help-list">
                    <li>Click item cards to view detailed information and history</li>
                    <li>Use the menu (⋮) on each item for quick actions</li>
                    <li>Switch between Comfortable, Compact, and List views for different layouts</li>
                    <li>Hidden groups can be shown again from the "Hidden Groups" section</li>
                    <li>The item count shows how many items match your current filters</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js" 
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" 
        crossorigin="anonymous"></script>
<script>
// Store loaded data globally for use by other functions
let favoritesData = null;
let lastUpdatedTimestamp = null;
let currentView = 'comfortable'; // comfortable, compact, list
let currentSort = 'default';
let searchQuery = '';

// New state variables for enhanced functionality
let currentItemSort = 'default';
let currentItemSortDirection = 'asc';
let currentGroupSort = 'default';
let currentGroupSortDirection = 'asc';
let showAllView = false;
let hiddenGroups = new Set(); // Track hidden group IDs

// Format number with commas
function formatNumber(num) {
    if (num === null || num === undefined) return '-';
    return Math.round(num).toLocaleString();
}

// Escape HTML for safe insertion
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Get CSRF token from cookies
function getCsrfToken() {
    return document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
}

/**
 * Update item count summary
 */
function updateItemCountSummary(visibleCount, totalCount) {
    $('#visibleItemCount').text(visibleCount);
    $('#totalItemCount').text(totalCount);
}

/**
 * Update last updated timestamp
 */
function updateLastUpdatedTime() {
    if (!lastUpdatedTimestamp) return;
    
    const now = Date.now();
    const diff = now - lastUpdatedTimestamp;
    const seconds = Math.floor(diff / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    
    let timeText;
    if (seconds < 60) {
        timeText = 'just now';
    } else if (minutes < 60) {
        timeText = minutes === 1 ? '1 min ago' : `${minutes} mins ago`;
    } else {
        timeText = hours === 1 ? '1 hour ago' : `${hours} hours ago`;
    }
    
    $('#lastUpdatedTime').text(timeText);
}

/**
 * Apply current view mode to the content
 */
function applyViewMode(view) {
    currentView = view;
    const $content = $('#favorites-content');
    
    // Remove all view classes
    $content.removeClass('view-comfortable view-compact view-list');
    
    // Add current view class
    $content.addClass('view-' + view);
    
    // Update button states
    $('.view-toggle-btn').removeClass('active');
    $(`.view-toggle-btn[data-view="${view}"]`).addClass('active');
    
    // Save preference
    localStorage.setItem('favorites_view_mode', view);
}

/**
 * Sort favorites array based on current sort option
 */
/**
 * Sort favorites based on current item sort settings
 */
function sortFavorites(favorites) {
    if (!favorites || favorites.length === 0) return favorites;
    
    const sorted = [...favorites];
    
    // Determine sort order multiplier (1 for asc, -1 for desc)
    const orderMultiplier = currentItemSortDirection === 'asc' ? 1 : -1;
    
    switch(currentItemSort) {
        case 'name':
            sorted.sort((a, b) => {
                const nameA = a.item_name || '';
                const nameB = b.item_name || '';
                return orderMultiplier * nameA.localeCompare(nameB);
            });
            break;
        case 'spread':
            sorted.sort((a, b) => {
                return orderMultiplier * ((a.spread_pct || 0) - (b.spread_pct || 0));
            });
            break;
        case 'high-price':
            sorted.sort((a, b) => {
                return orderMultiplier * ((a.high_price || 0) - (b.high_price || 0));
            });
            break;
        case 'low-price':
            sorted.sort((a, b) => {
                return orderMultiplier * ((a.low_price || 0) - (b.low_price || 0));
            });
            break;
        case 'default':
        default:
            // Keep original order
            break;
    }
    
    return sorted;
}

/**
 * Sort groups based on current group sort settings
 */
function sortGroups(groups, groupedFavorites) {
    if (!groups || groups.length === 0) return groups;
    
    const sorted = [...groups];
    const orderMultiplier = currentGroupSortDirection === 'asc' ? 1 : -1;
    
    switch(currentGroupSort) {
        case 'name':
            sorted.sort((a, b) => {
                const nameA = a.name || '';
                const nameB = b.name || '';
                return orderMultiplier * nameA.localeCompare(nameB);
            });
            break;
        case 'count':
            sorted.sort((a, b) => {
                const countA = (groupedFavorites[a.id] || []).length;
                const countB = (groupedFavorites[b.id] || []).length;
                return orderMultiplier * (countA - countB);
            });
            break;
        case 'spread':
            sorted.sort((a, b) => {
                const itemsA = groupedFavorites[a.id] || [];
                const itemsB = groupedFavorites[b.id] || [];
                
                // Calculate total spread value for each group (using absolute spread, not percentage)
                const totalSpreadA = itemsA.reduce((sum, item) => sum + (item.spread || 0), 0);
                const totalSpreadB = itemsB.reduce((sum, item) => sum + (item.spread || 0), 0);
                
                return orderMultiplier * (totalSpreadA - totalSpreadB);
            });
            break;
        case 'default':
        default:
            // Keep original order
            break;
    }
    
    return sorted;
}

/**
 * Filter favorites by search query
 */
function filterFavorites(favorites) {
    if (!searchQuery || searchQuery.trim() === '') {
        return favorites;
    }
    
    const query = searchQuery.toLowerCase();
    return favorites.filter(fav => {
        const itemName = fav.item_name || '';
        return itemName.toLowerCase().includes(query);
    });
}

/**
 * Apply both sorting and filtering to favorites
 */
function processFavorites(favorites) {
    let processed = filterFavorites(favorites);
    processed = sortFavorites(processed);
    return processed;
}

// Render a single favorite item card
function renderFavoriteItem(fav, allGroups = []) {
    const highPrice = fav.high_price ? formatNumber(fav.high_price) : '-';
    const lowPrice = fav.low_price ? formatNumber(fav.low_price) : '-';
    const spread = formatNumber(fav.spread);
    const spreadPct = fav.spread_pct ? fav.spread_pct.toFixed(1) : '0.0';
    const groupIds = JSON.stringify(fav.group_ids || []);
    const itemName = escapeHtml(fav.item_name);
    
    return `
        <div class="favorite-item" data-item-id="${fav.item_id}">
            <div class="favorite-item-header">
                <a href="/item_search/?id=${fav.item_id}&name=${encodeURIComponent(fav.item_name)}" class="favorite-item-name">${itemName}</a>
                <div class="favorite-item-actions">
                    <button class="favorite-action-btn" onclick="event.stopPropagation(); openChartModal(${fav.item_id}, '${fav.item_name.replace(/'/g, "\\'")}')" title="View Chart">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                        </svg>
                    </button>
                    <button class="favorite-action-btn" onclick="event.stopPropagation(); editFavoriteGroups(${fav.item_id}, '${fav.item_name.replace(/'/g, "\\'")}', ${groupIds})" title="Edit Groups">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                    </button>
                    <button class="favorite-action-btn delete" onclick="event.stopPropagation(); removeFavorite(${fav.item_id}, '${fav.item_name.replace(/'/g, "\\'")}')" title="Remove">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="favorite-prices">
                <div class="favorite-price">
                    <span class="favorite-price-label">High</span>
                    <span class="favorite-price-value high">${highPrice}</span>
                </div>
                <div class="favorite-price">
                    <span class="favorite-price-label">Low</span>
                    <span class="favorite-price-value low">${lowPrice}</span>
                </div>
            </div>
            <div class="favorite-spread">
                Spread: <strong>${spread}</strong> (${spreadPct}%)
            </div>
        </div>`;
}

// Render the favorites content
function renderFavoritesContent(data) {
    favoritesData = data;
    lastUpdatedTimestamp = Date.now();
    updateLastUpdatedTime();
    
    const container = document.getElementById('favorites-content');
    const groups = data.groups || [];
    const groupedFavorites = data.grouped_favorites || {};
    const ungroupedFavorites = data.ungrouped_favorites || [];
    const allFavorites = data.favorites || [];
    
    // Show toolbar if there are favorites
    if (allFavorites.length > 0) {
        $('#favoritesToolbar').fadeIn(200);
    }
    
    let html = '';
    let totalVisibleItems = 0;
    
    // Show All View - display all items in a flat list
    if (showAllView) {
        let allItems = processFavorites([...allFavorites]);
        totalVisibleItems = allItems.length;
        
        $('#favorites-content').addClass('show-all-view');
        
        if (allItems.length > 0) {
            html = `
                <div class="favorites-section">
                    <div class="section-header" style="cursor: default;">
                        <div class="section-title">
                            <svg fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                            </svg>
                            All Favorites
                            <span class="section-count">(${allItems.length} item${allItems.length !== 1 ? 's' : ''})</span>
                        </div>
                    </div>
                    <div class="favorites-grid">
                        ${allItems.map(item => renderFavoriteItem(item, data.groups)).join('')}
                    </div>
                </div>`;
        }
    } else {
        // Normal grouped view
        $('#favorites-content').removeClass('show-all-view');
        
        // Sort groups according to group sort settings
        let sortedGroups = sortGroups([...groups], groupedFavorites);
        
        // Render hidden groups section if any
        const hiddenGroupsList = sortedGroups.filter(g => hiddenGroups.has(g.id));
        if (hiddenGroupsList.length > 0) {
            html += `
                <div class="hidden-groups-section">
                    <div class="hidden-groups-header">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>
                        </svg>
                        Hidden Groups (${hiddenGroupsList.length})
                    </div>
                    <div class="hidden-groups-list">
                        ${hiddenGroupsList.map(group => `
                            <div class="hidden-group-badge" onclick="showHiddenGroup(${group.id})">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                                ${escapeHtml(group.name)}
                            </div>
                        `).join('')}
                    </div>
                </div>`;
        }
        
        // Render visible groups
        sortedGroups.forEach(group => {
            // Skip hidden groups
            if (hiddenGroups.has(group.id)) {
                return;
            }
            
            let groupItems = groupedFavorites[group.id] || [];
            
            // Apply processing (filter and sort)
            groupItems = processFavorites(groupItems);
            
            if (groupItems.length > 0) {
                totalVisibleItems += groupItems.length;
                const itemCount = groupItems.length;
                const plural = itemCount !== 1 ? 's' : '';
                html += `
                    <div class="favorites-section" data-group-id="${group.id}">
                        <div class="section-header">
                            <div class="section-header-left" onclick="toggleGroup(${group.id})">
                                <div class="collapse-toggle section-toggle-icon">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                    </svg>
                                </div>
                                <div class="section-title">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                                    </svg>
                                    ${escapeHtml(group.name)}
                                    <span class="section-count">(${itemCount} item${plural})</span>
                                </div>
                            </div>
                            <button class="group-visibility-toggle" onclick="event.stopPropagation(); toggleGroupVisibility(${group.id})" title="Hide group">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                            </button>
                        </div>
                        <div class="section-content" id="group-content-${group.id}">
                            <div class="favorites-grid">
                                ${groupItems.map(item => renderFavoriteItem(item, data.groups)).join('')}
                            </div>
                        </div>
                    </div>`;
            }
        });
        
        // Render ungrouped section only if there are ungrouped items
        let processedUngrouped = processFavorites(ungroupedFavorites);
        if (processedUngrouped.length > 0) {
            totalVisibleItems += processedUngrouped.length;
            const showUngroupedHeader = groups.length > 0;
            html += `
                <div class="ungrouped-section">
                    ${showUngroupedHeader ? `
                        <div class="section-header">
                            <div class="section-header-left">
                                <div class="section-title">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                                    </svg>
                                    Ungrouped
                                    <span class="section-count">(${processedUngrouped.length} item${processedUngrouped.length !== 1 ? 's' : ''})</span>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    <div class="favorites-grid">
                        ${processedUngrouped.map(item => renderFavoriteItem(item, data.groups)).join('')}
                    </div>
                </div>`;
        }
    }
    
    // Show message if no results after filtering
    if (html === '' && searchQuery) {
        html = `
            <div class="empty-state" style="text-align: center; padding: 60px 20px;">
                <svg style="width: 64px; height: 64px; color: var(--muted); margin-bottom: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <h3 style="color: var(--text); margin-bottom: 8px;">No items found</h3>
                <p style="color: var(--muted);">No favorites match your search for "${escapeHtml(searchQuery)}"</p>
            </div>`;
        totalVisibleItems = 0;
    }
    
    container.innerHTML = html;
    
    // Update item count summary
    updateItemCountSummary(totalVisibleItems, allFavorites.length);
    
    // Initialize collapsed groups state
    initializeCollapsedGroups();
    
    // Apply current view mode
    applyViewMode(currentView);
}

// Load favorites data
function loadFavoritesData() {
    fetch('/api/favorites/data/')
        .then(response => response.json())
        .then(data => {
            renderFavoritesContent(data);
        })
        .catch(error => {
            console.error('Error loading favorites:', error);
            document.getElementById('favorites-content').innerHTML = 
                '<div class="empty-state"><p>Error loading favorites. Please refresh the page.</p></div>';
        });
}

// Load data on page load
loadFavoritesData();

// Group collapse state persistence
const COLLAPSED_GROUPS_KEY = 'favorites_collapsed_groups';

function getCollapsedGroups() {
    try {
        return JSON.parse(localStorage.getItem(COLLAPSED_GROUPS_KEY) || '[]');
    } catch {
        return [];
    }
}

function setCollapsedGroups(groups) {
    localStorage.setItem(COLLAPSED_GROUPS_KEY, JSON.stringify(groups));
}

function toggleGroup(groupId) {
    const section = document.querySelector(`.favorites-section[data-group-id="${groupId}"]`);
    const header = section.querySelector('.section-header');
    const content = document.getElementById(`group-content-${groupId}`);
    
    const collapsed = getCollapsedGroups();
    const index = collapsed.indexOf(groupId);
    
    if (index > -1) {
        // Expand
        collapsed.splice(index, 1);
        header.classList.remove('collapsed');
        content.classList.remove('collapsed');
    } else {
        // Collapse
        collapsed.push(groupId);
        header.classList.add('collapsed');
        content.classList.add('collapsed');
    }
    
    setCollapsedGroups(collapsed);
}

function initializeCollapsedGroups() {
    const collapsed = getCollapsedGroups();
    collapsed.forEach(groupId => {
        const section = document.querySelector(`.favorites-section[data-group-id="${groupId}"]`);
        if (section) {
            const header = section.querySelector('.section-header');
            const content = document.getElementById(`group-content-${groupId}`);
            if (header && content) {
                header.classList.add('collapsed');
                content.classList.add('collapsed');
            }
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    
    const modal = document.getElementById('addFavoriteModal');
    const input = document.getElementById('addFavoriteInput');
    const suggestions = document.getElementById('addFavoriteSuggestions');
    let debounceTimer;
    let highlightedIndex = -1;
    
    // Input search
    input.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value.trim();
        highlightedIndex = -1;
        
        if (query.length < 2) {
            suggestions.classList.remove('show');
            return;
        }
        
        debounceTimer = setTimeout(() => {
            fetch(`/api/items/?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    if (Array.isArray(data) && data.length > 0) {
                        suggestions.innerHTML = data.slice(0, 8).map(item => 
                            `<div class="search-suggestion" data-id="${item.id}" data-name="${item.name}">${item.name}</div>`
                        ).join('');
                        suggestions.classList.add('show');
                        highlightedIndex = -1;
                    } else {
                        suggestions.classList.remove('show');
                    }
                })
                .catch(err => {
                    console.error('Search error:', err);
                    suggestions.classList.remove('show');
                });
        }, 200);
    });
    
    // Keyboard navigation
    input.addEventListener('keydown', function(e) {
        const items = suggestions.querySelectorAll('.search-suggestion');
        
        if (e.key === 'ArrowDown' || (e.key === 'Tab' && !e.shiftKey)) {
            if (suggestions.classList.contains('show') && items.length > 0) {
                e.preventDefault();
                highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);
                updateHighlight(items);
            }
        } else if (e.key === 'ArrowUp' || (e.key === 'Tab' && e.shiftKey)) {
            if (suggestions.classList.contains('show') && items.length > 0) {
                e.preventDefault();
                highlightedIndex = Math.max(highlightedIndex - 1, 0);
                updateHighlight(items);
            }
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (highlightedIndex >= 0 && items[highlightedIndex]) {
                const item = items[highlightedIndex];
                selectItem(item.dataset.id, item.dataset.name);
            }
        } else if (e.key === 'Escape') {
            closeAddFavoriteModal();
        }
    });
    
    function updateHighlight(items) {
        items.forEach((item, idx) => {
            if (idx === highlightedIndex) {
                item.classList.add('highlighted');
                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('highlighted');
            }
        });
    }
    
    // Suggestion click
    suggestions.addEventListener('click', function(e) {
        if (e.target.classList.contains('search-suggestion')) {
            selectItem(e.target.dataset.id, e.target.dataset.name);
        }
    });
    
    // Close modals on background click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('show');
            }
        });
    });
    
    // Global escape key handler
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal-overlay.show').forEach(modal => {
                modal.classList.remove('show');
            });
        }
    });
});

/**
 * jQuery-based initialization for new features
 */
$(document).ready(function() {
    
    // Load saved view preference
    const savedView = localStorage.getItem('favorites_view_mode');
    if (savedView) {
        currentView = savedView;
    }
    
    // Update timestamp every 30 seconds
    setInterval(updateLastUpdatedTime, 30000);
    
    // Search functionality
    let searchDebounce;
    $('#searchFavorites').on('input', function() {
        clearTimeout(searchDebounce);
        const value = $(this).val().trim();
        
        // Show/hide clear button
        if (value) {
            $('#searchClear').addClass('show');
        } else {
            $('#searchClear').removeClass('show');
        }
        
        searchDebounce = setTimeout(function() {
            searchQuery = value;
            if (favoritesData) {
                renderFavoritesContent(favoritesData);
            }
        }, 300);
    });
    
    // Clear search button
    $('#searchClear').on('click', function() {
        $('#searchFavorites').val('').trigger('input').focus();
    });
    
    // View toggle buttons
    $('.view-toggle-btn').on('click', function() {
        const view = $(this).data('view');
        applyViewMode(view);
    });
    
    // Keyboard shortcuts badge
    $('#shortcutsBadge').on('click', function() {
        openShortcutsModal();
    });
    
    // Global keyboard shortcuts
    $(document).on('keydown', function(e) {
        // Don't trigger shortcuts when typing in inputs or contenteditable elements
        if ($(e.target).is('input, textarea, select, [contenteditable]')) {
            // Exception: Escape key to clear search
            if (e.key === 'Escape' && $(e.target).is('#searchFavorites')) {
                $('#searchFavorites').val('').trigger('input').blur();
                e.preventDefault();
            }
            return;
        }
        
        // Don't trigger when modals are open (except for closing them)
        if ($('.modal-overlay.show').length > 0 && e.key !== 'Escape') {
            return;
        }
        
        switch(e.key) {
            case '?':
                e.preventDefault();
                openShortcutsModal();
                break;
            case 'n':
            case 'N':
                e.preventDefault();
                openAddFavoriteModal();
                break;
            case '/':
                e.preventDefault();
                $('#searchFavorites').focus();
                break;
            case 'g':
            case 'G':
                e.preventDefault();
                openManageGroupsModal();
                break;
            case 'c':
            case 'C':
                e.preventDefault();
                applyViewMode('compact');
                break;
            case 'l':
            case 'L':
                e.preventDefault();
                applyViewMode('list');
                break;
            case 'r':
            case 'R':
                e.preventDefault();
                location.reload();
                break;
            case '[':
                e.preventDefault();
                collapseAllGroups();
                break;
            case ']':
                e.preventDefault();
                expandAllGroups();
                break;
        }
    });
    
    // ========================================
    // NEW FEATURE EVENT HANDLERS
    // ========================================
    
    // Item Sort Control
    $('#sortItems').on('change', function() {
        currentItemSort = $(this).val();
        localStorage.setItem('favorites_item_sort', currentItemSort);
        if (favoritesData) {
            renderFavoritesContent(favoritesData);
        }
    });
    
    $('#itemSortDirection').on('click', function() {
        const btn = $(this);
        const currentDirection = btn.attr('data-direction');
        const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
        btn.attr('data-direction', newDirection);
        currentItemSortDirection = newDirection;
        localStorage.setItem('favorites_item_sort_direction', newDirection);
        if (favoritesData) {
            renderFavoritesContent(favoritesData);
        }
    });
    
    // Group Sort Control
    $('#sortGroups').on('change', function() {
        currentGroupSort = $(this).val();
        localStorage.setItem('favorites_group_sort', currentGroupSort);
        if (favoritesData) {
            renderFavoritesContent(favoritesData);
        }
    });
    
    $('#groupSortDirection').on('click', function() {
        const btn = $(this);
        const currentDirection = btn.attr('data-direction');
        const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
        btn.attr('data-direction', newDirection);
        currentGroupSortDirection = newDirection;
        localStorage.setItem('favorites_group_sort_direction', newDirection);
        if (favoritesData) {
            renderFavoritesContent(favoritesData);
        }
    });
    
    // Show All Toggle
    $('#showAllToggle').on('click', function() {
        showAllView = !showAllView;
        $(this).toggleClass('active', showAllView);
        $('#showAllToggleText').text(showAllView ? 'Group' : 'Un-Group');
        localStorage.setItem('favorites_show_all', showAllView ? 'true' : 'false');
        if (favoritesData) {
            renderFavoritesContent(favoritesData);
        }
    });
    
    // Help Button
    $('#helpBtn').on('click', function() {
        openHelpModal();
    });
    
    // Load saved preferences
    const savedItemSort = localStorage.getItem('favorites_item_sort');
    if (savedItemSort) {
        currentItemSort = savedItemSort;
        $('#sortItems').val(savedItemSort);
    }
    
    const savedItemSortDirection = localStorage.getItem('favorites_item_sort_direction');
    if (savedItemSortDirection) {
        currentItemSortDirection = savedItemSortDirection;
        $('#itemSortDirection').attr('data-direction', savedItemSortDirection);
    }
    
    const savedGroupSort = localStorage.getItem('favorites_group_sort');
    if (savedGroupSort) {
        currentGroupSort = savedGroupSort;
        $('#sortGroups').val(savedGroupSort);
    }
    
    const savedGroupSortDirection = localStorage.getItem('favorites_group_sort_direction');
    if (savedGroupSortDirection) {
        currentGroupSortDirection = savedGroupSortDirection;
        $('#groupSortDirection').attr('data-direction', savedGroupSortDirection);
    }
    
    const savedShowAll = localStorage.getItem('favorites_show_all');
    if (savedShowAll === 'true') {
        showAllView = true;
        $('#showAllToggle').addClass('active');
        $('#showAllToggleText').text('Group');
    } else {
        $('#showAllToggleText').text('Un-Group');
    }
    
    // Load hidden groups from localStorage
    const savedHiddenGroups = localStorage.getItem('favorites_hidden_groups');
    if (savedHiddenGroups) {
        try {
            const hiddenArray = JSON.parse(savedHiddenGroups);
            hiddenGroups = new Set(hiddenArray);
        } catch (e) {
            console.error('Error loading hidden groups:', e);
        }
    }
    
});

function selectItem(itemId, itemName) {
    const input = document.getElementById('addFavoriteInput');
    const suggestions = document.getElementById('addFavoriteSuggestions');
    const selectedDiv = document.getElementById('addFavoriteSelected');
    const selectedName = document.getElementById('selectedItemName');
    const selectedIdInput = document.getElementById('selectedItemId');
    const submitBtn = document.getElementById('addFavoriteSubmit');
    
    input.style.display = 'none';
    suggestions.classList.remove('show');
    selectedDiv.style.display = 'flex';
    selectedName.textContent = itemName;
    selectedIdInput.value = itemId;
    selectedIdInput.dataset.name = itemName;
    submitBtn.disabled = false;
}

function clearSelectedItem() {
    const input = document.getElementById('addFavoriteInput');
    const selectedDiv = document.getElementById('addFavoriteSelected');
    const selectedIdInput = document.getElementById('selectedItemId');
    const submitBtn = document.getElementById('addFavoriteSubmit');
    
    input.style.display = 'block';
    input.value = '';
    input.focus();
    selectedDiv.style.display = 'none';
    selectedIdInput.value = '';
    selectedIdInput.dataset.name = '';
    submitBtn.disabled = true;
}

function getSelectedGroupIds(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return [];
    
    const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
    return Array.from(checkboxes).map(cb => parseInt(cb.value));
}

function submitFavorite() {
    const selectedIdInput = document.getElementById('selectedItemId');
    const itemId = selectedIdInput.value;
    const itemName = selectedIdInput.dataset.name;
    const newGroupInput = document.getElementById('newGroupInput');
    
    if (!itemId || !itemName) return;
    
    const payload = {
        item_id: parseInt(itemId),
        item_name: itemName,
        group_ids: getSelectedGroupIds('addGroupCheckboxes')
    };
    
    if (newGroupInput && newGroupInput.value.trim()) {
        payload.new_group_name = newGroupInput.value.trim();
    }
    
    const csrfToken = getCsrfToken();
    
    fetch('/api/favorites/add/', {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            closeAddFavoriteModal();
            location.reload();
        } else {
            alert('Failed to add favorite: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Error adding favorite:', err);
        alert('Failed to add favorite. Please try again.');
    });
}

function populateGroupCheckboxes(containerIdPrefix, selectedGroupIds = []) {
    const container = document.getElementById(containerIdPrefix + 'Checkboxes');
    const section = document.getElementById(containerIdPrefix.replace('add', 'addGroups').replace('edit', 'editGroups') + 'Section') || document.getElementById('addGroupsSection');
    
    if (!favoritesData || !favoritesData.groups || favoritesData.groups.length === 0) {
        container.innerHTML = '';
        if (containerIdPrefix === 'addGroup') {
            document.getElementById('addGroupsSection').style.display = 'none';
        } else {
            const noGroupsMsg = document.querySelector('#editGroupsSection .no-groups-msg');
            if (noGroupsMsg) noGroupsMsg.style.display = 'block';
        }
        return;
    }
    
    if (containerIdPrefix === 'addGroup') {
        document.getElementById('addGroupsSection').style.display = '';
    } else {
        const noGroupsMsg = document.querySelector('#editGroupsSection .no-groups-msg');
        if (noGroupsMsg) noGroupsMsg.style.display = 'none';
    }
    
    let html = '';
    favoritesData.groups.forEach(group => {
        const checked = selectedGroupIds.includes(group.id) ? 'checked' : '';
        html += `
            <div class="checkbox-item">
                <input type="checkbox" id="${containerIdPrefix}-${group.id}" value="${group.id}" ${checked}>
                <label for="${containerIdPrefix}-${group.id}">${escapeHtml(group.name)}</label>
            </div>`;
    });
    container.innerHTML = html;
}

function openAddFavoriteModal() {
    const modal = document.getElementById('addFavoriteModal');
    const input = document.getElementById('addFavoriteInput');
    const newGroupInput = document.getElementById('newGroupInput');
    
    // Populate checkboxes from loaded data
    populateGroupCheckboxes('addGroup');
    
    modal.classList.add('show');
    clearSelectedItem();
    if (newGroupInput) newGroupInput.value = '';
    input.focus();
}

function closeAddFavoriteModal() {
    document.getElementById('addFavoriteModal').classList.remove('show');
    document.getElementById('addFavoriteSuggestions').classList.remove('show');
    clearSelectedItem();
}

function editFavoriteGroups(itemId, itemName, currentGroupIds) {
    const modal = document.getElementById('editGroupsModal');
    document.getElementById('editItemId').value = itemId;
    document.getElementById('editItemName').textContent = itemName;
    
    // Clear new group input
    const newGroupInput = document.getElementById('editNewGroupInput');
    if (newGroupInput) newGroupInput.value = '';
    
    // Populate checkboxes from loaded data with current selections
    populateGroupCheckboxes('editGroup', currentGroupIds);
    
    modal.classList.add('show');
}

function closeEditGroupsModal() {
    document.getElementById('editGroupsModal').classList.remove('show');
}

function saveItemGroups() {
    const itemId = document.getElementById('editItemId').value;
    const newGroupInput = document.getElementById('editNewGroupInput');
    
    const payload = {
        item_id: parseInt(itemId),
        group_ids: getSelectedGroupIds('editGroupCheckboxes')
    };
    
    if (newGroupInput && newGroupInput.value.trim()) {
        payload.new_group_name = newGroupInput.value.trim();
    }
    
    const csrfToken = getCsrfToken();
    
    fetch('/api/favorites/update-group/', {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            closeEditGroupsModal();
            location.reload();
        } else {
            alert('Failed to update groups: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Error updating groups:', err);
        alert('Failed to update groups. Please try again.');
    });
}

function removeFavorite(itemId, itemName) {
    const deleteModal = document.getElementById('deleteConfirmModal');
    const deleteItemName = document.getElementById('deleteItemName');
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    
    deleteItemName.textContent = itemName;
    deleteModal.classList.add('show');
    
    confirmBtn.onclick = function() {
        doRemoveFavorite(itemId);
    };
}

function closeDeleteModal() {
    document.getElementById('deleteConfirmModal').classList.remove('show');
}

function doRemoveFavorite(itemId) {
    const csrfToken = getCsrfToken();
    
    fetch('/api/favorites/remove/', {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ item_id: itemId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            closeDeleteModal();
            // Remove all instances of this item from the page
            document.querySelectorAll(`.favorite-item[data-item-id="${itemId}"]`).forEach(el => el.remove());
            checkEmptySections();
        }
    })
    .catch(err => {
        console.error('Error removing favorite:', err);
        closeDeleteModal();
    });
}

function checkEmptySections() {
    // Update counts and remove empty sections
    document.querySelectorAll('.favorites-section').forEach(section => {
        const items = section.querySelectorAll('.favorite-item');
        if (items.length === 0) {
            section.remove();
        } else {
            // Update the counter
            const countSpan = section.querySelector('.section-count');
            if (countSpan) {
                countSpan.textContent = `(${items.length} item${items.length !== 1 ? 's' : ''})`;
            }
        }
    });
    
    // Also handle ungrouped section
    const ungroupedSection = document.querySelector('.ungrouped-section');
    if (ungroupedSection) {
        const items = ungroupedSection.querySelectorAll('.favorite-item');
        if (items.length === 0) {
            ungroupedSection.remove();
        } else {
            const countSpan = ungroupedSection.querySelector('.section-count');
            if (countSpan) {
                countSpan.textContent = `(${items.length} item${items.length !== 1 ? 's' : ''})`;
            }
        }
    }
}

function openManageGroupsModal() {
    // Populate the groups list dynamically from favoritesData
    const groupsList = document.getElementById('groupsList');
    
    if (!favoritesData || !favoritesData.groups || favoritesData.groups.length === 0) {
        groupsList.innerHTML = '<div class="no-groups-message">No groups created yet</div>';
    } else {
        let html = '';
        favoritesData.groups.forEach(group => {
            // Count items in this group (with Array.isArray check for safety)
            const itemCount = favoritesData.favorites.filter(fav => 
                Array.isArray(fav.group_ids) && fav.group_ids.includes(group.id)
            ).length;
            
            html += `
                <div class="group-item" data-group-id="${group.id}">
                    <div class="group-item-content">
                        <span class="group-item-name" data-group-id="${group.id}">${escapeHtml(group.name)}</span>
                        <input type="text" class="group-name-input" data-group-id="${group.id}" value="${escapeHtml(group.name)}" style="display: none;">
                        <span class="group-item-count">(${itemCount} item${itemCount !== 1 ? 's' : ''})</span>
                    </div>
                    <div class="group-item-actions">
                        <button class="group-edit-btn" data-group-id="${group.id}" title="Edit name">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 14px; height: 14px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                        </button>
                        <button class="group-delete-btn" data-group-id="${group.id}" data-group-name="${escapeHtml(group.name)}">Delete</button>
                    </div>
                </div>
            `;
        });
        groupsList.innerHTML = html;
        
        // Add event listeners for delete buttons (safer than inline onclick)
        groupsList.querySelectorAll('.group-delete-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const groupId = parseInt(this.dataset.groupId);
                const groupName = this.dataset.groupName;
                deleteGroup(groupId, groupName);
            });
        });
        
        // Edit button listeners
        groupsList.querySelectorAll('.group-edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const groupId = this.dataset.groupId;
                const nameSpan = groupsList.querySelector(`.group-item-name[data-group-id="${groupId}"]`);
                const nameInput = groupsList.querySelector(`.group-name-input[data-group-id="${groupId}"]`);
                nameSpan.style.display = 'none';
                nameInput.style.display = 'inline-block';
                nameInput.focus();
                nameInput.select();
            });
        });
        
        // Save on Enter or blur
        groupsList.querySelectorAll('.group-name-input').forEach(input => {
            const saveGroupName = function() {
                const groupId = parseInt(this.dataset.groupId);
                const newName = this.value.trim();
                const nameSpan = groupsList.querySelector(`.group-item-name[data-group-id="${groupId}"]`);
                
                if (newName && newName !== nameSpan.textContent.trim()) {
                    // Call API to update group name
                    updateGroupName(groupId, newName);
                }
                nameSpan.style.display = 'inline';
                this.style.display = 'none';
            };
            
            input.addEventListener('blur', saveGroupName);
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.blur();
                } else if (e.key === 'Escape') {
                    const groupId = this.dataset.groupId;
                    const nameSpan = groupsList.querySelector(`.group-item-name[data-group-id="${groupId}"]`);
                    this.value = nameSpan.textContent;
                    nameSpan.style.display = 'inline';
                    this.style.display = 'none';
                }
            });
        });
    }
    
    document.getElementById('manageGroupsModal').classList.add('show');
}

function closeManageGroupsModal() {
    document.getElementById('manageGroupsModal').classList.remove('show');
}

function deleteGroup(groupId, groupName) {
    closeManageGroupsModal();
    
    const modal = document.getElementById('deleteGroupModal');
    const nameSpan = document.getElementById('deleteGroupName');
    const confirmBtn = document.getElementById('confirmDeleteGroupBtn');
    
    nameSpan.textContent = groupName;
    modal.classList.add('show');
    
    confirmBtn.onclick = function() {
        doDeleteGroup(groupId);
    };
}

function closeDeleteGroupModal() {
    document.getElementById('deleteGroupModal').classList.remove('show');
}

function doDeleteGroup(groupId) {
    const csrfToken = getCsrfToken();
    
    fetch('/api/favorites/groups/delete/', {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ group_id: groupId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            closeDeleteGroupModal();
            location.reload();
        } else {
            console.error('Failed to delete group:', data.error || 'Unknown error');
            closeDeleteGroupModal();
        }
    })
    .catch(err => {
        console.error('Error deleting group:', err);
        closeDeleteGroupModal();
    });
}

function updateGroupName(groupId, newName) {
    const csrfToken = getCsrfToken();
    
    fetch('/api/favorites/groups/update/', {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ group_id: groupId, name: newName })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // Update the group name in favoritesData
            const group = favoritesData.groups.find(g => g.id === groupId);
            if (group) {
                group.name = newName;
                // Update all instances of this group name in the DOM
                document.querySelectorAll('.section-title').forEach(title => {
                    if (title.closest('.favorites-section')?.dataset.groupId === String(groupId)) {
                        title.textContent = newName;
                    }
                });
                // Update the name in the Manage Groups modal
                const nameSpan = document.querySelector(`.group-item-name[data-group-id="${groupId}"]`);
                if (nameSpan) {
                    nameSpan.textContent = newName;
                }
            }
        } else {
            console.error('Failed to update group name:', data.error || 'Unknown error');
            // Optionally revert the input to original value
            const nameInput = document.querySelector(`.group-name-input[data-group-id="${groupId}"]`);
            const nameSpan = document.querySelector(`.group-item-name[data-group-id="${groupId}"]`);
            if (nameInput && nameSpan) {
                nameInput.value = nameSpan.textContent;
            }
        }
    })
    .catch(err => {
        console.error('Error updating group name:', err);
    });
}

/**
 * Shortcuts modal functions
 */
function openShortcutsModal() {
    $('#shortcutsModal').addClass('show');
}

function closeShortcutsModal() {
    $('#shortcutsModal').removeClass('show');
}

/**
 * Help modal functions
 */
function openHelpModal() {
    $('#helpModal').addClass('show');
}

function closeHelpModal() {
    $('#helpModal').removeClass('show');
}

/**
 * Collapse all groups
 */
function collapseAllGroups() {
    $('.favorites-section').addClass('collapsed');
    localStorage.setItem('favorites_all_collapsed', 'true');
}

/**
 * Expand all groups
 */
function expandAllGroups() {
    $('.favorites-section').removeClass('collapsed');
    localStorage.removeItem('favorites_all_collapsed');
}

/**
 * Toggle group visibility (hide/show)
 */
function toggleGroupVisibility(groupId) {
    if (hiddenGroups.has(groupId)) {
        hiddenGroups.delete(groupId);
    } else {
        hiddenGroups.add(groupId);
    }
    
    // Save to localStorage
    localStorage.setItem('favorites_hidden_groups', JSON.stringify(Array.from(hiddenGroups)));
    
    // Re-render
    if (favoritesData) {
        renderFavoritesContent(favoritesData);
    }
}

/**
 * Show a hidden group
 */
function showHiddenGroup(groupId) {
    hiddenGroups.delete(groupId);
    localStorage.setItem('favorites_hidden_groups', JSON.stringify(Array.from(hiddenGroups)));
    if (favoritesData) {
        renderFavoritesContent(favoritesData);
    }
}

// Chart Modal Functions
let chartInstance = null;
let chartData = null;
let currentChartItemId = null;
let currentTimestep = null;

function openChartModal(itemId, itemName) {
    const modal = document.getElementById('chartModal');
    const title = document.getElementById('chartModalTitle');
    title.textContent = `${itemName} - Price History`;
    currentChartItemId = itemId;
    modal.classList.add('show');
    
    // Reset to default range and load chart
    document.querySelectorAll('.chart-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.range === 'month') btn.classList.add('active');
    });
    
    loadChart(itemId, 'month');
}

function closeChartModal() {
    document.getElementById('chartModal').classList.remove('show');
    if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
    }
    chartData = null;
    currentChartItemId = null;
    currentTimestep = null;
}

async function loadChart(itemId, range) {
    const loading = document.getElementById('chartLoading');
    loading.style.display = 'flex';
    
    // Determine timestep based on range
    let timestep;
    if (range === 'day') {
        timestep = '5m';
    } else if (range === 'week') {
        timestep = '1h';
    } else {
        timestep = '24h';
    }
    
    try {
        const response = await fetch('/api/item/history/?id=' + itemId + '&timestep=' + timestep);
        const data = await response.json();
        
        if (data.data && data.data.length > 0) {
            chartData = data.data;
            currentTimestep = timestep;
            filterAndDisplayChart(range);
        } else {
            displayEmptyChart();
        }
    } catch (error) {
        console.error('Error loading price history:', error);
        displayEmptyChart();
    } finally {
        loading.style.display = 'none';
    }
}

async function switchChartRange(range) {
    let requiredTimestep;
    if (range === 'day') {
        requiredTimestep = '5m';
    } else if (range === 'week') {
        requiredTimestep = '1h';
    } else {
        requiredTimestep = '24h';
    }
    
    if (currentTimestep !== requiredTimestep && currentChartItemId) {
        const loading = document.getElementById('chartLoading');
        loading.style.display = 'flex';
        
        try {
            const response = await fetch('/api/item/history/?id=' + currentChartItemId + '&timestep=' + requiredTimestep);
            const data = await response.json();
            
            if (data.data && data.data.length > 0) {
                chartData = data.data;
                currentTimestep = requiredTimestep;
            }
        } catch (error) {
            console.error('Error loading price history:', error);
        } finally {
            loading.style.display = 'none';
        }
    }
    
    filterAndDisplayChart(range);
}

function filterAndDisplayChart(range) {
    if (!chartData) return;
    
    const now = Date.now() / 1000;
    let filteredData = chartData;
    let minTime, maxTime;
    
    maxTime = new Date();
    
    switch (range) {
        case 'day':
            filteredData = chartData.filter(d => d.timestamp > now - 86400);
            minTime = new Date(Date.now() - 86400 * 1000);
            break;
        case 'week':
            filteredData = chartData.filter(d => d.timestamp > now - 604800);
            minTime = new Date(Date.now() - 604800 * 1000);
            break;
        case 'month':
            filteredData = chartData.filter(d => d.timestamp > now - 2592000);
            minTime = new Date(Date.now() - 2592000 * 1000);
            break;
        case '6month':
            filteredData = chartData.filter(d => d.timestamp > now - 15552000);
            minTime = new Date(Date.now() - 15552000 * 1000);
            break;
        case 'year':
            minTime = new Date(Date.now() - 365 * 86400 * 1000);
            break;
    }
    
    displayChart(filteredData, minTime, maxTime);
}

function displayChart(data, minTime, maxTime) {
    const ctx = document.getElementById('favoriteChart').getContext('2d');
    
    if (chartInstance) {
        chartInstance.destroy();
    }
    
    const labels = data.map(d => new Date(d.timestamp * 1000));
    const highPrices = data.map(d => d.avgHighPrice);
    const lowPrices = data.map(d => d.avgLowPrice);
    
    chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Instant Buy (High)',
                    data: highPrices,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 5,
                    pointHitRadius: 10,
                    tension: 0.3,
                    fill: false,
                    spanGaps: true
                },
                {
                    label: 'Instant Sell (Low)',
                    data: lowPrices,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 5,
                    pointHitRadius: 10,
                    tension: 0.3,
                    fill: false,
                    spanGaps: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    left: 10,
                    right: 20
                }
            },
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 14 },
                    bodyFont: { size: 13 },
                    callbacks: {
                        title: function(context) {
                            return new Date(context[0].parsed.x).toLocaleString();
                        },
                        label: function(context) {
                            return context.dataset.label + ': ' + 
                                (context.parsed.y ? context.parsed.y.toLocaleString() + ' gp' : 'N/A');
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    min: minTime,
                    max: maxTime,
                    time: {
                        displayFormats: {
                            hour: 'MMM d, HH:mm',
                            day: 'MMM d',
                            week: 'MMM d',
                            month: 'MMM yyyy'
                        }
                    },
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxTicksLimit: 8
                    }
                },
                y: {
                    beginAtZero: false,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            if (value >= 1000000) {
                                return (value / 1000000).toFixed(1) + 'M';
                            } else if (value >= 1000) {
                                return (value / 1000).toFixed(0) + 'K';
                            }
                            return value;
                        }
                    }
                }
            }
        }
    });
}

function displayEmptyChart() {
    const ctx = document.getElementById('favoriteChart').getContext('2d');
    
    if (chartInstance) {
        chartInstance.destroy();
    }
    
    chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: 'No price history available',
                    font: { size: 16 }
                }
            }
        }
    });
}

// Chart range button click handlers
document.querySelectorAll('.chart-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        switchChartRange(btn.dataset.range);
    });
});

// Close modal on backdrop click
document.getElementById('chartModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeChartModal();
    }
});
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
{% endblock %}
