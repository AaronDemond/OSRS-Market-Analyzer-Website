{% extends 'base.html' %}
{% load humanize %}

{% block title %}My Flips{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 30px;
    }
    
    .page-header-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(17, 153, 142, 0.3);
    }
    
    .page-header-icon svg {
        width: 24px;
        height: 24px;
        color: white;
    }
    
    .page-header-text h1 {
        font-size: 1.75rem;
        font-weight: 700;
        color: #1a1a2e;
        margin: 0 0 2px 0;
        letter-spacing: -0.02em;
    }
    
    .page-header-text p {
        color: #6c757d;
        margin: 0;
        font-size: 0.95rem;
    }

    .table-hover tbody tr:hover > * {
        --bs-table-hover-bg: #ff9800;
        background-color: #ff9800;
    }
    .autocomplete-wrapper {
        position: relative;
    }
    .autocomplete-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 200px;
        overflow-y: auto;
        background: #fff;
        border: 1px solid #ced4da;
        border-top: none;
        border-radius: 0 0 4px 4px;
        z-index: 1000;
        display: none;
    }
    .autocomplete-results.show {
        display: block;
    }
    .autocomplete-item {
        padding: 8px 12px;
        cursor: pointer;
    }
    .autocomplete-item:hover,
    .autocomplete-item.active {
        background-color: #667eea;
        color: #fff;
    }
    .sortable {
        cursor: pointer;
        user-select: none;
    }
    .sortable:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    .sort-icon::after {
        content: '⇅';
        margin-left: 5px;
        opacity: 0.5;
    }
    .sortable.asc .sort-icon::after {
        content: '↑';
        opacity: 1;
    }
    .sortable.desc .sort-icon::after {
        content: '↓';
        opacity: 1;
    }
    .stats-row {
        display: flex;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .stat-card {
        padding: 1rem 1.5rem;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
    }
    .stat-label {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.9;
        margin-bottom: 0.25rem;
    }
    .stat-value {
        font-size: 1.25rem;
        font-weight: 600;
    }
    .stat-card {
        padding: 1rem 1.5rem;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .stat-card.positive {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    .stat-card.negative {
        background: linear-gradient(135deg, #cb2d3e 0%, #ef473a 100%);
    }
    .stat-card.zero {
        background: linear-gradient(135deg, #606c88 0%, #3f4c6b 100%);
    }
    .stat-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.9;
        margin-bottom: 0.25rem;
    }
    .btn-new-flip {
        padding: 0.6rem 1.2rem;
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(17, 153, 142, 0.3);
    }
    .btn-new-flip:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(17, 153, 142, 0.4);
        color: white;
    }
    .btn-delete-flip {
        padding: 0.6rem 1.2rem;
        background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(247, 151, 30, 0.3);
    }
    .btn-delete-flip:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(247, 151, 30, 0.4);
        color: white;
    }
    .btn-delete-flip.active {
        background: linear-gradient(135deg, #cb2d3e 0%, #ef473a 100%);
        box-shadow: 0 4px 12px rgba(203, 45, 62, 0.4);
    }
    #flipsTable.delete-mode tbody tr {
        cursor: pointer;
    }
    #flipsTable.delete-mode tbody tr:hover > * {
        --bs-table-hover-bg: #dc3545;
        background-color: #dc3545;
        color: #fff;
    }
    #flipsTable.delete-mode tbody tr:hover a {
        color: #fff;
    }
    .time-filter {
        display: flex;
        gap: 0;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    .time-filter-btn {
        padding: 0.6rem 1.2rem;
        border: none;
        background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
        color: rgba(255, 255, 255, 0.7);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }
    .time-filter-btn:hover {
        color: #fff;
        background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
    }
    .time-filter-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
    }
    .time-filter-btn:first-child {
        border-radius: 12px 0 0 12px;
    }
    .time-filter-btn:last-child {
        border-radius: 0 12px 12px 0;
    }
    .filter-row {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .filter-label {
        font-weight: 600;
        color: #4a5568;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
    }
    .time-filter-dropdown {
        display: none;
    }
    @media (max-width: 1010px) {
        .time-filter {
            display: none;
        }
        .time-filter-dropdown {
            display: block;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-icon">
        <svg fill="currentColor" viewBox="0 0 20 20">
            <path d="M10 2a1 1 0 011 1v1.323l.956.285a4.5 4.5 0 012.626 2.02 1 1 0 01-1.724 1.016 2.5 2.5 0 00-1.46-1.123L11 6.4V10l.956.285a4.5 4.5 0 01-.001 8.48l-.955.285V20a1 1 0 11-2 0v-.95l-.956-.285a4.5 4.5 0 01-2.626-2.02 1 1 0 011.724-1.016 2.5 2.5 0 001.46 1.123l.398.118V13l-.956-.285a4.5 4.5 0 01.001-8.48L9 4.05V3a1 1 0 011-1zm1 8.79V6.4l.398.118a2.5 2.5 0 010 4.723L11 10.79zm-2 .42l-.398-.118a2.5 2.5 0 010-4.723L9 6.25v3.96zm0 2.54v3.96l-.398-.118a2.5 2.5 0 010-4.723L9 11.75zm2 .46l.398.118a2.5 2.5 0 010 4.723L11 17.17v-3.96z"/>
        </svg>
    </div>
    <div class="page-header-text">
        <h1>My Flips</h1>
        <p>Track your Grand Exchange flipping profits</p>
    </div>
</div>

<div class="stats-row">
    <div class="stat-card {% if total_unrealized > 0 %}positive{% elif total_unrealized < 0 %}negative{% else %}zero{% endif %}">
        <span class="stat-label">Unrealized Net</span>
        <span class="stat-value">{% if total_unrealized >= 0 %}+{% endif %}{{ total_unrealized|floatformat:0|intcomma }} gp</span>
    </div>
    <div class="stat-card {% if total_realized > 0 %}positive{% elif total_realized < 0 %}negative{% else %}zero{% endif %}">
        <span class="stat-label">Realized Net</span>
        <span class="stat-value">{% if total_realized >= 0 %}+{% endif %}{{ total_realized|floatformat:0|intcomma }} gp</span>
    </div>
    <div class="stat-card">
        <span class="stat-label">Position Size</span>
        <span class="stat-value">{{ position_size|floatformat:0|intcomma }} gp</span>
    </div>
</div>

<hr style="border: none; border-top: 1px solid #e0e0e0; margin: 1.5rem 0;">

<div class="d-flex flex-column flex-md-row justify-content-md-between align-items-md-center gap-3 mb-3">
    <div class="d-flex gap-3">
        <button type="button" class="btn-new-flip" data-bs-toggle="modal" data-bs-target="#newFlipModal">
            New Flip
        </button>
        <button type="button" class="btn-delete-flip" id="deleteFlipBtn">
            Delete Flip
        </button>
    </div>
    <div class="filter-row mb-0">
        <span class="filter-label">Compare To:</span>
        <div class="time-filter">
            <button class="time-filter-btn {% if time_filter == 'current' or not time_filter %}active{% endif %}" data-filter="current">Current</button>
            <button class="time-filter-btn {% if time_filter == 'week' %}active{% endif %}" data-filter="week">Week</button>
            <button class="time-filter-btn {% if time_filter == 'month' %}active{% endif %}" data-filter="month">Month</button>
            <button class="time-filter-btn {% if time_filter == 'year' %}active{% endif %}" data-filter="year">Year</button>
        </div>
        <select class="form-select time-filter-dropdown" id="timeFilterDropdown">
            <option value="current" {% if time_filter == 'current' or not time_filter %}selected{% endif %}>Current</option>
            <option value="week" {% if time_filter == 'week' %}selected{% endif %}>Week</option>
            <option value="month" {% if time_filter == 'month' %}selected{% endif %}>Month</option>
            <option value="year" {% if time_filter == 'year' %}selected{% endif %}>Year</option>
        </select>
    </div>
</div>

<!-- New Flip Modal -->
<div class="modal fade" id="newFlipModal" tabindex="-1" aria-labelledby="newFlipModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newFlipModalLabel">New Flip</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'add_flip' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3 autocomplete-wrapper">
                        <label for="itemName" class="form-label">Item Name</label>
                        <input type="text" class="form-control" id="itemName" name="item_name" autocomplete="off" required>
                        <div class="autocomplete-results" id="autocompleteResults"></div>
                    </div>
                    <div class="mb-3">
                        <label for="price" class="form-label">Price</label>
                        <input type="number" class="form-control" id="price" name="price" required>
                    </div>
                    <div class="mb-3">
                        <label for="date" class="form-label">Date</label>
                        <input type="datetime-local" class="form-control" id="date" name="date" required>
                    </div>
                    <div class="mb-3">
                        <label for="quantity" class="form-label">Total Quantity</label>
                        <input type="number" class="form-control" id="quantity" name="quantity" required>
                    </div>
                    <div class="mb-3">
                        <label for="type" class="form-label">Type</label>
                        <select class="form-select" id="type" name="type" required>
                            <option value="buy">Buy</option>
                            <option value="sell">Sell</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Flip</button>
                </div>
            </form>
        </div>
    </div>
</div>

<table class="table table-striped table-hover" id="flipsTable">
    <thead class="table-dark">
        <tr>
            <th class="sortable" data-col="0" data-type="string">Item <span class="sort-icon"></span></th>
            <th class="sortable" data-col="1" data-type="number">Price Paid<span class="sort-icon"></span></th>
            <th class="sortable" data-col="2" data-type="number">Quantity Holding <span class="sort-icon"></span></th>
            <th class="sortable" data-col="3" data-type="number">High Price <span class="sort-icon"></span></th>
            <th class="sortable" data-col="4" data-type="number">Low Price <span class="sort-icon"></span></th>
            <th class="sortable" data-col="5" data-type="number">Unrealized Net <span class="sort-icon"></span></th>
            <th class="sortable" data-col="6" data-type="number">Realized Net <span class="sort-icon"></span></th>
        </tr>
    </thead>
    <tbody>
        {% for item in items %}
        <tr data-item-id="{{ item.item_id }}" data-item-name="{{ item.name }}">
            <td><a href="{% url 'item_detail' item.item_id %}">{{ item.name }}</a></td>
            <td data-value="{{ item.avg_price }}">{{ item.avg_price|intcomma }}</td>
            <td data-value="{{ item.quantity_holding }}">{{ item.quantity_holding|intcomma }}</td>
            <td data-value="{{ item.high_price|default:0 }}">{% if item.high_price %}{{ item.high_price|intcomma }}{% else %}-{% endif %}</td>
            <td data-value="{{ item.low_price|default:0 }}">{% if item.low_price %}{{ item.low_price|intcomma }}{% else %}-{% endif %}</td>
            <td data-value="{{ item.unrealized_net }}" class="{% if item.unrealized_net > 0 %}text-success{% elif item.unrealized_net < 0 %}text-danger{% endif %}">{% if item.unrealized_net >= 0 %}+{% endif %}{{ item.unrealized_net|floatformat:0|intcomma }}</td>
            <td data-value="{{ item.realized_net }}" class="{% if item.realized_net > 0 %}text-success{% elif item.realized_net < 0 %}text-danger{% endif %}">{% if item.realized_net >= 0 %}+{% endif %}{{ item.realized_net|floatformat:0|intcomma }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="7" class="text-center">No flips recorded yet.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-refresh page every 5 minutes
    setInterval(function() {
        window.location.reload();
    }, 5 * 60 * 1000);
    
    const input = document.getElementById('itemName');
    const results = document.getElementById('autocompleteResults');
    let activeIndex = -1;
    let items = [];

    input.addEventListener('input', function() {
        const query = this.value;
        if (query.length < 2) {
            results.classList.remove('show');
            return;
        }

        fetch(`/api/items/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                items = data;
                activeIndex = -1;
                if (data.length === 0) {
                    results.classList.remove('show');
                    return;
                }
                results.innerHTML = data.map((item, i) => 
                    `<div class="autocomplete-item" data-index="${i}" data-name="${item.name}">${item.name}</div>`
                ).join('');
                results.classList.add('show');
            });
    });

    input.addEventListener('keydown', function(e) {
        const itemElements = results.querySelectorAll('.autocomplete-item');
        if (!results.classList.contains('show') || itemElements.length === 0) return;

        if (e.key === 'ArrowDown' || e.key === 'Tab') {
            e.preventDefault();
            activeIndex = Math.min(activeIndex + 1, itemElements.length - 1);
            updateActive(itemElements);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            activeIndex = Math.max(activeIndex - 1, 0);
            updateActive(itemElements);
        } else if (e.key === 'Enter' && activeIndex >= 0) {
            e.preventDefault();
            selectItem(itemElements[activeIndex].dataset.name);
        }
    });

    results.addEventListener('click', function(e) {
        if (e.target.classList.contains('autocomplete-item')) {
            selectItem(e.target.dataset.name);
        }
    });

    function updateActive(itemElements) {
        itemElements.forEach((el, i) => {
            el.classList.toggle('active', i === activeIndex);
        });
        if (activeIndex >= 0) {
            itemElements[activeIndex].scrollIntoView({ block: 'nearest' });
        }
    }

    function selectItem(name) {
        input.value = name;
        results.classList.remove('show');
        activeIndex = -1;
    }

    document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !results.contains(e.target)) {
            results.classList.remove('show');
        }
    });

    // Table sorting
    const table = document.getElementById('flipsTable');
    const headers = table.querySelectorAll('th.sortable');
    let currentCol = -1;
    let currentAsc = true;
    
    headers.forEach(header => {
        header.addEventListener('click', function() {
            const col = parseInt(this.dataset.col);
            const type = this.dataset.type;
            
            // Toggle direction if same column, otherwise start ascending
            if (col === currentCol) {
                currentAsc = !currentAsc;
            } else {
                currentCol = col;
                currentAsc = true;
            }
            
            // Reset all headers
            headers.forEach(h => h.classList.remove('asc', 'desc'));
            
            // Set current sort direction
            this.classList.add(currentAsc ? 'asc' : 'desc');
            
            sortTable(col, type, currentAsc);
        });
    });

    function sortTable(col, type, asc) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        rows.sort((a, b) => {
            let aVal, bVal;
            const aCell = a.cells[col];
            const bCell = b.cells[col];
            
            if (type === 'number') {
                aVal = parseFloat(aCell.dataset.value) || 0;
                bVal = parseFloat(bCell.dataset.value) || 0;
            } else {
                aVal = aCell.textContent.trim().toLowerCase();
                bVal = bCell.textContent.trim().toLowerCase();
            }
            
            if (aVal < bVal) return asc ? -1 : 1;
            if (aVal > bVal) return asc ? 1 : -1;
            return 0;
        });
        
        rows.forEach(row => tbody.appendChild(row));
    }

    // Delete flip functionality
    const deleteBtn = document.getElementById('deleteFlipBtn');
    let deleteMode = false;
    let isProcessing = false;
    
    deleteBtn.addEventListener('click', function() {
        if (!deleteMode) {
            deleteMode = true;
            deleteBtn.textContent = 'Click a row to delete';
            deleteBtn.classList.add('btn-warning');
            deleteBtn.classList.remove('btn-danger');
            table.classList.add('delete-mode');
        } else {
            cancelDeleteMode();
        }
    });

    function cancelDeleteMode() {
        deleteMode = false;
        isProcessing = false;
        deleteBtn.textContent = 'Delete Flip';
        deleteBtn.classList.remove('btn-warning');
        deleteBtn.classList.add('btn-danger');
        table.classList.remove('delete-mode');
    }

    table.querySelector('tbody').addEventListener('click', function(e) {
        if (!deleteMode || isProcessing) return;
        
        const row = e.target.closest('tr');
        if (!row || !row.dataset.itemId) return;
        
        e.preventDefault();
        e.stopImmediatePropagation();
        
        isProcessing = true;
        deleteMode = false;
        
        const itemName = row.dataset.itemName;
        const itemId = row.dataset.itemId;
        
        if (confirm(`Are you sure you want to delete all flips for "${itemName}"?`)) {
            // Create and submit a form to delete
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/flips/delete/${itemId}/`;
            
            const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrf;
            form.appendChild(csrfInput);
            
            document.body.appendChild(form);
            form.submit();
        } else {
            cancelDeleteMode();
        }
    });

    // Time filter functionality
    const filterBtns = document.querySelectorAll('.time-filter-btn');
    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const filter = this.dataset.filter;
            window.location.href = `/flips/?filter=${filter}`;
        });
    });

    // Dropdown filter functionality
    const filterDropdown = document.getElementById('timeFilterDropdown');
    if (filterDropdown) {
        filterDropdown.addEventListener('change', function() {
            const filter = this.value;
            window.location.href = `/flips/?filter=${filter}`;
        });
    }
});
</script>
{% endblock %}
{% endblock %}
