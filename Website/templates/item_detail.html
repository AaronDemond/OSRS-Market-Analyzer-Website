{% extends 'base.html' %}
{% load humanize %}

{% block title %}{{ item_name }} - GE Tools{% endblock %}

{% block extra_css %}
<style>
    .table-hover tbody tr:hover > * {
        --bs-table-hover-bg: #ff9800;
        background-color: #ff9800;
    }
    .sortable {
        cursor: pointer;
        user-select: none;
    }
    .sortable:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    .sort-icon::after {
        content: '⇅';
        margin-left: 5px;
        opacity: 0.5;
    }
    .sortable.asc .sort-icon::after {
        content: '↑';
        opacity: 1;
    }
    .sortable.desc .sort-icon::after {
        content: '↓';
        opacity: 1;
    }
    #itemTable.delete-mode tbody tr {
        cursor: pointer;
    }
    #itemTable.delete-mode tbody tr:hover > * {
        --bs-table-hover-bg: #dc3545;
        background-color: #dc3545;
        color: #fff;
    }
    #itemTable.edit-mode tbody tr {
        cursor: pointer;
    }
    #itemTable.edit-mode tbody tr:hover > * {
        --bs-table-hover-bg: #667eea;
        background-color: #667eea;
        color: #fff;
    }
</style>
{% endblock %}

{% block content %}
<h1>{{ item_name }}</h1>
<a href="{% url 'flips' %}" class="btn btn-secondary mb-3">← Back to My Flips</a>
<button type="button" class="btn btn-primary mb-3 ms-2" id="editFlipBtn">
    Edit Flip
</button>
<button type="button" class="btn btn-danger mb-3 ms-2" id="deleteFlipBtn">
    Delete Flip
</button>

<form id="deleteForm" method="post" action="{% url 'delete_single_flip' %}">
    {% csrf_token %}
    <input type="hidden" name="flip_id" id="deleteFlipId">
</form>

<!-- Edit Flip Modal -->
<div class="modal fade" id="editFlipModal" tabindex="-1" aria-labelledby="editFlipModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editFlipModalLabel">Edit Flip</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'edit_flip' %}">
                {% csrf_token %}
                <input type="hidden" name="flip_id" id="editFlipId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editItemName" class="form-label">Item Name</label>
                        <input type="text" class="form-control" id="editItemName" name="item_name" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editPrice" class="form-label">Price</label>
                        <input type="number" class="form-control" id="editPrice" name="price" required>
                    </div>
                    <div class="mb-3">
                        <label for="editDate" class="form-label">Date</label>
                        <input type="datetime-local" class="form-control" id="editDate" name="date" required>
                    </div>
                    <div class="mb-3">
                        <label for="editQuantity" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="editQuantity" name="quantity" required>
                    </div>
                    <div class="mb-3">
                        <label for="editType" class="form-label">Type</label>
                        <select class="form-select" id="editType" name="type" required>
                            <option value="buy">Buy</option>
                            <option value="sell">Sell</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<table class="table table-striped table-hover" id="itemTable">
    <thead class="table-dark">
        <tr>
            <th class="sortable" data-col="0" data-type="string">Item <span class="sort-icon"></span></th>
            <th class="sortable" data-col="1" data-type="string">Type <span class="sort-icon"></span></th>
            <th class="sortable" data-col="2" data-type="number">Price <span class="sort-icon"></span></th>
            <th class="sortable" data-col="3" data-type="date">Date <span class="sort-icon"></span></th>
            <th class="sortable" data-col="4" data-type="number">Quantity <span class="sort-icon"></span></th>
        </tr>
    </thead>
    <tbody>
        {% for flip in flips %}
        <tr data-flip-id="{{ flip.id }}" data-flip-info="{{ flip.type|capfirst }} {{ flip.quantity }} @ {{ flip.price|intcomma }}" data-item-name="{{ flip.item_name }}" data-price="{{ flip.price }}" data-date="{{ flip.date|date:'Y-m-d' }}T{{ flip.date|date:'H:i' }}" data-quantity="{{ flip.quantity }}" data-type="{{ flip.type }}">
            <td>{{ flip.item_name }}</td>
            <td>{{ flip.type|capfirst }}</td>
            <td data-value="{{ flip.price }}">{{ flip.price|intcomma }}</td>
            <td data-value="{{ flip.date|date:'Y-m-d H:i' }}">{{ flip.date|date:'M d, Y H:i' }}</td>
            <td data-value="{{ flip.quantity }}">{{ flip.quantity|intcomma }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="5" class="text-center">No flips recorded for this item.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('itemTable');
    const headers = table.querySelectorAll('th.sortable');
    let currentCol = -1;
    let currentAsc = true;
    
    headers.forEach(header => {
        header.addEventListener('click', function() {
            const col = parseInt(this.dataset.col);
            const type = this.dataset.type;
            
            if (col === currentCol) {
                currentAsc = !currentAsc;
            } else {
                currentCol = col;
                currentAsc = true;
            }
            
            headers.forEach(h => h.classList.remove('asc', 'desc'));
            this.classList.add(currentAsc ? 'asc' : 'desc');
            
            sortTable(col, type, currentAsc);
        });
    });

    function sortTable(col, type, asc) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        rows.sort((a, b) => {
            let aVal, bVal;
            const aCell = a.cells[col];
            const bCell = b.cells[col];
            
            if (type === 'number') {
                aVal = parseFloat(aCell.dataset.value) || 0;
                bVal = parseFloat(bCell.dataset.value) || 0;
            } else if (type === 'date') {
                aVal = aCell.dataset.value || '';
                bVal = bCell.dataset.value || '';
            } else {
                aVal = aCell.textContent.trim().toLowerCase();
                bVal = bCell.textContent.trim().toLowerCase();
            }
            
            if (aVal < bVal) return asc ? -1 : 1;
            if (aVal > bVal) return asc ? 1 : -1;
            return 0;
        });
        
        rows.forEach(row => tbody.appendChild(row));
    }

    // Edit flip functionality
    const editBtn = document.getElementById('editFlipBtn');
    const editModal = new bootstrap.Modal(document.getElementById('editFlipModal'));
    let editMode = false;
    
    editBtn.addEventListener('click', function() {
        if (!editMode) {
            editMode = true;
            editBtn.textContent = 'Click a row to edit';
            editBtn.classList.add('btn-warning');
            editBtn.classList.remove('btn-primary');
            table.classList.add('edit-mode');
        } else {
            cancelEditMode();
        }
    });

    function cancelEditMode() {
        editMode = false;
        editBtn.textContent = 'Edit Flip';
        editBtn.classList.remove('btn-warning');
        editBtn.classList.add('btn-primary');
        table.classList.remove('edit-mode');
    }

    document.getElementById('editFlipModal').addEventListener('hidden.bs.modal', function() {
        cancelEditMode();
    });

    // Delete flip functionality
    const deleteBtn = document.getElementById('deleteFlipBtn');
    let deleteMode = false;
    let isProcessing = false;
    
    deleteBtn.addEventListener('click', function() {
        if (!deleteMode) {
            deleteMode = true;
            deleteBtn.textContent = 'Click a row to delete';
            deleteBtn.classList.add('btn-warning');
            deleteBtn.classList.remove('btn-danger');
            table.classList.add('delete-mode');
        } else {
            cancelDeleteMode();
        }
    });

    function cancelDeleteMode() {
        deleteMode = false;
        isProcessing = false;
        deleteBtn.textContent = 'Delete Flip';
        deleteBtn.classList.remove('btn-warning');
        deleteBtn.classList.add('btn-danger');
        table.classList.remove('delete-mode');
    }

    table.querySelector('tbody').addEventListener('click', function(e) {
        const row = e.target.closest('tr');
        if (!row || !row.dataset.flipId) return;
        
        // Handle edit mode
        if (editMode) {
            e.preventDefault();
            e.stopImmediatePropagation();
            
            document.getElementById('editFlipId').value = row.dataset.flipId;
            document.getElementById('editItemName').value = row.dataset.itemName;
            document.getElementById('editPrice').value = row.dataset.price;
            document.getElementById('editDate').value = row.dataset.date;
            document.getElementById('editQuantity').value = row.dataset.quantity;
            document.getElementById('editType').value = row.dataset.type;
            
            editMode = false;
            table.classList.remove('edit-mode');
            editBtn.textContent = 'Edit Flip';
            editBtn.classList.remove('btn-warning');
            editBtn.classList.add('btn-primary');
            
            editModal.show();
            return;
        }
        
        // Handle delete mode
        if (!deleteMode || isProcessing) return;
        
        e.preventDefault();
        e.stopImmediatePropagation();
        
        isProcessing = true;
        deleteMode = false;
        
        const flipId = row.dataset.flipId;
        const flipInfo = row.dataset.flipInfo;
        
        if (confirm(`Are you sure you want to delete this flip?\n${flipInfo}`)) {
            document.getElementById('deleteFlipId').value = flipId;
            document.getElementById('deleteForm').submit();
        } else {
            cancelDeleteMode();
        }
    });
});
</script>
{% endblock %}
{% endblock %}
